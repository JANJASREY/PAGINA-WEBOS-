<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>

<!-- Mirrored from www.httrack.com/src/htsparse.c.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 02 Jan 2023 20:32:47 GMT -->
<HEAD>
<TITLE>./htsparse.c - HTTrack Website Copier</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#1F00FF" ALINK="#FF0000" VLINK="#9900DD">
<A NAME="top">
<A NAME="file1">
<H1>./htsparse.c</H1>

<PRE>
<I><FONT COLOR="#B22222">/* ------------------------------------------------------------ */</FONT></I>
<I><FONT COLOR="#B22222">/*
HTTrack Website Copier, Offline Browser for Windows and Unix
Copyright (C) 1998-2015 Xavier Roche and other contributors

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.

Important notes:

- We hereby ask people using this source NOT to use it in purpose of grabbing
emails addresses, or collecting any other private information on persons.
This would disgrace our work, and spoil the many hours we spent on it.

Please visit our Website: http://www.httrack.com
*/</FONT></I>

<I><FONT COLOR="#B22222">/* ------------------------------------------------------------ */</FONT></I>
<I><FONT COLOR="#B22222">/* File: htsparse.c parser                                      */</FONT></I>
<I><FONT COLOR="#B22222">/*       html/javascript/css parser                             */</FONT></I>
<I><FONT COLOR="#B22222">/*       and other parser routines                              */</FONT></I>
<I><FONT COLOR="#B22222">/* Author: Xavier Roche                                         */</FONT></I>
<I><FONT COLOR="#B22222">/* ------------------------------------------------------------ */</FONT></I>

<I><FONT COLOR="#B22222">/* Internal engine bytecode */</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">HTS_INTERNAL_BYTECODE</FONT>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;fcntl.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;ctype.h&gt;</FONT></B>

<I><FONT COLOR="#B22222">/* File defs */</FONT></I>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htscore.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">/* specific definitions */</FONT></I>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsbase.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsnet.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsbauth.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsmd5.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsindex.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htscharset.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsencoding.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">/* external modules */</FONT></I>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsmodules.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">// htswrap_add
</FONT></I>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htswrap.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">// parser
</FONT></I>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsparse.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsback.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">// arrays
</FONT></I>#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsarrays.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">/** Append bytes to the output buffer up to the pointer 'html'. **/</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">HT_add_adr</FONT> do { \
  if ( (opt-&gt;getmode &amp; 1) != 0 &amp;&amp; ptr &gt; 0 ) { \
    const size_t sz_ = html - lastsaved; \
    if (sz_ != 0) { \
      TypedArrayAppend(output_buffer, lastsaved, sz_); \
      lastsaved = html; \
    } \
  } \
} while(0)

<I><FONT COLOR="#B22222">/** Append to the output buffer the string 'A'. **/</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">HT_ADD</FONT></B>(A) TypedArrayAppend(output_buffer, A, strlen(A))

<I><FONT COLOR="#B22222">/** Append to the output buffer the string 'A', html-escaped. **/</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">HT_ADD_HTMLESCAPED_ANY</FONT></B>(A, FUNCTION) do { \
  if ((opt-&gt;getmode &amp; 1) != 0 &amp;&amp; ptr&gt;0) { \
    const char *const str_ = (A); \
    size_t size_; \
    <I><FONT COLOR="#B22222">/* &amp;amp; is the maximum expansion */</FONT></I> \
    TypedArrayEnsureRoom(output_buffer, strlen(str_) * 5 + 1024); \
    size_ = FUNCTION(str_, &amp;TypedArrayTail(output_buffer), \
                     TypedArrayRoom(output_buffer)); \
    TypedArraySize(output_buffer) += size_; \
  } \
} while(0)

<I><FONT COLOR="#B22222">/** Append to the output buffer the string 'A', html-escaped for &amp;. **/</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">HT_ADD_HTMLESCAPED</FONT></B>(A) HT_ADD_HTMLESCAPED_ANY(A, escape_for_html_print)

<I><FONT COLOR="#B22222">/**
 * Append to the output buffer the string 'A', html-escaped for &amp; and 
 * high chars.
 **/</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">HT_ADD_HTMLESCAPED_FULL</FONT></B>(A) HT_ADD_HTMLESCAPED_ANY(A, escape_for_html_print_full)

<I><FONT COLOR="#B22222">// does nothing
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">XH_uninit</FONT> do {} while(0)

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">HT_ADD_END</FONT> { \
  int ok=0;\
  if (TypedArraySize(output_buffer) != 0) { \
    const size_t ht_len = TypedArraySize(output_buffer); \
    const char *const ht_buff = TypedArrayElts(output_buffer); \
    char digest[32+2];\
    off_t fsize_old = fsize(fconv(OPT_GET_BUFF(opt),OPT_GET_BUFF_SIZE(opt),savename()));\
    digest[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;\
    domd5mem(TypedArrayElts(output_buffer), ht_len, digest, 1);\
    if (fsize_old == (off_t) ht_len) { \
      int mlen = 0;\
      char* mbuff;\
      cache_readdata(cache,<B><FONT COLOR="#BC8F8F">&quot;//[HTML-MD5]//&quot;</FONT></B>,savename(),&amp;mbuff,&amp;mlen);\
      if (mlen) \
        mbuff[mlen]=<B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;\
      if ((mlen == 32) &amp;&amp; (strcmp(((mbuff!=NULL)?mbuff:<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>),digest)==0)) {\
        ok=1;\
        hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;File not re-written (md5): %s&quot;</FONT></B>,savename());\
      } else {\
        ok=0;\
      } \
    }\
    if (!ok) { \
      file_notify(opt,urladr(), urlfil(), savename(), 1, 1, r-&gt;notmodified); \
      fp=filecreate(&amp;opt-&gt;state.strc, savename()); \
      if (fp) { \
        if (ht_len&gt;0) {\
        if (fwrite(ht_buff,1,ht_len,fp) != ht_len) { \
          int fcheck;\
          if ((fcheck=check_fatal_io_errno())) {\
            opt-&gt;state.exit_xh=-1;\
          }\
          if (opt-&gt;log) {   \
            hts_log_print(opt, LOG_ERROR | LOG_ERRNO, <B><FONT COLOR="#BC8F8F">&quot;Unable to write HTML file %s&quot;</FONT></B>, savename());\
            if (fcheck) {\
              hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;* * Fatal write error, giving up&quot;</FONT></B>);\
            }\
          }\
        }\
        }\
        fclose(fp); fp=NULL; \
        if (strnotempty(r-&gt;lastmodified)) \
        set_filetime_rfc822(savename(),r-&gt;lastmodified); \
      } else {\
        int fcheck;\
        if ((fcheck=check_fatal_io_errno())) {\
  				hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Mirror aborted: disk full or filesystem problems&quot;</FONT></B>); \
          opt-&gt;state.exit_xh=-1;\
        }\
        hts_log_print(opt, LOG_ERROR | LOG_ERRNO, <B><FONT COLOR="#BC8F8F">&quot;Unable to save file %s&quot;</FONT></B>, savename());\
        if (fcheck) {\
          hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;* * Fatal write error, giving up&quot;</FONT></B>);\
        }\
      }\
    } else {\
      file_notify(opt,urladr(), urlfil(), savename(), 0, 0, r-&gt;notmodified); \
      filenote(&amp;opt-&gt;state.strc, savename(),NULL); \
    }\
    if (cache-&gt;ndx)\
      cache_writedata(cache-&gt;ndx,cache-&gt;dat,<B><FONT COLOR="#BC8F8F">&quot;//[HTML-MD5]//&quot;</FONT></B>,savename(),digest,(int)strlen(digest));\
  } \
  TypedArrayFree(output_buffer); \
}
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">HT_ADD_FOP</FONT>

<I><FONT COLOR="#B22222">// COPY IN HTSCORE.C
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">HT_INDEX_END</FONT> do { \
  if (!makeindex_done) { \
  if (makeindex_fp) { \
  char BIGSTK tempo[1024]; \
  if (makeindex_links == 1) { \
  char BIGSTK link_escaped[HTS_URLMAXSIZE*2]; \
  escape_uri_utf(makeindex_firstlink, link_escaped, sizeof(link_escaped)); \
  sprintf(tempo,<B><FONT COLOR="#BC8F8F">&quot;&lt;meta HTTP-EQUIV=\&quot;Refresh\&quot; CONTENT=\&quot;0; URL=%s\&quot;&gt;&quot;</FONT></B>CRLF,link_escaped); \
  } else \
  tempo[0]=<B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; \
  hts_template_format(makeindex_fp,template_footer, \
  <B><FONT COLOR="#BC8F8F">&quot;&lt;!-- Mirror and index made by HTTrack Website Copier/&quot;</FONT></B>HTTRACK_VERSION<B><FONT COLOR="#BC8F8F">&quot; &quot;</FONT></B>HTTRACK_AFF_AUTHORS<B><FONT COLOR="#BC8F8F">&quot; --&gt;&quot;</FONT></B>, \
  tempo, <I><FONT COLOR="#B22222">/* EOF */</FONT></I> NULL \
  ); \
  fflush(makeindex_fp); \
  fclose(makeindex_fp);  <I><FONT COLOR="#B22222">/* à ne pas oublier sinon on passe une nuit blanche */</FONT></I>  \
  makeindex_fp=NULL; \
  usercommand(opt,0,NULL,fconcat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),  StringBuff(opt-&gt;path_html_utf8),<B><FONT COLOR="#BC8F8F">&quot;index.html&quot;</FONT></B>),<B><FONT COLOR="#BC8F8F">&quot;primary&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;primary&quot;</FONT></B>);  \
  } \
  } \
  makeindex_done=1;    <I><FONT COLOR="#B22222">/* ok c'est fait */</FONT></I>  \
} while(0)

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">ENGINE_DEFINE_CONTEXT</FONT></B>() \
  ENGINE_DEFINE_CONTEXT_BASE(); \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  htsblk* const r HTS_UNUSED = stre-&gt;r_; \
  hash_struct* const hash HTS_UNUSED = stre-&gt;hash_; \
  char* const codebase HTS_UNUSED = stre-&gt;codebase; \
  char* const base HTS_UNUSED = stre-&gt;base; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  const char * const template_header HTS_UNUSED = stre-&gt;template_header_; \
  const char * const template_body HTS_UNUSED = stre-&gt;template_body_; \
  const char * const template_footer HTS_UNUSED = stre-&gt;template_footer_; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  HTS_UNUSED char* const makeindex_firstlink = stre-&gt;makeindex_firstlink_; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  int error = * stre-&gt;error_; \
  int store_errpage = * stre-&gt;store_errpage_; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  int makeindex_done = *stre-&gt;makeindex_done_; \
  FILE* makeindex_fp = *stre-&gt;makeindex_fp_; \
  int makeindex_links = *stre-&gt;makeindex_links_; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  LLint stat_fragment = *stre-&gt;stat_fragment_; \
  HTS_UNUSED TStamp makestat_time = stre-&gt;makestat_time; \
  HTS_UNUSED FILE* makestat_fp = stre-&gt;makestat_fp

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">ENGINE_SET_CONTEXT</FONT></B>() \
  ENGINE_SET_CONTEXT_BASE(); \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  error = * stre-&gt;error_; \
  store_errpage = * stre-&gt;store_errpage_; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  makeindex_done = *stre-&gt;makeindex_done_; \
  makeindex_fp = *stre-&gt;makeindex_fp_; \
  makeindex_links = *stre-&gt;makeindex_links_; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  stat_fragment = *stre-&gt;stat_fragment_; \
  makestat_time = stre-&gt;makestat_time; \
  makestat_fp = stre-&gt;makestat_fp

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">ENGINE_LOAD_CONTEXT</FONT></B>() \
  ENGINE_DEFINE_CONTEXT()

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">ENGINE_SAVE_CONTEXT</FONT></B>() \
  ENGINE_SAVE_CONTEXT_BASE(); \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  * stre-&gt;error_ = error; \
  * stre-&gt;store_errpage_ = store_errpage; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  *stre-&gt;makeindex_done_ = makeindex_done; \
  *stre-&gt;makeindex_fp_ = makeindex_fp; \
  *stre-&gt;makeindex_links_ = makeindex_links; \
  <I><FONT COLOR="#B22222">/* */</FONT></I> \
  *stre-&gt;stat_fragment_ = stat_fragment

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">_FILTERS</FONT>     (*opt-&gt;filters.filters)
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">_FILTERS_PTR</FONT> (opt-&gt;filters.filptr)
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">_ROBOTS</FONT>      ((robots_wizard*)opt-&gt;robotsptr)

<I><FONT COLOR="#B22222">/* Apply current *adr character for the script automate */</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">AUTOMATE_LOOKUP_CURRENT_ADR</FONT></B>() do { \
  if (inscript) { \
  int new_state_pos; \
  new_state_pos=inscript_state[inscript_state_pos][(unsigned char)*html]; \
  if (new_state_pos &lt; 0) { \
  new_state_pos=inscript_state[inscript_state_pos][INSCRIPT_DEFAULT]; \
  } \
  assertf(new_state_pos &gt;= 0); \
  assertf(new_state_pos*sizeof(inscript_state[0]) &lt; sizeof(inscript_state)); \
  inscript_state_pos=new_state_pos; \
  } \
} while(0)

<I><FONT COLOR="#B22222">/* Increment current pointer to 'steps' characters, modifying automate if necessary */</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">INCREMENT_CURRENT_ADR</FONT></B>(steps) do { \
  int steps__ = (int) ( steps ); \
  while(steps__ &gt; 0) { \
  html++; \
  AUTOMATE_LOOKUP_CURRENT_ADR(); \
  steps__ --; \
  } \
} while(0)

<I><FONT COLOR="#B22222">/* Main parser */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">htsparse</FONT></B>(htsmoduleStruct * str, htsmoduleStructExtended * stre) {
  <B><FONT COLOR="#228B22">char</FONT></B> catbuff[CATBUFF_SIZE];

  <I><FONT COLOR="#B22222">/* Load engine variables */</FONT></I>
  ENGINE_LOAD_CONTEXT();

  {
    <B><FONT COLOR="#228B22">char</FONT></B> *cAddr = r-&gt;adr;
    <B><FONT COLOR="#228B22">int</FONT></B> cSize = (<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;size;

    hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;engine: preprocess-html: %s%s&quot;</FONT></B>, urladr(),
                  urlfil());
    <B><FONT COLOR="#A020F0">if</FONT></B> (RUN_CALLBACK4(opt, preprocess, &amp;cAddr, &amp;cSize, urladr(), urlfil()) == 1) {
      r-&gt;adr = cAddr;
      r-&gt;size = cSize;
    }
  }
  <B><FONT COLOR="#A020F0">if</FONT></B> (RUN_CALLBACK4(opt, check_html, r-&gt;adr, (<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;size, urladr(), urlfil())) {
    FILE *fp = NULL;                  <I><FONT COLOR="#B22222">// fichier écrit localement 
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *html = r-&gt;adr;        <I><FONT COLOR="#B22222">// pointeur (on parcours)
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *lastsaved;            <I><FONT COLOR="#B22222">// adresse du dernier octet sauvé + 1
</FONT></I>
    hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;scanning file %s%s (%s)..&quot;</FONT></B>, urladr(), urlfil(),
                  savename());

    <I><FONT COLOR="#B22222">/* Hack to avoid NULL char problems with C syntax */</FONT></I>
    <I><FONT COLOR="#B22222">/* Yes, some bogus HTML pages can embed null chars
    and therefore can not be properly handled if this hack is not done
    */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr != NULL) {
      size_t i;
      <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0 ; i &lt; (size_t) r-&gt;size ; i++) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr[i] == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
          r-&gt;adr[i] = <B><FONT COLOR="#BC8F8F">' '</FONT></B>;
        }
      }
    }

    <I><FONT COLOR="#B22222">// Indexing!
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_MAKE_KEYWORD_INDEX</FONT>
    <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;kindex) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (index_keyword
          (r-&gt;adr, r-&gt;size, r-&gt;contenttype, savename(),
           StringBuff(opt-&gt;path_html_utf8))) {
        hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;indexing file..done&quot;</FONT></B>);
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;indexing file..error!&quot;</FONT></B>);
      }
    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    <I><FONT COLOR="#B22222">// Now, parsing
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {      <I><FONT COLOR="#B22222">// récupérer les html sur disque       
</FONT></I>      <I><FONT COLOR="#B22222">// créer le fichier html local
</FONT></I>      HT_ADD_FOP;               <I><FONT COLOR="#B22222">// écrire peu à peu le fichier
</FONT></I>    }

    <B><FONT COLOR="#A020F0">if</FONT></B> (!error) {
      <I><FONT COLOR="#B22222">// output HTML
</FONT></I>      TypedArray(<B><FONT COLOR="#228B22">char</FONT></B>) output_buffer = EMPTY_TYPED_ARRAY;

      time_t user_interact_timestamp = 0;
      <B><FONT COLOR="#228B22">int</FONT></B> detect_title = 0;     <I><FONT COLOR="#B22222">// détection  du title
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> back_add_stats = opt-&gt;state.back_add_stats;

      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *in_media = NULL;    <I><FONT COLOR="#B22222">// in other media type (real media and so..)
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> intag = 0;            <I><FONT COLOR="#B22222">// on est dans un tag
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> incomment = 0;        <I><FONT COLOR="#B22222">// dans un &lt;!--
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> inscript = 0;         <I><FONT COLOR="#B22222">// dans un scipt pour applets javascript)
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> inscript_locked = 0;  <I><FONT COLOR="#B22222">// in locked script (ie. js file)
</FONT></I>      <B><FONT COLOR="#228B22">signed</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> inscript_state[10][257];
      <B><FONT COLOR="#228B22">typedef</FONT></B> <B><FONT COLOR="#228B22">enum</FONT></B> {
        INSCRIPT_START = 0,
        INSCRIPT_ANTISLASH,
        INSCRIPT_INQUOTE,
        INSCRIPT_INQUOTE2,
        INSCRIPT_SLASH,
        INSCRIPT_SLASHSLASH,
        INSCRIPT_COMMENT,
        INSCRIPT_COMMENT2,
        INSCRIPT_ANTISLASH_IN_QUOTE,
        INSCRIPT_ANTISLASH_IN_QUOTE2,
        INSCRIPT_DEFAULT = 256
      } INSCRIPT;
      INSCRIPT inscript_state_pos = INSCRIPT_START;
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *inscript_name = NULL;       <I><FONT COLOR="#B22222">// script tag name
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> inscript_tag = 0;     <I><FONT COLOR="#B22222">// on est dans un &lt;body onLoad=&quot;... terminé par &gt;
</FONT></I>      <B><FONT COLOR="#228B22">char</FONT></B> inscript_tag_lastc = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

      <I><FONT COLOR="#B22222">// terminaison (&quot; ou ') du &quot;&lt;body onLoad=..&quot;
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> inscriptgen = 0;      <I><FONT COLOR="#B22222">// on est dans un code générant, ex après obj.write(&quot;..
</FONT></I>
      <I><FONT COLOR="#B22222">//int inscript_check_comments=0, inscript_in_comments=0;    // javascript comments
</FONT></I>      <B><FONT COLOR="#228B22">char</FONT></B> scriptgen_q = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;  <I><FONT COLOR="#B22222">// caractère faisant office de guillemet (' ou &quot;)
</FONT></I>
      <I><FONT COLOR="#B22222">//int no_esc_utf=0;      // ne pas echapper chars &gt; 127
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> nofollow = 0;         <I><FONT COLOR="#B22222">// ne pas scanner
</FONT></I>
      <I><FONT COLOR="#B22222">//
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> parseall_lastc = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;        <I><FONT COLOR="#B22222">// dernier caractère parsé pour parseall
</FONT></I>
      <I><FONT COLOR="#B22222">//int parseall_incomment=0;   // dans un /* */ (exemple: a = /* URL */ &quot;img.gif&quot;;)
</FONT></I>      <I><FONT COLOR="#B22222">//
</FONT></I>      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *intag_start = html;
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *intag_name = NULL;
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *intag_startattr = NULL;
      <B><FONT COLOR="#228B22">int</FONT></B> intag_start_valid = 0;
      <B><FONT COLOR="#228B22">int</FONT></B> intag_ctype = 0;

      <I><FONT COLOR="#B22222">//
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> emited_footer = 0;    <I><FONT COLOR="#B22222">// emitted footer comment tag(s) count
</FONT></I>
      <I><FONT COLOR="#B22222">//
</FONT></I>      <B><FONT COLOR="#228B22">int</FONT></B> parent_relative = 0;  <I><FONT COLOR="#B22222">// the parent is the base path (.js, .css..)
</FONT></I>
      lastsaved = html;

      <I><FONT COLOR="#B22222">/* Initialize script automate for comments, quotes.. */</FONT></I>
      memset(inscript_state, 0xff, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(inscript_state));
      inscript_state[INSCRIPT_START][INSCRIPT_DEFAULT] = INSCRIPT_START;        <I><FONT COLOR="#B22222">/* by default, stay in START */</FONT></I>
      inscript_state[INSCRIPT_START][<B><FONT COLOR="#BC8F8F">'\\'</FONT></B>] = INSCRIPT_ANTISLASH;        <I><FONT COLOR="#B22222">/* #1: \ escapes the next character whatever it is */</FONT></I>
      inscript_state[INSCRIPT_ANTISLASH][INSCRIPT_DEFAULT] = INSCRIPT_START;
      inscript_state[INSCRIPT_START][<B><FONT COLOR="#BC8F8F">'\''</FONT></B>] = INSCRIPT_INQUOTE;  <I><FONT COLOR="#B22222">/* #2: ' opens quote and only ' returns to 0 */</FONT></I>
      inscript_state[INSCRIPT_INQUOTE][INSCRIPT_DEFAULT] = INSCRIPT_INQUOTE;
      inscript_state[INSCRIPT_INQUOTE][<B><FONT COLOR="#BC8F8F">'\''</FONT></B>] = INSCRIPT_START;
      inscript_state[INSCRIPT_INQUOTE][<B><FONT COLOR="#BC8F8F">'\\'</FONT></B>] = INSCRIPT_ANTISLASH_IN_QUOTE;
      inscript_state[INSCRIPT_START][<B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>] = INSCRIPT_INQUOTE2; <I><FONT COLOR="#B22222">/* #3: &quot; opens double-quote and only &quot; returns to 0 */</FONT></I>
      inscript_state[INSCRIPT_INQUOTE2][INSCRIPT_DEFAULT] = INSCRIPT_INQUOTE2;
      inscript_state[INSCRIPT_INQUOTE2][<B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>] = INSCRIPT_START;
      inscript_state[INSCRIPT_INQUOTE2][<B><FONT COLOR="#BC8F8F">'\\'</FONT></B>] = INSCRIPT_ANTISLASH_IN_QUOTE2;
      inscript_state[INSCRIPT_START][<B><FONT COLOR="#BC8F8F">'/'</FONT></B>] = INSCRIPT_SLASH;     <I><FONT COLOR="#B22222">/* #4: / state, default to #0 */</FONT></I>
      inscript_state[INSCRIPT_SLASH][INSCRIPT_DEFAULT] = INSCRIPT_START;
      inscript_state[INSCRIPT_SLASH][<B><FONT COLOR="#BC8F8F">'/'</FONT></B>] = INSCRIPT_SLASHSLASH;        <I><FONT COLOR="#B22222">/* #5: // with only LF to escape */</FONT></I>
      inscript_state[INSCRIPT_SLASHSLASH][INSCRIPT_DEFAULT] =
        INSCRIPT_SLASHSLASH;
      inscript_state[INSCRIPT_SLASHSLASH][<B><FONT COLOR="#BC8F8F">'\n'</FONT></B>] = INSCRIPT_START;
      inscript_state[INSCRIPT_SLASH][<B><FONT COLOR="#BC8F8F">'*'</FONT></B>] = INSCRIPT_COMMENT;   <I><FONT COLOR="#B22222">/* #6: / * with only * / to escape */</FONT></I>
      inscript_state[INSCRIPT_COMMENT][INSCRIPT_DEFAULT] = INSCRIPT_COMMENT;
      inscript_state[INSCRIPT_COMMENT][<B><FONT COLOR="#BC8F8F">'*'</FONT></B>] = INSCRIPT_COMMENT2;        <I><FONT COLOR="#B22222">/* #7: closing comments */</FONT></I>
      inscript_state[INSCRIPT_COMMENT2][INSCRIPT_DEFAULT] = INSCRIPT_COMMENT;
      inscript_state[INSCRIPT_COMMENT2][<B><FONT COLOR="#BC8F8F">'/'</FONT></B>] = INSCRIPT_START;
      inscript_state[INSCRIPT_COMMENT2][<B><FONT COLOR="#BC8F8F">'*'</FONT></B>] = INSCRIPT_COMMENT2;
      inscript_state[INSCRIPT_ANTISLASH_IN_QUOTE][INSCRIPT_DEFAULT] = INSCRIPT_INQUOTE; <I><FONT COLOR="#B22222">/* #8: escape in '' */</FONT></I>
      inscript_state[INSCRIPT_ANTISLASH_IN_QUOTE2][INSCRIPT_DEFAULT] = INSCRIPT_INQUOTE2;       <I><FONT COLOR="#B22222">/* #9: escape in &quot;&quot; */</FONT></I>

      <I><FONT COLOR="#B22222">/* Primary list or URLs */</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> (ptr == 0) {
        intag = 1;
        intag_start_valid = 0;
        intag_name = NULL;
      }
      <I><FONT COLOR="#B22222">/* Check is the file is a .js file */</FONT></I>
      <B><FONT COLOR="#A020F0">else</FONT></B>
        <B><FONT COLOR="#A020F0">if</FONT></B> ((compare_mime
             (opt, r-&gt;contenttype, str-&gt;url_file,
              <B><FONT COLOR="#BC8F8F">&quot;application/x-javascript&quot;</FONT></B>) != 0)
            || (compare_mime(opt, r-&gt;contenttype, str-&gt;url_file, <B><FONT COLOR="#BC8F8F">&quot;text/css&quot;</FONT></B>) !=
                0)
        ) {                     <I><FONT COLOR="#B22222">/* JavaScript js file */</FONT></I>
        inscript = 1;
        inscript_locked = 1;    <I><FONT COLOR="#B22222">/* Don't exit js space upon &lt;/script&gt; */</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;parsedebug) {
          HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;&lt;@@ inscript @@&gt;&quot;</FONT></B>);
        }
        inscript_name = <B><FONT COLOR="#BC8F8F">&quot;script&quot;</FONT></B>;
        intag = 1;              <I><FONT COLOR="#B22222">// because après &lt;script&gt; on y est .. - pas utile
</FONT></I>        intag_start_valid = 0;  <I><FONT COLOR="#B22222">// OUI car nous sommes dans du code, plus dans du &quot;vrai&quot; tag
</FONT></I>        hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;note: this file is a javascript file&quot;</FONT></B>);
        <I><FONT COLOR="#B22222">// for javascript only
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (compare_mime
            (opt, r-&gt;contenttype, str-&gt;url_file,
             <B><FONT COLOR="#BC8F8F">&quot;application/x-javascript&quot;</FONT></B>) != 0) {
          <I><FONT COLOR="#B22222">// all links must be checked against parent, not this link
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (heap(ptr)-&gt;precedent != 0) {
            parent_relative = 1;
          }
        }
      }
      <I><FONT COLOR="#B22222">/* Or a real audio */</FONT></I>
      <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (compare_mime(opt, r-&gt;contenttype, str-&gt;url_file, <B><FONT COLOR="#BC8F8F">&quot;audio/x-pn-realaudio&quot;</FONT></B>) != 0) { <I><FONT COLOR="#B22222">/* realaudio link file */</FONT></I>
        inscript = intag = 0;
        inscript_name = <B><FONT COLOR="#BC8F8F">&quot;media&quot;</FONT></B>;
        intag_start_valid = 0;
        in_media = <B><FONT COLOR="#BC8F8F">&quot;LNK&quot;</FONT></B>;       <I><FONT COLOR="#B22222">// real media! -&gt; links
</FONT></I>      }
      <I><FONT COLOR="#B22222">/* Or a m3u playlist */</FONT></I>
      <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (compare_mime(opt, r-&gt;contenttype, str-&gt;url_file, <B><FONT COLOR="#BC8F8F">&quot;audio/x-mpegurl&quot;</FONT></B>) != 0) {      <I><FONT COLOR="#B22222">/* mp3 link file */</FONT></I>
        inscript = intag = 0;
        inscript_name = <B><FONT COLOR="#BC8F8F">&quot;media&quot;</FONT></B>;
        intag_start_valid = 0;
        in_media = <B><FONT COLOR="#BC8F8F">&quot;LNK&quot;</FONT></B>;       <I><FONT COLOR="#B22222">// m3u! -&gt; links
</FONT></I>      } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (compare_mime(opt, r-&gt;contenttype, str-&gt;url_file, <B><FONT COLOR="#BC8F8F">&quot;application/x-authorware-map&quot;</FONT></B>) != 0) {       <I><FONT COLOR="#B22222">/* macromedia aam file */</FONT></I>
        inscript = intag = 0;
        inscript_name = <B><FONT COLOR="#BC8F8F">&quot;media&quot;</FONT></B>;
        intag_start_valid = 0;
        in_media = <B><FONT COLOR="#BC8F8F">&quot;AAM&quot;</FONT></B>;       <I><FONT COLOR="#B22222">// aam
</FONT></I>      }
      <I><FONT COLOR="#B22222">/* Or a RSS file */</FONT></I>
      <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (compare_mime(opt, r-&gt;contenttype, str-&gt;url_file, <B><FONT COLOR="#BC8F8F">&quot;text/xml&quot;</FONT></B>) != 0
               || compare_mime(opt, r-&gt;contenttype, str-&gt;url_file,
                               <B><FONT COLOR="#BC8F8F">&quot;application/xml&quot;</FONT></B>) != 0) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (strstr(html, <B><FONT COLOR="#BC8F8F">&quot;http://purl.org/rss/&quot;</FONT></B>) != NULL)        <I><FONT COLOR="#B22222">// Hmm, this is a bit lame ; will have to cleanup
</FONT></I>        {                       <I><FONT COLOR="#B22222">/* RSS file */</FONT></I>
          inscript = intag = 0;
          intag_start_valid = 0;
          in_media = NULL;      <I><FONT COLOR="#B22222">// regular XML
</FONT></I>        } <B><FONT COLOR="#A020F0">else</FONT></B> {                <I><FONT COLOR="#B22222">// cancel: write all
</FONT></I>          html = r-&gt;adr + r-&gt;size;
          HT_add_adr;
          lastsaved = html;
        }
      }
      <I><FONT COLOR="#B22222">// Detect UTF8 format
</FONT></I>      <I><FONT COLOR="#B22222">//if (is_unicode_utf8(r-&gt;adr, (unsigned int) r-&gt;size) == 1) {
</FONT></I>      <I><FONT COLOR="#B22222">//  no_esc_utf=1;
</FONT></I>      <I><FONT COLOR="#B22222">//} else {
</FONT></I>      <I><FONT COLOR="#B22222">//  no_esc_utf=0;
</FONT></I>      <I><FONT COLOR="#B22222">//}
</FONT></I>
      <I><FONT COLOR="#B22222">// Hack to prevent any problems with ram files of other files
</FONT></I>      *(r-&gt;adr + r-&gt;size) = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

      <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>      <I><FONT COLOR="#B22222">// analyser ce qu'il y a en mémoire (fichier html)
</FONT></I>      <I><FONT COLOR="#B22222">// on scanne les balises
</FONT></I>      <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>      opt-&gt;state._hts_in_html_done = 0; <I><FONT COLOR="#B22222">// 0% scannés
</FONT></I>      opt-&gt;state._hts_in_html_parsing = 1;      <I><FONT COLOR="#B22222">// flag pour indiquer un parsing
</FONT></I>
      base[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;           <I><FONT COLOR="#B22222">// effacer base-href
</FONT></I>      <B><FONT COLOR="#A020F0">do</FONT></B> {
        <B><FONT COLOR="#228B22">int</FONT></B> p = 0;
        <B><FONT COLOR="#228B22">int</FONT></B> valid_p = 0;        <I><FONT COLOR="#B22222">// force to take p even if == 0
</FONT></I>        <B><FONT COLOR="#228B22">int</FONT></B> ending_p = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;    <I><FONT COLOR="#B22222">// ending quote?
</FONT></I>        <B><FONT COLOR="#228B22">int</FONT></B> archivetag_p = 0;   <I><FONT COLOR="#B22222">// avoid multiple-archives with commas
</FONT></I>        <B><FONT COLOR="#228B22">int</FONT></B> unquoted_script = 0;
        INSCRIPT inscript_state_pos_prev = inscript_state_pos;

        error = 0;

        <I><FONT COLOR="#B22222">/* Break if we are done yet */</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> (html - r-&gt;adr &gt;= r-&gt;size)
          <B><FONT COLOR="#A020F0">break</FONT></B>;

        <I><FONT COLOR="#B22222">/*
           index.html built here
         */</FONT></I>
        <I><FONT COLOR="#B22222">// Construction index.html (sommaire)
</FONT></I>        <I><FONT COLOR="#B22222">// Avant de tester les a href,
</FONT></I>        <I><FONT COLOR="#B22222">// Ici on teste si l'on doit construire l'index vers le(s) site(s) miroir(s)
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (!makeindex_done) {  <I><FONT COLOR="#B22222">// autoriation d'écrire un index
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (!detect_title) {
            <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;depth == heap(ptr)-&gt;depth) {      <I><FONT COLOR="#B22222">// on note toujours les premiers liens
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (!in_media) {
                <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;makeindex &amp;&amp; (ptr &gt; 0)) {
                  <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;getmode &amp; 1) {       <I><FONT COLOR="#B22222">// autorisation d'écrire
</FONT></I>                    p = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;title&quot;</FONT></B>);
                    <B><FONT COLOR="#A020F0">if</FONT></B> (p) {
                      <B><FONT COLOR="#A020F0">if</FONT></B> (*(html - 1) == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                        p = 0;  <I><FONT COLOR="#B22222">// /title
</FONT></I>                    } <B><FONT COLOR="#A020F0">else</FONT></B> {
                      <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(html, <B><FONT COLOR="#BC8F8F">&quot;/html&quot;</FONT></B>))
                        p = -1; <I><FONT COLOR="#B22222">// noter, mais sans titre
</FONT></I>                      <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(html, <B><FONT COLOR="#BC8F8F">&quot;body&quot;</FONT></B>))
                        p = -1; <I><FONT COLOR="#B22222">// noter, mais sans titre
</FONT></I>                      <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (html - r-&gt;adr &gt;= r-&gt;size - 1)
                        p = -1; <I><FONT COLOR="#B22222">// noter, mais sans titre
</FONT></I>                      <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (html - r-&gt;adr &gt;= r-&gt;size - 2)     <I><FONT COLOR="#B22222">// we got to hurry
</FONT></I>                        p = -1; <I><FONT COLOR="#B22222">// xxc xxc xxc
</FONT></I>                    }
                  } <B><FONT COLOR="#A020F0">else</FONT></B>
                    p = 0;

                  <B><FONT COLOR="#A020F0">if</FONT></B> (p) {      <I><FONT COLOR="#B22222">// ok center                            
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (makeindex_fp == NULL) {
                      file_notify(opt, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>,
                                  fconcat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), 
                                          StringBuff(opt-&gt;path_html_utf8),
                                          <B><FONT COLOR="#BC8F8F">&quot;index.html&quot;</FONT></B>), 1, 1, 0);
                      verif_backblue(opt, StringBuff(opt-&gt;path_html_utf8));     <I><FONT COLOR="#B22222">// générer gif
</FONT></I>                      makeindex_fp =
                        filecreate(&amp;opt-&gt;state.strc,
                                   fconcat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), 
                                           StringBuff(opt-&gt;path_html_utf8),
                                           <B><FONT COLOR="#BC8F8F">&quot;index.html&quot;</FONT></B>));
                      <B><FONT COLOR="#A020F0">if</FONT></B> (makeindex_fp != NULL) {

                        <I><FONT COLOR="#B22222">// Header
</FONT></I>                        hts_template_format(makeindex_fp, template_header,
                                <B><FONT COLOR="#BC8F8F">&quot;&lt;!-- Mirror and index made by HTTrack Website Copier/&quot;</FONT></B>
                                HTTRACK_VERSION <B><FONT COLOR="#BC8F8F">&quot; &quot;</FONT></B> HTTRACK_AFF_AUTHORS <B><FONT COLOR="#BC8F8F">&quot; --&gt;&quot;</FONT></B>, <I><FONT COLOR="#B22222">/* EOF */</FONT></I> NULL);

                      } <B><FONT COLOR="#A020F0">else</FONT></B>
                        makeindex_done = -1;    <I><FONT COLOR="#B22222">// fait, erreur
</FONT></I>                    }

                    <B><FONT COLOR="#A020F0">if</FONT></B> (makeindex_fp != NULL) {
                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];
                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK s[HTS_URLMAXSIZE * 2];
                      <B><FONT COLOR="#228B22">char</FONT></B> *a = NULL;
                      <B><FONT COLOR="#228B22">char</FONT></B> *b = NULL;

                      s[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                      <B><FONT COLOR="#A020F0">if</FONT></B> (p &gt; 0) {
                        a = strchr(html, <B><FONT COLOR="#BC8F8F">'&gt;'</FONT></B>);
                        <B><FONT COLOR="#A020F0">if</FONT></B> (a != NULL) {
                          a++;
                          <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
                            a++;        <I><FONT COLOR="#B22222">// sauter espaces &amp; co
</FONT></I>                          b = strchr(a, <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>);   <I><FONT COLOR="#B22222">// prochain tag
</FONT></I>                        }
                      }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (lienrelatif
                          (tempo, heap(ptr)-&gt;sav,
                           concat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
                                  StringBuff(opt-&gt;path_html_utf8),
                                  <B><FONT COLOR="#BC8F8F">&quot;index.html&quot;</FONT></B>)) == 0) {
                        detect_title = 1;       <I><FONT COLOR="#B22222">// ok détecté pour cette page!
</FONT></I>                        makeindex_links++;      <I><FONT COLOR="#B22222">// un de plus
</FONT></I>                        strcpybuff(makeindex_firstlink, tempo);
                        <I><FONT COLOR="#B22222">//
</FONT></I>
                        <I><FONT COLOR="#B22222">/* Hack */</FONT></I>
                        <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;mimehtml) {
                          strcpybuff(makeindex_firstlink,
                                     <B><FONT COLOR="#BC8F8F">&quot;cid:primary/primary&quot;</FONT></B>);
                        }

                        <B><FONT COLOR="#A020F0">if</FONT></B> ((b == a) || (a == NULL) || (b == NULL)) {   <I><FONT COLOR="#B22222">// pas de titre
</FONT></I>                          strcpybuff(s, tempo);
                        } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((b - a) &lt; 256) {
                          b--;
                          <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*b))
                            b--;
                          strncpy(s, a, b - a + 1);
                          *(s + (b - a) + 1) = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                        }

                        <I><FONT COLOR="#B22222">// Decode title with encoding
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> (str-&gt;page_charset_ != NULL 
                            &amp;&amp; *str-&gt;page_charset_ != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
                          <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> sUtf = 
                            hts_convertStringToUTF8(s, strlen(s), str-&gt;page_charset_);
                          <B><FONT COLOR="#A020F0">if</FONT></B> (sUtf != NULL) {
                            strcpy(s, sUtf);
                            free(sUtf);
                          }
                        }

                        <I><FONT COLOR="#B22222">// Body
</FONT></I>                        inplace_escape_uri_utf(tempo, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(tempo));
                        hts_template_format(makeindex_fp, template_body, tempo, s, <I><FONT COLOR="#B22222">/* EOF */</FONT></I> NULL);
                      }
                    }
                  }
                }
              }

            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (heap(ptr)-&gt;depth &lt; opt-&gt;depth) {        <I><FONT COLOR="#B22222">// on a sauté level1+1 et level1
</FONT></I>              HT_INDEX_END;
            }
          }                     <I><FONT COLOR="#B22222">// if (opt-&gt;makeindex)
</FONT></I>        }
        <I><FONT COLOR="#B22222">// FIN Construction index.html (sommaire)
</FONT></I>        <I><FONT COLOR="#B22222">/*
           end -- index.html built here
         */</FONT></I>

        <I><FONT COLOR="#B22222">/* Parse */</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> ((*html == <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>)       <I><FONT COLOR="#B22222">/* No starting tag */</FONT></I>
            &amp;&amp;(!inscript)       <I><FONT COLOR="#B22222">/* Not in (java)script */</FONT></I>
            &amp;&amp;(!incomment)      <I><FONT COLOR="#B22222">/* Not in comment (&lt;!--) */</FONT></I>
            &amp;&amp;(!in_media)       <I><FONT COLOR="#B22222">/* Not in media */</FONT></I>
          ) {
          intag = 1;
          intag_ctype = 0;
          <I><FONT COLOR="#B22222">//parseall_incomment=0;
</FONT></I>          <I><FONT COLOR="#B22222">//inquote=0;  // effacer quote
</FONT></I>          intag_start = html;
          <B><FONT COLOR="#A020F0">for</FONT></B>(intag_name = html + 1; is_realspace(*intag_name); intag_name++) ;
          intag_start_valid = 1;
          codebase[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;   <I><FONT COLOR="#B22222">// effacer éventuel codebase
</FONT></I>
          <I><FONT COLOR="#B22222">/* Meta ? */</FONT></I>
          <B><FONT COLOR="#A020F0">if</FONT></B> (check_tag(intag_start, <B><FONT COLOR="#BC8F8F">&quot;meta&quot;</FONT></B>)) {
            <B><FONT COLOR="#228B22">int</FONT></B> pos;

            <I><FONT COLOR="#B22222">// &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> ((pos = rech_tageq_all(html, <B><FONT COLOR="#BC8F8F">&quot;http-equiv&quot;</FONT></B>))) {
              <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *token = NULL;
              <B><FONT COLOR="#228B22">int</FONT></B> len = rech_endtoken(html + pos, &amp;token);

              <B><FONT COLOR="#A020F0">if</FONT></B> (len &gt; 0) {
                <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(token, <B><FONT COLOR="#BC8F8F">&quot;content-type&quot;</FONT></B>)) {
                  intag_ctype = 1;
                  <I><FONT COLOR="#B22222">//NOPE-we do not convert the whole page actually
</FONT></I>                  <I><FONT COLOR="#B22222">//intag_start[1] = 'X';
</FONT></I>                } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(token, <B><FONT COLOR="#BC8F8F">&quot;refresh&quot;</FONT></B>)) {
                  intag_ctype = 2;
                }
              }
            }
          }

          <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;getmode &amp; 1) {       <I><FONT COLOR="#B22222">// sauver html
</FONT></I>            p = 0;
            <B><FONT COLOR="#A020F0">switch</FONT></B> (emited_footer) {
            <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">0</FONT></B>:
              <I><FONT COLOR="#B22222">// We are looking for the first head so that we can declare the HTTP-headers charset early
</FONT></I>              <I><FONT COLOR="#B22222">// Emit as soon as we see the first &lt;head&gt;, &lt;meta&gt;, or &lt;body&gt; tag.
</FONT></I>              <I><FONT COLOR="#B22222">// FIXME: we currently emit the tag BEFORE the &lt;head&gt; tag, actually, which is not clean
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;&lt;head&gt;&quot;</FONT></B>)) != 0
                  || ((p = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;&lt;head&quot;</FONT></B>)) != 0 &amp;&amp; isspace(html[p]))
                  || (p = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;&lt;body&gt;&quot;</FONT></B>)) != 0
                  || ((p = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;&lt;body&quot;</FONT></B>)) != 0 &amp;&amp; isspace(html[p]))
                  || ((p = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;&lt;meta&quot;</FONT></B>)) != 0 &amp;&amp; isspace(html[p]))
                ) {
                emited_footer++;
              } <B><FONT COLOR="#A020F0">else</FONT></B> {
                p = 0;
              }
              <B><FONT COLOR="#A020F0">break</FONT></B>;
            <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">1</FONT></B>:
              <I><FONT COLOR="#B22222">// And the closing comment info tag
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;&lt;/html&quot;</FONT></B>) != 0)) {
                emited_footer++;
              } <B><FONT COLOR="#A020F0">else</FONT></B> {
                p = 0;
              }
              <B><FONT COLOR="#A020F0">break</FONT></B>;
            <B><FONT COLOR="#5F9EA0">default</FONT></B>:
              p = 0;
              <B><FONT COLOR="#A020F0">break</FONT></B>;
            }

            <B><FONT COLOR="#A020F0">if</FONT></B> (p != 0) {
              <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *eol = <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>;

              <B><FONT COLOR="#A020F0">if</FONT></B> (strchr(r-&gt;adr, <B><FONT COLOR="#BC8F8F">'\r'</FONT></B>))
                eol = <B><FONT COLOR="#BC8F8F">&quot;\r\n&quot;</FONT></B>;
              <B><FONT COLOR="#A020F0">if</FONT></B> (StringNotEmpty(opt-&gt;footer) || opt-&gt;urlmode != 4) {   <I><FONT COLOR="#B22222">/* != preserve */</FONT></I>
                <B><FONT COLOR="#A020F0">if</FONT></B> (StringNotEmpty(opt-&gt;footer)) {
                  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[1024 + HTS_URLMAXSIZE * 2];
                  <B><FONT COLOR="#228B22">char</FONT></B> gmttime[256];

                  tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                  time_gmt_rfc822(gmttime);
                  strcatbuff(tempo, eol);
                  hts_template_format_str(tempo + strlen(tempo), <B><FONT COLOR="#A020F0">sizeof</FONT></B>(tempo) - strlen(tempo),
                          StringBuff(opt-&gt;footer),
                          jump_identification_const(urladr()), urlfil(), gmttime,
                          HTTRACK_VERSIONID, <I><FONT COLOR="#B22222">/* EOF */</FONT></I> NULL);
                  strcatbuff(tempo, eol);
                  <I><FONT COLOR="#B22222">//fwrite(tempo,1,strlen(tempo),fp);
</FONT></I>                  HT_ADD(tempo);
                }
                <I><FONT COLOR="#B22222">// Emit charset ?
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (emited_footer == 1 &amp;&amp; strnotempty(r-&gt;charset)) {
                  HT_ADD
                    (<B><FONT COLOR="#BC8F8F">&quot;&lt;!-- Added by HTTrack --&gt;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html;charset=&quot;</FONT></B>);
                  HT_ADD(r-&gt;charset);
                  HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;\&quot; /&gt;&lt;!-- /Added by HTTrack --&gt;&quot;</FONT></B>);
                  HT_ADD(eol);
                }
              }
            }
          }
          <I><FONT COLOR="#B22222">// éliminer les &lt;!-- (commentaires) : intag dévalidé
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (*(html + 1) == <B><FONT COLOR="#BC8F8F">'!'</FONT></B>)
            <B><FONT COLOR="#A020F0">if</FONT></B> (*(html + 2) == <B><FONT COLOR="#BC8F8F">'-'</FONT></B>)
              <B><FONT COLOR="#A020F0">if</FONT></B> (*(html + 3) == <B><FONT COLOR="#BC8F8F">'-'</FONT></B>) {
                intag = 0;
                incomment = 1;
                intag_start_valid = 0;
              }

        } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((*html == <B><FONT COLOR="#BC8F8F">'&gt;'</FONT></B>)        <I><FONT COLOR="#B22222">/* ending tag */</FONT></I>
                   &amp;&amp;((!inscript &amp;&amp; !in_media) || (inscript_tag))       <I><FONT COLOR="#B22222">/* and in tag (or in script) */</FONT></I>
          ) {
          <B><FONT COLOR="#A020F0">if</FONT></B> (inscript_tag) {
            inscript_tag = inscript = 0;
            intag = 0;
            incomment = 0;
            intag_start_valid = 0;
            intag_name = NULL;
            <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;parsedebug) {
              HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;&lt;@@ /inscript @@&gt;&quot;</FONT></B>);
            }
          } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (!incomment) {
            intag = 0;          <I><FONT COLOR="#B22222">//inquote=0;
</FONT></I>
            <I><FONT COLOR="#B22222">// entrée dans du javascript?
</FONT></I>            <I><FONT COLOR="#B22222">// on parse ICI car il se peut qu'on ait eu a parser les src=.. dedans
</FONT></I>            <I><FONT COLOR="#B22222">//if (!inscript) {  // sinon on est dans un obj.write(&quot;..
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> ((intag_start_valid) &amp;&amp; (check_tag(intag_start, <B><FONT COLOR="#BC8F8F">&quot;script&quot;</FONT></B>)
                                        || check_tag(intag_start, <B><FONT COLOR="#BC8F8F">&quot;style&quot;</FONT></B>)
                )
              ) {
              <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = intag_start;    <I><FONT COLOR="#B22222">// &lt;
</FONT></I>
              <I><FONT COLOR="#B22222">// ** while(is_realspace(*(--a)));
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>) {  <I><FONT COLOR="#B22222">// sûr que c'est un tag?
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (check_tag(intag_start, <B><FONT COLOR="#BC8F8F">&quot;script&quot;</FONT></B>))
                  inscript_name = <B><FONT COLOR="#BC8F8F">&quot;script&quot;</FONT></B>;
                <B><FONT COLOR="#A020F0">else</FONT></B>
                  inscript_name = <B><FONT COLOR="#BC8F8F">&quot;style&quot;</FONT></B>;
                inscript = 1;
                inscript_state_pos = INSCRIPT_START;
                intag = 1;      <I><FONT COLOR="#B22222">// because après &lt;script&gt; on y est .. - pas utile
</FONT></I>                intag_start_valid = 0;  <I><FONT COLOR="#B22222">// OUI car nous sommes dans du code, plus dans du &quot;vrai&quot; tag
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;parsedebug) {
                  HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;&lt;@@ inscript @@&gt;&quot;</FONT></B>);
                }
              }
            }
          } <B><FONT COLOR="#A020F0">else</FONT></B> {              <I><FONT COLOR="#B22222">/* end of comment? */</FONT></I>
            <I><FONT COLOR="#B22222">// vérifier fermeture correcte
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> ((*(html - 1) == <B><FONT COLOR="#BC8F8F">'-'</FONT></B>) &amp;&amp; (*(html - 2) == <B><FONT COLOR="#BC8F8F">'-'</FONT></B>)) {
              intag = 0;
              incomment = 0;
              intag_start_valid = 0;
              intag_name = NULL;
            }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">GT_ENDS_COMMENT</FONT>
            <I><FONT COLOR="#B22222">/* wrong comment ending */</FONT></I>
            <B><FONT COLOR="#A020F0">else</FONT></B> {
              <I><FONT COLOR="#B22222">/* check if correct ending does not exists
                 &lt;!-- foo &gt; example &lt;!-- bar &gt; is sometimes accepted by browsers
                 when no --&gt; is used somewhere else.. darn those browsers are dirty
               */</FONT></I>
              <B><FONT COLOR="#A020F0">if</FONT></B> (!strstr(html, <B><FONT COLOR="#BC8F8F">&quot;--&gt;&quot;</FONT></B>)) {
                intag = 0;
                incomment = 0;
                intag_start_valid = 0;
                intag_name = NULL;
              }
            }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
          }
          <I><FONT COLOR="#B22222">//}
</FONT></I>        }
        <I><FONT COLOR="#B22222">//else if (*adr==34) {
</FONT></I>        <I><FONT COLOR="#B22222">//  inquote=(inquote?0:1);
</FONT></I>        <I><FONT COLOR="#B22222">//}
</FONT></I>        <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (intag || inscript || in_media) {       <I><FONT COLOR="#B22222">// nous sommes dans un tag/commentaire, tester si on recoit un tag
</FONT></I>          <B><FONT COLOR="#228B22">int</FONT></B> p_type = 0;
          <B><FONT COLOR="#228B22">int</FONT></B> p_nocatch = 0;
          <B><FONT COLOR="#228B22">int</FONT></B> p_searchMETAURL = 0;      <I><FONT COLOR="#B22222">// chercher ..URL=&lt;url&gt;
</FONT></I>          <B><FONT COLOR="#228B22">int</FONT></B> add_class = 0;    <I><FONT COLOR="#B22222">// ajouter .class
</FONT></I>          <B><FONT COLOR="#228B22">int</FONT></B> add_class_dots_to_patch = 0;      <I><FONT COLOR="#B22222">// number of '.' in code=&quot;x.y.z&lt;realname&gt;&quot;
</FONT></I>          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *p_flush = NULL;

          <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>          <I><FONT COLOR="#B22222">// parsing évolé
</FONT></I>          <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (((isalpha((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) *html)) || (*html == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) || (inscript) || (in_media) || (inscriptgen))) {        <I><FONT COLOR="#B22222">// sinon pas la peine de tester..
</FONT></I>
            <I><FONT COLOR="#B22222">/* caractère de terminaison pour &quot;miniparsing&quot; javascript=.. ? 
               (ex: &lt;a href=&quot;javascript:()&quot; action=&quot;foo&quot;&gt; ) */</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (inscript_tag) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (inscript_tag_lastc) {
                <B><FONT COLOR="#A020F0">if</FONT></B> (*html == inscript_tag_lastc) {
                  <I><FONT COLOR="#B22222">/* sortir */</FONT></I>
                  inscript_tag = inscript = 0;
                  incomment = 0;
                  <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;parsedebug) {
                    HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;&lt;@@ /inscript @@&gt;&quot;</FONT></B>);
                  }
                }
              }
            }

            <I><FONT COLOR="#B22222">/* automate */</FONT></I>
            AUTOMATE_LOOKUP_CURRENT_ADR();

            <I><FONT COLOR="#B22222">// Note:
</FONT></I>            <I><FONT COLOR="#B22222">// Certaines pages ne respectent pas le html
</FONT></I>            <I><FONT COLOR="#B22222">// notamment les guillements ne sont pas fixés
</FONT></I>            <I><FONT COLOR="#B22222">// Nous sommes dans un tag, donc on peut faire un test plus
</FONT></I>            <I><FONT COLOR="#B22222">// large pour pouvoi prendre en compte ces particularités
</FONT></I>
            <I><FONT COLOR="#B22222">// à vérifier: ACTION, CODEBASE, VRML
</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (in_media) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(in_media, <B><FONT COLOR="#BC8F8F">&quot;LNK&quot;</FONT></B>) == 0) {       <I><FONT COLOR="#B22222">// real media
</FONT></I>                p = 0;
                valid_p = 1;
              } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(in_media, <B><FONT COLOR="#BC8F8F">&quot;AAM&quot;</FONT></B>) == 0) {        <I><FONT COLOR="#B22222">// AAM
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (is_space((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) html[0])
                    &amp;&amp; !is_space((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) html[1])) {
                  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = html + 1;
                  <B><FONT COLOR="#228B22">int</FONT></B> n = 0;
                  <B><FONT COLOR="#228B22">int</FONT></B> ok = 0;
                  <B><FONT COLOR="#228B22">int</FONT></B> dot = 0;

                  <B><FONT COLOR="#A020F0">while</FONT></B>(n &lt; HTS_URLMAXSIZE / 2 &amp;&amp; a[n] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>
                        &amp;&amp; (!is_space((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) a[n]) || !(ok = 1))
                    ) {
                    <B><FONT COLOR="#A020F0">if</FONT></B> (a[n] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B>) {
                      dot = n;
                    }
                    n++;
                  }
                  <B><FONT COLOR="#A020F0">if</FONT></B> (ok &amp;&amp; dot &gt; 0) {
                    <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tmp[HTS_URLMAXSIZE / 2 + 2];

                    tmp[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                    strncat(tmp, a + dot + 1, n - dot - 1);
                    <B><FONT COLOR="#A020F0">if</FONT></B> (is_knowntype(opt, tmp) || ishtml_ext(tmp) != -1) {
                      html++;
                      p = 0;
                      valid_p = 1;
                      unquoted_script = 1;
                    }
                  }
                }
              }
            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (ptr &gt; 0) {       <I><FONT COLOR="#B22222">/* pas première page 0 (primary) */</FONT></I>
              p = 0;            <I><FONT COLOR="#B22222">// saut pour le nom de fichier: adresse nom fichier=adr+p
</FONT></I>
              <I><FONT COLOR="#B22222">// ------------------------------
</FONT></I>              <I><FONT COLOR="#B22222">// détection d'écriture JavaScript.
</FONT></I>              <I><FONT COLOR="#B22222">// osons les obj.write et les obj.href=.. ! osons!
</FONT></I>              <I><FONT COLOR="#B22222">// note: inscript==1 donc on sautera après les \&quot;
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (inscript) {
                <B><FONT COLOR="#A020F0">if</FONT></B> (inscriptgen) {      <I><FONT COLOR="#B22222">// on est déja dans un objet générant..
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (*html == scriptgen_q) {    <I><FONT COLOR="#B22222">// fermeture des &quot; ou '
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (*(html - 1) != <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>) {   <I><FONT COLOR="#B22222">// non
</FONT></I>                      inscriptgen = 0;  <I><FONT COLOR="#B22222">// ok parsing terminé
</FONT></I>                    }
                  }
                } <B><FONT COLOR="#A020F0">else</FONT></B> {
                  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = NULL;
                  <B><FONT COLOR="#228B22">char</FONT></B> check_this_fking_line = 0;       <I><FONT COLOR="#B22222">// parsing code javascript..
</FONT></I>                  <B><FONT COLOR="#228B22">char</FONT></B> must_be_terminated = 0;  <I><FONT COLOR="#B22222">// caractère obligatoire de terminaison!
</FONT></I>                  <B><FONT COLOR="#228B22">int</FONT></B> token_size;

                  <B><FONT COLOR="#A020F0">if</FONT></B> (!(token_size = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;.writeln&quot;</FONT></B>)))        <I><FONT COLOR="#B22222">// détection ...objet.write[ln](&quot;code html&quot;)...
</FONT></I>                    token_size = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;.write&quot;</FONT></B>);
                  <B><FONT COLOR="#A020F0">if</FONT></B> (token_size) {
                    a = html + token_size;
                    <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*a))
                      a++;      <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'('</FONT></B>) {    <I><FONT COLOR="#B22222">// début parenthèse
</FONT></I>                      check_this_fking_line = 2;        <I><FONT COLOR="#B22222">// à parser!
</FONT></I>                      must_be_terminated = <B><FONT COLOR="#BC8F8F">')'</FONT></B>;
                      a++;      <I><FONT COLOR="#B22222">// sauter (
</FONT></I>                    }
                  }
                  <I><FONT COLOR="#B22222">// euhh ??? ???
</FONT></I>                  <I><FONT COLOR="#B22222">/* else if (strfield(adr,&quot;.href&quot;)) {  // détection ...objet.href=&quot;...
                     a=adr+5;
                     while(is_realspace(*a)) a++; // sauter espaces
                     if (*a=='=') {  // ohh un égal
                     check_this_fking_line=1;  // à noter!
                     must_be_terminated=';';   // et si t'as oublié le ; tu sais pas coder
                     a++;   // sauter =
                     }

                     } */</FONT></I>

                  <I><FONT COLOR="#B22222">// on a un truc du genre instruction&quot;code généré&quot; dont on parse le code
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (check_this_fking_line) {
                    <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*a))
                      a++;
                    <B><FONT COLOR="#A020F0">if</FONT></B> ((*a == <B><FONT COLOR="#BC8F8F">'\''</FONT></B>) || (*a == <B><FONT COLOR="#BC8F8F">'&quot;'</FONT></B>)) {  <I><FONT COLOR="#B22222">// départ de '' ou &quot;&quot;
</FONT></I>                      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *b;

                      scriptgen_q = *a; <I><FONT COLOR="#B22222">// quote
</FONT></I>                      b = a + 1;        <I><FONT COLOR="#B22222">// départ de la chaîne
</FONT></I>                      <I><FONT COLOR="#B22222">// vérifier forme (&quot;code&quot;) et pas (&quot;code&quot;+var), ingérable
</FONT></I>                      <B><FONT COLOR="#A020F0">do</FONT></B> {
                        <B><FONT COLOR="#A020F0">if</FONT></B> (*a == scriptgen_q &amp;&amp; *(a - 1) != <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>)      <I><FONT COLOR="#B22222">// quote non slash
</FONT></I>                          <B><FONT COLOR="#A020F0">break</FONT></B>;        <I><FONT COLOR="#B22222">// sortie
</FONT></I>                        <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (*a == 10 &amp;&amp; *(a - 1) != <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>   <I><FONT COLOR="#B22222">/* LF and no continue (\) character */</FONT></I>
                                 &amp;&amp; (*(a - 1) != <B><FONT COLOR="#BC8F8F">'\r'</FONT></B> || *(a - 2) != <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>))     <I><FONT COLOR="#B22222">/* and not CRLF and no .. */</FONT></I>
                          <B><FONT COLOR="#A020F0">break</FONT></B>;
                        <B><FONT COLOR="#A020F0">else</FONT></B>
                          a++;  <I><FONT COLOR="#B22222">// caractère suivant
</FONT></I>                      } <B><FONT COLOR="#A020F0">while</FONT></B>((a - b) &lt; HTS_URLMAXSIZE / 2);
                      <B><FONT COLOR="#A020F0">if</FONT></B> (*a == scriptgen_q) {  <I><FONT COLOR="#B22222">// fin du quote
</FONT></I>                        a++;
                        <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*a))
                          a++;
                        <B><FONT COLOR="#A020F0">if</FONT></B> (*a == must_be_terminated) { <I><FONT COLOR="#B22222">// parenthèse fermante: (&quot;..&quot;)
</FONT></I>
                          <I><FONT COLOR="#B22222">// bon, on doit parser une ligne javascript
</FONT></I>                          <I><FONT COLOR="#B22222">// 1) si check.. ==1 alors c'est un nom de fichier direct, donc
</FONT></I>                          <I><FONT COLOR="#B22222">// on fixe p sur le saut nécessaire pour atteindre le nom du fichier
</FONT></I>                          <I><FONT COLOR="#B22222">// et le moteur se débrouillera ensuite tout seul comme un grand
</FONT></I>                          <I><FONT COLOR="#B22222">// 2) si check==2 c'est un peu plus tordu car là on génére du
</FONT></I>                          <I><FONT COLOR="#B22222">// code html au sein de code javascript au sein de code html
</FONT></I>                          <I><FONT COLOR="#B22222">// dans ce cas on doit fixer un flag à un puis ensuite dans la boucle
</FONT></I>                          <I><FONT COLOR="#B22222">// on devra parser les instructions standard comme &lt;a href etc
</FONT></I>                          <I><FONT COLOR="#B22222">// NOTE: le code javascript autogénéré n'est pas pris en compte!!
</FONT></I>                          <I><FONT COLOR="#B22222">// (et ne marche pas dans 50% des cas de toute facon!)
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (check_this_fking_line == 1) {
                            p = (<B><FONT COLOR="#228B22">int</FONT></B>) (b - html);        <I><FONT COLOR="#B22222">// calculer saut!
</FONT></I>                          } <B><FONT COLOR="#A020F0">else</FONT></B> {
                            inscriptgen = 1;    <I><FONT COLOR="#B22222">// SCRIPTGEN actif
</FONT></I>                            html = b;    <I><FONT COLOR="#B22222">// jump
</FONT></I>                          }

                          <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;debug &gt; 1) &amp;&amp; (opt-&gt;log != NULL)) {
                            <B><FONT COLOR="#228B22">char</FONT></B> str[512];

                            str[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            strncatbuff(str, b, minimum((<B><FONT COLOR="#228B22">int</FONT></B>) (a - b + 1), 32));
                            hts_log_print(opt, LOG_DEBUG,
                                          <B><FONT COLOR="#BC8F8F">&quot;active code (%s) detected in javascript: %s&quot;</FONT></B>,
                                          (check_this_fking_line ==
                                           2) ? <B><FONT COLOR="#BC8F8F">&quot;parse&quot;</FONT></B> : <B><FONT COLOR="#BC8F8F">&quot;pickup&quot;</FONT></B>, str);
                          }
                        }

                      }

                    }

                  }
                }
              }
              <I><FONT COLOR="#B22222">// fin detection code générant javascript vers html
</FONT></I>              <I><FONT COLOR="#B22222">// ------------------------------
</FONT></I>
              <I><FONT COLOR="#B22222">// analyse proprement dite, A HREF=.. etc..
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (!p) {
                <I><FONT COLOR="#B22222">// si dans un tag, et pas dans un script - sauf si on analyse un obj.write(&quot;..
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> ((intag &amp;&amp; (!inscript)) || inscriptgen) {
                  <B><FONT COLOR="#A020F0">if</FONT></B> ((*(html - 1) == <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>) || (is_space(*(html - 1)))) {  <I><FONT COLOR="#B22222">// &lt;tag &lt; tag etc
</FONT></I>                    <I><FONT COLOR="#B22222">// &lt;A HREF=.. pour les liens HTML
</FONT></I>                    p = rech_tageq(html, <B><FONT COLOR="#BC8F8F">&quot;href&quot;</FONT></B>);
                    <B><FONT COLOR="#A020F0">if</FONT></B> (p) {    <I><FONT COLOR="#B22222">// href.. tester si c'est une bas href!
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> ((intag_start_valid) &amp;&amp; check_tag(intag_start, <B><FONT COLOR="#BC8F8F">&quot;base&quot;</FONT></B>)) {      <I><FONT COLOR="#B22222">// oui!
</FONT></I>                        <I><FONT COLOR="#B22222">// ** note: base href et codebase ne font pas bon ménage..
</FONT></I>                        p_type = 2;     <I><FONT COLOR="#B22222">// c'est un chemin
</FONT></I>                      }
                    }

                    <I><FONT COLOR="#B22222">/* Tags supplémentaires à vérifier (&lt;img src=..&gt; etc) */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0) {
                      <B><FONT COLOR="#228B22">int</FONT></B> i = 0;

                      <B><FONT COLOR="#A020F0">while</FONT></B>((p == 0) &amp;&amp; (strnotempty(hts_detect[i]))) {
                        p = rech_tageq(html, hts_detect[i]);
                        <B><FONT COLOR="#A020F0">if</FONT></B> (p) {
                          <I><FONT COLOR="#B22222">/* This is a temporary hack to avoid archive=foo.jar,bar.jar .. */</FONT></I>
                          <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(hts_detect[i], <B><FONT COLOR="#BC8F8F">&quot;archive&quot;</FONT></B>) == 0) {
                            archivetag_p = 1;
                          }
                        }
                        i++;
                      }
                    }

                    <I><FONT COLOR="#B22222">/* Tags supplémentaires en début à vérifier (&lt;object .. hotspot1=..&gt; etc) */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0) {
                      <B><FONT COLOR="#228B22">int</FONT></B> i = 0;

                      <B><FONT COLOR="#A020F0">while</FONT></B>((p == 0) &amp;&amp; (strnotempty(hts_detectbeg[i]))) {
                        p = rech_tageqbegdigits(html, hts_detectbeg[i]);
                        i++;
                      }
                    }

                    <I><FONT COLOR="#B22222">/* Tags supplémentaires à vérifier : URL=.. */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0) {
                      <B><FONT COLOR="#228B22">int</FONT></B> i = 0;

                      <B><FONT COLOR="#A020F0">while</FONT></B>((p == 0) &amp;&amp; (strnotempty(hts_detectURL[i]))) {
                        p = rech_tageq(html, hts_detectURL[i]);
                        i++;
                      }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (p) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> (intag_ctype == 1) {
                          p = 0;
#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
                          <I><FONT COLOR="#B22222">//if ((pos=rech_tageq(html, &quot;content&quot;))) {
</FONT></I>                          <B><FONT COLOR="#228B22">char</FONT></B> temp[256];
                          <B><FONT COLOR="#228B22">char</FONT></B> *token = NULL;
                          <B><FONT COLOR="#228B22">int</FONT></B> len = rech_endtoken(html + pos, &amp;token);

                          <B><FONT COLOR="#A020F0">if</FONT></B> (len &gt; 0 &amp;&amp; len &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(temp) - 2) {
                            <B><FONT COLOR="#228B22">char</FONT></B> *chpos;

                            temp[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            strncat(temp, token, len);
                            <B><FONT COLOR="#A020F0">if</FONT></B> ((chpos = strstr(temp, <B><FONT COLOR="#BC8F8F">&quot;charset&quot;</FONT></B>))
                                &amp;&amp; (chpos = strchr(chpos, <B><FONT COLOR="#BC8F8F">'='</FONT></B>))
                              ) {
                              chpos++;
                              <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*chpos))
                                chpod++;
                              <I><FONT COLOR="#B22222">//chpos
</FONT></I>                            }
                          }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                        }
                        <I><FONT COLOR="#B22222">// &lt;META HTTP-EQUIV=&quot;Refresh&quot; CONTENT=&quot;3;URL=http://www.example.com&quot;&gt;
</FONT></I>                        <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (intag_ctype == 2) {
                          p_searchMETAURL = 1;
                        } <B><FONT COLOR="#A020F0">else</FONT></B> {
                          p = 0;        <I><FONT COLOR="#B22222">/* cancel */</FONT></I>
                        }
                      }

                    }

                    <I><FONT COLOR="#B22222">/* Tags supplémentaires à vérifier, mais à ne pas capturer */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0) {
                      <B><FONT COLOR="#228B22">int</FONT></B> i = 0;

                      <B><FONT COLOR="#A020F0">while</FONT></B>((p == 0) &amp;&amp; (strnotempty(hts_detectandleave[i]))) {
                        p = rech_tageq(html, hts_detectandleave[i]);
                        i++;
                      }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (p)
                        p_nocatch = 1;  <I><FONT COLOR="#B22222">/* ne pas rechercher */</FONT></I>
                    }

                    <I><FONT COLOR="#B22222">/* Evénements */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0 &amp;&amp; !inscript     <I><FONT COLOR="#B22222">/* we don't want events inside document.write */</FONT></I>
                      ) {
                      <B><FONT COLOR="#228B22">int</FONT></B> i = 0;

                      <I><FONT COLOR="#B22222">/* détection onLoad etc */</FONT></I>
                      <B><FONT COLOR="#A020F0">while</FONT></B>((p == 0) &amp;&amp; (strnotempty(hts_detect_js[i]))) {
                        p = rech_tageq(html, hts_detect_js[i]);
                        i++;
                      }
                      <I><FONT COLOR="#B22222">/* non détecté - détecter également les onXxxxx= */</FONT></I>
                      <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((*html == <B><FONT COLOR="#BC8F8F">'o'</FONT></B>) &amp;&amp; (*(html + 1) == <B><FONT COLOR="#BC8F8F">'n'</FONT></B>)
                            &amp;&amp; isUpperLetter(*(html + 2))) {
                          p = 0;
                          <B><FONT COLOR="#A020F0">while</FONT></B>(isalpha((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) html[p]) &amp;&amp; (p &lt; 64))
                            p++;
                          <B><FONT COLOR="#A020F0">if</FONT></B> (p &lt; 64) {
                            <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(html[p]))
                              p++;
                            <B><FONT COLOR="#A020F0">if</FONT></B> (html[p] == <B><FONT COLOR="#BC8F8F">'='</FONT></B>)
                              p++;
                            <B><FONT COLOR="#A020F0">else</FONT></B>
                              p = 0;
                          } <B><FONT COLOR="#A020F0">else</FONT></B>
                            p = 0;
                        }
                      }
                      <I><FONT COLOR="#B22222">/* OK, événement repéré */</FONT></I>
                      <B><FONT COLOR="#A020F0">if</FONT></B> (p) {
                        inscript_tag_lastc = *(html + p);        <I><FONT COLOR="#B22222">/* à attendre à la fin */</FONT></I>
                        html += p <I><FONT COLOR="#B22222">/*+ 1*/</FONT></I>;   <I><FONT COLOR="#B22222">/* saut */</FONT></I>
                        <I><FONT COLOR="#B22222">/*
                           On est désormais dans du code javascript
                         */</FONT></I>
                        inscript_name = <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>;
                        inscript = inscript_tag = 1;
                        inscript_state_pos = INSCRIPT_START;
                        <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;parsedebug) {
                          HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;&lt;@@ inscript @@&gt;&quot;</FONT></B>);
                        }
                      }
                      p = 0;    <I><FONT COLOR="#B22222">/* quoi qu'il arrive, ne rien démarrer ici */</FONT></I>
                    }
                    <I><FONT COLOR="#B22222">// &lt;APPLET CODE=.. pour les applet java.. [CODEBASE (chemin..) à faire]
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0) {
                      p = rech_tageq(html, <B><FONT COLOR="#BC8F8F">&quot;code&quot;</FONT></B>);
                      <B><FONT COLOR="#A020F0">if</FONT></B> (p) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((intag_start_valid) &amp;&amp; check_tag(intag_start, <B><FONT COLOR="#BC8F8F">&quot;applet&quot;</FONT></B>)) {  <I><FONT COLOR="#B22222">// dans un &lt;applet !
</FONT></I>                          p_type = -1;  <I><FONT COLOR="#B22222">// juste le nom de fichier+dossier, écire avant codebase 
</FONT></I>                          add_class = 1;        <I><FONT COLOR="#B22222">// ajouter .class au besoin                         
</FONT></I>
                          <I><FONT COLOR="#B22222">// vérifier qu'il n'y a pas de codebase APRES
</FONT></I>                          <I><FONT COLOR="#B22222">// sinon on swappe les deux.
</FONT></I>                          <I><FONT COLOR="#B22222">// pas très propre mais c'est ce qu'il y a de plus simple à faire!!
</FONT></I>
                          {
                            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a;

                            a = html;
                            <B><FONT COLOR="#A020F0">while</FONT></B>((*a) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'&gt;'</FONT></B>)
                                  &amp;&amp; (!rech_tageq(a, <B><FONT COLOR="#BC8F8F">&quot;codebase&quot;</FONT></B>)))
                              a++;
                            <B><FONT COLOR="#A020F0">if</FONT></B> (rech_tageq(a, <B><FONT COLOR="#BC8F8F">&quot;codebase&quot;</FONT></B>)) {    <I><FONT COLOR="#B22222">// banzai! codebase=
</FONT></I>                              <B><FONT COLOR="#228B22">char</FONT></B> *b;

                              b = strchr(a, <B><FONT COLOR="#BC8F8F">'&gt;'</FONT></B>);
                              <B><FONT COLOR="#A020F0">if</FONT></B> (b != NULL) {
                                <B><FONT COLOR="#A020F0">if</FONT></B> (b - html &lt; 1000) { <I><FONT COLOR="#B22222">// au total &lt; 1Ko
</FONT></I>                                  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];
                                  <B><FONT COLOR="#228B22">const</FONT></B> size_t offset = html - r-&gt;adr;
                                  <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> modify = &amp;r-&gt;adr[offset];
                                  assertf(modify == html);

                                  tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                                  strncatbuff(tempo, a, b - a);
                                  strcatbuff(tempo, <B><FONT COLOR="#BC8F8F">&quot; &quot;</FONT></B>);
                                  strncatbuff(tempo, html, a - html - 1);
                                  <I><FONT COLOR="#B22222">// éventuellement remplire par des espaces pour avoir juste la taille
</FONT></I>                                  <B><FONT COLOR="#A020F0">while</FONT></B>(strlen(tempo) &lt; (size_t) (b - html))
                                    strcatbuff(tempo, <B><FONT COLOR="#BC8F8F">&quot; &quot;</FONT></B>);
                                  <I><FONT COLOR="#B22222">// pas d'erreur?
</FONT></I>                                  <B><FONT COLOR="#A020F0">if</FONT></B> (strlen(tempo) == b - html) {
                                    strncpy(modify, tempo, strlen(tempo)); <I><FONT COLOR="#B22222">// PAS d'octet nul à la fin!
</FONT></I>                                    p = 0;      <I><FONT COLOR="#B22222">// DEVALIDER!!
</FONT></I>                                    p_type = 0;
                                    add_class = 0;
                                  }
                                }
                              }
                            }
                          }

                        }
                      }
                    }
                    <I><FONT COLOR="#B22222">// liens à patcher mais pas à charger (ex: codebase)
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0) {       <I><FONT COLOR="#B22222">// note: si non chargé (ex: ignorer .class) patché tout de même
</FONT></I>                      p = rech_tageq(html, <B><FONT COLOR="#BC8F8F">&quot;codebase&quot;</FONT></B>);
                      <B><FONT COLOR="#A020F0">if</FONT></B> (p) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((intag_start_valid) &amp;&amp; check_tag(intag_start, <B><FONT COLOR="#BC8F8F">&quot;applet&quot;</FONT></B>)) {  <I><FONT COLOR="#B22222">// dans un &lt;applet !
</FONT></I>                          p_type = -2;
                        } <B><FONT COLOR="#A020F0">else</FONT></B>
                          p = -1;       <I><FONT COLOR="#B22222">// ne plus chercher
</FONT></I>                      }
                    }

                    <I><FONT COLOR="#B22222">// Meta tags pour robots
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (p == 0) {
                      <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;robots) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((intag_start_valid)
                            &amp;&amp; check_tag(intag_start, <B><FONT COLOR="#BC8F8F">&quot;meta&quot;</FONT></B>)) {
                          <B><FONT COLOR="#A020F0">if</FONT></B> (rech_tageq(html, <B><FONT COLOR="#BC8F8F">&quot;name&quot;</FONT></B>)) {        <I><FONT COLOR="#B22222">// name=robots.txt
</FONT></I>                            <B><FONT COLOR="#228B22">char</FONT></B> tempo[1100];
                            <B><FONT COLOR="#228B22">char</FONT></B> *a;

                            tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            a = strchr(html, <B><FONT COLOR="#BC8F8F">'&gt;'</FONT></B>);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG_ROBOTS</FONT>
                            printf(<B><FONT COLOR="#BC8F8F">&quot;robots.txt meta tag detected\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                            <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
                              <B><FONT COLOR="#A020F0">if</FONT></B> (a - html &lt; 999) {
                                strncatbuff(tempo, html, a - html);
                                <B><FONT COLOR="#A020F0">if</FONT></B> (strstrcase(tempo, <B><FONT COLOR="#BC8F8F">&quot;content&quot;</FONT></B>)) {
                                  <B><FONT COLOR="#A020F0">if</FONT></B> (strstrcase(tempo, <B><FONT COLOR="#BC8F8F">&quot;robots&quot;</FONT></B>)) {
                                    <B><FONT COLOR="#A020F0">if</FONT></B> (strstrcase(tempo, <B><FONT COLOR="#BC8F8F">&quot;nofollow&quot;</FONT></B>)) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG_ROBOTS</FONT>
                                      printf
                                        (<B><FONT COLOR="#BC8F8F">&quot;robots.txt meta tag: nofollow in %s%s\n&quot;</FONT></B>,
                                         urladr(), urlfil());
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                                      nofollow = 1;     <I><FONT COLOR="#B22222">// NE PLUS suivre liens dans cette page
</FONT></I>                                      hts_log_print(opt, LOG_WARNING,
                                                    <B><FONT COLOR="#BC8F8F">&quot;Link %s%s not scanned (follow robots meta tag)&quot;</FONT></B>,
                                                    urladr(), urlfil());
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                    <I><FONT COLOR="#B22222">// entrée dans une applet javascript
</FONT></I>                    <I><FONT COLOR="#B22222">/*if (!inscript) {  // sinon on est dans un obj.write(&quot;..
                       if (p==0)
                       if (rech_sampletag(html,&quot;script&quot;))
                       if (check_tag(intag_start,&quot;script&quot;)) {
                       inscript=1;
                       }
                       } */</FONT></I>

                    <I><FONT COLOR="#B22222">// Ici on procède à une analyse du code javascript pour tenter de récupérer
</FONT></I>                    <I><FONT COLOR="#B22222">// certains fichiers évidents.
</FONT></I>                    <I><FONT COLOR="#B22222">// C'est devenu obligatoire vu le nombre de pages qui intègrent
</FONT></I>                    <I><FONT COLOR="#B22222">// des images réactives par exemple
</FONT></I>                  }
                } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (inscript) {

#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
                  <I><FONT COLOR="#B22222">/* Check // javascript comments */</FONT></I>
                  <B><FONT COLOR="#A020F0">if</FONT></B> (*html == 10 || *html == 13) {
                    inscript_check_comments = 1;
                    inscript_in_comments = 0;
                  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (inscript_check_comments) {
                    <B><FONT COLOR="#A020F0">if</FONT></B> (!is_realspace(*html)) {
                      inscript_check_comments = 0;
                      <B><FONT COLOR="#A020F0">if</FONT></B> (html[0] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B> &amp;&amp; html[1] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {
                        inscript_in_comments = 1;
                      }
                    }
                  }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

                  <I><FONT COLOR="#B22222">/* Parse */</FONT></I>
                  assertf(inscript_name != NULL);
                  <B><FONT COLOR="#A020F0">if</FONT></B> (*html == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>
                      &amp;&amp;
                      ((strfield(html, <B><FONT COLOR="#BC8F8F">&quot;/script&quot;</FONT></B>)
                        &amp;&amp; strfield(inscript_name, <B><FONT COLOR="#BC8F8F">&quot;script&quot;</FONT></B>))
                       || (strfield(html, <B><FONT COLOR="#BC8F8F">&quot;/style&quot;</FONT></B>)
                           &amp;&amp; strfield(inscript_name, <B><FONT COLOR="#BC8F8F">&quot;style&quot;</FONT></B>))
                      )
                      &amp;&amp; inscript_locked == 0) {
                    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = html;

                    <I><FONT COLOR="#B22222">//while(is_realspace(*(--a)));
</FONT></I>                    <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*a))
                      a--;
                    a--;
                    <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>) {    <I><FONT COLOR="#B22222">// sûr que c'est un tag?
</FONT></I>                      inscript = 0;
                      <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;parsedebug) {
                        HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;&lt;@@ /inscript @@&gt;&quot;</FONT></B>);
                      }
                    }
                  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (inscript_state_pos ==
                             INSCRIPT_START <I><FONT COLOR="#B22222">/*!inscript_in_comments */</FONT></I> ) {
                    <I><FONT COLOR="#B22222">/*
                       Script Analyzing - different types supported:
                       foo=&quot;url&quot;
                       foo(&quot;url&quot;) or foo(url)
                       foo &quot;url&quot;
                     */</FONT></I>
                    <B><FONT COLOR="#228B22">char</FONT></B> expected = <B><FONT COLOR="#BC8F8F">'='</FONT></B>;        <I><FONT COLOR="#B22222">// caractère attendu après
</FONT></I>                    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *expected_end = <B><FONT COLOR="#BC8F8F">&quot;;&quot;</FONT></B>;
                    <B><FONT COLOR="#228B22">int</FONT></B> can_avoid_quotes = 0;
                    <B><FONT COLOR="#228B22">char</FONT></B> quotes_replacement = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                    <B><FONT COLOR="#228B22">int</FONT></B> ensure_not_mime = 0;

                    <B><FONT COLOR="#A020F0">if</FONT></B> (inscript_tag)
                      expected_end = <B><FONT COLOR="#BC8F8F">&quot;;\&quot;\'&quot;</FONT></B>;   <I><FONT COLOR="#B22222">// voir a href=&quot;javascript:doc.location='foo'&quot;
</FONT></I>
                    <I><FONT COLOR="#B22222">/* Can we parse javascript ? */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;parsejava &amp; HTSPARSE_NO_JAVASCRIPT) == 0) {
                      <B><FONT COLOR="#228B22">int</FONT></B> nc;

                      nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;.src&quot;</FONT></B>);       <I><FONT COLOR="#B22222">// nom.src=&quot;image&quot;;
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc &amp;&amp; inscript_tag &amp;&amp; inscript_tag_lastc == *(html - 1))
                        nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;src&quot;</FONT></B>);       <I><FONT COLOR="#B22222">// onXXX='src=&quot;image&quot;;'
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc)
                        nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;.location&quot;</FONT></B>);        <I><FONT COLOR="#B22222">// document.location=&quot;doc&quot;
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc)
                        nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;:location&quot;</FONT></B>);        <I><FONT COLOR="#B22222">// javascript:location=&quot;doc&quot;
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc) {        <I><FONT COLOR="#B22222">// location=&quot;doc&quot;
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> ((nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;location&quot;</FONT></B>))
                            &amp;&amp; !isspace(*(html - 1))
                          )
                          nc = 0;
                      }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc)
                        nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;.href&quot;</FONT></B>);    <I><FONT COLOR="#B22222">// document.location=&quot;doc&quot;
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc)
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;.open&quot;</FONT></B>))) {    <I><FONT COLOR="#B22222">// window.open(&quot;doc&quot;,..
</FONT></I>                          expected = <B><FONT COLOR="#BC8F8F">'('</FONT></B>;       <I><FONT COLOR="#B22222">// parenthèse
</FONT></I>                          expected_end = <B><FONT COLOR="#BC8F8F">&quot;),&quot;</FONT></B>;  <I><FONT COLOR="#B22222">// fin: virgule ou parenthèse
</FONT></I>                          ensure_not_mime = 1;  <I><FONT COLOR="#B22222">//* ensure the url is not a mime type */
</FONT></I>                        }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc)
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;.replace&quot;</FONT></B>))) { <I><FONT COLOR="#B22222">// window.replace(&quot;url&quot;)
</FONT></I>                          expected = <B><FONT COLOR="#BC8F8F">'('</FONT></B>;       <I><FONT COLOR="#B22222">// parenthèse
</FONT></I>                          expected_end = <B><FONT COLOR="#BC8F8F">&quot;)&quot;</FONT></B>;   <I><FONT COLOR="#B22222">// fin: parenthèse
</FONT></I>                        }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc)
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;.link&quot;</FONT></B>))) {    <I><FONT COLOR="#B22222">// window.link(&quot;url&quot;)
</FONT></I>                          expected = <B><FONT COLOR="#BC8F8F">'('</FONT></B>;       <I><FONT COLOR="#B22222">// parenthèse
</FONT></I>                          expected_end = <B><FONT COLOR="#BC8F8F">&quot;)&quot;</FONT></B>;   <I><FONT COLOR="#B22222">// fin: parenthèse
</FONT></I>                        }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc &amp;&amp; (nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;url&quot;</FONT></B>)) &amp;&amp; (!isalnum(*(html - 1))) &amp;&amp; *(html - 1) != <B><FONT COLOR="#BC8F8F">'_'</FONT></B>) {  <I><FONT COLOR="#B22222">// url(url)
</FONT></I>                        expected = <B><FONT COLOR="#BC8F8F">'('</FONT></B>; <I><FONT COLOR="#B22222">// parenthèse
</FONT></I>                        expected_end = <B><FONT COLOR="#BC8F8F">&quot;)&quot;</FONT></B>;     <I><FONT COLOR="#B22222">// fin: parenthèse
</FONT></I>                        can_avoid_quotes = 1;
                        quotes_replacement = <B><FONT COLOR="#BC8F8F">')'</FONT></B>;
                      }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (!nc)
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((nc = strfield(html, <B><FONT COLOR="#BC8F8F">&quot;import&quot;</FONT></B>))) {   <I><FONT COLOR="#B22222">// import &quot;url&quot;
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (is_space(*(html + nc))) {
                            expected = 0;       <I><FONT COLOR="#B22222">// no char expected
</FONT></I>                          } <B><FONT COLOR="#A020F0">else</FONT></B>
                            nc = 0;
                        }
                      <B><FONT COLOR="#A020F0">if</FONT></B> (nc) {
                        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a;

                        a = html + nc;
                        <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*a))
                          a++;
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((*a == expected) || (!expected)) {
                          <B><FONT COLOR="#A020F0">if</FONT></B> (expected)
                            a++;
                          <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*a))
                            a++;
                          <B><FONT COLOR="#A020F0">if</FONT></B> ((*a == 34) || (*a == <B><FONT COLOR="#BC8F8F">'\''</FONT></B>) || (can_avoid_quotes)) {
                            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *b, *c;
                            <B><FONT COLOR="#228B22">int</FONT></B> ndelim = 1;

                            <B><FONT COLOR="#A020F0">if</FONT></B> ((*a == 34) || (*a == <B><FONT COLOR="#BC8F8F">'\''</FONT></B>))
                              a++;
                            <B><FONT COLOR="#A020F0">else</FONT></B>
                              ndelim = 0;
                            b = a;
                            <B><FONT COLOR="#A020F0">if</FONT></B> (ndelim) {
                              <B><FONT COLOR="#A020F0">while</FONT></B>((*b != 34) &amp;&amp; (*b != <B><FONT COLOR="#BC8F8F">'\''</FONT></B>) &amp;&amp; (*b != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>))
                                b++;
                            } <B><FONT COLOR="#A020F0">else</FONT></B> {
                              <B><FONT COLOR="#A020F0">while</FONT></B>((*b != quotes_replacement) &amp;&amp; (*b != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>))
                                b++;
                            }
                            c = b--;
                            c += ndelim;
                            <B><FONT COLOR="#A020F0">while</FONT></B>(*c == <B><FONT COLOR="#BC8F8F">' '</FONT></B>)
                              c++;
                            <B><FONT COLOR="#A020F0">if</FONT></B> ((strchr(expected_end, *c)) || (*c == <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>)
                                || (*c == <B><FONT COLOR="#BC8F8F">'\r'</FONT></B>)) {
                              c -= (ndelim + 1);
                              <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) (c - a + 1)) {
                                <B><FONT COLOR="#A020F0">if</FONT></B> (ensure_not_mime) {
                                  <B><FONT COLOR="#228B22">int</FONT></B> i = 0;

                                  <B><FONT COLOR="#A020F0">while</FONT></B>(a != NULL &amp;&amp; hts_main_mime[i] != NULL
                                        &amp;&amp; hts_main_mime[i][0] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
                                    <B><FONT COLOR="#228B22">int</FONT></B> p;

                                    <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(a, hts_main_mime[i]))
                                        &amp;&amp; a[p] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {
                                      a = NULL;
                                    }
                                    i++;
                                  }
                                }
                                <I><FONT COLOR="#B22222">// Check for bogus links (Vasiliy)
</FONT></I>                                <B><FONT COLOR="#A020F0">if</FONT></B> (a != NULL) {
                                  <B><FONT COLOR="#228B22">const</FONT></B> size_t size = c - a + 1;
                                  <B><FONT COLOR="#228B22">int</FONT></B> i;
                                  <B><FONT COLOR="#228B22">int</FONT></B> first = 1;

                                  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; size; i++) {
                                    <I><FONT COLOR="#B22222">// Suspicious (in code ?), abort.
</FONT></I>                                    <B><FONT COLOR="#A020F0">if</FONT></B> (a[i] == <B><FONT COLOR="#BC8F8F">','</FONT></B> || a[i] == <B><FONT COLOR="#BC8F8F">';'</FONT></B>) {
                                      <B><FONT COLOR="#A020F0">if</FONT></B> (first) {
                                        a = NULL;
                                        <B><FONT COLOR="#A020F0">break</FONT></B>;
                                      }
                                    }
                                    <I><FONT COLOR="#B22222">// Suspicious, abort.
</FONT></I>                                    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (a[i] == <B><FONT COLOR="#BC8F8F">'&quot;'</FONT></B> || a[i] == <B><FONT COLOR="#BC8F8F">'\''</FONT></B>
                                             || a[i] == <B><FONT COLOR="#BC8F8F">'\t'</FONT></B> || a[i] == <B><FONT COLOR="#BC8F8F">'\r'</FONT></B>
                                             || a[i] == <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>) {
                                      a = NULL;
                                      <B><FONT COLOR="#A020F0">break</FONT></B>;
                                    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (a[i] != <B><FONT COLOR="#BC8F8F">' '</FONT></B>) {
                                      first = 0;
                                    }
                                  }
                                }
                                <B><FONT COLOR="#A020F0">if</FONT></B> (a != NULL) {
                                  <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;debug &gt; 1) &amp;&amp; (opt-&gt;log != NULL)) {
                                    <B><FONT COLOR="#228B22">char</FONT></B> str[512];

                                    str[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                                    strncatbuff(str, a,
                                                minimum((<B><FONT COLOR="#228B22">int</FONT></B>) (c - a + 1), 32));
                                    hts_log_print(opt, LOG_DEBUG,
                                                  <B><FONT COLOR="#BC8F8F">&quot;link detected in javascript: %s&quot;</FONT></B>,
                                                  str);
                                  }
                                  p = (<B><FONT COLOR="#228B22">int</FONT></B>) (a - html);  <I><FONT COLOR="#B22222">// p non nul: TRAITER CHAINE COMME FICHIER
</FONT></I>                                  <B><FONT COLOR="#A020F0">if</FONT></B> (can_avoid_quotes) {
                                    ending_p = quotes_replacement;
                                  }
                                }
                              }
                            }

                          }
                        }
                      }

                    }
                    <I><FONT COLOR="#B22222">/* HTSPARSE_NO_JAVASCRIPT */</FONT></I>
                  }
                }
              }

            } <B><FONT COLOR="#A020F0">else</FONT></B> {            <I><FONT COLOR="#B22222">// ptr == 0
</FONT></I>              <I><FONT COLOR="#B22222">//p=rech_tageq(adr,&quot;primary&quot;);    // lien primaire, yeah
</FONT></I>              p = 0;            <I><FONT COLOR="#B22222">// No stupid tag anymore, raw link
</FONT></I>              valid_p = 1;      <I><FONT COLOR="#B22222">// Valid even if p==0
</FONT></I>              <B><FONT COLOR="#A020F0">while</FONT></B>((html[p] == <B><FONT COLOR="#BC8F8F">'\r'</FONT></B>) || (html[p] == <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>))
                p++;
              <I><FONT COLOR="#B22222">//can_avoid_quotes=1;
</FONT></I>              ending_p = <B><FONT COLOR="#BC8F8F">'\r'</FONT></B>;
            }

          } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (isspace((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) *html)) {
            intag_startattr = html + 1;  <I><FONT COLOR="#B22222">// attribute in tag (for dirty parsing)
</FONT></I>          }

          <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>          <I><FONT COLOR="#B22222">// dernier recours - parsing &quot;sale&quot; : détection systématique des .gif, etc.
</FONT></I>          <I><FONT COLOR="#B22222">// risque: générer de faux fichiers parazites
</FONT></I>          <I><FONT COLOR="#B22222">// fix: ne parse plus dans les commentaires
</FONT></I>          <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;parseall &amp;&amp; (opt-&gt;parsejava &amp; HTSPARSE_NO_AGGRESSIVE) == 0 &amp;&amp; (ptr &gt; 0) &amp;&amp; (!in_media) <I><FONT COLOR="#B22222">/* &amp;&amp; (!inscript_in_comments) */</FONT></I> ) {  <I><FONT COLOR="#B22222">// option parsing &quot;brut&quot;
</FONT></I>            <I><FONT COLOR="#B22222">//int incomment_justquit=0;
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (!is_realspace(*html)) {
              <B><FONT COLOR="#228B22">int</FONT></B> noparse = 0;

              <I><FONT COLOR="#B22222">// Gestion des /* */
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
              <B><FONT COLOR="#A020F0">if</FONT></B> (inscript) {
                <B><FONT COLOR="#A020F0">if</FONT></B> (parseall_incomment) {
                  <B><FONT COLOR="#A020F0">if</FONT></B> ((*html == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) &amp;&amp; (*(html - 1) == <B><FONT COLOR="#BC8F8F">'*'</FONT></B>))
                    parseall_incomment = 0;
                  incomment_justquit = 1;       <I><FONT COLOR="#B22222">// ne pas noter dernier caractère
</FONT></I>                } <B><FONT COLOR="#A020F0">else</FONT></B> {
                  <B><FONT COLOR="#A020F0">if</FONT></B> ((*html == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) &amp;&amp; (*(html + 1) == <B><FONT COLOR="#BC8F8F">'*'</FONT></B>))
                    parseall_incomment = 1;
                }
              } <B><FONT COLOR="#A020F0">else</FONT></B>
                parseall_incomment = 0;
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
              <I><FONT COLOR="#B22222">/* ensure automate state  0 (not in comments, quotes..) */</FONT></I>
              <B><FONT COLOR="#A020F0">if</FONT></B> (inscript
                  &amp;&amp; (inscript_state_pos != INSCRIPT_INQUOTE
                      &amp;&amp; inscript_state_pos != INSCRIPT_INQUOTE2)) {
                noparse = 1;
              }

              <I><FONT COLOR="#B22222">/* vérifier que l'on est pas dans un &lt;!-- --&gt; pur */</FONT></I>
              <B><FONT COLOR="#A020F0">if</FONT></B> ((!intag) &amp;&amp; (incomment) &amp;&amp; (!inscript))
                noparse = 1;    <I><FONT COLOR="#B22222">/* commentaire */</FONT></I>

              <I><FONT COLOR="#B22222">// recherche d'URLs
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (!noparse) {
                <I><FONT COLOR="#B22222">//if ((!parseall_incomment) &amp;&amp; (!noparse)) {
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (!p) {       <I><FONT COLOR="#B22222">// non déja trouvé
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (html != r-&gt;adr) {  <I><FONT COLOR="#B22222">// &gt;1 caractère
</FONT></I>                    <I><FONT COLOR="#B22222">// scanner les chaines
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> ((*html == <B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>) || (*html == <B><FONT COLOR="#BC8F8F">'\''</FONT></B>)) {     <I><FONT COLOR="#B22222">// &quot;xx.gif&quot; 'xx.gif'
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (strchr(<B><FONT COLOR="#BC8F8F">&quot;=(,&quot;</FONT></B>, parseall_lastc)) {      <I><FONT COLOR="#B22222">// exemple: a=&quot;img.gif.. (handles comments)
</FONT></I>                        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = html;
                        <B><FONT COLOR="#228B22">char</FONT></B> stop = *html;       <I><FONT COLOR="#B22222">// &quot; ou '
</FONT></I>                        <B><FONT COLOR="#228B22">int</FONT></B> count = 0;

                        <I><FONT COLOR="#B22222">// sauter caractères
</FONT></I>                        a++;
                        <I><FONT COLOR="#B22222">// copier
</FONT></I>                        <B><FONT COLOR="#A020F0">while</FONT></B>((*a) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'\''</FONT></B>) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>)
                              &amp;&amp; (count &lt; HTS_URLMAXSIZE)) {
                          count++;
                          a++;
                        }

                        <I><FONT COLOR="#B22222">// ok chaine terminée par &quot; ou '
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> ((*a == stop) &amp;&amp; (count &lt; HTS_URLMAXSIZE)
                            &amp;&amp; (count &gt; 0)) {
                          <B><FONT COLOR="#228B22">char</FONT></B> c;

                          <I><FONT COLOR="#B22222">//char* aend;
</FONT></I>                          <I><FONT COLOR="#B22222">//
</FONT></I>                          <I><FONT COLOR="#B22222">//aend=a;     // sauver début
</FONT></I>                          a++;
                          <B><FONT COLOR="#A020F0">while</FONT></B>(is_taborspace(*a))
                            a++;
                          c = *a;
                          <B><FONT COLOR="#A020F0">if</FONT></B> (strchr(<B><FONT COLOR="#BC8F8F">&quot;),;&gt;/+\r\n&quot;</FONT></B>, c)) {        <I><FONT COLOR="#B22222">// exemple: ..img.gif&quot;;
</FONT></I>                            <I><FONT COLOR="#B22222">// le / est pour funct(&quot;img.gif&quot; /* URL */);
</FONT></I>                            <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];
                            <B><FONT COLOR="#228B22">char</FONT></B> type[256];
                            <B><FONT COLOR="#228B22">int</FONT></B> url_ok = 0;     <I><FONT COLOR="#B22222">// url valide?
</FONT></I>
                            tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            type[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            <I><FONT COLOR="#B22222">//
</FONT></I>                            strncatbuff(tempo, html + 1, count);
                            <I><FONT COLOR="#B22222">//
</FONT></I>                            <B><FONT COLOR="#A020F0">if</FONT></B> ((!strchr(tempo, <B><FONT COLOR="#BC8F8F">' '</FONT></B>)) || inscript) {    <I><FONT COLOR="#B22222">// espace dedans: méfiance! (sauf dans code javascript)
</FONT></I>                              <B><FONT COLOR="#228B22">int</FONT></B> invalid_url = 0;

                              <I><FONT COLOR="#B22222">// escape                              
</FONT></I>                              unescape_amp(tempo);

                              <I><FONT COLOR="#B22222">// Couper au # ou ? éventuel
</FONT></I>                              {
                                <B><FONT COLOR="#228B22">char</FONT></B> *a = strchr(tempo, <B><FONT COLOR="#BC8F8F">'#'</FONT></B>);

                                <B><FONT COLOR="#A020F0">if</FONT></B> (a)
                                  *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                                a = strchr(tempo, <B><FONT COLOR="#BC8F8F">'?'</FONT></B>);
                                <B><FONT COLOR="#A020F0">if</FONT></B> (a)
                                  *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                              }

                              <I><FONT COLOR="#B22222">// vérifier qu'il n'y a pas de caractères spéciaux
</FONT></I>                              <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(tempo))
                                invalid_url = 1;
                              <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strchr(tempo, <B><FONT COLOR="#BC8F8F">'*'</FONT></B>)
                                       || strchr(tempo, <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>)
                                       || strchr(tempo, <B><FONT COLOR="#BC8F8F">'&gt;'</FONT></B>)
                                       || strchr(tempo, <B><FONT COLOR="#BC8F8F">','</FONT></B>)    <I><FONT COLOR="#B22222">/* list of files ? */</FONT></I>
                                       ||strchr(tempo, <B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>)    <I><FONT COLOR="#B22222">/* potential parsing bug */</FONT></I>
                                       ||strchr(tempo, <B><FONT COLOR="#BC8F8F">'\''</FONT></B>)    <I><FONT COLOR="#B22222">/* potential parsing bug */</FONT></I>
                                )
                                invalid_url = 1;
                              <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (tempo[0] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B> &amp;&amp; isalnum(tempo[1]))    <I><FONT COLOR="#B22222">// &quot;.gif&quot;
</FONT></I>                                invalid_url = 1;

                              <I><FONT COLOR="#B22222">/* non invalide? */</FONT></I>
                              <B><FONT COLOR="#A020F0">if</FONT></B> (!invalid_url) {
                                <I><FONT COLOR="#B22222">// Un plus à la fin? Alors ne pas prendre sauf si extension (&quot;/toto.html#&quot;+tag)
</FONT></I>                                <B><FONT COLOR="#A020F0">if</FONT></B> (c != <B><FONT COLOR="#BC8F8F">'+'</FONT></B>) { <I><FONT COLOR="#B22222">// PAS de plus à la fin
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
                                  <B><FONT COLOR="#228B22">char</FONT></B> *a;
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                                  <I><FONT COLOR="#B22222">// &quot;Comparisons of scheme names MUST be case-insensitive&quot; (RFC2616)                                  
</FONT></I>                                  <B><FONT COLOR="#A020F0">if</FONT></B> ((strfield(tempo, <B><FONT COLOR="#BC8F8F">&quot;http:&quot;</FONT></B>))
                                      || (strfield(tempo, <B><FONT COLOR="#BC8F8F">&quot;ftp:&quot;</FONT></B>))
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
                                      || (strfield(tempo, <B><FONT COLOR="#BC8F8F">&quot;https:&quot;</FONT></B>)
                                      )
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                                    )   <I><FONT COLOR="#B22222">// ok pas de problème
</FONT></I>                                    url_ok = 1;
                                  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (tempo[strlen(tempo) - 1] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {   <I><FONT COLOR="#B22222">// un slash: ok..
</FONT></I>                                    <B><FONT COLOR="#A020F0">if</FONT></B> (inscript)       <I><FONT COLOR="#B22222">// sinon si pas javascript, méfiance (répertoire style base?)
</FONT></I>                                      url_ok = 1;
                                  }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
                                  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((a = strchr(tempo, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>))) {  <I><FONT COLOR="#B22222">// un slash: ok..
</FONT></I>                                    <B><FONT COLOR="#A020F0">if</FONT></B> (inscript) {     <I><FONT COLOR="#B22222">// sinon si pas javascript, méfiance (style &quot;text/css&quot;)
</FONT></I>                                      <B><FONT COLOR="#A020F0">if</FONT></B> (strchr(a + 1, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>))   <I><FONT COLOR="#B22222">// un seul / : abandon (STYLE type='text/css')
</FONT></I>                                        <B><FONT COLOR="#A020F0">if</FONT></B> (!strchr(tempo, <B><FONT COLOR="#BC8F8F">' '</FONT></B>))        <I><FONT COLOR="#B22222">// avoid spaces (too dangerous for comments)
</FONT></I>                                          url_ok = 1;
                                    }
                                  }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                                }
                                <I><FONT COLOR="#B22222">// Prendre si extension reconnue
</FONT></I>                                <B><FONT COLOR="#A020F0">if</FONT></B> (!url_ok) {
                                  get_httptype(opt, type, tempo, 0);
                                  <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(type))        <I><FONT COLOR="#B22222">// type reconnu!
</FONT></I>                                    url_ok = 1;
                                  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (is_dyntype(get_ext(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), tempo)))       <I><FONT COLOR="#B22222">// reconnu php,cgi,asp..
</FONT></I>                                    url_ok = 1;
                                  <I><FONT COLOR="#B22222">// MAIS pas les foobar@aol.com !!
</FONT></I>                                  <B><FONT COLOR="#A020F0">if</FONT></B> (strchr(tempo, <B><FONT COLOR="#BC8F8F">'@'</FONT></B>))
                                    url_ok = 0;
                                }
                                <I><FONT COLOR="#B22222">//
</FONT></I>                                <I><FONT COLOR="#B22222">// Ok, cela pourrait être une URL
</FONT></I>                                <B><FONT COLOR="#A020F0">if</FONT></B> (url_ok) {

                                  <I><FONT COLOR="#B22222">// Check if not fodbidden tag (id,name..)
</FONT></I>                                  <B><FONT COLOR="#A020F0">if</FONT></B> (intag_start_valid) {
                                    <B><FONT COLOR="#A020F0">if</FONT></B> (intag_start)
                                      <B><FONT COLOR="#A020F0">if</FONT></B> (intag_startattr)
                                        <B><FONT COLOR="#A020F0">if</FONT></B> (intag)
                                          <B><FONT COLOR="#A020F0">if</FONT></B> (!inscript)
                                            <B><FONT COLOR="#A020F0">if</FONT></B> (!incomment) {
                                              <B><FONT COLOR="#228B22">int</FONT></B> i = 0, nop = 0;

                                              <B><FONT COLOR="#A020F0">while</FONT></B>((nop == 0)
                                                    &amp;&amp;
                                                    (strnotempty
                                                     (hts_nodetect[i]))) {
                                                nop =
                                                  rech_tageq(intag_startattr,
                                                             hts_nodetect[i]);
                                                i++;
                                              }
                                              <I><FONT COLOR="#B22222">// Forbidden tag
</FONT></I>                                              <B><FONT COLOR="#A020F0">if</FONT></B> (nop) {
                                                url_ok = 0;
                                                hts_log_print(opt, LOG_DEBUG,
                                                              <B><FONT COLOR="#BC8F8F">&quot;dirty parsing: bad tag avoided: %s&quot;</FONT></B>,
                                                              hts_nodetect[i -
                                                                           1]);
                                              }
                                            }
                                  }

                                  <I><FONT COLOR="#B22222">// Accepter URL, on la traitera comme une URL normale!!
</FONT></I>                                  <B><FONT COLOR="#A020F0">if</FONT></B> (url_ok) {
                                    valid_p = 1;
                                    p = 0;
                                  }

                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }               <I><FONT COLOR="#B22222">// p == 0               
</FONT></I>
              }                 <I><FONT COLOR="#B22222">// not in comment
</FONT></I>
              <I><FONT COLOR="#B22222">// plus dans un commentaire
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (inscript_state_pos == INSCRIPT_START
                  &amp;&amp; inscript_state_pos_prev == INSCRIPT_START) {
                parseall_lastc = *html;  <I><FONT COLOR="#B22222">// caractère avant le prochain
</FONT></I>              }

            }                   <I><FONT COLOR="#B22222">// if realspace
</FONT></I>          }                     <I><FONT COLOR="#B22222">// if parseall
</FONT></I>
          <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>          <I><FONT COLOR="#B22222">// p!=0 : on a repéré un éventuel lien
</FONT></I>          <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>          <I><FONT COLOR="#B22222">//
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> ((p &gt; 0) || (valid_p)) {   <I><FONT COLOR="#B22222">// on a repéré un lien
</FONT></I>            <I><FONT COLOR="#B22222">//int lien_valide=0;
</FONT></I>            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *eadr = NULL;  <I><FONT COLOR="#B22222">/* fin de l'URL */</FONT></I>

            <I><FONT COLOR="#B22222">//char* quote_adr=NULL;     /* adresse du ? dans l'adresse */
</FONT></I>            <B><FONT COLOR="#228B22">int</FONT></B> ok = 1;
            <B><FONT COLOR="#228B22">char</FONT></B> quote = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
            <B><FONT COLOR="#228B22">int</FONT></B> quoteinscript = 0;
            <B><FONT COLOR="#228B22">int</FONT></B> noquote = 0;
            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *tag_attr_start = html;

            <I><FONT COLOR="#B22222">// si nofollow ou un stop a été déclenché, réécrire tous les liens en externe
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> ((nofollow)
                || (opt-&gt;state.stop
                    &amp;&amp; <I><FONT COLOR="#B22222">/* force follow not to lose previous cache data */</FONT></I>
                    !opt-&gt;is_update)
              )
              p_nocatch = 1;

            <I><FONT COLOR="#B22222">// écrire codebase avant, flusher avant code
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> ((p_type == -1) || (p_type == -2)) {
              <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                HT_add_adr;     <I><FONT COLOR="#B22222">// refresh
</FONT></I>              }
              lastsaved = html;  <I><FONT COLOR="#B22222">// dernier écrit+1
</FONT></I>            }
            <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>            <I><FONT COLOR="#B22222">// adr+=p;
</FONT></I>            INCREMENT_CURRENT_ADR(p);
            <B><FONT COLOR="#A020F0">while</FONT></B>((is_space(*html)
                   || (inscriptgen &amp;&amp; html[0] == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B> &amp;&amp; is_space(html[1])
                   )
                  )
                  &amp;&amp; quote == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (!quote)
                <B><FONT COLOR="#A020F0">if</FONT></B> ((*html == <B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>) || (*html == <B><FONT COLOR="#BC8F8F">'\''</FONT></B>)) {
                  quote = *html; <I><FONT COLOR="#B22222">// on doit attendre cela à la fin
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (inscriptgen &amp;&amp; *(html - 1) == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>) {
                    quoteinscript = 1;  <I><FONT COLOR="#B22222">/* will wait for \&quot; */</FONT></I>
                  }
                }
              <I><FONT COLOR="#B22222">// puis quitter
</FONT></I>              <I><FONT COLOR="#B22222">// html++;    // sauter les espaces, &quot;&quot; et cie
</FONT></I>              INCREMENT_CURRENT_ADR(1);
            }

            <I><FONT COLOR="#B22222">/* Stop at \n (LF) if primary links or link lists */</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (ptr == 0 || (in_media &amp;&amp; strcmp(in_media, <B><FONT COLOR="#BC8F8F">&quot;LNK&quot;</FONT></B>) == 0))
              quote = <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>;
            <I><FONT COLOR="#B22222">/* s'arrêter que ce soit un ' ou un &quot; : pour document.write('&lt;img src=&quot;foo'+a); par exemple! */</FONT></I>
            <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (inscript &amp;&amp; !unquoted_script)
              noquote = 1;

            <I><FONT COLOR="#B22222">// sauter éventuel \&quot; ou \' javascript
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (inscript) {     <I><FONT COLOR="#B22222">// on est dans un obj.write(&quot;..
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (*html == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>) {
                <B><FONT COLOR="#A020F0">if</FONT></B> ((*(html + 1) == <B><FONT COLOR="#BC8F8F">'\''</FONT></B>) || (*(html + 1) == <B><FONT COLOR="#BC8F8F">'&quot;'</FONT></B>)) {      <I><FONT COLOR="#B22222">// \&quot; ou \'
</FONT></I>                  <I><FONT COLOR="#B22222">// html+=2;    // sauter
</FONT></I>                  INCREMENT_CURRENT_ADR(2);
                }
              }
            }
            <I><FONT COLOR="#B22222">// sauter content=&quot;1;URL=http://..
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (p_searchMETAURL) {
              <B><FONT COLOR="#228B22">int</FONT></B> l = 0;

              <B><FONT COLOR="#A020F0">while</FONT></B>((html + l + 4 &lt; r-&gt;adr + r-&gt;size)
                    &amp;&amp; (!strfield(html + l, <B><FONT COLOR="#BC8F8F">&quot;URL=&quot;</FONT></B>))
                    &amp;&amp; (l &lt; 128))
                l++;
              <B><FONT COLOR="#A020F0">if</FONT></B> (!strfield(html + l, <B><FONT COLOR="#BC8F8F">&quot;URL=&quot;</FONT></B>))
                ok = -1;
              <B><FONT COLOR="#A020F0">else</FONT></B>
                html += (l + 4);
            }

            <I><FONT COLOR="#B22222">/* éviter les javascript:document.location=.. : les parser, plutôt */</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (ok != -1) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(html, <B><FONT COLOR="#BC8F8F">&quot;javascript:&quot;</FONT></B>)
                  &amp;&amp; !inscript  <I><FONT COLOR="#B22222">/* we don't want to parse 'javascript:' inside document.write inside scripts */</FONT></I>
                ) {
                ok = -1;
                <I><FONT COLOR="#B22222">/*
                   On est désormais dans du code javascript
                 */</FONT></I>
                inscript_name = <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>;
                inscript_tag = inscript = 1;
                inscript_state_pos = INSCRIPT_START;
                inscript_tag_lastc = quote;     <I><FONT COLOR="#B22222">/* à attendre à la fin */</FONT></I>
                <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;parsedebug) {
                  HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;&lt;@@ inscript @@&gt;&quot;</FONT></B>);
                }
              }
            }

            <B><FONT COLOR="#A020F0">if</FONT></B> (p_type == 1) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (*html == <B><FONT COLOR="#BC8F8F">'#'</FONT></B>) {
                html++;          <I><FONT COLOR="#B22222">// sauter # pour usemap etc
</FONT></I>              }
            }
            eadr = html;

            <I><FONT COLOR="#B22222">// ne pas flusher après code si on doit écrire le codebase avant!
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> ((p_type != -1) &amp;&amp; (p_type != 2) &amp;&amp; (p_type != -2)) {
              <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                HT_add_adr;     <I><FONT COLOR="#B22222">// refresh
</FONT></I>              }
              lastsaved = html;  <I><FONT COLOR="#B22222">// dernier écrit+1
</FONT></I>              <I><FONT COLOR="#B22222">// après on écrira soit les données initiales,
</FONT></I>              <I><FONT COLOR="#B22222">// soir une URL/lien modifié!
</FONT></I>            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (p_type == -1)
              p_flush = html;    <I><FONT COLOR="#B22222">// flusher jusqu'à adr ensuite
</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (ok != -1) {     <I><FONT COLOR="#B22222">// continuer
</FONT></I>              <I><FONT COLOR="#B22222">// découper le lien
</FONT></I>              <B><FONT COLOR="#A020F0">do</FONT></B> {
                <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) *eadr &lt; 32) {   <I><FONT COLOR="#B22222">// caractère de contrôle (ou \0)
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (!is_space(*eadr))
                    ok = 0;
                }
                <B><FONT COLOR="#A020F0">if</FONT></B> (eadr - html &gt; HTS_URLMAXSIZE)    <I><FONT COLOR="#B22222">// ** trop long, &gt;HTS_URLMAXSIZE caractères (on prévoit HTS_URLMAXSIZE autres pour path)
</FONT></I>                  ok = -1;      <I><FONT COLOR="#B22222">// ne pas traiter ce lien
</FONT></I>
                <B><FONT COLOR="#A020F0">if</FONT></B> (ok &gt; 0) {
                  <I><FONT COLOR="#B22222">//if (*eadr!=' ') {  
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (is_space(*eadr)) {        <I><FONT COLOR="#B22222">// guillemets,CR, etc
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> ((*eadr == quote &amp;&amp; (!quoteinscript || *(eadr - 1) == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>))     <I><FONT COLOR="#B22222">// end quote
</FONT></I>                        || (noquote &amp;&amp; (*eadr == <B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B> || *eadr == <B><FONT COLOR="#BC8F8F">'\''</FONT></B>))        <I><FONT COLOR="#B22222">// end at any quote
</FONT></I>                        || (!noquote &amp;&amp; quote == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> &amp;&amp; is_realspace(*eadr))   <I><FONT COLOR="#B22222">// unquoted href
</FONT></I>                      )         <I><FONT COLOR="#B22222">// si pas d'attente de quote spéciale ou si quote atteinte
</FONT></I>                      ok = 0;
                  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (ending_p &amp;&amp; (*eadr == ending_p))
                    ok = 0;
                  <B><FONT COLOR="#A020F0">else</FONT></B> {
                    <B><FONT COLOR="#A020F0">switch</FONT></B> (*eadr) {
                    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#BC8F8F">'&gt;'</FONT></B>:
                      <B><FONT COLOR="#A020F0">if</FONT></B> (!quote) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> (!inscript &amp;&amp; !in_media) {
                          intag = 0;    <I><FONT COLOR="#B22222">// PLUS dans un tag!
</FONT></I>                          intag_start_valid = 0;
                          intag_name = NULL;
                        }
                        ok = 0;
                      }
                      <B><FONT COLOR="#A020F0">break</FONT></B>;
                      <I><FONT COLOR="#B22222">/*case '&lt;': */</FONT></I>
                    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#BC8F8F">'#'</FONT></B>:
                      <B><FONT COLOR="#A020F0">if</FONT></B> (*(eadr - 1) != <B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>)   <I><FONT COLOR="#B22222">// &amp;#40;
</FONT></I>                        ok = 0;
                      <B><FONT COLOR="#A020F0">break</FONT></B>;
                      <I><FONT COLOR="#B22222">// case '?': non!
</FONT></I>                    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>:
                      <B><FONT COLOR="#A020F0">if</FONT></B> (inscript)
                        ok = 0;
                      <B><FONT COLOR="#A020F0">break</FONT></B>;    <I><FONT COLOR="#B22222">// \&quot; ou \' point d'arrêt
</FONT></I>                    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#BC8F8F">'?'</FONT></B>:  <I><FONT COLOR="#B22222">/*quote_adr=adr; */</FONT></I>
                      <B><FONT COLOR="#A020F0">break</FONT></B>;    <I><FONT COLOR="#B22222">// noter position query
</FONT></I>                    }
                  }
                  <I><FONT COLOR="#B22222">//}
</FONT></I>                }
                eadr++;
              } <B><FONT COLOR="#A020F0">while</FONT></B>(ok == 1);

              <I><FONT COLOR="#B22222">// Empty link detected
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (eadr - html &lt;= 1) {        <I><FONT COLOR="#B22222">// link empty
</FONT></I>                ok = -1;        <I><FONT COLOR="#B22222">// No
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (*html != <B><FONT COLOR="#BC8F8F">'#'</FONT></B>) {      <I><FONT COLOR="#B22222">// Not empty+unique #
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (eadr - html == 1) {    <I><FONT COLOR="#B22222">// 1=link empty with delim (end_adr-start_adr)
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (quote) {
                      <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                        HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;#&quot;</FONT></B>);    <I><FONT COLOR="#B22222">// We add this for a &lt;href=&quot;&quot;&gt;
</FONT></I>                      }
                    }
                  }
                }
              }
              <I><FONT COLOR="#B22222">// This is a dirty and horrible hack to avoid parsing an Adobe GoLive bogus tag
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(html, <B><FONT COLOR="#BC8F8F">&quot;(Empty Reference!)&quot;</FONT></B>)) {
                ok = -1;        <I><FONT COLOR="#B22222">// No
</FONT></I>              }

            }

            <B><FONT COLOR="#A020F0">if</FONT></B> (ok == 0) {      <I><FONT COLOR="#B22222">// tester un lien
</FONT></I>              <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK lien[HTS_URLMAXSIZE * 2];
              <B><FONT COLOR="#228B22">int</FONT></B> meme_adresse = 0;     <I><FONT COLOR="#B22222">// 0 par défaut pour primary
</FONT></I>
              <I><FONT COLOR="#B22222">//char *copie_de_adr=html;
</FONT></I>              <I><FONT COLOR="#B22222">//char* p;
</FONT></I>
              <I><FONT COLOR="#B22222">// construire lien (découpage)
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (eadr - html - 1 &lt; HTS_URLMAXSIZE) {        <I><FONT COLOR="#B22222">// pas trop long?
</FONT></I>                strncpy(lien, html, eadr - html - 1);
                lien[eadr - html - 1] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                <I><FONT COLOR="#B22222">//printf(&quot;link: %s\n&quot;,lien);          
</FONT></I>                <I><FONT COLOR="#B22222">// supprimer les espaces
</FONT></I>                <B><FONT COLOR="#A020F0">while</FONT></B>((lien[strlen(lien) - 1] == <B><FONT COLOR="#BC8F8F">' '</FONT></B>) &amp;&amp; (strnotempty(lien)))
                  lien[strlen(lien) - 1] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

              } <B><FONT COLOR="#A020F0">else</FONT></B>
                lien[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; <I><FONT COLOR="#B22222">// erreur
</FONT></I>
              <I><FONT COLOR="#B22222">// ------------------------------------------------------
</FONT></I>              <I><FONT COLOR="#B22222">// Lien repéré et extrait
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(lien) &gt; 0) {      <I><FONT COLOR="#B22222">// construction du lien
</FONT></I>                lien_adrfilsave afs;
                <B><FONT COLOR="#228B22">int</FONT></B> forbidden_url = -1; <I><FONT COLOR="#B22222">// lien non interdit (mais non autorisé..)
</FONT></I>                <B><FONT COLOR="#228B22">int</FONT></B> just_test_it = 0;   <I><FONT COLOR="#B22222">// mode de test des liens
</FONT></I>                <B><FONT COLOR="#228B22">int</FONT></B> set_prio_to = 0;    <I><FONT COLOR="#B22222">// pour capture de page isolée
</FONT></I>                <B><FONT COLOR="#228B22">int</FONT></B> import_done = 0;    <I><FONT COLOR="#B22222">// lien importé (ne pas scanner ensuite *à priori*)
</FONT></I>
                <I><FONT COLOR="#B22222">//
</FONT></I>                afs.af.adr[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                afs.af.fil[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                afs.save[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                <I><FONT COLOR="#B22222">//
</FONT></I>                <I><FONT COLOR="#B22222">// 0: autorisé
</FONT></I>                <I><FONT COLOR="#B22222">// 1: interdit (patcher tout de même adresse)
</FONT></I>
                hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;link detected in html (tag): %s&quot;</FONT></B>,
                              lien);

                <I><FONT COLOR="#B22222">// external check
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (!RUN_CALLBACK1(opt, linkdetected, lien)
                    || !RUN_CALLBACK2(opt, linkdetected2, lien, intag_start)) {
                  error = 1;    <I><FONT COLOR="#B22222">// erreur
</FONT></I>                  hts_log_print(opt, LOG_ERROR,
                                <B><FONT COLOR="#BC8F8F">&quot;Link %s refused by external wrapper&quot;</FONT></B>, lien);
                }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_STRIP_DOUBLE_SLASH</FONT>
                <I><FONT COLOR="#B22222">// supprimer les // en / (sauf pour http://)
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;urlhack) {
                  <B><FONT COLOR="#228B22">char</FONT></B> *a, *p, *q;
                  <B><FONT COLOR="#228B22">int</FONT></B> done = 0;

                  a = strchr(lien, <B><FONT COLOR="#BC8F8F">':'</FONT></B>);        <I><FONT COLOR="#B22222">// http://
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
                    a++;
                    <B><FONT COLOR="#A020F0">while</FONT></B>(*a == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                      a++;      <I><FONT COLOR="#B22222">// position après http://
</FONT></I>                  } <B><FONT COLOR="#A020F0">else</FONT></B> {
                    a = lien;   <I><FONT COLOR="#B22222">// début
</FONT></I>                    <B><FONT COLOR="#A020F0">while</FONT></B>(*a == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                      a++;      <I><FONT COLOR="#B22222">// position après http://
</FONT></I>                  }
                  q = strchr(a, <B><FONT COLOR="#BC8F8F">'?'</FONT></B>);   <I><FONT COLOR="#B22222">// ne pas traiter après '?'
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (!q)
                    q = a + strlen(a) - 1;
                  <B><FONT COLOR="#A020F0">while</FONT></B>((p = strstr(a, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>)) &amp;&amp; (!done)) {     <I><FONT COLOR="#B22222">// remplacer // par /
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (p &gt; q) {    <I><FONT COLOR="#B22222">// après le ? (toto.cgi?param=1//2.3)
</FONT></I>                      done = 1; <I><FONT COLOR="#B22222">// stopper
</FONT></I>                    } <B><FONT COLOR="#A020F0">else</FONT></B> {
                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];

                      tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                      strncatbuff(tempo, a, p - a);
                      strcatbuff(tempo, p + 1);
                      strcpybuff(a, tempo);     <I><FONT COLOR="#B22222">// recopier
</FONT></I>                    }
                  }
                }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

                <I><FONT COLOR="#B22222">// purger espaces de début et fin, CR,LF résiduels
</FONT></I>                <I><FONT COLOR="#B22222">// (IMG SRC=&quot;foo.&lt;\n&gt;&lt;\t&gt;gif&lt;\t&gt;&quot;)
</FONT></I>                {
                  <B><FONT COLOR="#228B22">char</FONT></B> *a = lien;
                  size_t llen;

                  <I><FONT COLOR="#B22222">// strip ending spaces
</FONT></I>                  llen = (*a != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) ? strlen(a) : 0;
                  <B><FONT COLOR="#A020F0">while</FONT></B>(llen &gt; 0 &amp;&amp; is_realspace(lien[llen - 1])) {
                    a[--llen] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                  }
                  <I><FONT COLOR="#B22222">//  skip leading ones
</FONT></I>                  <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*a))
                    a++;
                  <I><FONT COLOR="#B22222">// strip cr, lf, tab inside URL
</FONT></I>                  llen = 0;
                  <B><FONT COLOR="#A020F0">while</FONT></B>(*a) {
                    <B><FONT COLOR="#A020F0">if</FONT></B> (*a != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B> &amp;&amp; *a != <B><FONT COLOR="#BC8F8F">'\r'</FONT></B> &amp;&amp; *a != <B><FONT COLOR="#BC8F8F">'\t'</FONT></B>) {
                      lien[llen++] = *a;
                    }
                    a++;
                  }
                  lien[llen] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                }

                <I><FONT COLOR="#B22222">// commas are forbidden
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (archivetag_p) {
                  <B><FONT COLOR="#A020F0">if</FONT></B> (strchr(lien, <B><FONT COLOR="#BC8F8F">','</FONT></B>)) {
                    error = 1;  <I><FONT COLOR="#B22222">// erreur
</FONT></I>                    hts_log_print(opt, LOG_DEBUG,
                                  <B><FONT COLOR="#BC8F8F">&quot;link rejected (multiple-archive) %s&quot;</FONT></B>, lien);
                  }
                }

                <I><FONT COLOR="#B22222">/* Unescape/escape %20 and other &amp;nbsp; */</FONT></I>
                {
                  <I><FONT COLOR="#B22222">// Note: always true (iso-8859-1 as default)
</FONT></I>                  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> charset = str-&gt;page_charset_;
                  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> hasCharset = charset != NULL 
                    &amp;&amp; *charset != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK query[HTS_URLMAXSIZE * 2];

                  <I><FONT COLOR="#B22222">// cut query string
</FONT></I>                  {
                    <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> a = strchr(lien, <B><FONT COLOR="#BC8F8F">'?'</FONT></B>);
                    <B><FONT COLOR="#A020F0">if</FONT></B> (a != NULL) {
                      strcpybuff(query, a);
                      *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                    } <B><FONT COLOR="#A020F0">else</FONT></B> {
                      query[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                    }
                  }

                  <I><FONT COLOR="#B22222">// Unescape %XX, but not yet high-chars (supposedly encoded with UTF-8)
</FONT></I>                  strcpybuff(lien, 
                    unescape_http_unharm(catbuff, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(catbuff), lien, 1 | 2));     <I><FONT COLOR="#B22222">/* note: '%' is still escaped */</FONT></I>

                  <I><FONT COLOR="#B22222">// Force to encode non-printable chars (should never happend)
</FONT></I>                  escape_remove_control(lien);
                  
                  <I><FONT COLOR="#B22222">// charset conversion for the URI filename, 
</FONT></I>                  <I><FONT COLOR="#B22222">// and not already UTF-8
</FONT></I>                  <I><FONT COLOR="#B22222">// (note: not for the query string!)
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (hasCharset &amp;&amp; !hts_isCharsetUTF8(charset)) {
                    <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> s = hts_convertStringToUTF8(lien, strlen(lien), charset);
                    <B><FONT COLOR="#A020F0">if</FONT></B> (s != NULL) {
                      hts_log_print(opt, LOG_DEBUG,
                        <B><FONT COLOR="#BC8F8F">&quot;engine: save-name: '%s' charset conversion from '%s' to '%s'&quot;</FONT></B>,
                        charset, lien, s);
                      strcpybuff(lien, s);
                      free(s);
                    }
                  }

                  <I><FONT COLOR="#B22222">// decode URI entities with UTF-8 charset
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_unescapeEntities(lien, lien, strlen(lien) + 1) != 0) {
                    hts_log_print(opt, LOG_WARNING,
                      <B><FONT COLOR="#BC8F8F">&quot;could not decode URI '%s' with charset '%s'&quot;</FONT></B>, lien, charset);
                  }

                  <I><FONT COLOR="#B22222">// decode query string entities with page charset
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (hasCharset) {
                    <B><FONT COLOR="#A020F0">if</FONT></B> (hts_unescapeEntitiesWithCharset(query, 
                                                        query, strlen(query) + 1,
                                                        charset) != 0) {
                        hts_log_print(opt, LOG_WARNING,
                          <B><FONT COLOR="#BC8F8F">&quot;could not decode query string '%s' with charset '%s'&quot;</FONT></B>, query, charset);
                    }
                  }

                  <I><FONT COLOR="#B22222">// Decode remaining %XX high characters with UTF-8 
</FONT></I>                  <I><FONT COLOR="#B22222">// but only when this leads to valid UTF-8.
</FONT></I>                  <I><FONT COLOR="#B22222">// Otherwise, leave them unescaped.
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_unescapeUrlSpecial(lien, catbuff, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(catbuff),
                                             UNESCAPE_URL_NO_ASCII) == 0) {
                    strcpybuff(lien, catbuff);
                  } <B><FONT COLOR="#A020F0">else</FONT></B> {
                    hts_log_print(opt, LOG_WARNING,
                      <B><FONT COLOR="#BC8F8F">&quot;could not URL-decode string '%s'&quot;</FONT></B>, lien);
                  }

                  <I><FONT COLOR="#B22222">// we need to encode query string non-ascii chars, 
</FONT></I>                  <I><FONT COLOR="#B22222">// leaving the encoding as-is (unlike the file part)
</FONT></I>                  <I><FONT COLOR="#B22222">// and copy back query
</FONT></I>                  append_escape_check_url(query, lien, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(lien));
                }

                <I><FONT COLOR="#B22222">// convertir les éventuels \ en des / pour éviter des problèmes de reconnaissance!
</FONT></I>                {
                  <B><FONT COLOR="#228B22">char</FONT></B> *a;

                  <B><FONT COLOR="#A020F0">for</FONT></B>(a = jump_identification(lien); *a != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> &amp;&amp; *a != <B><FONT COLOR="#BC8F8F">'?'</FONT></B>;
                      a++) {
                    <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>) {
                      *a = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;
                    }
                  }
                }

                <I><FONT COLOR="#B22222">// supprimer le(s) ./
</FONT></I>                <B><FONT COLOR="#A020F0">while</FONT></B>((lien[0] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B>) &amp;&amp; (lien[1] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)) {
                  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];

                  strcpybuff(tempo, lien + <I><FONT COLOR="#B22222">/* ./ */</FONT></I> 2);
                  strcpybuff(lien, tempo);
                }
                <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(lien) == 0)     <I><FONT COLOR="#B22222">// sauf si plus de nom de fichier
</FONT></I>                  strcpybuff(lien, <B><FONT COLOR="#BC8F8F">&quot;./&quot;</FONT></B>);

                <I><FONT COLOR="#B22222">// vérifie les /~machin -&gt; /~machin/
</FONT></I>                <I><FONT COLOR="#B22222">// supposition dangereuse?
</FONT></I>                <I><FONT COLOR="#B22222">// OUI!!
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_TILDE_SLASH</FONT>
                <B><FONT COLOR="#A020F0">if</FONT></B> (lien[strlen(lien) - 1] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {
                  <B><FONT COLOR="#228B22">char</FONT></B> *a = lien + strlen(lien) - 1;

                  <I><FONT COLOR="#B22222">// éviter aussi index~1.html
</FONT></I>                  <B><FONT COLOR="#A020F0">while</FONT></B>(a &gt; lien &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'~'</FONT></B>) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                        &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'.'</FONT></B>))
                    a--;
                  <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'~'</FONT></B>) {
                    strcatbuff(lien, <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);      <I><FONT COLOR="#B22222">// ajouter slash
</FONT></I>                  }
                }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

                <I><FONT COLOR="#B22222">// APPLET CODE=&quot;mixer.MixerApplet.class&quot; --&gt; APPLET CODE=&quot;mixer/MixerApplet.class&quot;
</FONT></I>                <I><FONT COLOR="#B22222">// yes, this is dirty
</FONT></I>                <I><FONT COLOR="#B22222">// but I'm so lazzy..
</FONT></I>                <I><FONT COLOR="#B22222">// and besides the java &quot;code&quot; convention is really a pain in html code
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (p_type == -1) {
                  <B><FONT COLOR="#228B22">char</FONT></B> *a = strrchr(lien, <B><FONT COLOR="#BC8F8F">'.'</FONT></B>);

                  add_class_dots_to_patch = 0;
                  <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
                    <B><FONT COLOR="#228B22">char</FONT></B> *b;

                    <B><FONT COLOR="#A020F0">do</FONT></B> {
                      b = strchr(lien, <B><FONT COLOR="#BC8F8F">'.'</FONT></B>);
                      <B><FONT COLOR="#A020F0">if</FONT></B> ((b != a) &amp;&amp; (b)) {
                        add_class_dots_to_patch++;
                        *b = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;
                      }
                    } <B><FONT COLOR="#A020F0">while</FONT></B>((b != a) &amp;&amp; (b));
                  }
                }
                <I><FONT COLOR="#B22222">// éliminer les éventuels :80 (port par défaut!)
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (link_has_authority(lien)) {
                  <B><FONT COLOR="#228B22">char</FONT></B> *a;

                  a = strstr(lien, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);       <I><FONT COLOR="#B22222">// &quot;//&quot; authority
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (a)
                    a += 2;
                  <B><FONT COLOR="#A020F0">else</FONT></B>
                    a = lien;
                  <I><FONT COLOR="#B22222">// while((*a) &amp;&amp; (*a!='/') &amp;&amp; (*a!=':')) a++;
</FONT></I>                  a = jump_toport(a);
                  <B><FONT COLOR="#A020F0">if</FONT></B> (a) {      <I><FONT COLOR="#B22222">// port
</FONT></I>                    <B><FONT COLOR="#228B22">int</FONT></B> port = 0;
                    <B><FONT COLOR="#228B22">int</FONT></B> defport = 80;
                    <B><FONT COLOR="#228B22">char</FONT></B> *b = a + 1;

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
                    <I><FONT COLOR="#B22222">// FIXME
</FONT></I>                    <I><FONT COLOR="#B22222">//if (strfield(adr, &quot;https:&quot;)) {
</FONT></I>                    <I><FONT COLOR="#B22222">//}
</FONT></I>#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                    <B><FONT COLOR="#A020F0">while</FONT></B>(isdigit((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) *b)) {
                      port *= 10;
                      port += (<B><FONT COLOR="#228B22">int</FONT></B>) (*b - <B><FONT COLOR="#BC8F8F">'0'</FONT></B>);
                      b++;
                    }
                    <B><FONT COLOR="#A020F0">if</FONT></B> (port == defport) {      <I><FONT COLOR="#B22222">// port 80, default - c'est débile
</FONT></I>                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];

                      tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                      strncatbuff(tempo, lien, a - lien);
                      strcatbuff(tempo, a + 3); <I><FONT COLOR="#B22222">// sauter :80
</FONT></I>                      strcpybuff(lien, tempo);
                    }
                  }
                }
                <I><FONT COLOR="#B22222">// filtrer les parazites (mailto &amp; cie)
</FONT></I>                <I><FONT COLOR="#B22222">/*
                   if (strfield(lien,&quot;mailto:&quot;)) {  // ne pas traiter
                   error=1;
                   } else if (strfield(lien,&quot;news:&quot;)) {  // ne pas traiter
                   error=1;
                   }
                 */</FONT></I>

                <I><FONT COLOR="#B22222">// vérifier que l'on ne doit pas ajouter de .class
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (!error) {
                  <B><FONT COLOR="#A020F0">if</FONT></B> (add_class) {
                    <B><FONT COLOR="#228B22">char</FONT></B> *a = lien + strlen(lien) - 1;

                    <B><FONT COLOR="#A020F0">while</FONT></B>((a &gt; lien) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'.'</FONT></B>))
                      a--;
                    <B><FONT COLOR="#A020F0">if</FONT></B> (*a != <B><FONT COLOR="#BC8F8F">'.'</FONT></B>)
                      strcatbuff(lien, <B><FONT COLOR="#BC8F8F">&quot;.class&quot;</FONT></B>);       <I><FONT COLOR="#B22222">// ajouter .class
</FONT></I>                    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (!strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;.class&quot;</FONT></B>))
                      strcatbuff(lien, <B><FONT COLOR="#BC8F8F">&quot;.class&quot;</FONT></B>);       <I><FONT COLOR="#B22222">// idem
</FONT></I>                  }
                }
                <I><FONT COLOR="#B22222">// si c'est un chemin, alors vérifier (toto/toto.html -&gt; http://www/toto/)
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (!error) {
                  hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;position link check %s&quot;</FONT></B>, lien);

                  <B><FONT COLOR="#A020F0">if</FONT></B> ((p_type == 2) || (p_type == -2)) {        <I><FONT COLOR="#B22222">// code ou codebase                        
</FONT></I>                    <I><FONT COLOR="#B22222">// Vérifier les codebase=applet (au lieu de applet/)
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (p_type == -2) { <I><FONT COLOR="#B22222">// codebase
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(lien)) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> (lien[strlen(lien) - 1] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {     <I><FONT COLOR="#B22222">// pas répertoire
</FONT></I>                          strcatbuff(lien, <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                        }
                      }
                    }

                    <I><FONT COLOR="#B22222">/* base has always authority */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (p_type == 2 &amp;&amp; !link_has_authority(lien)) {
                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tmp[HTS_URLMAXSIZE * 2];

                      strcpybuff(tmp, <B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>);
                      strcatbuff(tmp, lien);
                      strcpybuff(lien, tmp);
                    }

                    <I><FONT COLOR="#B22222">/* only one ending / (bug on some pages) */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (strlen(lien) &gt; 2) {
                      size_t len = strlen(lien);

                      <B><FONT COLOR="#A020F0">while</FONT></B>(len &gt; 1 &amp;&amp; lien[len - 1] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B> &amp;&amp; lien[len - 2] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)    <I><FONT COLOR="#B22222">/* double // (bug) */</FONT></I>
                        lien[--len] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                    }
                    <I><FONT COLOR="#B22222">// copier nom host si besoin est
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(lien)) {    <I><FONT COLOR="#B22222">// pas de http://
</FONT></I>                      lien_adrfil af2;   <I><FONT COLOR="#B22222">// ** euh ident_url_relatif??
</FONT></I>
                      <B><FONT COLOR="#A020F0">if</FONT></B> (ident_url_relatif(lien, urladr(), urlfil(), &amp;af2) &lt; 0) {
                        error = 1;
                      } <B><FONT COLOR="#A020F0">else</FONT></B> {
                        strcpybuff(lien, <B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>);
                        strcatbuff(lien, af2.adr);
                        <B><FONT COLOR="#A020F0">if</FONT></B> (*af2.fil != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                          strcatbuff(lien, <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                        strcatbuff(lien, af2.fil);
                        {
                          <B><FONT COLOR="#228B22">char</FONT></B> *a;

                          a = lien + strlen(lien) - 1;
                          <B><FONT COLOR="#A020F0">while</FONT></B>((*a) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) &amp;&amp; (a &gt; lien))
                            a--;
                          <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {
                            *(a + 1) = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                          }
                        }
                        <I><FONT COLOR="#B22222">//char BIGSTK tempo[HTS_URLMAXSIZE*2];
</FONT></I>                        <I><FONT COLOR="#B22222">//strcpybuff(tempo,&quot;http://&quot;);
</FONT></I>                        <I><FONT COLOR="#B22222">//strcatbuff(tempo,urladr());    // host
</FONT></I>                        <I><FONT COLOR="#B22222">//if (*lien!='/')
</FONT></I>                        <I><FONT COLOR="#B22222">//  strcatbuff(tempo,&quot;/&quot;);
</FONT></I>                        <I><FONT COLOR="#B22222">//strcatbuff(tempo,lien);
</FONT></I>                        <I><FONT COLOR="#B22222">//strcpybuff(lien,tempo);
</FONT></I>                      }
                    }

                    <B><FONT COLOR="#A020F0">if</FONT></B> (!error) {       <I><FONT COLOR="#B22222">// pas d'erreur?
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (p_type == 2) {        <I><FONT COLOR="#B22222">// code ET PAS codebase      
</FONT></I>                        <B><FONT COLOR="#228B22">char</FONT></B> *a = lien + strlen(lien) - 1;
                        <B><FONT COLOR="#228B22">char</FONT></B> *start_of_filename = jump_identification(lien);

                        <B><FONT COLOR="#A020F0">if</FONT></B> (start_of_filename != NULL
                            &amp;&amp; (start_of_filename =
                                strchr(start_of_filename, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)) != NULL)
                          start_of_filename++;
                        <B><FONT COLOR="#A020F0">if</FONT></B> (start_of_filename == NULL)
                          strcatbuff(lien, <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                        <B><FONT COLOR="#A020F0">while</FONT></B>((a &gt; lien) &amp;&amp; (*a) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>))
                          a--;
                        <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {        <I><FONT COLOR="#B22222">// ok on a repéré le dernier /
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (start_of_filename != NULL
                              &amp;&amp; a + 1 &gt;= start_of_filename) {
                            *(a + 1) = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;    <I><FONT COLOR="#B22222">// couper
</FONT></I>                          }
                        } <B><FONT COLOR="#A020F0">else</FONT></B> {
                          *lien = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; <I><FONT COLOR="#B22222">// éliminer
</FONT></I>                          error = 1;    <I><FONT COLOR="#B22222">// erreur, ne pas poursuivre
</FONT></I>                        }
                      }
                      <I><FONT COLOR="#B22222">// stocker base ou codebase?
</FONT></I>                      <B><FONT COLOR="#A020F0">switch</FONT></B> (p_type) {
                      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">2</FONT></B>:{
                          <I><FONT COLOR="#B22222">//if (*lien!='/') strcatbuff(base,&quot;/&quot;);
</FONT></I>                          strcpybuff(base, lien);
                        }
                        <B><FONT COLOR="#A020F0">break</FONT></B>;  <I><FONT COLOR="#B22222">// base
</FONT></I>                      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">-2</FONT></B>:{
                          <I><FONT COLOR="#B22222">//if (*lien!='/') strcatbuff(codebase,&quot;/&quot;);
</FONT></I>                          strcpybuff(codebase, lien);
                        }
                        <B><FONT COLOR="#A020F0">break</FONT></B>;  <I><FONT COLOR="#B22222">// base
</FONT></I>                      }

                      hts_log_print(opt, LOG_DEBUG,
                                    <B><FONT COLOR="#BC8F8F">&quot;code/codebase link %s base %s&quot;</FONT></B>, lien,
                                    base);
                      <I><FONT COLOR="#B22222">//printf(&quot;base code: %s - %s\n&quot;,lien,base);
</FONT></I>                    }

                  } <B><FONT COLOR="#A020F0">else</FONT></B> {
                    <B><FONT COLOR="#228B22">char</FONT></B> *_base;

                    <B><FONT COLOR="#A020F0">if</FONT></B> (p_type == -1)   <I><FONT COLOR="#B22222">// code (applet)
</FONT></I>                      _base = codebase;
                    <B><FONT COLOR="#A020F0">else</FONT></B>
                      _base = base;

                    <I><FONT COLOR="#B22222">// ajouter chemin de base href..
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(_base)) {   <I><FONT COLOR="#B22222">// considérer base
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(lien)) {  <I><FONT COLOR="#B22222">// non absolue
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> (*lien != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {     <I><FONT COLOR="#B22222">// non absolu sur le site (/)
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> ((strlen(_base) + strlen(lien)) &lt; HTS_URLMAXSIZE) {
                            <I><FONT COLOR="#B22222">// mailto: and co: do NOT add base
</FONT></I>                            <B><FONT COLOR="#A020F0">if</FONT></B> (ident_url_relatif
                                (lien, urladr(), urlfil(), &amp;afs.af) &gt;= 0) {
                              <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];

                              <I><FONT COLOR="#B22222">// base est absolue
</FONT></I>                              strcpybuff(tempo, _base);
                              strcatbuff(tempo,
                                         lien + ((*lien == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) ? 1 : 0));
                              strcpybuff(lien, tempo);  <I><FONT COLOR="#B22222">// patcher en considérant base
</FONT></I>                              <I><FONT COLOR="#B22222">// ** vérifier que ../ fonctionne (ne doit pas arriver mais bon..)
</FONT></I>
                              hts_log_print(opt, LOG_DEBUG,
                                            <B><FONT COLOR="#BC8F8F">&quot;link modified with code/codebase %s&quot;</FONT></B>,
                                            lien);
                            }
                          } <B><FONT COLOR="#A020F0">else</FONT></B> {
                            error = 1;  <I><FONT COLOR="#B22222">// erreur
</FONT></I>                            hts_log_print(opt, LOG_ERROR,
                                          <B><FONT COLOR="#BC8F8F">&quot;Link %s too long with base href&quot;</FONT></B>,
                                          lien);
                          }
                        } <B><FONT COLOR="#A020F0">else</FONT></B> {
                          lien_adrfil baseaf;
                          <B><FONT COLOR="#A020F0">if</FONT></B> (ident_url_absolute(_base, &amp;baseaf) &gt;= 0) {
                            <B><FONT COLOR="#A020F0">if</FONT></B> ((strlen(baseaf.adr) + strlen(lien)) &lt; HTS_URLMAXSIZE) {
                              <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];

                              <I><FONT COLOR="#B22222">// base est absolue
</FONT></I>                              tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                              <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(baseaf.adr)) {
                                strcatbuff(tempo, <B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>);
                              }
                              strcatbuff(tempo, baseaf.adr);
                              strcatbuff(tempo, lien);
                              strcpybuff(lien, tempo);  <I><FONT COLOR="#B22222">// patcher en considérant base
</FONT></I>
                              hts_log_print(opt, LOG_DEBUG,
                                            <B><FONT COLOR="#BC8F8F">&quot;link modified with code/codebase %s&quot;</FONT></B>,
                                            lien);
                            } <B><FONT COLOR="#A020F0">else</FONT></B> {
                              error = 1;        <I><FONT COLOR="#B22222">// erreur
</FONT></I>                              hts_log_print(opt, LOG_ERROR,
                                            <B><FONT COLOR="#BC8F8F">&quot;Link %s too long with base href&quot;</FONT></B>,
                                            lien);
                            }
                          }
                        }
                      }
                    }

                  }
                }
                <I><FONT COLOR="#B22222">// transformer lien quelconque (http, relatif, etc) en une adresse
</FONT></I>                <I><FONT COLOR="#B22222">// et un chemin+fichier (adr,fil)
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (!error) {
                  <B><FONT COLOR="#228B22">int</FONT></B> reponse;

                  hts_log_print(opt, LOG_DEBUG,
                                <B><FONT COLOR="#BC8F8F">&quot;build relative link %s with %s%s&quot;</FONT></B>, lien,
                                relativeurladr(), relativeurlfil());
                  <B><FONT COLOR="#A020F0">if</FONT></B> ((reponse =
                       ident_url_relatif(lien, relativeurladr(), relativeurlfil(),
                                         &amp;afs.af)) &lt; 0) {
                    afs.af.adr[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;      <I><FONT COLOR="#B22222">// erreur
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (reponse == -2) {
                      hts_log_print(opt, LOG_WARNING,
                                    <B><FONT COLOR="#BC8F8F">&quot;Link %s not caught (unknown protocol)&quot;</FONT></B>,
                                    lien);
                    } <B><FONT COLOR="#A020F0">else</FONT></B> {
                      hts_log_print(opt, LOG_DEBUG,
                                    <B><FONT COLOR="#BC8F8F">&quot;ident_url_relatif failed for %s with %s%s&quot;</FONT></B>,
                                    lien, relativeurladr(), relativeurlfil());
                    }
                  } <B><FONT COLOR="#A020F0">else</FONT></B> {
                    hts_log_print(opt, LOG_DEBUG,
                                  <B><FONT COLOR="#BC8F8F">&quot;built relative link %s with %s%s -&gt; %s%s&quot;</FONT></B>,
                                  lien, relativeurladr(), relativeurlfil(), afs.af.adr,
                                  afs.af.fil);
                  }
                } <B><FONT COLOR="#A020F0">else</FONT></B> {
                  hts_log_print(opt, LOG_DEBUG,
                                <B><FONT COLOR="#BC8F8F">&quot;link %s not build, error detected before&quot;</FONT></B>,
                                lien);
                  afs.af.adr[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                }

                <I><FONT COLOR="#B22222">// Le lien doit juste être réécrit, mais ne doit pas générer un lien
</FONT></I>                <I><FONT COLOR="#B22222">// exemple: &lt;FORM ACTION=&quot;url_cgi&quot;&gt;
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (p_nocatch) {
                  forbidden_url = 1;    <I><FONT COLOR="#B22222">// interdire récupération du lien
</FONT></I>                  hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;link forced external at %s%s&quot;</FONT></B>,
                                afs.af.adr, afs.af.fil);
                }
                <I><FONT COLOR="#B22222">// Tester si un lien doit être accepté ou refusé (wizard)
</FONT></I>                <I><FONT COLOR="#B22222">// forbidden_url=1 : lien refusé
</FONT></I>                <I><FONT COLOR="#B22222">// forbidden_url=0 : lien accepté
</FONT></I>                <I><FONT COLOR="#B22222">//if ((ptr&gt;0) &amp;&amp; (p_type!=2) &amp;&amp; (p_type!=-2)) {    // tester autorisations?
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> ((p_type != 2) &amp;&amp; (p_type != -2)) {  <I><FONT COLOR="#B22222">// tester autorisations?
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (!p_nocatch) {
                    <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.adr[0] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
                      hts_log_print(opt, LOG_DEBUG,
                                    <B><FONT COLOR="#BC8F8F">&quot;wizard link test at %s%s..&quot;</FONT></B>, afs.af.adr, afs.af.fil);
                      forbidden_url =
                        hts_acceptlink(opt, ptr, afs.af.adr, afs.af.fil,
                                       intag_name ? intag_name : NULL,
                                       intag_name ? tag_attr_start : NULL,
                                       &amp;set_prio_to, &amp;just_test_it);
                      hts_log_print(opt, LOG_DEBUG,
                                    <B><FONT COLOR="#BC8F8F">&quot;result for wizard link test: %d&quot;</FONT></B>,
                                    forbidden_url);
                    }
                  }
                }
                <I><FONT COLOR="#B22222">// calculer meme_adresse
</FONT></I>                meme_adresse =
                  strfield2(jump_identification_const(afs.af.adr),
                            jump_identification_const(urladr()));

                <I><FONT COLOR="#B22222">// Début partie sauvegarde
</FONT></I>
                <I><FONT COLOR="#B22222">// ici on forme le nom du fichier à sauver, et on patche l'URL
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.adr[0] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
                  <I><FONT COLOR="#B22222">// savename(): simplifier les ../ et autres joyeusetés
</FONT></I>                  <B><FONT COLOR="#228B22">int</FONT></B> r_sv = 0;

                  <I><FONT COLOR="#B22222">// En cas de moved, adresse première
</FONT></I>                  lien_adrfil former;

                  <I><FONT COLOR="#B22222">//
</FONT></I>                  afs.save[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                  former.adr[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                  former.fil[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                  <I><FONT COLOR="#B22222">//
</FONT></I>
                  <I><FONT COLOR="#B22222">// nom du chemin à sauver si on doit le calculer
</FONT></I>                  <I><FONT COLOR="#B22222">// note: url_savename peut décider de tester le lien si il le trouve
</FONT></I>                  <I><FONT COLOR="#B22222">// suspect, et modifier alors adr et fil
</FONT></I>                  <I><FONT COLOR="#B22222">// dans ce cas on aura une référence directe au lieu des traditionnels
</FONT></I>                  <I><FONT COLOR="#B22222">// moved en cascade (impossible à reproduire à priori en local, lorsque des fichiers
</FONT></I>                  <I><FONT COLOR="#B22222">// gif sont impliqués par exemple)
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> ((p_type != 2) &amp;&amp; (p_type != -2)) {        <I><FONT COLOR="#B22222">// pas base href ou codebase
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (forbidden_url != 1) {
                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK last_adr[HTS_URLMAXSIZE * 2];

                      <I><FONT COLOR="#B22222">/* Calc */</FONT></I>
                      last_adr[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                      <I><FONT COLOR="#B22222">//char last_fil[HTS_URLMAXSIZE*2]=&quot;&quot;;
</FONT></I>                      strcpybuff(last_adr, afs.af.adr);        <I><FONT COLOR="#B22222">// ancienne adresse
</FONT></I>                      <I><FONT COLOR="#B22222">//strcpybuff(last_fil,fil);    // ancien chemin
</FONT></I>                      r_sv =
                        url_savename(&amp;afs, &amp;former, heap(ptr)-&gt;adr, heap(ptr)-&gt;fil, opt,
                                     sback, cache, hash, ptr,
                                     numero_passe, NULL);
                      <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(jump_identification_const(last_adr),
                        jump_identification_const(afs.af.adr)) != 0) {       <I><FONT COLOR="#B22222">// a changé
</FONT></I>
                        <I><FONT COLOR="#B22222">// 2e test si moved
</FONT></I>
                        <I><FONT COLOR="#B22222">// Tester si un lien doit être accepté ou refusé (wizard)
</FONT></I>                        <I><FONT COLOR="#B22222">// forbidden_url=1 : lien refusé
</FONT></I>                        <I><FONT COLOR="#B22222">// forbidden_url=0 : lien accepté
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> ((ptr &gt; 0) &amp;&amp; (p_type != 2) &amp;&amp; (p_type != -2)) {     <I><FONT COLOR="#B22222">// tester autorisations?
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!p_nocatch) {
                            <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.adr[0] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
                              hts_log_print(opt, LOG_DEBUG,
                                            <B><FONT COLOR="#BC8F8F">&quot;wizard moved link retest at %s%s..&quot;</FONT></B>,
                                            afs.af.adr, afs.af.fil);
                              forbidden_url =
                                hts_acceptlink(opt, ptr, afs.af.adr, afs.af.fil,
                                               intag_name ? intag_name : NULL,
                                               intag_name ? tag_attr_start :
                                               NULL, &amp;set_prio_to,
                                               &amp;just_test_it);
                              hts_log_print(opt, LOG_DEBUG,
                                            <B><FONT COLOR="#BC8F8F">&quot;result for wizard moved link retest: %d&quot;</FONT></B>,
                                            forbidden_url);
                            }
                          }
                        }
                        <I><FONT COLOR="#B22222">//import_done=1;    // c'est un import!
</FONT></I>                        meme_adresse = 0;       <I><FONT COLOR="#B22222">// on a changé
</FONT></I>                      }
                    } <B><FONT COLOR="#A020F0">else</FONT></B> {
                      strcpybuff(afs.save, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);     <I><FONT COLOR="#B22222">// dummy
</FONT></I>                    }
                  }
                  <I><FONT COLOR="#B22222">// resolve unresolved type
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (r_sv != -1 &amp;&amp; p_type != 2 &amp;&amp; p_type != -2
                      &amp;&amp; forbidden_url == 0 &amp;&amp; IS_DELAYED_EXT(afs.save)
                    ) {
                    time_t t;

                    <I><FONT COLOR="#B22222">// pas d'erreur, on continue
</FONT></I>                    r_sv =
                      hts_wait_delayed(str, &amp;afs, heap(ptr)-&gt;adr,
                                       heap(ptr)-&gt;fil, &amp;former,
                                       &amp;forbidden_url);

                    <I><FONT COLOR="#B22222">/* User interaction, because hts_wait_delayed can be slow.. (3.43) */</FONT></I>
                    t = time(NULL);
                    <B><FONT COLOR="#A020F0">if</FONT></B> (user_interact_timestamp == 0
                        || t - user_interact_timestamp &gt; 0) {
                      user_interact_timestamp = t;
                      ENGINE_SAVE_CONTEXT();
                      {
                        hts_mirror_process_user_interaction(str, stre);
                      }
                      ENGINE_SET_CONTEXT();
                    }
                  }
                  <I><FONT COLOR="#B22222">// record!
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (r_sv != -1) {     <I><FONT COLOR="#B22222">// pas d'erreur, on continue
</FONT></I>                    <I><FONT COLOR="#B22222">/* log */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;debug &gt; 1) &amp;&amp; (opt-&gt;log != NULL)) {
                      <B><FONT COLOR="#A020F0">if</FONT></B> (forbidden_url != 1) { <I><FONT COLOR="#B22222">// le lien va être chargé
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> ((p_type == 2) || (p_type == -2)) {  <I><FONT COLOR="#B22222">// base href ou codebase, pas un lien
</FONT></I>                          hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Code/Codebase: %s%s&quot;</FONT></B>,
                                        afs.af.adr, afs.af.fil);
                        } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 4) == 0) {
                          hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Record: %s%s -&gt; %s&quot;</FONT></B>,
                                        afs.af.adr, afs.af.fil, afs.save);
                        } <B><FONT COLOR="#A020F0">else</FONT></B> {
                          <B><FONT COLOR="#A020F0">if</FONT></B> (!ishtml(opt, afs.af.fil))
                            hts_log_print(opt, LOG_DEBUG,
                                          <B><FONT COLOR="#BC8F8F">&quot;Record after: %s%s -&gt; %s&quot;</FONT></B>, afs.af.adr, afs.af.fil,
                                          afs.save);
                          <B><FONT COLOR="#A020F0">else</FONT></B>
                            hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Record: %s%s -&gt; %s&quot;</FONT></B>,
                                          afs.af.adr, afs.af.fil, afs.save);
                        }
                      } <B><FONT COLOR="#A020F0">else</FONT></B>
                        hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;External: %s%s&quot;</FONT></B>, afs.af.adr,
                                      afs.af.fil);
                    }
                    <I><FONT COLOR="#B22222">/* FIN log */</FONT></I>

                    <I><FONT COLOR="#B22222">// écrire lien
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> ((p_type == 2) || (p_type == -2)) {      <I><FONT COLOR="#B22222">// base href ou codebase, sauter
</FONT></I>                      lastsaved = eadr - 1 + 1; <I><FONT COLOR="#B22222">// sauter &quot;
</FONT></I>                    }
                    <I><FONT COLOR="#B22222">/* */</FONT></I>
                    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;urlmode == 0) {       <I><FONT COLOR="#B22222">// URL absolue dans tous les cas
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {    <I><FONT COLOR="#B22222">// ecrire les html
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(afs.af.adr)) {
                          HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>);
                        } <B><FONT COLOR="#A020F0">else</FONT></B> {
                          <B><FONT COLOR="#228B22">char</FONT></B> *aut = strstr(afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);

                          <B><FONT COLOR="#A020F0">if</FONT></B> (aut) {
                            <B><FONT COLOR="#228B22">char</FONT></B> tmp[256];

                            tmp[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            strncatbuff(tmp, afs.af.adr, aut - afs.af.adr);   <I><FONT COLOR="#B22222">// scheme
</FONT></I>                            HT_ADD(tmp);        <I><FONT COLOR="#B22222">// Protocol
</FONT></I>                            HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);
                          }
                        }

                        <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;passprivacy) {
                          HT_ADD_HTMLESCAPED(jump_protocol_const(afs.af.adr));       <I><FONT COLOR="#B22222">// Password
</FONT></I>                        } <B><FONT COLOR="#A020F0">else</FONT></B> {
                          HT_ADD_HTMLESCAPED(jump_identification_const(afs.af.adr)); <I><FONT COLOR="#B22222">// No Password
</FONT></I>                        }
                        <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.fil[0] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                          HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                        HT_ADD_HTMLESCAPED(afs.af.fil);
                      }
                      lastsaved = eadr - 1;     <I><FONT COLOR="#B22222">// dernier écrit+1 (enfin euh apres on fait un ++ alors hein)
</FONT></I>                      <I><FONT COLOR="#B22222">/* */</FONT></I>
                    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;urlmode == 4) {     <I><FONT COLOR="#B22222">// ne rien faire!
</FONT></I>                      <I><FONT COLOR="#B22222">/* */</FONT></I>
                      <I><FONT COLOR="#B22222">/* leave the link 'as is' */</FONT></I>
                      <I><FONT COLOR="#B22222">/* Sinon, dépend de interne/externe */</FONT></I>
                    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (forbidden_url == 1) {    <I><FONT COLOR="#B22222">// le lien ne sera pas chargé, référence externe!
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> (p_type != -1) {     <I><FONT COLOR="#B22222">// pas que le nom de fichier (pas classe java)
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;external) {
                            <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(afs.af.adr)) {
                              HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>);
                              <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;passprivacy) {
                                HT_ADD_HTMLESCAPED(afs.af.adr);        <I><FONT COLOR="#B22222">// Password
</FONT></I>                              } <B><FONT COLOR="#A020F0">else</FONT></B> {
                                HT_ADD_HTMLESCAPED(jump_identification_const(afs.af.adr));   <I><FONT COLOR="#B22222">// No Password
</FONT></I>                              }
                              <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.fil[0] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                                HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                              HT_ADD_HTMLESCAPED(afs.af.fil);
                            } <B><FONT COLOR="#A020F0">else</FONT></B> {
                              <B><FONT COLOR="#228B22">char</FONT></B> *aut = strstr(afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);

                              <B><FONT COLOR="#A020F0">if</FONT></B> (aut) {
                                <B><FONT COLOR="#228B22">char</FONT></B> tmp[256];

                                tmp[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                                strncatbuff(tmp, afs.af.adr, (aut - afs.af.adr));       <I><FONT COLOR="#B22222">// scheme
</FONT></I>                                HT_ADD(tmp);    <I><FONT COLOR="#B22222">// Protocol
</FONT></I>                                HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);
                                <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;passprivacy) {
                                  HT_ADD_HTMLESCAPED(jump_protocol_const(afs.af.adr));       <I><FONT COLOR="#B22222">// Password
</FONT></I>                                } <B><FONT COLOR="#A020F0">else</FONT></B> {
                                  HT_ADD_HTMLESCAPED(jump_identification_const(afs.af.adr)); <I><FONT COLOR="#B22222">// No Password
</FONT></I>                                }
                                <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.fil[0] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                                  HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                                HT_ADD_HTMLESCAPED(afs.af.fil);
                              }
                            }
                            <I><FONT COLOR="#B22222">//
</FONT></I>                          } <B><FONT COLOR="#A020F0">else</FONT></B> {      <I><FONT COLOR="#B22222">// fichier/page externe, mais on veut générer une erreur
</FONT></I>                            <I><FONT COLOR="#B22222">//
</FONT></I>                            <B><FONT COLOR="#228B22">int</FONT></B> patch_it = 0;
                            <B><FONT COLOR="#228B22">int</FONT></B> add_url = 0;
                            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *cat_name = NULL;
                            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *cat_data = NULL;
                            <B><FONT COLOR="#228B22">int</FONT></B> cat_nb = 0;
                            <B><FONT COLOR="#228B22">int</FONT></B> cat_data_len = 0;

                            <I><FONT COLOR="#B22222">// ajouter lien external
</FONT></I>                            <B><FONT COLOR="#A020F0">switch</FONT></B> ((link_has_authority(afs.af.adr)) ? 1
                                    : ((afs.af.fil[strlen(afs.af.fil) - 1] ==
                                        <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) ? 1 : (ishtml(opt, afs.af.fil)))) {
                            <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">1</FONT></B>:
                            <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">-2</FONT></B>:   <I><FONT COLOR="#B22222">// html ou répertoire
</FONT></I>                              <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;getmode &amp; 1) {   <I><FONT COLOR="#B22222">// sauver html
</FONT></I>                                patch_it = 1;   <I><FONT COLOR="#B22222">// redirect
</FONT></I>                                add_url = 1;    <I><FONT COLOR="#B22222">// avec link?
</FONT></I>                                cat_name = <B><FONT COLOR="#BC8F8F">&quot;external.html&quot;</FONT></B>;
                                cat_nb = 0;
                                cat_data = HTS_DATA_UNKNOWN_HTML;
                                cat_data_len = HTS_DATA_UNKNOWN_HTML_LEN;
                              }
                              <B><FONT COLOR="#A020F0">break</FONT></B>;
                            <B><FONT COLOR="#5F9EA0">default</FONT></B>:   <I><FONT COLOR="#B22222">// inconnu
</FONT></I>                              <I><FONT COLOR="#B22222">// asp, cgi..
</FONT></I>                              <B><FONT COLOR="#A020F0">if</FONT></B> ((strfield2
                                   (afs.af.fil + max(0, strlen(afs.af.fil) - 4),
                                    <B><FONT COLOR="#BC8F8F">&quot;.gif&quot;</FONT></B>))
                                  ||
                                  (strfield2
                                   (afs.af.fil + max(0, strlen(afs.af.fil) - 4),
                                    <B><FONT COLOR="#BC8F8F">&quot;.jpg&quot;</FONT></B>))
                                  ||
                                  (strfield2
                                   (afs.af.fil + max(0, strlen(afs.af.fil) - 4),
                                    <B><FONT COLOR="#BC8F8F">&quot;.xbm&quot;</FONT></B>))
                                  <I><FONT COLOR="#B22222">/*|| (ishtml(opt,fil)!=0) */</FONT></I>
                                ) {
                                patch_it = 1;   <I><FONT COLOR="#B22222">// redirect
</FONT></I>                                add_url = 1;    <I><FONT COLOR="#B22222">// avec link aussi
</FONT></I>                                cat_name = <B><FONT COLOR="#BC8F8F">&quot;external.gif&quot;</FONT></B>;
                                cat_nb = 1;
                                cat_data = HTS_DATA_UNKNOWN_GIF;
                                cat_data_len = HTS_DATA_UNKNOWN_GIF_LEN;
                              } <B><FONT COLOR="#A020F0">else</FONT></B> {  <I><FONT COLOR="#B22222">/* if (is_dyntype(get_ext(fil))) */</FONT></I>

                                patch_it = 1;   <I><FONT COLOR="#B22222">// redirect
</FONT></I>                                add_url = 1;    <I><FONT COLOR="#B22222">// avec link?
</FONT></I>                                cat_name = <B><FONT COLOR="#BC8F8F">&quot;external.html&quot;</FONT></B>;
                                cat_nb = 0;
                                cat_data = HTS_DATA_UNKNOWN_HTML;
                                cat_data_len = HTS_DATA_UNKNOWN_HTML_LEN;
                              }
                              <B><FONT COLOR="#A020F0">break</FONT></B>;
                            }   <I><FONT COLOR="#B22222">// html,gif
</FONT></I>
                            <B><FONT COLOR="#A020F0">if</FONT></B> (patch_it) {
                              <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK save[HTS_URLMAXSIZE * 2];
                              <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];

                              strcpybuff(save, StringBuff(opt-&gt;path_html_utf8));
                              strcatbuff(save, cat_name);
                              <B><FONT COLOR="#A020F0">if</FONT></B> (lienrelatif(tempo, save, relativesavename()) == 0) {
                                <I><FONT COLOR="#B22222">/* Never escape high-chars (we don't know the encoding!!) */</FONT></I>
                                inplace_escape_uri_utf(tempo, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(tempo));  <I><FONT COLOR="#B22222">// escape with %xx
</FONT></I>                                <I><FONT COLOR="#B22222">//if (!no_esc_utf)
</FONT></I>                                <I><FONT COLOR="#B22222">//  escape_uri(tempo);     // escape with %xx
</FONT></I>                                <I><FONT COLOR="#B22222">//else
</FONT></I>                                <I><FONT COLOR="#B22222">//  escape_uri_utf(tempo);     // escape with %xx
</FONT></I>                                HT_ADD_HTMLESCAPED(tempo);      <I><FONT COLOR="#B22222">// page externe
</FONT></I>                                <B><FONT COLOR="#A020F0">if</FONT></B> (add_url) {
                                  HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;?link=&quot;</FONT></B>);     <I><FONT COLOR="#B22222">// page externe
</FONT></I>
                                  <I><FONT COLOR="#B22222">// same as above
</FONT></I>                                  <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(afs.af.adr)) {
                                    HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>);
                                    <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;passprivacy) {
                                      HT_ADD_HTMLESCAPED(afs.af.adr);  <I><FONT COLOR="#B22222">// Password
</FONT></I>                                    } <B><FONT COLOR="#A020F0">else</FONT></B> {
                                      HT_ADD_HTMLESCAPED(jump_identification_const(afs.af.adr));     <I><FONT COLOR="#B22222">// No Password
</FONT></I>                                    }
                                    <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.fil[0] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                                      HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                                    HT_ADD_HTMLESCAPED(afs.af.fil);
                                  } <B><FONT COLOR="#A020F0">else</FONT></B> {
                                    <B><FONT COLOR="#228B22">char</FONT></B> *aut = strstr(afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);

                                    <B><FONT COLOR="#A020F0">if</FONT></B> (aut) {
                                      <B><FONT COLOR="#228B22">char</FONT></B> tmp[256];

                                      tmp[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                                      strncatbuff(tmp, afs.af.adr, (aut - afs.af.adr) + 2);     <I><FONT COLOR="#B22222">// scheme
</FONT></I>                                      HT_ADD(tmp);
                                      <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;passprivacy) {
                                        HT_ADD_HTMLESCAPED(jump_protocol_const(afs.af.adr)); <I><FONT COLOR="#B22222">// Password
</FONT></I>                                      } <B><FONT COLOR="#A020F0">else</FONT></B> {
                                        HT_ADD_HTMLESCAPED(jump_identification_const(afs.af.adr));   <I><FONT COLOR="#B22222">// No Password
</FONT></I>                                      }
                                      <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.fil[0] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                                        HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                                      HT_ADD_HTMLESCAPED(afs.af.fil);
                                    }
                                  }
                                  <I><FONT COLOR="#B22222">//
</FONT></I>
                                }
                              }
                              <I><FONT COLOR="#B22222">// écrire fichier?
</FONT></I>                              <B><FONT COLOR="#A020F0">if</FONT></B> (verif_external(opt, cat_nb, 1)) {
                                FILE *fp =
                                  filecreate(&amp;opt-&gt;state.strc,
                                             fconcat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), 
                                                     StringBuff(opt-&gt;
                                                                path_html_utf8),
                                                     cat_name));
                                <B><FONT COLOR="#A020F0">if</FONT></B> (fp) {
                                  <B><FONT COLOR="#A020F0">if</FONT></B> (cat_data_len == 0) {      <I><FONT COLOR="#B22222">// texte
</FONT></I>                                    verif_backblue(opt,
                                                   StringBuff(opt-&gt;
                                                              path_html_utf8));
                                    fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;%s%s&quot;</FONT></B>,
                                            <B><FONT COLOR="#BC8F8F">&quot;&lt;!-- Created by HTTrack Website Copier/&quot;</FONT></B>
                                            HTTRACK_VERSION <B><FONT COLOR="#BC8F8F">&quot; &quot;</FONT></B>
                                            HTTRACK_AFF_AUTHORS <B><FONT COLOR="#BC8F8F">&quot; --&gt;&quot;</FONT></B> LF,
                                            cat_data);
                                  } <B><FONT COLOR="#A020F0">else</FONT></B> {      <I><FONT COLOR="#B22222">// data
</FONT></I>                                    fwrite(cat_data, cat_data_len, 1, fp);
                                  }
                                  fclose(fp);
                                  usercommand(opt, 0, NULL,
                                              fconcat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), 
                                                      StringBuff(opt-&gt;
                                                                 path_html_utf8),
                                                      cat_name), <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
                                }
                              }
                            } <B><FONT COLOR="#A020F0">else</FONT></B> {    <I><FONT COLOR="#B22222">// écrire normalement le nom de fichier
</FONT></I>                              HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>);
                              <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;passprivacy) {
                                HT_ADD_HTMLESCAPED(afs.af.adr);        <I><FONT COLOR="#B22222">// Password
</FONT></I>                              } <B><FONT COLOR="#A020F0">else</FONT></B> {
                                HT_ADD_HTMLESCAPED(jump_identification_const(afs.af.adr));   <I><FONT COLOR="#B22222">// No Password
</FONT></I>                              }
                              <B><FONT COLOR="#A020F0">if</FONT></B> (afs.af.fil[0] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                                HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                              HT_ADD_HTMLESCAPED(afs.af.fil);
                            }   <I><FONT COLOR="#B22222">// patcher?
</FONT></I>                          }     <I><FONT COLOR="#B22222">// external
</FONT></I>                        } <B><FONT COLOR="#A020F0">else</FONT></B> {        <I><FONT COLOR="#B22222">// que le nom de fichier (classe java)
</FONT></I>                          <I><FONT COLOR="#B22222">// en gros recopie de plus bas: copier codebase et base
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (p_flush) {
                            <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];      <I><FONT COLOR="#B22222">// &lt;-- ajouté
</FONT></I>                            <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo_pat[HTS_URLMAXSIZE * 2];

                            <I><FONT COLOR="#B22222">// Calculer chemin
</FONT></I>                            tempo_pat[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            strcpybuff(tempo, afs.af.fil);     <I><FONT COLOR="#B22222">// &lt;-- ajouté
</FONT></I>                            {
                              <B><FONT COLOR="#228B22">char</FONT></B> *a = strrchr(tempo, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);

                              <I><FONT COLOR="#B22222">// Example: we converted code=&quot;x.y.z.foo.class&quot; into &quot;x/y/z/foo.class&quot;
</FONT></I>                              <I><FONT COLOR="#B22222">// we have to do the contrary now
</FONT></I>                              <B><FONT COLOR="#A020F0">if</FONT></B> (add_class_dots_to_patch &gt; 0) {
                                <B><FONT COLOR="#A020F0">while</FONT></B>((add_class_dots_to_patch &gt; 0) &amp;&amp; (a)) {
                                  *a = <B><FONT COLOR="#BC8F8F">'.'</FONT></B>;     <I><FONT COLOR="#B22222">// convert &quot;false&quot; java / into .
</FONT></I>                                  add_class_dots_to_patch--;
                                  a = strrchr(tempo, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);
                                }
                                <I><FONT COLOR="#B22222">// if add_class_dots_to_patch, this is because there is a problem!!
</FONT></I>                                <B><FONT COLOR="#A020F0">if</FONT></B> (add_class_dots_to_patch) {
                                  hts_log_print(opt, LOG_WARNING,
                                                <B><FONT COLOR="#BC8F8F">&quot;Error: can not rewind java path %s, check html code&quot;</FONT></B>,
                                                tempo);
                                }
                              }
                              <I><FONT COLOR="#B22222">// Cut path/filename
</FONT></I>                              <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
                                <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo2[HTS_URLMAXSIZE * 2];

                                strcpybuff(tempo2, a + 1);      <I><FONT COLOR="#B22222">// FICHIER
</FONT></I>                                strncatbuff(tempo_pat, tempo, (a - tempo) + 1);   <I><FONT COLOR="#B22222">// chemin
</FONT></I>                                strcpybuff(tempo, tempo2);      <I><FONT COLOR="#B22222">// fichier
</FONT></I>                              }
                            }

                            <I><FONT COLOR="#B22222">// érire codebase=&quot;chemin&quot;
</FONT></I>                            <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                              <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo4[HTS_URLMAXSIZE * 2];

                              tempo4[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

                              <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(tempo_pat)) {
                                HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;codebase=\&quot;http://&quot;</FONT></B>);
                                <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;passprivacy) {
                                  HT_ADD_HTMLESCAPED(afs.af.adr);      <I><FONT COLOR="#B22222">// Password
</FONT></I>                                } <B><FONT COLOR="#A020F0">else</FONT></B> {
                                  HT_ADD_HTMLESCAPED(jump_identification_const(afs.af.adr)); <I><FONT COLOR="#B22222">// No Password
</FONT></I>                                }
                                <B><FONT COLOR="#A020F0">if</FONT></B> (*tempo_pat != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
                                  HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
                                HT_ADD(tempo_pat);
                                HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;\&quot; &quot;</FONT></B>);
                              }

                              strncatbuff(tempo4, lastsaved, p_flush - lastsaved);
                              HT_ADD(tempo4);   <I><FONT COLOR="#B22222">// refresh code=&quot;
</FONT></I>                              HT_ADD(tempo);
                            }
                          }
                        }
                      }
                      lastsaved = eadr - 1;
                    }
                    <I><FONT COLOR="#B22222">/*
                       else if (opt-&gt;urlmode==1) {    // ABSOLU, c'est le cas le moins courant
                       //  NE FONCTIONNE PAS!!  (et est inutile)
                       if ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr&gt;0)) {    // ecrire les html
                       // écrire le lien modifié, absolu
                       HT_ADD(&quot;file:&quot;);
                       if (*save=='/')
                       HT_ADD(save+1)
                       else
                       HT_ADD(save)
                       }
                       lastsaved=eadr-1;    // dernier écrit+1 (enfin euh apres on fait un ++ alors hein)
                       }
                     */</FONT></I>
                    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;mimehtml) {
                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK cid[HTS_URLMAXSIZE * 3];

                      HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;cid:&quot;</FONT></B>);
                      make_content_id(afs.af.adr, afs.af.fil, cid, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(cid));
                      HT_ADD_HTMLESCAPED(cid);
                      lastsaved = eadr - 1;     <I><FONT COLOR="#B22222">// dernier écrit+1 (enfin euh apres on fait un ++ alors hein)
</FONT></I>                    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;urlmode == 3) {     <I><FONT COLOR="#B22222">// URI absolue /
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {    <I><FONT COLOR="#B22222">// ecrire les html
</FONT></I>                        HT_ADD_HTMLESCAPED(afs.af.fil);
                      }
                      lastsaved = eadr - 1;     <I><FONT COLOR="#B22222">// dernier écrit+1 (enfin euh apres on fait un ++ alors hein)
</FONT></I>                    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;urlmode == 5) {     <I><FONT COLOR="#B22222">// transparent proxy URL
</FONT></I>                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];
                      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *uri;
                      <B><FONT COLOR="#228B22">int</FONT></B> i;
                      <B><FONT COLOR="#228B22">char</FONT></B> *pos;

                      <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {    <I><FONT COLOR="#B22222">// ecrire les html
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(afs.af.adr)) {
                          HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>);
                        } <B><FONT COLOR="#A020F0">else</FONT></B> {
                          <B><FONT COLOR="#228B22">char</FONT></B> *aut = strstr(afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);

                          <B><FONT COLOR="#A020F0">if</FONT></B> (aut) {
                            <B><FONT COLOR="#228B22">char</FONT></B> tmp[256];

                            tmp[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            strncatbuff(tmp, afs.af.adr, (aut - afs.af.adr));   <I><FONT COLOR="#B22222">// scheme
</FONT></I>                            HT_ADD(tmp);        <I><FONT COLOR="#B22222">// Protocol
</FONT></I>                            HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);
                          }
                        }

                        <I><FONT COLOR="#B22222">// filename is taken as URI (ex: &quot;C:\My Website\www.example.com\foo4242.html)
</FONT></I>                        uri = afs.save;

                        <I><FONT COLOR="#B22222">// .. after stripping the path prefix (ex: &quot;www.example.com\foo4242.html)
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(StringBuff(opt-&gt;path_html_utf8))) {
                          uri += StringLength(opt-&gt;path_html_utf8);
                          <B><FONT COLOR="#A020F0">for</FONT></B>(; uri[0] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B> || uri[0] == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>; uri++) ;
                        }
                        <I><FONT COLOR="#B22222">// and replacing all \ by / (ex: &quot;www.example.com/foo4242.html)
</FONT></I>                        strcpybuff(tempo, uri);
                        <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; tempo[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; i++) {
                          <B><FONT COLOR="#A020F0">if</FONT></B> (tempo[i] == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>) {
                            tempo[i] = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;
                          }
                        }

                        <I><FONT COLOR="#B22222">// put original query string if any (ex: &quot;www.example.com/foo4242.html?q=45)
</FONT></I>                        pos = strchr(afs.af.fil, <B><FONT COLOR="#BC8F8F">'?'</FONT></B>);
                        <B><FONT COLOR="#A020F0">if</FONT></B> (pos != NULL) {
                          strcatbuff(tempo, pos);
                        }
                        <I><FONT COLOR="#B22222">// write it
</FONT></I>                        HT_ADD_HTMLESCAPED(tempo);
                      }
                      lastsaved = eadr - 1;     <I><FONT COLOR="#B22222">// dernier écrit+1 (enfin euh apres on fait un ++ alors hein)
</FONT></I>                    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;urlmode == 2) {     <I><FONT COLOR="#B22222">// RELATIF
</FONT></I>                      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];

                      tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                      <I><FONT COLOR="#B22222">// calculer le lien relatif
</FONT></I>
                      <B><FONT COLOR="#A020F0">if</FONT></B> (lienrelatif(tempo, afs.save, relativesavename()) == 0) {
                        <B><FONT COLOR="#A020F0">if</FONT></B> (!in_media) {        <I><FONT COLOR="#B22222">// In media (such as real audio): don't patch
</FONT></I>                          <I><FONT COLOR="#B22222">/* Never escape high-chars (we don't know the encoding!!) */</FONT></I>
                          inplace_escape_uri_utf(tempo, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(tempo));

                          <I><FONT COLOR="#B22222">//if (!no_esc_utf)
</FONT></I>                          <I><FONT COLOR="#B22222">//  escape_uri(tempo);     // escape with %xx
</FONT></I>                          <I><FONT COLOR="#B22222">//else {
</FONT></I>                          <I><FONT COLOR="#B22222">//  /* No escaping at all - remaining upper chars will be escaped below */
</FONT></I>                          <I><FONT COLOR="#B22222">//  /* FIXME - Should be done in all local cases */
</FONT></I>                          <I><FONT COLOR="#B22222">//  //x_escape_html(tempo);
</FONT></I>                          <I><FONT COLOR="#B22222">//  //escape_uri_utf(tempo);     // FIXME - escape with %xx
</FONT></I>                          <I><FONT COLOR="#B22222">//  //escape_uri(tempo);     // escape with %xx
</FONT></I>                          <I><FONT COLOR="#B22222">//}
</FONT></I>                        }
                        hts_log_print(opt, LOG_DEBUG,
                                      <B><FONT COLOR="#BC8F8F">&quot;relative link at %s build with %s and %s: %s&quot;</FONT></B>,
                                      afs.af.adr, afs.save, relativesavename(), tempo);

                        <I><FONT COLOR="#B22222">// lien applet (code) - il faut placer un codebase avant
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> (p_type == -1) {     <I><FONT COLOR="#B22222">// que le nom de fichier
</FONT></I>
                          <B><FONT COLOR="#A020F0">if</FONT></B> (p_flush) {
                            <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo_pat[HTS_URLMAXSIZE * 2];

                            tempo_pat[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                            {
                              <B><FONT COLOR="#228B22">char</FONT></B> *a = strrchr(tempo, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);

                              <I><FONT COLOR="#B22222">// Example: we converted code=&quot;x.y.z.foo.class&quot; into &quot;x/y/z/foo.class&quot;
</FONT></I>                              <I><FONT COLOR="#B22222">// we have to do the contrary now
</FONT></I>                              <B><FONT COLOR="#A020F0">if</FONT></B> (add_class_dots_to_patch &gt; 0) {
                                <B><FONT COLOR="#A020F0">while</FONT></B>((add_class_dots_to_patch &gt; 0) &amp;&amp; (a)) {
                                  *a = <B><FONT COLOR="#BC8F8F">'.'</FONT></B>;     <I><FONT COLOR="#B22222">// convert &quot;false&quot; java / into .
</FONT></I>                                  add_class_dots_to_patch--;
                                  a = strrchr(tempo, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);
                                }
                                <I><FONT COLOR="#B22222">// if add_class_dots_to_patch, this is because there is a problem!!
</FONT></I>                                <B><FONT COLOR="#A020F0">if</FONT></B> (add_class_dots_to_patch) {
                                  hts_log_print(opt, LOG_WARNING,
                                                <B><FONT COLOR="#BC8F8F">&quot;Error: can not rewind java path %s, check html code&quot;</FONT></B>,
                                                tempo);
                                }
                              }

                              <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
                                <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo2[HTS_URLMAXSIZE * 2];

                                strcpybuff(tempo2, a + 1);
                                strncatbuff(tempo_pat, tempo, a - tempo + 1);   <I><FONT COLOR="#B22222">// chemin
</FONT></I>                                strcpybuff(tempo, tempo2);      <I><FONT COLOR="#B22222">// fichier
</FONT></I>                              }
                            }

                            <I><FONT COLOR="#B22222">// érire codebase=&quot;chemin&quot;
</FONT></I>                            <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                              <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo4[HTS_URLMAXSIZE * 2];

                              tempo4[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

                              <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(tempo_pat)) {
                                HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;codebase=\&quot;&quot;</FONT></B>);
                                HT_ADD_HTMLESCAPED(tempo_pat);
                                HT_ADD(<B><FONT COLOR="#BC8F8F">&quot;\&quot; &quot;</FONT></B>);
                              }

                              strncatbuff(tempo4, lastsaved, p_flush - lastsaved);
                              HT_ADD(tempo4);   <I><FONT COLOR="#B22222">// refresh code=&quot;
</FONT></I>                            }
                          }
                          <I><FONT COLOR="#B22222">//lastsaved=adr;    // dernier écrit+1
</FONT></I>                        }

                        <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                          <I><FONT COLOR="#B22222">// convert to local codepage - NOT, already converted into %NN, and passed to the remote server so we do not have anything to do
</FONT></I>                          <I><FONT COLOR="#B22222">//if (str-&gt;page_charset_ != NULL &amp;&amp; *str-&gt;page_charset_ != '\0') {
</FONT></I>                          <I><FONT COLOR="#B22222">//  char *const local_save = hts_convertStringFromUTF8(tempo, strlen(tempo), str-&gt;page_charset_);
</FONT></I>                          <I><FONT COLOR="#B22222">//  if (local_save != NULL) {
</FONT></I>                          <I><FONT COLOR="#B22222">//    strcpybuff(tempo, local_save);
</FONT></I>                          <I><FONT COLOR="#B22222">//    free(local_save);
</FONT></I>                          <I><FONT COLOR="#B22222">//  } else {
</FONT></I>                          <I><FONT COLOR="#B22222">//    if ((opt-&gt;debug&gt;1) &amp;&amp; (opt-&gt;log!=NULL)) {
</FONT></I>                          <I><FONT COLOR="#B22222">//      fprintf(opt-&gt;log, &quot;Warning: could not build local charset representation of '%s' in '%s'&quot;LF, tempo, str-&gt;page_charset_);
</FONT></I>                          <I><FONT COLOR="#B22222">//    }
</FONT></I>                          <I><FONT COLOR="#B22222">//  }
</FONT></I>                          <I><FONT COLOR="#B22222">//}
</FONT></I>
                          <I><FONT COLOR="#B22222">// écrire le lien modifié, relatif
</FONT></I>                          <I><FONT COLOR="#B22222">// Note: escape all chars, even &gt;127 (no UTF)
</FONT></I>                          HT_ADD_HTMLESCAPED_FULL(tempo);

                          <I><FONT COLOR="#B22222">// Add query-string, for informational purpose only
</FONT></I>                          <I><FONT COLOR="#B22222">// Useless, because all parameters-pages are saved into different targets
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;includequery) {
                            <B><FONT COLOR="#228B22">char</FONT></B> *a = strchr(lien, <B><FONT COLOR="#BC8F8F">'?'</FONT></B>);

                            <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
                              HT_ADD_HTMLESCAPED(a);
                            }
                          }
                        }
                        lastsaved = eadr - 1;   <I><FONT COLOR="#B22222">// dernier écrit+1 (enfin euh apres on fait un ++ alors hein)
</FONT></I>                      } <B><FONT COLOR="#A020F0">else</FONT></B> {
                        hts_log_print(opt, LOG_WARNING,
                                      <B><FONT COLOR="#BC8F8F">&quot;Error building relative link %s and %s&quot;</FONT></B>,
                                      afs.save, relativesavename());
                      }
                    }           <I><FONT COLOR="#B22222">// sinon le lien sera écrit normalement
</FONT></I>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
                    <B><FONT COLOR="#A020F0">if</FONT></B> (fexist(save)) { <I><FONT COLOR="#B22222">// le fichier existe..
</FONT></I>                      adr[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                      <I><FONT COLOR="#B22222">//if ((opt-&gt;debug&gt;0) &amp;&amp; (opt-&gt;log!=NULL)) {
</FONT></I>                      hts_log_print(opt, LOG_WARNING,
                                    <B><FONT COLOR="#BC8F8F">&quot;Link has already been written on disk, cancelled: %s&quot;</FONT></B>,
                                    save);
                    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

                    <I><FONT COLOR="#B22222">/* Security check */</FONT></I>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (strlen(afs.save) &gt;= HTS_URLMAXSIZE) {
                      afs.af.adr[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                      hts_log_print(opt, LOG_WARNING, <B><FONT COLOR="#BC8F8F">&quot;Link is too long: %s&quot;</FONT></B>,
                                    afs.save);
                    }

                    <B><FONT COLOR="#A020F0">if</FONT></B> ((afs.af.adr[0] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) &amp;&amp; (p_type != 2) &amp;&amp; (p_type != -2) &amp;&amp; (forbidden_url != 1)) {  <I><FONT COLOR="#B22222">// si le fichier n'existe pas, ajouter à la liste                            
</FONT></I>                      <I><FONT COLOR="#B22222">// n'y a-t-il pas trop de liens?
</FONT></I>                      <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;maxlink &gt; 0 &amp;&amp; opt-&gt;lien_tot + 1 &gt;= opt-&gt;maxlink) {       <I><FONT COLOR="#B22222">// trop de liens!
</FONT></I>                        printf(<B><FONT COLOR="#BC8F8F">&quot;PANIC! : Too many URLs : &gt;%d [%d]\n&quot;</FONT></B>, opt-&gt;lien_tot,
                               __LINE__);
                        hts_log_print(opt, LOG_PANIC, <B><FONT COLOR="#BC8F8F">&quot;Too many URLs, giving up..(&gt;%d)&quot;</FONT></B>,
                                      opt-&gt;maxlink);
                        hts_log_print(opt, LOG_INFO,
                                      <B><FONT COLOR="#BC8F8F">&quot;To avoid that: use #L option for more links (example: -#L1000000)&quot;</FONT></B>);
                        <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                          <B><FONT COLOR="#A020F0">if</FONT></B> (fp) {
                            fclose(fp);
                            fp = NULL;
                          }
                        }
                        XH_uninit;      <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>                        <B><FONT COLOR="#A020F0">return</FONT></B> -1;
                      } <B><FONT COLOR="#A020F0">else</FONT></B> {  <I><FONT COLOR="#B22222">// noter le lien sur la listes des liens à charger
</FONT></I>                        <B><FONT COLOR="#228B22">int</FONT></B> pass_fix, dejafait = 0;

                        <I><FONT COLOR="#B22222">// Calculer la priorité de ce lien
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 4) == 0) {  <I><FONT COLOR="#B22222">// traiter html après
</FONT></I>                          pass_fix = 0;
                        } <B><FONT COLOR="#A020F0">else</FONT></B> {        <I><FONT COLOR="#B22222">// vérifier que ce n'est pas un !html
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!ishtml(opt, afs.af.fil))
                            pass_fix = 1;       <I><FONT COLOR="#B22222">// priorité inférieure (traiter après)
</FONT></I>                          <B><FONT COLOR="#A020F0">else</FONT></B>
                            pass_fix = max(0, numero_passe);    <I><FONT COLOR="#B22222">// priorité normale
</FONT></I>                        }

                        <I><FONT COLOR="#B22222">/* If the file seems to be an html file, get depth-1 */</FONT></I>
                        <I><FONT COLOR="#B22222">/*
                           if (strnotempty(save)) {
                           if (ishtml(opt,save) == 1) {
                           // descore_prio = 2;
                           } else {
                           // descore_prio = 1;
                           }
                           }
                         */</FONT></I>

                        <I><FONT COLOR="#B22222">// vérifier que le lien n'a pas déja été noté
</FONT></I>                        <I><FONT COLOR="#B22222">// si c'est le cas, alors il faut s'assurer que la priorité associée
</FONT></I>                        <I><FONT COLOR="#B22222">// au fichier est la plus grande des deux priorités
</FONT></I>                        <I><FONT COLOR="#B22222">//
</FONT></I>                        <I><FONT COLOR="#B22222">// On part de la fin et on essaye de se presser (économise temps machine)
</FONT></I>                        {
                          <B><FONT COLOR="#228B22">int</FONT></B> i = hash_read(hash, afs.save, NULL, 0);   <I><FONT COLOR="#B22222">// lecture type 0 (sav)
</FONT></I>
                          <B><FONT COLOR="#A020F0">if</FONT></B> (i &gt;= 0) {
                            <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;debug &gt; 1) &amp;&amp; (opt-&gt;log != NULL)) {
                              <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(afs.af.adr, heap(i)-&gt;adr) != 0
                                  || strcmp(afs.af.fil, heap(i)-&gt;fil) != 0) {
                                hts_log_print(opt, LOG_DEBUG,
                                              <B><FONT COLOR="#BC8F8F">&quot;merging similar links %s%s and %s%s&quot;</FONT></B>,
                                              afs.af.adr, afs.af.fil, heap(i)-&gt;adr,
                                              heap(i)-&gt;fil);
                              }
                            }
                            heap(i)-&gt;depth =
                              maximum(heap(i)-&gt;depth, heap(ptr)-&gt;depth - 1);
                            dejafait = 1;
                          }
                        }

                        <I><FONT COLOR="#B22222">// le lien n'a jamais été créé.
</FONT></I>                        <I><FONT COLOR="#B22222">// cette fois ci, on le crée!
</FONT></I>                        <B><FONT COLOR="#A020F0">if</FONT></B> (!dejafait) {
                          <I><FONT COLOR="#B22222">//
</FONT></I>                          <I><FONT COLOR="#B22222">// &gt;&gt;&gt;&gt; CREER LE LIEN &lt;&lt;&lt;&lt;
</FONT></I>                          <I><FONT COLOR="#B22222">//
</FONT></I>                          <I><FONT COLOR="#B22222">// enregistrer lien à charger
</FONT></I>                          <I><FONT COLOR="#B22222">//heap_top()-&gt;adr[0]=heap_top()-&gt;fil[0]=heap_top()-&gt;sav[0]='\0';
</FONT></I>                          <I><FONT COLOR="#B22222">// même adresse: l'objet père est l'objet père de l'actuel
</FONT></I>
                          <I><FONT COLOR="#B22222">// DEBUT ROBOTS.TXT AJOUT
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!just_test_it) {
                            <B><FONT COLOR="#A020F0">if</FONT></B> ((!strfield(afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;ftp://&quot;</FONT></B>))      <I><FONT COLOR="#B22222">// non ftp
</FONT></I>                                &amp;&amp; (!strfield(afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;file://&quot;</FONT></B>))
                              ) {       <I><FONT COLOR="#B22222">// non file
</FONT></I>                              <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;robots) {        <I><FONT COLOR="#B22222">// récupérer robots
</FONT></I>                                <B><FONT COLOR="#A020F0">if</FONT></B> (ishtml(opt, afs.af.fil) != 0) {    <I><FONT COLOR="#B22222">// pas la peine pour des fichiers isolés
</FONT></I>                                  <B><FONT COLOR="#A020F0">if</FONT></B> (checkrobots(_ROBOTS, afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>) != -1) {    <I><FONT COLOR="#B22222">// robots.txt ?
</FONT></I>                                    checkrobots_set(_ROBOTS, afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);  <I><FONT COLOR="#B22222">// ajouter entrée vide
</FONT></I>                                    <B><FONT COLOR="#A020F0">if</FONT></B> (checkrobots(_ROBOTS, afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>) == -1) {  <I><FONT COLOR="#B22222">// robots.txt ?
</FONT></I>                                      <I><FONT COLOR="#B22222">// enregistrer robots.txt (MACRO)
</FONT></I>                                      <B><FONT COLOR="#A020F0">if</FONT></B> (!hts_record_link(opt, afs.af.adr, <B><FONT COLOR="#BC8F8F">&quot;/robots.txt&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, NULL)) {
                                        <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                                          <B><FONT COLOR="#A020F0">if</FONT></B> (fp) {
                                            fclose(fp);
                                            fp = NULL;
                                          }
                                        }
                                        XH_uninit;      <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>                                        <B><FONT COLOR="#A020F0">return</FONT></B> -1;
                                      }
                                      heap_top()-&gt;testmode = 0;    <I><FONT COLOR="#B22222">// pas mode test
</FONT></I>                                      heap_top()-&gt;link_import = 0; <I><FONT COLOR="#B22222">// pas mode import     
</FONT></I>                                      heap_top()-&gt;premier = heap_top_index();
                                      heap_top()-&gt;precedent = ptr;
                                      heap_top()-&gt;depth = 0;
                                      heap_top()-&gt;pass2 = max(0, numero_passe);
                                      heap_top()-&gt;retry = 0;
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG_ROBOTS</FONT>
                                      printf
                                        (<B><FONT COLOR="#BC8F8F">&quot;robots.txt: added file robots.txt for %s\n&quot;</FONT></B>,
                                         adr);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                                      hts_log_print(opt, LOG_DEBUG,
                                                    <B><FONT COLOR="#BC8F8F">&quot;robots.txt added at %s&quot;</FONT></B>,
                                                    afs.af.adr);
                                    } <B><FONT COLOR="#A020F0">else</FONT></B> {
                                      hts_log_print(opt, LOG_ERROR,
                                                    <B><FONT COLOR="#BC8F8F">&quot;Unexpected robots.txt error at %d&quot;</FONT></B>,
                                                    __LINE__);
                                    }
                                  }
                                }
                              }
                            }
                          }
                          <I><FONT COLOR="#B22222">// FIN ROBOTS.TXT AJOUT
</FONT></I>
                          <I><FONT COLOR="#B22222">// enregistrer
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!hts_record_link(opt, afs.af.adr, afs.af.fil, afs.save, 
                                               former.adr, former.fil, codebase)) {
                            <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
                              <B><FONT COLOR="#A020F0">if</FONT></B> (fp) {
                                fclose(fp);
                                fp = NULL;
                              }
                            }
                            XH_uninit;  <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>                            <B><FONT COLOR="#A020F0">return</FONT></B> -1;
                          }
                          <I><FONT COLOR="#B22222">// mode test?
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!just_test_it)
                            heap_top()-&gt;testmode = 0;      <I><FONT COLOR="#B22222">// pas mode test
</FONT></I>                          <B><FONT COLOR="#A020F0">else</FONT></B>
                            heap_top()-&gt;testmode = 1;      <I><FONT COLOR="#B22222">// mode test
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!import_done)
                            heap_top()-&gt;link_import = 0;   <I><FONT COLOR="#B22222">// pas mode import
</FONT></I>                          <B><FONT COLOR="#A020F0">else</FONT></B>
                            heap_top()-&gt;link_import = 1;   <I><FONT COLOR="#B22222">// mode import
</FONT></I>                          <I><FONT COLOR="#B22222">// écrire autres paramètres de la structure-lien
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> ((meme_adresse) &amp;&amp; (!import_done)
                              &amp;&amp; (heap(ptr)-&gt;premier != 0))
                            heap_top()-&gt;premier = heap(ptr)-&gt;premier;
                          <B><FONT COLOR="#A020F0">else</FONT></B>  <I><FONT COLOR="#B22222">// sinon l'objet père est le précédent lui même
</FONT></I>                            heap_top()-&gt;premier = heap_top_index();
                          <I><FONT COLOR="#B22222">// heap_top()-&gt;premier=ptr;
</FONT></I>
                          heap_top()-&gt;precedent = ptr;
                          <I><FONT COLOR="#B22222">// noter la priorité
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!set_prio_to)
                            heap_top()-&gt;depth = heap(ptr)-&gt;depth - 1;
                          <B><FONT COLOR="#A020F0">else</FONT></B>
                            heap_top()-&gt;depth = max(0, min(heap(ptr)-&gt;depth - 1, set_prio_to - 1));       <I><FONT COLOR="#B22222">// PRIORITE NULLE (catch page)
</FONT></I>                          <I><FONT COLOR="#B22222">// noter pass
</FONT></I>                          heap_top()-&gt;pass2 = pass_fix;
                          heap_top()-&gt;retry = opt-&gt;retry;

                          <I><FONT COLOR="#B22222">//strcpybuff(heap_top()-&gt;adr,adr);
</FONT></I>                          <I><FONT COLOR="#B22222">//strcpybuff(heap_top()-&gt;fil,fil);
</FONT></I>                          <I><FONT COLOR="#B22222">//strcpybuff(heap_top()-&gt;sav,save); 
</FONT></I>                          <B><FONT COLOR="#A020F0">if</FONT></B> (!just_test_it) {
                            hts_log_print(opt, LOG_DEBUG,
                                          <B><FONT COLOR="#BC8F8F">&quot;OK, NOTE: %s%s -&gt; %s&quot;</FONT></B>,
                                          heap_top()-&gt;adr,
                                          heap_top()-&gt;fil,
                                          heap_top()-&gt;sav);
                          } <B><FONT COLOR="#A020F0">else</FONT></B> {
                            hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;OK, TEST: %s%s&quot;</FONT></B>,
                                          heap_top()-&gt;adr,
                                          heap_top()-&gt;fil);
                          }

                        } <B><FONT COLOR="#A020F0">else</FONT></B> {        <I><FONT COLOR="#B22222">// if !dejafait
</FONT></I>                          hts_log_print(opt, LOG_DEBUG,
                                        <B><FONT COLOR="#BC8F8F">&quot;link has already been recorded, cancelled: %s&quot;</FONT></B>,
                                        afs.save);

                        }

                      }         <I><FONT COLOR="#B22222">// si pas trop de liens
</FONT></I>                    }           <I><FONT COLOR="#B22222">// si adr[0]!='\0'
</FONT></I>
                  }             <I><FONT COLOR="#B22222">// if adr[0]!='\0' 
</FONT></I>
                }               <I><FONT COLOR="#B22222">// if adr[0]!='\0'
</FONT></I>
              }                 <I><FONT COLOR="#B22222">// if strlen(lien)&gt;0
</FONT></I>
            }                   <I><FONT COLOR="#B22222">// if ok==0      
</FONT></I>
            assertf(eadr - html &gt;= 0);   <I><FONT COLOR="#B22222">// Should not go back
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (eadr &gt; html) {
              INCREMENT_CURRENT_ADR(eadr - 1 - html);
            }
            <I><FONT COLOR="#B22222">// adr=eadr-1;  // ** sauter
</FONT></I>
            <I><FONT COLOR="#B22222">/* We skipped bytes and skip the &quot; : reset state */</FONT></I>
            <I><FONT COLOR="#B22222">/*if (inscript) {
               inscript_state_pos = INSCRIPT_START;
               } */</FONT></I>

          }                     <I><FONT COLOR="#B22222">// if (p) 
</FONT></I>
        }                       <I><FONT COLOR="#B22222">// si '&lt;' ou '&gt;'
</FONT></I>
        <I><FONT COLOR="#B22222">// plus loin
</FONT></I>        html++;                  <I><FONT COLOR="#B22222">// automate will be checked next loop
</FONT></I>
        <I><FONT COLOR="#B22222">/* Otimization: if we are scanning in HTML data (not in tag or script), 
           then jump to the next starting tag */</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> (ptr &gt; 0) {
          <B><FONT COLOR="#A020F0">if</FONT></B> ((!intag)          <I><FONT COLOR="#B22222">/* Not in tag */</FONT></I>
              &amp;&amp;(!inscript)     <I><FONT COLOR="#B22222">/* Not in (java)script */</FONT></I>
              &amp;&amp;(!in_media)     <I><FONT COLOR="#B22222">/* Not in media */</FONT></I>
              &amp;&amp;(!incomment)    <I><FONT COLOR="#B22222">/* Not in comment (&lt;!--) */</FONT></I>
              &amp;&amp;(!inscript_tag) <I><FONT COLOR="#B22222">/* Not in tag with script inside */</FONT></I>
            ) {
            <I><FONT COLOR="#B22222">/* Not at the end */</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (html - r-&gt;adr &lt; r-&gt;size) {
              <I><FONT COLOR="#B22222">/* Not on a starting tag yet */</FONT></I>
              <B><FONT COLOR="#A020F0">if</FONT></B> (*html != <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>) {
                <I><FONT COLOR="#B22222">/* strchr does not well behave with null chrs.. */</FONT></I>
                <I><FONT COLOR="#B22222">/* char* adr_next = strchr(adr,'&lt;'); */</FONT></I>
                <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr_next = html;

                <B><FONT COLOR="#A020F0">while</FONT></B>(*adr_next != <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B> &amp;&amp; (adr_next - r-&gt;adr) &lt; r-&gt;size) {
                  adr_next++;
                }
                <I><FONT COLOR="#B22222">/* Jump to near end (index hack) */</FONT></I>
                <B><FONT COLOR="#A020F0">if</FONT></B> (!adr_next || *adr_next != <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>) {
                  <B><FONT COLOR="#A020F0">if</FONT></B> (html - r-&gt;adr &lt; r-&gt;size - 4
                      &amp;&amp; r-&gt;size &gt; 4
                    ) {
                    html = r-&gt;adr + r-&gt;size - 2;
                  }
                } <B><FONT COLOR="#A020F0">else</FONT></B> {
                  html = adr_next;
                }
              }
            }
          }
        }
        <I><FONT COLOR="#B22222">// ----------
</FONT></I>        <I><FONT COLOR="#B22222">// écrire peu à peu
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0))
          HT_add_adr;
        lastsaved = html;        <I><FONT COLOR="#B22222">// dernier écrit+1
</FONT></I>        <I><FONT COLOR="#B22222">// ----------
</FONT></I>
        <I><FONT COLOR="#B22222">// Checks
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (back_add_stats != opt-&gt;state.back_add_stats) {
          back_add_stats = opt-&gt;state.back_add_stats;

          <I><FONT COLOR="#B22222">// Check max time
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (!back_checkmirror(opt)) {
            html = r-&gt;adr + r-&gt;size;
          }
        }
        <I><FONT COLOR="#B22222">// pour les stats du shell si parsing trop long
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;size)
          opt-&gt;state._hts_in_html_done =
            (100 * ((<B><FONT COLOR="#228B22">int</FONT></B>) (html - r-&gt;adr))) / (<B><FONT COLOR="#228B22">int</FONT></B>) (r-&gt;size);
        <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;state._hts_in_html_poll) {
          opt-&gt;state._hts_in_html_poll = 0;
          <I><FONT COLOR="#B22222">// temps à attendre, et remplir autant que l'on peut le cache (backing)
</FONT></I>          back_wait(sback, opt, cache, HTS_STAT.stat_timestart);
          back_fillmax(sback, opt, cache, ptr, numero_passe);

          <I><FONT COLOR="#B22222">// Transfer rate
</FONT></I>          engine_stats();

          <I><FONT COLOR="#B22222">// Refresh various stats
</FONT></I>          HTS_STAT.stat_nsocket = back_nsoc(sback);
          HTS_STAT.stat_errors = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;error&quot;</FONT></B>);
          HTS_STAT.stat_warnings = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;warning&quot;</FONT></B>);
          HTS_STAT.stat_infos = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);
          HTS_STAT.nbk = backlinks_done(sback, opt-&gt;liens, opt-&gt;lien_tot, ptr);
          HTS_STAT.nb = back_transferred(HTS_STAT.stat_bytes, sback);

          <B><FONT COLOR="#A020F0">if</FONT></B> (!RUN_CALLBACK7
              (opt, loop, sback-&gt;lnk, sback-&gt;count, 0, ptr, opt-&gt;lien_tot,
               (<B><FONT COLOR="#228B22">int</FONT></B>) (time_local() - HTS_STAT.stat_timestart), &amp;HTS_STAT)) {
            hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Exit requested by shell or user&quot;</FONT></B>);
            *stre-&gt;exit_xh_ = 1;        <I><FONT COLOR="#B22222">// exit requested
</FONT></I>            XH_uninit;
            <B><FONT COLOR="#A020F0">return</FONT></B> -1;
            <I><FONT COLOR="#B22222">//adr = r-&gt;adr + r-&gt;size;  // exit
</FONT></I>          } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;state._hts_cancel == 1) {
            <I><FONT COLOR="#B22222">// adr = r-&gt;adr + r-&gt;size;  // exit
</FONT></I>            nofollow = 1;       <I><FONT COLOR="#B22222">// moins violent
</FONT></I>            opt-&gt;state._hts_cancel = 0;
          }

        }
        <I><FONT COLOR="#B22222">// refresh the backing system each 2 seconds
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (engine_stats()) {
          back_wait(sback, opt, cache, HTS_STAT.stat_timestart);
          back_fillmax(sback, opt, cache, ptr, numero_passe);
        }
      } <B><FONT COLOR="#A020F0">while</FONT></B>(html - r-&gt;adr &lt; r-&gt;size);

      opt-&gt;state._hts_in_html_parsing = 0;      <I><FONT COLOR="#B22222">// flag
</FONT></I>      opt-&gt;state._hts_cancel = 0;       <I><FONT COLOR="#B22222">// pas de cancel
</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;getmode &amp; 1) &amp;&amp; (ptr &gt; 0)) {
        {
          <B><FONT COLOR="#228B22">char</FONT></B> *cAddr = TypedArrayElts(output_buffer);
          <B><FONT COLOR="#228B22">int</FONT></B> cSize = (<B><FONT COLOR="#228B22">int</FONT></B>) TypedArraySize(output_buffer);

          hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;engine: postprocess-html: %s%s&quot;</FONT></B>,
                        urladr(), urlfil());
          <B><FONT COLOR="#A020F0">if</FONT></B> (RUN_CALLBACK4(opt, postprocess, &amp;cAddr, &amp;cSize, urladr(), urlfil()) == 1) {
            <B><FONT COLOR="#A020F0">if</FONT></B> (cAddr != TypedArrayElts(output_buffer)) {
              hts_log_print(opt, LOG_DEBUG, 
                <B><FONT COLOR="#BC8F8F">&quot;engine: postprocess-html: callback modified data, applying %d bytes&quot;</FONT></B>, cSize);
              TypedArraySize(output_buffer) = 0;
              TypedArrayAppend(output_buffer, cAddr, cSize);
            }
          }
        }

        <I><FONT COLOR="#B22222">/* Flush and save to disk */</FONT></I>
        HT_ADD_END;             <I><FONT COLOR="#B22222">// achever
</FONT></I>      }
      <I><FONT COLOR="#B22222">//
</FONT></I>      <I><FONT COLOR="#B22222">//
</FONT></I>      <I><FONT COLOR="#B22222">//
</FONT></I>    }                           <I><FONT COLOR="#B22222">// if !error
</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;getmode &amp; 1) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (fp) {
        fclose(fp);
        fp = NULL;
      }
    }
    <I><FONT COLOR="#B22222">// sauver fichier
</FONT></I>    <I><FONT COLOR="#B22222">//structcheck(savename());
</FONT></I>    <I><FONT COLOR="#B22222">//filesave(opt,r-&gt;adr,r-&gt;size,savename());
</FONT></I>
  }                             <I><FONT COLOR="#B22222">// analyse OK
</FONT></I>
  <I><FONT COLOR="#B22222">/* Apply changes */</FONT></I>
  ENGINE_SAVE_CONTEXT();

  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/*
Check 301, 302, .. statuscodes (moved)
*/</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_mirror_check_moved</FONT></B>(htsmoduleStruct * str,
                           htsmoduleStructExtended * stre) {
  <I><FONT COLOR="#B22222">/* Load engine variables */</FONT></I>
  ENGINE_LOAD_CONTEXT();

  <I><FONT COLOR="#B22222">// DEBUT rattrapage des 301,302,307..
</FONT></I>  <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (!error) {
    <I><FONT COLOR="#B22222">////////{
</FONT></I>    <I><FONT COLOR="#B22222">// on a chargé un fichier en plus
</FONT></I>    <I><FONT COLOR="#B22222">// if (!error) stat_loaded+=r.size;
</FONT></I>
    <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>    <I><FONT COLOR="#B22222">// Rattrapage des 301,302,307 (moved) et 412,416 - les 304 le sont dans le backing 
</FONT></I>    <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (HTTP_IS_REDIRECT(r-&gt;statuscode)) {
      <I><FONT COLOR="#B22222">//if (r-&gt;adr!=NULL) {   // adr==null si fichier direct. [catch: davename normalement si cgi]
</FONT></I>      <I><FONT COLOR="#B22222">//int i=0;
</FONT></I>      <I><FONT COLOR="#B22222">// char* p;
</FONT></I>
      hts_log_print(opt, LOG_WARNING, <B><FONT COLOR="#BC8F8F">&quot;%s for %s%s&quot;</FONT></B>, r-&gt;msg, urladr(), urlfil());

      {
        <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK mov_url[HTS_URLMAXSIZE * 2];
        lien_adrfilsave savedmoved;
        lien_adrfil *<B><FONT COLOR="#228B22">const</FONT></B> moved = &amp;savedmoved.af;
        <B><FONT COLOR="#228B22">int</FONT></B> get_it = 0;         <I><FONT COLOR="#B22222">// ne pas prendre le fichier à la même adresse par défaut
</FONT></I>        <B><FONT COLOR="#228B22">int</FONT></B> reponse = 0;

        mov_url[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        moved-&gt;adr[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        moved-&gt;fil[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        savedmoved.save[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        <I><FONT COLOR="#B22222">//
</FONT></I>
        strcpybuff(mov_url, r-&gt;location);

        <I><FONT COLOR="#B22222">// url qque -&gt; adresse+fichier
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> ((reponse =
             ident_url_relatif(mov_url, urladr(), urlfil(), moved)) &gt;= 0) {
          <B><FONT COLOR="#228B22">int</FONT></B> set_prio_to = 0;  <I><FONT COLOR="#B22222">// pas de priotité fixéd par wizard
</FONT></I>
          <I><FONT COLOR="#B22222">// check whether URLHack is harmless or not
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;urlhack) {
            <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK n_adr[HTS_URLMAXSIZE * 2], n_fil[HTS_URLMAXSIZE * 2];
            <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK pn_adr[HTS_URLMAXSIZE * 2], pn_fil[HTS_URLMAXSIZE * 2];

            n_adr[0] = n_fil[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
            (<B><FONT COLOR="#228B22">void</FONT></B>) adr_normalized(moved-&gt;adr, n_adr);
            (<B><FONT COLOR="#228B22">void</FONT></B>) fil_normalized(moved-&gt;fil, n_fil);
            (<B><FONT COLOR="#228B22">void</FONT></B>) adr_normalized(urladr(), pn_adr);
            (<B><FONT COLOR="#228B22">void</FONT></B>) fil_normalized(urlfil(), pn_fil);
            <B><FONT COLOR="#A020F0">if</FONT></B> (strcasecmp(n_adr, pn_adr) == 0
                &amp;&amp; strcasecmp(n_fil, pn_fil) == 0) {
              hts_log_print(opt, LOG_WARNING,
                            <B><FONT COLOR="#BC8F8F">&quot;Redirected link is identical because of 'URL Hack' option: %s%s and %s%s&quot;</FONT></B>,
                            urladr(), urlfil(), moved-&gt;adr, moved-&gt;fil);
            }
          }
          <I><FONT COLOR="#B22222">//if (ident_url_absolute(mov_url,moved-&gt;adr,moved-&gt;fil)!=-1) {    // ok URL reconnue
</FONT></I>          <I><FONT COLOR="#B22222">// c'est (en gros) la même URL..
</FONT></I>          <I><FONT COLOR="#B22222">// si c'est un problème de casse dans le host c'est que le serveur est buggé
</FONT></I>          <I><FONT COLOR="#B22222">// (&quot;RFC says..&quot; : host name IS case insensitive)
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> ((strfield2(moved-&gt;adr, urladr()) != 0) &amp;&amp; (strfield2(moved-&gt;fil, urlfil()) != 0)) { <I><FONT COLOR="#B22222">// identique à casse près
</FONT></I>            <I><FONT COLOR="#B22222">// on tourne en rond
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(moved-&gt;fil, urlfil()) == 0) {
              error = 1;
              get_it = -1;      <I><FONT COLOR="#B22222">// ne rien faire
</FONT></I>              hts_log_print(opt, LOG_WARNING,
                            <B><FONT COLOR="#BC8F8F">&quot;Can not bear crazy server (%s) for %s%s&quot;</FONT></B>, r-&gt;msg,
                            urladr(), urlfil());
            } <B><FONT COLOR="#A020F0">else</FONT></B> {            <I><FONT COLOR="#B22222">// mauvaise casse, effacer entrée dans la pile et rejouer une fois
</FONT></I>              get_it = 1;
            }
          } <B><FONT COLOR="#A020F0">else</FONT></B> {              <I><FONT COLOR="#B22222">// adresse différente
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (ishtml(opt, mov_url) == 0) {    <I><FONT COLOR="#B22222">// pas même adresse MAIS c'est un fichier non html (pas de page moved possible)
</FONT></I>              <I><FONT COLOR="#B22222">// -&gt; on prend à cette adresse, le lien sera enregistré avec lien_record() (hash)
</FONT></I>              hts_log_print(opt, LOG_DEBUG,
                            <B><FONT COLOR="#BC8F8F">&quot;wizard link test for moved file at %s%s..&quot;</FONT></B>,
                            moved-&gt;adr, moved-&gt;fil);
              <I><FONT COLOR="#B22222">// accepté?
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (hts_acceptlink(opt, ptr, moved-&gt;adr, moved-&gt;fil, NULL, NULL, &amp;set_prio_to, NULL) != 1) {   <I><FONT COLOR="#B22222">/* nouvelle adresse non refusée ? */</FONT></I>
                get_it = 1;
                hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;moved link accepted: %s%s&quot;</FONT></B>,
                              moved-&gt;adr, moved-&gt;fil);
              }
            }                   <I><FONT COLOR="#B22222">/* sinon traité normalement */</FONT></I>
          }

          <I><FONT COLOR="#B22222">//if ((strfield2(moved-&gt;adr,urladr())!=0) &amp;&amp; (strfield2(moved-&gt;fil,urlfil())!=0)) {  // identique à casse près
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (get_it == 1) {
            <I><FONT COLOR="#B22222">// court-circuiter le reste du traitement
</FONT></I>            <I><FONT COLOR="#B22222">// et reculer pour mieux sauter
</FONT></I>            hts_log_print(opt, LOG_WARNING,
                          <B><FONT COLOR="#BC8F8F">&quot;Warning moved treated for %s%s (real one is %s%s)&quot;</FONT></B>,
                          urladr(), urlfil(), moved-&gt;adr, moved-&gt;fil);
            <I><FONT COLOR="#B22222">// canceller lien actuel
</FONT></I>            error = 1;
            hts_invalidate_link(opt, ptr);  <I><FONT COLOR="#B22222">// invalidate hashtable entry
</FONT></I>            <I><FONT COLOR="#B22222">// noter NOUVEAU lien
</FONT></I>            <I><FONT COLOR="#B22222">//xxc xxc
</FONT></I>            <I><FONT COLOR="#B22222">//  set_prio_to=0+1;  // protection if the moved URL is an html page!!
</FONT></I>            <I><FONT COLOR="#B22222">//xxc xxc
</FONT></I>            {
              <I><FONT COLOR="#B22222">// calculer lien et éventuellement modifier addresse/fichier
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (url_savename(&amp;savedmoved, NULL,
                   heap(heap(ptr)-&gt;precedent)-&gt;adr,
                   heap(heap(ptr)-&gt;precedent)-&gt;fil, opt,
                   sback, cache, hash, ptr, numero_passe, NULL) != -1) {
                <B><FONT COLOR="#A020F0">if</FONT></B> (hash_read(hash, savedmoved.save, NULL, HASH_STRUCT_FILENAME) &lt; 0) {   <I><FONT COLOR="#B22222">// n'existe pas déja
</FONT></I>                  <I><FONT COLOR="#B22222">// enregistrer lien avec SAV IDENTIQUE
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_record_link(opt, moved-&gt;adr, moved-&gt;fil, heap(ptr)-&gt;sav, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, NULL)) {
                    <I><FONT COLOR="#B22222">// mode test?
</FONT></I>                    heap_top()-&gt;testmode = heap(ptr)-&gt;testmode;
                    heap_top()-&gt;link_import = 0;   <I><FONT COLOR="#B22222">// mode normal
</FONT></I>                    <B><FONT COLOR="#A020F0">if</FONT></B> (!set_prio_to)
                      heap_top()-&gt;depth = heap(ptr)-&gt;depth;
                    <B><FONT COLOR="#A020F0">else</FONT></B>
                      heap_top()-&gt;depth = max(0, min(set_prio_to - 1, heap(ptr)-&gt;depth)); <I><FONT COLOR="#B22222">// PRIORITE NULLE (catch page)
</FONT></I>                    heap_top()-&gt;pass2 =
                      max(heap(ptr)-&gt;pass2, numero_passe);
                    heap_top()-&gt;retry = heap(ptr)-&gt;retry;
                    heap_top()-&gt;premier = heap(ptr)-&gt;premier;
                    heap_top()-&gt;precedent = heap(ptr)-&gt;precedent;
                  } <B><FONT COLOR="#A020F0">else</FONT></B> {      <I><FONT COLOR="#B22222">// oups erreur, plus de mémoire!!
</FONT></I>                    XH_uninit;  <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>                    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
                  }
                } <B><FONT COLOR="#A020F0">else</FONT></B> {
                  hts_log_print(opt, LOG_INFO,
                                <B><FONT COLOR="#BC8F8F">&quot;moving %s to an existing file %s&quot;</FONT></B>,
                                heap(ptr)-&gt;fil, urlfil());
                }

              }
            }

            <I><FONT COLOR="#B22222">//printf(&quot;-&gt; %s %s %s\n&quot;,liens[lien_tot-1]-&gt;adr,liens[lien_tot-1]-&gt;fil,liens[lien_tot-1]-&gt;sav);
</FONT></I>
            <I><FONT COLOR="#B22222">// note métaphysique: il se peut qu'il y ait un index.html et un INDEX.HTML
</FONT></I>            <I><FONT COLOR="#B22222">// sous DOS ca marche pas très bien... mais comme je suis génial url_savename()
</FONT></I>            <I><FONT COLOR="#B22222">// est à même de régler ce problème
</FONT></I>          }
        }                       <I><FONT COLOR="#B22222">// ident_url_xx
</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> (get_it == 0) {      <I><FONT COLOR="#B22222">// adresse vraiment différente et potentiellement en html (pas de possibilité de bouger la page tel quel à cause des &lt;img src..&gt; et cie)
</FONT></I>          <B><FONT COLOR="#228B22">const</FONT></B> size_t rn_size = 8192;
          <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> rn = (<B><FONT COLOR="#228B22">char</FONT></B> *) malloct(rn_size);
          <B><FONT COLOR="#A020F0">if</FONT></B> (rn != NULL) {
            hts_log_print(opt, LOG_WARNING, <B><FONT COLOR="#BC8F8F">&quot;File has moved from %s%s to %s&quot;</FONT></B>,
                          urladr(), urlfil(), mov_url);
            <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;mimehtml) {
              inplace_escape_uri(mov_url, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(mov_url));
            } <B><FONT COLOR="#A020F0">else</FONT></B> {
              <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK cid[HTS_URLMAXSIZE * 3];
              make_content_id(moved-&gt;adr, moved-&gt;fil, cid, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(cid));
              strcpybuff(mov_url, <B><FONT COLOR="#BC8F8F">&quot;cid:&quot;</FONT></B>);
              strcatbuff(mov_url, cid);
            }
            <I><FONT COLOR="#B22222">// On prépare une page qui sautera immédiatement sur la bonne URL
</FONT></I>            <I><FONT COLOR="#B22222">// Le scanner re-changera, ensuite, cette URL, pour la mirrorer!
</FONT></I>            snprintf(rn, rn_size,
              <B><FONT COLOR="#BC8F8F">&quot;&lt;HTML&gt;&quot;</FONT></B> CRLF
              <B><FONT COLOR="#BC8F8F">&quot;&lt;!-- Created by HTTrack Website Copier/&quot;</FONT></B> HTTRACK_VERSION <B><FONT COLOR="#BC8F8F">&quot; &quot;</FONT></B> HTTRACK_AFF_AUTHORS <B><FONT COLOR="#BC8F8F">&quot; --&gt;&quot;</FONT></B> CRLF
              <B><FONT COLOR="#BC8F8F">&quot;&lt;HEAD&gt;&quot;</FONT></B> CRLF 
              <B><FONT COLOR="#BC8F8F">&quot;&lt;META HTTP-EQUIV=\&quot;Content-Type\&quot; CONTENT=\&quot;text/html;charset=UTF-8\&quot;&gt;&quot;</FONT></B>
              <B><FONT COLOR="#BC8F8F">&quot;&lt;META HTTP-EQUIV=\&quot;Refresh\&quot; CONTENT=\&quot;0; URL=%s\&quot;&gt;&quot;</FONT></B>
              <B><FONT COLOR="#BC8F8F">&quot;&lt;TITLE&gt;Page has moved&lt;/TITLE&gt;&quot;</FONT></B> CRLF 
              <B><FONT COLOR="#BC8F8F">&quot;&lt;/HEAD&gt;&quot;</FONT></B> CRLF
              <B><FONT COLOR="#BC8F8F">&quot;&lt;BODY&gt;&quot;</FONT></B> CRLF
              <B><FONT COLOR="#BC8F8F">&quot;&lt;A HREF=\&quot;%s\&quot;&gt;&lt;h3&gt;Click here...&lt;/h3&gt;&lt;/A&gt;&quot;</FONT></B> CRLF
              <B><FONT COLOR="#BC8F8F">&quot;&lt;/BODY&gt;&quot;</FONT></B> CRLF
              <B><FONT COLOR="#BC8F8F">&quot;&lt;!-- Created by HTTrack Website Copier/&quot;</FONT></B> HTTRACK_VERSION <B><FONT COLOR="#BC8F8F">&quot; &quot;</FONT></B> HTTRACK_AFF_AUTHORS <B><FONT COLOR="#BC8F8F">&quot; --&gt;&quot;</FONT></B> CRLF
              <B><FONT COLOR="#BC8F8F">&quot;&lt;/HTML&gt;&quot;</FONT></B> CRLF,
              mov_url, mov_url);

            <I><FONT COLOR="#B22222">// changer la page
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr) {
              freet(r-&gt;adr);
              r-&gt;adr = NULL;
            }
            r-&gt;adr = rn;
            r-&gt;size = strlen(r-&gt;adr);
            strcpybuff(r-&gt;contenttype, <B><FONT COLOR="#BC8F8F">&quot;text/html&quot;</FONT></B>);
          }
        }                       <I><FONT COLOR="#B22222">// get_it==0
</FONT></I>
      }                         <I><FONT COLOR="#B22222">// bloc
</FONT></I>      <I><FONT COLOR="#B22222">// erreur HTTP (ex: 404, not found)
</FONT></I>    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((r-&gt;statuscode == HTTP_PRECONDITION_FAILED)
               || (r-&gt;statuscode == HTTP_REQUESTED_RANGE_NOT_SATISFIABLE)
      ) {                       <I><FONT COLOR="#B22222">// Precondition Failed, c'est à dire pour nous redemander TOUT le fichier
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (fexist_utf8(heap(ptr)-&gt;sav)) {
        remove(heap(ptr)-&gt;sav);        <I><FONT COLOR="#B22222">// Eliminer
</FONT></I>      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_log_print(opt, LOG_WARNING,
                      <B><FONT COLOR="#BC8F8F">&quot;Unexpected 412/416 error (%s) for %s%s, '%s' could not be found on disk&quot;</FONT></B>,
                      r-&gt;msg, urladr(), urlfil(),
                      heap(ptr)-&gt;sav != NULL ? heap(ptr)-&gt;sav : <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (!fexist_utf8(heap(ptr)-&gt;sav)) {    <I><FONT COLOR="#B22222">// Bien éliminé? (sinon on boucle..)
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
        printf(<B><FONT COLOR="#BC8F8F">&quot;Partial content NOT up-to-date, reget all file for %s\n&quot;</FONT></B>,
               heap(ptr)-&gt;sav);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Partial file reget (%s) for %s%s&quot;</FONT></B>,
                      r-&gt;msg, urladr(), urlfil());
        <I><FONT COLOR="#B22222">// enregistrer le MEME lien
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (hts_record_link(opt, heap(ptr)-&gt;adr, heap(ptr)-&gt;fil, heap(ptr)-&gt;sav, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, NULL)) {
          heap_top()-&gt;testmode = heap(ptr)-&gt;testmode;   <I><FONT COLOR="#B22222">// mode test?
</FONT></I>          heap_top()-&gt;link_import = 0;   <I><FONT COLOR="#B22222">// pas mode import
</FONT></I>          heap_top()-&gt;depth = heap(ptr)-&gt;depth;
          heap_top()-&gt;pass2 = max(heap(ptr)-&gt;pass2, numero_passe);
          heap_top()-&gt;retry = heap(ptr)-&gt;retry;
          heap_top()-&gt;premier = heap(ptr)-&gt;premier;
          heap_top()-&gt;precedent = ptr;
          <I><FONT COLOR="#B22222">//
</FONT></I>          <I><FONT COLOR="#B22222">// canceller lien actuel
</FONT></I>          error = 1;
          hts_invalidate_link(opt, ptr);  <I><FONT COLOR="#B22222">// invalidate hashtable entry
</FONT></I>          <I><FONT COLOR="#B22222">//
</FONT></I>        } <B><FONT COLOR="#A020F0">else</FONT></B> {              <I><FONT COLOR="#B22222">// oups erreur, plus de mémoire!!
</FONT></I>          XH_uninit;          <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>          <B><FONT COLOR="#A020F0">return</FONT></B> 0;
        }
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Can not remove old file %s&quot;</FONT></B>, urlfil());
        error = 1;
      }

      <I><FONT COLOR="#B22222">// Error ?
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (error) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;errpage) {
          <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr) {         <I><FONT COLOR="#B22222">// désalloc
</FONT></I>            freet(r-&gt;adr);
            r-&gt;adr = NULL;
          }
        }
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;statuscode != HTTP_OK) {
      <B><FONT COLOR="#228B22">int</FONT></B> can_retry = 0;

      <I><FONT COLOR="#B22222">// cas où l'on peut reessayer
</FONT></I>      <B><FONT COLOR="#A020F0">switch</FONT></B> (r-&gt;statuscode) {
        <I><FONT COLOR="#B22222">//case -1: can_retry=1; break;
</FONT></I>      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">STATUSCODE_TIMEOUT</FONT></B>:
        <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;hostcontrol) { <I><FONT COLOR="#B22222">// timeout et retry épuisés
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;hostcontrol &amp; 1) &amp;&amp; (heap(ptr)-&gt;retry &lt;= 0)) {
            hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Link banned: %s%s&quot;</FONT></B>, urladr(), urlfil());
            host_ban(opt, ptr, sback, jump_identification_const(urladr()));
            hts_log_print(opt, LOG_DEBUG,
                          <B><FONT COLOR="#BC8F8F">&quot;Info: previous log - link banned: %s%s&quot;</FONT></B>, urladr(),
                          urlfil());
          } <B><FONT COLOR="#A020F0">else</FONT></B>
            can_retry = 1;
        } <B><FONT COLOR="#A020F0">else</FONT></B>
          can_retry = 1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">STATUSCODE_SLOW</FONT></B>:
        <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;hostcontrol) &amp;&amp; (heap(ptr)-&gt;retry &lt;= 0)) {   <I><FONT COLOR="#B22222">// too slow
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;hostcontrol &amp; 2) {
            hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Link banned: %s%s&quot;</FONT></B>, urladr(), urlfil());
            host_ban(opt, ptr, sback, jump_identification_const(urladr()));
            hts_log_print(opt, LOG_DEBUG,
                          <B><FONT COLOR="#BC8F8F">&quot;Info: previous log - link banned: %s%s&quot;</FONT></B>, urladr(),
                          urlfil());
          } <B><FONT COLOR="#A020F0">else</FONT></B>
            can_retry = 1;
        } <B><FONT COLOR="#A020F0">else</FONT></B>
          can_retry = 1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">STATUSCODE_CONNERROR</FONT></B>:       <I><FONT COLOR="#B22222">// connect closed
</FONT></I>        can_retry = 1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">STATUSCODE_NON_FATAL</FONT></B>:       <I><FONT COLOR="#B22222">// other (non fatal) error
</FONT></I>        can_retry = 1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">STATUSCODE_SSL_HANDSHAKE</FONT></B>:   <I><FONT COLOR="#B22222">// bad SSL handskake
</FONT></I>        can_retry = 1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">408</FONT></B>:
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">409</FONT></B>:
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">500</FONT></B>:
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">502</FONT></B>:
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">504</FONT></B>:
        can_retry = 1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      }

      <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(heap(ptr)-&gt;fil, <B><FONT COLOR="#BC8F8F">&quot;/primary&quot;</FONT></B>) != 0) {   <I><FONT COLOR="#B22222">// no primary (internal page 0)
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> ((heap(ptr)-&gt;retry &lt;= 0) || (!can_retry)) { <I><FONT COLOR="#B22222">// retry épuisés (ou retry impossible)
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;retry &gt; 0) &amp;&amp; (can_retry)) {
            hts_log_print(opt, LOG_ERROR,
                          <B><FONT COLOR="#BC8F8F">&quot;\&quot;%s\&quot; (%d) after %d retries at link %s%s (from %s%s)&quot;</FONT></B>,
                          r-&gt;msg, r-&gt;statuscode, opt-&gt;retry, urladr(), urlfil(),
                          heap(heap(ptr)-&gt;precedent)-&gt;adr,
                          heap(heap(ptr)-&gt;precedent)-&gt;fil);
          } <B><FONT COLOR="#A020F0">else</FONT></B> {
            <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;statuscode == STATUSCODE_TEST_OK) {  <I><FONT COLOR="#B22222">// test OK
</FONT></I>              hts_log_print(opt, LOG_INFO, <B><FONT COLOR="#BC8F8F">&quot;Test OK at link %s%s (from %s%s)&quot;</FONT></B>,
                            urladr(), urlfil(), heap(heap(ptr)-&gt;precedent)-&gt;adr,
                            heap(heap(ptr)-&gt;precedent)-&gt;fil);
            } <B><FONT COLOR="#A020F0">else</FONT></B> {
              <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(urlfil(), <B><FONT COLOR="#BC8F8F">&quot;/robots.txt&quot;</FONT></B>)) {      <I><FONT COLOR="#B22222">// ne pas afficher d'infos sur robots.txt par défaut
</FONT></I>                hts_log_print(opt, LOG_ERROR,
                              <B><FONT COLOR="#BC8F8F">&quot;\&quot;%s\&quot; (%d) at link %s%s (from %s%s)&quot;</FONT></B>, r-&gt;msg,
                              r-&gt;statuscode, urladr(), urlfil(),
                              heap(heap(ptr)-&gt;precedent)-&gt;adr,
                              heap(heap(ptr)-&gt;precedent)-&gt;fil);
              } <B><FONT COLOR="#A020F0">else</FONT></B> {
                hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;No robots.txt rules at %s&quot;</FONT></B>,
                              urladr());
              }
            }
          }

          <I><FONT COLOR="#B22222">// NO error in trop level
</FONT></I>          <I><FONT COLOR="#B22222">// due to the &quot;no connection -&gt; previous restored&quot; hack
</FONT></I>          <I><FONT COLOR="#B22222">// This prevent the engine from wiping all data if the website has been deleted (or moved)
</FONT></I>          <I><FONT COLOR="#B22222">// since last time (which is quite annoying)
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (heap(ptr)-&gt;precedent != 0) {
            <I><FONT COLOR="#B22222">// ici on teste si on doit enregistrer la page tout de même
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;errpage) {
              store_errpage = 1;
            }
          } <B><FONT COLOR="#A020F0">else</FONT></B> {
            <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(urlfil(), <B><FONT COLOR="#BC8F8F">&quot;/robots.txt&quot;</FONT></B>) != 0) {
              <I><FONT COLOR="#B22222">/*
                 This is an error caused by a link entered by the user
                 That is, link(s) entered by user are invalid (404, 500, connect error, proxy error-&gt;.)
                 If all links entered are invalid, the session failed and we will attempt to restore
                 the previous one
                 Example: Try to update a website which has been deleted remotely: this may delete
                 the website locally, which is really not desired (especially if the website disappeared!)
                 With this hack, the engine won't wipe local files (how clever)
               */</FONT></I>
              HTS_STAT.stat_errors_front++;
            }
          }

        } <B><FONT COLOR="#A020F0">else</FONT></B> {                <I><FONT COLOR="#B22222">// retry!!
</FONT></I>          hts_log_print(opt, LOG_NOTICE,
                        <B><FONT COLOR="#BC8F8F">&quot;Retry after error %d (%s) at link %s%s (from %s%s)&quot;</FONT></B>,
                        r-&gt;statuscode, r-&gt;msg, urladr(), urlfil(),
                        heap(heap(ptr)-&gt;precedent)-&gt;adr,
                        heap(heap(ptr)-&gt;precedent)-&gt;fil);
          <I><FONT COLOR="#B22222">// redemander fichier
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (hts_record_link(opt, urladr(), urlfil(), savename(), <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, codebase)) {
            heap_top()-&gt;testmode = heap(ptr)-&gt;testmode;   <I><FONT COLOR="#B22222">// mode test?
</FONT></I>            heap_top()-&gt;link_import = 0;   <I><FONT COLOR="#B22222">// pas mode import
</FONT></I>            heap_top()-&gt;depth = heap(ptr)-&gt;depth;
            heap_top()-&gt;pass2 = max(heap(ptr)-&gt;pass2, numero_passe);
            heap_top()-&gt;retry = heap(ptr)-&gt;retry - 1;     <I><FONT COLOR="#B22222">// moins 1 retry!
</FONT></I>            heap_top()-&gt;premier = heap(ptr)-&gt;premier;
            heap_top()-&gt;precedent = heap(ptr)-&gt;precedent;
          } <B><FONT COLOR="#A020F0">else</FONT></B> {              <I><FONT COLOR="#B22222">// oups erreur, plus de mémoire!!
</FONT></I>            <B><FONT COLOR="#A020F0">return</FONT></B> 0;
          }
        }
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Info: no robots.txt at %s%s&quot;</FONT></B>, urladr(),
                      urlfil());
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (!store_errpage) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr) {           <I><FONT COLOR="#B22222">// désalloc
</FONT></I>          freet(r-&gt;adr);
          r-&gt;adr = NULL;
        }
        error = 1;              <I><FONT COLOR="#B22222">// erreur!
</FONT></I>      }
      <I><FONT COLOR="#B22222">// otherwise, consider this is not an error
</FONT></I>    }
    <I><FONT COLOR="#B22222">// FIN rattrapage des 301,302,307..
</FONT></I>    <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>
  }                             <I><FONT COLOR="#B22222">// if !error
</FONT></I>
  <I><FONT COLOR="#B22222">/* Apply changes */</FONT></I>
  ENGINE_SAVE_CONTEXT();

  <B><FONT COLOR="#A020F0">return</FONT></B> 0;

}

<I><FONT COLOR="#B22222">/*
  Process pause, link adding..
*/</FONT></I>
<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_mirror_process_user_interaction</FONT></B>(htsmoduleStruct * str,
                                         htsmoduleStructExtended * stre) {
  <B><FONT COLOR="#228B22">int</FONT></B> b;

  <I><FONT COLOR="#B22222">/* Load engine variables */</FONT></I>
  ENGINE_LOAD_CONTEXT();

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">BDEBUG</FONT>==1
  printf(<B><FONT COLOR="#BC8F8F">&quot;\nBack test..\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  <I><FONT COLOR="#B22222">// pause/lock files
</FONT></I>  {
    <B><FONT COLOR="#228B22">int</FONT></B> do_pause = 0;

    <I><FONT COLOR="#B22222">// user pause lockfile : create hts-paused.lock --&gt; HTTrack will be paused
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (fexist
        (fconcat
         (OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
         StringBuff(opt-&gt;path_log), <B><FONT COLOR="#BC8F8F">&quot;hts-stop.lock&quot;</FONT></B>))) {
      <I><FONT COLOR="#B22222">// remove lockfile
</FONT></I>      remove(fconcat
             (OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
             StringBuff(opt-&gt;path_log), <B><FONT COLOR="#BC8F8F">&quot;hts-stop.lock&quot;</FONT></B>));
      <B><FONT COLOR="#A020F0">if</FONT></B> (!fexist
          (fconcat
           (OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
           StringBuff(opt-&gt;path_log), <B><FONT COLOR="#BC8F8F">&quot;hts-stop.lock&quot;</FONT></B>))) {
        do_pause = 1;
      }
    }
    <I><FONT COLOR="#B22222">// after receving N bytes, pause
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;fragment &gt; 0) {
      <B><FONT COLOR="#A020F0">if</FONT></B> ((HTS_STAT.stat_bytes - stat_fragment) &gt; opt-&gt;fragment) {
        do_pause = 1;
      }
    }
    <I><FONT COLOR="#B22222">// pause?
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (do_pause) {
      hts_log_print(opt, LOG_INFO, <B><FONT COLOR="#BC8F8F">&quot;engine: pause requested..&quot;</FONT></B>);
      <B><FONT COLOR="#A020F0">while</FONT></B>(back_nsoc(sback) &gt; 0) {     <I><FONT COLOR="#B22222">// attendre fin des transferts
</FONT></I>        back_wait(sback, opt, cache, HTS_STAT.stat_timestart);
        Sleep(200);
        {
          back_wait(sback, opt, cache, HTS_STAT.stat_timestart);

          <I><FONT COLOR="#B22222">// Transfer rate
</FONT></I>          engine_stats();

          <I><FONT COLOR="#B22222">// Refresh various stats
</FONT></I>          HTS_STAT.stat_nsocket = back_nsoc(sback);
          HTS_STAT.stat_errors = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;error&quot;</FONT></B>);
          HTS_STAT.stat_warnings = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;warning&quot;</FONT></B>);
          HTS_STAT.stat_infos = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);
          HTS_STAT.nbk = backlinks_done(sback, opt-&gt;liens, opt-&gt;lien_tot, ptr);
          HTS_STAT.nb = back_transferred(HTS_STAT.stat_bytes, sback);

          b = 0;
          <B><FONT COLOR="#A020F0">if</FONT></B> (!RUN_CALLBACK7
              (opt, loop, sback-&gt;lnk, sback-&gt;count, b, ptr, opt-&gt;lien_tot,
               (<B><FONT COLOR="#228B22">int</FONT></B>) (time_local() - HTS_STAT.stat_timestart), &amp;HTS_STAT)
              || !back_checkmirror(opt)) {
            hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Exit requested by shell or user&quot;</FONT></B>);
            *stre-&gt;exit_xh_ = 1;        <I><FONT COLOR="#B22222">// exit requested
</FONT></I>            XH_uninit;
            <B><FONT COLOR="#A020F0">return</FONT></B>;
          }
        }
      }
      <I><FONT COLOR="#B22222">// On désalloue le buffer d'enregistrement des chemins créée, au cas où pendant la pause
</FONT></I>      <I><FONT COLOR="#B22222">// l'utilisateur ferait un rm -r après avoir effectué un tar
</FONT></I>      <I><FONT COLOR="#B22222">// structcheck_init(1);
</FONT></I>      {
        FILE *fp =
          fopen(fconcat
                (OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
                StringBuff(opt-&gt;path_log),
                 <B><FONT COLOR="#BC8F8F">&quot;hts-paused.lock&quot;</FONT></B>), <B><FONT COLOR="#BC8F8F">&quot;wb&quot;</FONT></B>);
        <B><FONT COLOR="#A020F0">if</FONT></B> (fp) {
          fspc(NULL, fp, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);       <I><FONT COLOR="#B22222">// dater
</FONT></I>          fprintf(fp,
                  <B><FONT COLOR="#BC8F8F">&quot;Pause&quot;</FONT></B> LF <B><FONT COLOR="#BC8F8F">&quot;HTTrack is paused after retreiving &quot;</FONT></B> LLintP
                  <B><FONT COLOR="#BC8F8F">&quot; bytes&quot;</FONT></B> LF <B><FONT COLOR="#BC8F8F">&quot;Delete this file to continue the mirror-&gt;..&quot;</FONT></B> LF
                  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B> LF <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, (LLint) HTS_STAT.stat_bytes);
          fclose(fp);
        }
      }
      stat_fragment = HTS_STAT.stat_bytes;
      <I><FONT COLOR="#B22222">/* Info for wrappers */</FONT></I>
      hts_log_print(opt, LOG_INFO, <B><FONT COLOR="#BC8F8F">&quot;engine: pause: %s&quot;</FONT></B>,
                    fconcat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),  StringBuff(opt-&gt;path_log),
                            <B><FONT COLOR="#BC8F8F">&quot;hts-paused.lock&quot;</FONT></B>));
      RUN_CALLBACK1(opt, pause,
                    fconcat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),  StringBuff(opt-&gt;path_log),
                            <B><FONT COLOR="#BC8F8F">&quot;hts-paused.lock&quot;</FONT></B>));
    }
    <I><FONT COLOR="#B22222">//
</FONT></I>  }
  <I><FONT COLOR="#B22222">// end of pause/lock files
</FONT></I>
  <I><FONT COLOR="#B22222">// changement dans les préférences
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;state._hts_addurl) {
    lien_adrfilsave add;

    <B><FONT COLOR="#A020F0">while</FONT></B>(*opt-&gt;state._hts_addurl) {
      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK add_url[HTS_URLMAXSIZE * 2];

      add.af.adr[0] = add.af.fil[0] = add_url[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(*opt-&gt;state._hts_addurl))
        strcpybuff(add_url, <B><FONT COLOR="#BC8F8F">&quot;http://&quot;</FONT></B>); <I><FONT COLOR="#B22222">// ajouter http://
</FONT></I>      strcatbuff(add_url, *opt-&gt;state._hts_addurl);
      <B><FONT COLOR="#A020F0">if</FONT></B> (ident_url_absolute(add_url, &amp;add.af) &gt;= 0) {
        <I><FONT COLOR="#B22222">// ----Ajout----
</FONT></I>
        <I><FONT COLOR="#B22222">// calculer lien et éventuellement modifier addresse/fichier
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (url_savename
            (&amp;add, NULL, NULL, NULL, opt, sback, cache, hash, ptr, numero_passe, NULL) != -1) {
          <B><FONT COLOR="#A020F0">if</FONT></B> (hash_read(hash, add.save, NULL, HASH_STRUCT_FILENAME) &lt; 0) { <I><FONT COLOR="#B22222">// n'existe pas déja
</FONT></I>            <I><FONT COLOR="#B22222">// enregistrer lien
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (hts_record_link(opt, add.af.adr, add.af.fil, add.save, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, NULL)) {
              heap_top()-&gt;testmode = 0;    <I><FONT COLOR="#B22222">// mode test?
</FONT></I>              heap_top()-&gt;link_import = 0; <I><FONT COLOR="#B22222">// mode normal
</FONT></I>              heap_top()-&gt;depth = opt-&gt;depth;
              heap_top()-&gt;pass2 = max(0, numero_passe);
              heap_top()-&gt;retry = opt-&gt;retry;
              heap_top()-&gt;premier = heap_top_index();
              heap_top()-&gt;precedent = heap_top_index();
              <I><FONT COLOR="#B22222">//
</FONT></I>              hts_log_print(opt, LOG_INFO, <B><FONT COLOR="#BC8F8F">&quot;Link added by user: %s%s&quot;</FONT></B>, add.af.adr,
                            add.af.fil);
              <I><FONT COLOR="#B22222">//
</FONT></I>            } <B><FONT COLOR="#A020F0">else</FONT></B> {            <I><FONT COLOR="#B22222">// oups erreur, plus de mémoire!!
</FONT></I>              XH_uninit;        <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>              <B><FONT COLOR="#A020F0">return</FONT></B>;
            }
          } <B><FONT COLOR="#A020F0">else</FONT></B> {
            hts_log_print(opt, LOG_NOTICE,
                          <B><FONT COLOR="#BC8F8F">&quot;Existing link %s%s not added after user request&quot;</FONT></B>,
                          add.af.adr, add.af.fil);
          }

        }
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Error during URL decoding for %s&quot;</FONT></B>,
                      add_url);
      }
      <I><FONT COLOR="#B22222">// ----Fin Ajout----
</FONT></I>      opt-&gt;state._hts_addurl++; <I><FONT COLOR="#B22222">// suivante
</FONT></I>    }
    opt-&gt;state._hts_addurl = NULL;      <I><FONT COLOR="#B22222">// libérer _hts_addurl
</FONT></I>  }
  <I><FONT COLOR="#B22222">// si une pause a été demandée
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;state._hts_setpause
      || back_pluggable_sockets_strict(sback, opt) &lt;= 0) {
    <I><FONT COLOR="#B22222">// index du lien actuel
</FONT></I>    <B><FONT COLOR="#228B22">int</FONT></B> b = back_index(opt, sback, urladr(), urlfil(), savename());
    <B><FONT COLOR="#228B22">int</FONT></B> prev = opt-&gt;state._hts_in_html_parsing;

    <B><FONT COLOR="#A020F0">if</FONT></B> (b &lt; 0)
      b = 0;                    <I><FONT COLOR="#B22222">// forcer pour les stats
</FONT></I>    <B><FONT COLOR="#A020F0">while</FONT></B>(opt-&gt;state._hts_setpause || back_pluggable_sockets_strict(sback, opt) &lt;= 0) { <I><FONT COLOR="#B22222">// on fait la pause..
</FONT></I>      opt-&gt;state._hts_in_html_parsing = 6;
      back_wait(sback, opt, cache, HTS_STAT.stat_timestart);

      <I><FONT COLOR="#B22222">// Transfer rate
</FONT></I>      engine_stats();

      <I><FONT COLOR="#B22222">// Refresh various stats
</FONT></I>      HTS_STAT.stat_nsocket = back_nsoc(sback);
      HTS_STAT.stat_errors = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;error&quot;</FONT></B>);
      HTS_STAT.stat_warnings = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;warning&quot;</FONT></B>);
      HTS_STAT.stat_infos = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);
      HTS_STAT.nbk = backlinks_done(sback, opt-&gt;liens, opt-&gt;lien_tot, ptr);
      HTS_STAT.nb = back_transferred(HTS_STAT.stat_bytes, sback);

      <B><FONT COLOR="#A020F0">if</FONT></B> (!RUN_CALLBACK7
          (opt, loop, sback-&gt;lnk, sback-&gt;count, b, ptr, opt-&gt;lien_tot,
           (<B><FONT COLOR="#228B22">int</FONT></B>) (time_local() - HTS_STAT.stat_timestart), &amp;HTS_STAT)) {
        hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Exit requested by shell or user&quot;</FONT></B>);
        *stre-&gt;exit_xh_ = 1;    <I><FONT COLOR="#B22222">// exit requested
</FONT></I>        XH_uninit;
        <B><FONT COLOR="#A020F0">return</FONT></B>;
      }
      Sleep(100);               <I><FONT COLOR="#B22222">// pause
</FONT></I>    }
    opt-&gt;state._hts_in_html_parsing = prev;
  }
  ENGINE_SAVE_CONTEXT();
  <B><FONT COLOR="#A020F0">return</FONT></B>;
}

<I><FONT COLOR="#B22222">/*
Wait for next file and
check 301, 302, .. statuscodes (moved)
*/</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_mirror_wait_for_next_file</FONT></B>(htsmoduleStruct * str,
                                  htsmoduleStructExtended * stre) {
  <I><FONT COLOR="#B22222">/* Load engine variables */</FONT></I>
  ENGINE_DEFINE_CONTEXT();
  <B><FONT COLOR="#228B22">int</FONT></B> b;
  <B><FONT COLOR="#228B22">int</FONT></B> n;

  <I><FONT COLOR="#B22222">/* This is not supposed to hapen. */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (heap(ptr)-&gt;pass2 == -1) {
    hts_log_print(opt, LOG_WARNING, <B><FONT COLOR="#BC8F8F">&quot;Link is already ready %s%s&quot;</FONT></B>, urladr(),
                  urlfil());
  }

  <I><FONT COLOR="#B22222">/* User interaction */</FONT></I>
  ENGINE_SAVE_CONTEXT();
  {
    hts_mirror_process_user_interaction(str, stre);
  }
  ENGINE_SET_CONTEXT();

  <I><FONT COLOR="#B22222">/* Done while processing user interactions ? */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (heap(ptr)-&gt;pass2 == -1) {
    hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Link is now ready %s%s&quot;</FONT></B>, urladr(), urlfil());
    <I><FONT COLOR="#B22222">// We are ready
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> 2;                   <I><FONT COLOR="#B22222">// goto jump_if_done;
</FONT></I>  }
  <I><FONT COLOR="#B22222">// si le fichier n'est pas en backing, le mettre..
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (!back_exist(str-&gt;sback, str-&gt;opt, urladr(), urlfil(), savename())) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">BDEBUG</FONT>==1
    printf(<B><FONT COLOR="#BC8F8F">&quot;crash backing: %s%s\n&quot;</FONT></B>, heap(ptr)-&gt;adr, heap(ptr)-&gt;fil);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B> (back_add
        (sback, opt, cache, urladr(), urlfil(), savename(),
         heap(heap(ptr)-&gt;precedent)-&gt;adr, heap(heap(ptr)-&gt;precedent)-&gt;fil,
         heap(ptr)-&gt;testmode) == -1) {
      printf(<B><FONT COLOR="#BC8F8F">&quot;PANIC! : Crash adding error, unexpected error found.. [%d]\n&quot;</FONT></B>,
             __LINE__);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">BDEBUG</FONT>==1
      printf(<B><FONT COLOR="#BC8F8F">&quot;error while crash adding\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Unexpected backing error for %s%s&quot;</FONT></B>, urladr(),
                    urlfil());

    }
  }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">BDEBUG</FONT>==1
  printf(<B><FONT COLOR="#BC8F8F">&quot;test number of socks\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  <I><FONT COLOR="#B22222">// ajouter autant de socket qu'on peut ajouter
</FONT></I>  n = opt-&gt;maxsoc - back_nsoc(sback);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">BDEBUG</FONT>==1
  printf(<B><FONT COLOR="#BC8F8F">&quot;%d sockets available for backing\n&quot;</FONT></B>, n);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  <B><FONT COLOR="#A020F0">if</FONT></B> ((n &gt; 0) &amp;&amp; (!opt-&gt;state._hts_setpause)) { <I><FONT COLOR="#B22222">// si sockets libre et pas en pause, ajouter
</FONT></I>    <I><FONT COLOR="#B22222">// remplir autant que l'on peut le cache (backing)
</FONT></I>    back_fillmax(sback, opt, cache, ptr, numero_passe);
  }
  <I><FONT COLOR="#B22222">// index du lien actuel
</FONT></I>  {
    <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>    <I><FONT COLOR="#B22222">// attendre que le fichier actuel soit prêt - BOUCLE D'ATTENTE
</FONT></I>    <B><FONT COLOR="#A020F0">do</FONT></B> {
      <I><FONT COLOR="#B22222">/* User interaction */</FONT></I>
      ENGINE_SAVE_CONTEXT();
      {
        hts_mirror_process_user_interaction(str, stre);
      }
      ENGINE_SET_CONTEXT();

      <I><FONT COLOR="#B22222">// index du lien actuel
</FONT></I>      b = back_index(opt, sback, urladr(), urlfil(), savename());
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">BDEBUG</FONT>==1
      printf(<B><FONT COLOR="#BC8F8F">&quot;back index %d, waiting\n&quot;</FONT></B>, b);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      <I><FONT COLOR="#B22222">// Continue to the loop if link still present
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (b &lt; 0)
        <B><FONT COLOR="#A020F0">break</FONT></B>;

      <I><FONT COLOR="#B22222">// Receive data
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].status &gt; 0)
        back_wait(sback, opt, cache, HTS_STAT.stat_timestart);

      <I><FONT COLOR="#B22222">// Continue to the loop if link still present
</FONT></I>      b = back_index(opt, sback, urladr(), urlfil(), savename());
      <B><FONT COLOR="#A020F0">if</FONT></B> (b &lt; 0)
        <B><FONT COLOR="#A020F0">break</FONT></B>;

      <I><FONT COLOR="#B22222">// Stop the mirror
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (!back_checkmirror(opt)) {
        hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Exit requested by shell or user&quot;</FONT></B>);
        *stre-&gt;exit_xh_ = 1;    <I><FONT COLOR="#B22222">// exit requested
</FONT></I>        XH_uninit;
        <B><FONT COLOR="#A020F0">return</FONT></B> 0;
      }
      <I><FONT COLOR="#B22222">// And fill the backing stack
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].status &gt; 0)
        back_fillmax(sback, opt, cache, ptr, numero_passe);

      <I><FONT COLOR="#B22222">// Continue to the loop if link still present
</FONT></I>      b = back_index(opt, sback, urladr(), urlfil(), savename());
      <B><FONT COLOR="#A020F0">if</FONT></B> (b &lt; 0)
        <B><FONT COLOR="#A020F0">break</FONT></B>;

      <I><FONT COLOR="#B22222">// autres occupations de HTTrack: statistiques, boucle d'attente, etc.
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;makestat) || (opt-&gt;maketrack)) {
        TStamp l = time_local();

        <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) (l - makestat_time) &gt;= 60) {
          <B><FONT COLOR="#A020F0">if</FONT></B> (makestat_fp != NULL) {
            fspc(NULL, makestat_fp, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);
            fprintf(makestat_fp,
                    <B><FONT COLOR="#BC8F8F">&quot;Rate= %d (/&quot;</FONT></B> LLintP <B><FONT COLOR="#BC8F8F">&quot;) \11NewLinks= %d (/%d)&quot;</FONT></B> LF,
                    (<B><FONT COLOR="#228B22">int</FONT></B>) ((HTS_STAT.HTS_TOTAL_RECV -
                            *stre-&gt;makestat_total_) / (l - makestat_time)),
                    (LLint) HTS_STAT.HTS_TOTAL_RECV,
                    (<B><FONT COLOR="#228B22">int</FONT></B>) opt-&gt;lien_tot - *stre-&gt;makestat_lnk_, (<B><FONT COLOR="#228B22">int</FONT></B>) opt-&gt;lien_tot);
            fflush(makestat_fp);
            *stre-&gt;makestat_total_ = HTS_STAT.HTS_TOTAL_RECV;
            *stre-&gt;makestat_lnk_ = heap_top_index();
          }
          <B><FONT COLOR="#A020F0">if</FONT></B> (stre-&gt;maketrack_fp != NULL) {
            <B><FONT COLOR="#228B22">int</FONT></B> i;

            fspc(NULL, stre-&gt;maketrack_fp, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);
            fprintf(stre-&gt;maketrack_fp, LF);
            <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; back_max; i++) {
              back_info(sback, i, 3, stre-&gt;maketrack_fp);
            }
            fprintf(stre-&gt;maketrack_fp, LF);
            fflush(stre-&gt;maketrack_fp);

          }
          makestat_time = l;
        }
      }

      <I><FONT COLOR="#B22222">/* cancel links */</FONT></I>
      {
        <B><FONT COLOR="#228B22">int</FONT></B> i;
        <B><FONT COLOR="#228B22">char</FONT></B> *s;

        <B><FONT COLOR="#A020F0">while</FONT></B>((s = hts_cancel_file_pop(opt)) != NULL) {
          <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(s)) { <I><FONT COLOR="#B22222">// fichier à canceller
</FONT></I>            <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; back_max; i++) {
              <B><FONT COLOR="#A020F0">if</FONT></B> ((back[i].status &gt; 0)) {
                <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(back[i].url_sav, s) == 0) {  <I><FONT COLOR="#B22222">// ok trouvé
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (back[i].status != 1000) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_DEBUG_CLOSESOCK</FONT>
                    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;user cancel: deletehttp\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
                    <B><FONT COLOR="#A020F0">if</FONT></B> (back[i].r.soc != INVALID_SOCKET)
                      deletehttp(&amp;back[i].r);
                    back[i].r.soc = INVALID_SOCKET;
                    back[i].r.statuscode = STATUSCODE_INVALID;
                    strcpybuff(back[i].r.msg, <B><FONT COLOR="#BC8F8F">&quot;Cancelled by User&quot;</FONT></B>);
                    back[i].status = 0; <I><FONT COLOR="#B22222">// terminé
</FONT></I>                    back_set_finished(sback, i);
                  } <B><FONT COLOR="#A020F0">else</FONT></B>        <I><FONT COLOR="#B22222">// cancel ftp.. flag à 1
</FONT></I>                    back[i].stop_ftp = 1;
                }
              }
            }
            s[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
          }
          freet(s);
        }

        <I><FONT COLOR="#B22222">// Transfer rate
</FONT></I>        engine_stats();

        <I><FONT COLOR="#B22222">// Refresh various stats
</FONT></I>        HTS_STAT.stat_nsocket = back_nsoc(sback);
        HTS_STAT.stat_errors = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;error&quot;</FONT></B>);
        HTS_STAT.stat_warnings = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;warning&quot;</FONT></B>);
        HTS_STAT.stat_infos = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);
        HTS_STAT.nbk = backlinks_done(sback, opt-&gt;liens, opt-&gt;lien_tot, ptr);
        HTS_STAT.nb = back_transferred(HTS_STAT.stat_bytes, sback);

        <B><FONT COLOR="#A020F0">if</FONT></B> (!RUN_CALLBACK7
            (opt, loop, sback-&gt;lnk, sback-&gt;count, b, ptr, opt-&gt;lien_tot,
             (<B><FONT COLOR="#228B22">int</FONT></B>) (time_local() - HTS_STAT.stat_timestart), &amp;HTS_STAT)) {
          hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Exit requested by shell or user&quot;</FONT></B>);
          *stre-&gt;exit_xh_ = 1;  <I><FONT COLOR="#B22222">// exit requested
</FONT></I>          XH_uninit;
          <B><FONT COLOR="#A020F0">return</FONT></B> 0;
        }

      }

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_POLL</FONT>
      <B><FONT COLOR="#A020F0">if</FONT></B> ((opt-&gt;shell) || (opt-&gt;keyboard) || (opt-&gt;verbosedisplay)
          || (!opt-&gt;quiet)) {
        TStamp tl;

        *stre-&gt;info_shell_ = 1;

        <I><FONT COLOR="#B22222">/* Toggle with ENTER */</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;quiet) {
          <B><FONT COLOR="#A020F0">if</FONT></B> (check_stdin()) {
            <B><FONT COLOR="#228B22">char</FONT></B> com[256];

            linput(stdin, com, 200);
            <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;verbosedisplay == 2)
              opt-&gt;verbosedisplay = 1;
            <B><FONT COLOR="#A020F0">else</FONT></B>
              opt-&gt;verbosedisplay = 2;
            <I><FONT COLOR="#B22222">/* Info for wrappers */</FONT></I>
            hts_log_print(opt, LOG_INFO, <B><FONT COLOR="#BC8F8F">&quot;engine: change-options&quot;</FONT></B>);
            RUN_CALLBACK0(opt, chopt);
          }
        }

        tl = time_local();

        <I><FONT COLOR="#B22222">// générer un message d'infos sur l'état actuel
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;shell) {       <I><FONT COLOR="#B22222">// si shell
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> ((tl - *stre-&gt;last_info_shell_) &gt; 0) {     <I><FONT COLOR="#B22222">// toute les 1 sec
</FONT></I>            FILE *fp = stdout;
            <B><FONT COLOR="#228B22">int</FONT></B> a = 0;

            *stre-&gt;last_info_shell_ = tl;
            <B><FONT COLOR="#A020F0">if</FONT></B> (fexist(fconcat(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),  StringBuff(opt-&gt;path_log), <B><FONT COLOR="#BC8F8F">&quot;hts-autopsy&quot;</FONT></B>))) { <I><FONT COLOR="#B22222">// débuggage: teste si le robot est vivant
</FONT></I>              <I><FONT COLOR="#B22222">// (oui je sais un robot vivant.. mais bon.. il a le droit de vivre lui aussi)
</FONT></I>              <I><FONT COLOR="#B22222">// (libérons les robots esclaves de l'internet!)
</FONT></I>              remove(fconcat
                     (OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
                     StringBuff(opt-&gt;path_log),
                      <B><FONT COLOR="#BC8F8F">&quot;hts-autopsy&quot;</FONT></B>));
              fp =
                fopen(fconcat
                      (OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
                      StringBuff(opt-&gt;path_log),
                       <B><FONT COLOR="#BC8F8F">&quot;hts-isalive&quot;</FONT></B>), <B><FONT COLOR="#BC8F8F">&quot;wb&quot;</FONT></B>);
              a = 1;
            }
            <B><FONT COLOR="#A020F0">if</FONT></B> ((*stre-&gt;info_shell_) || a) {
              <B><FONT COLOR="#228B22">int</FONT></B> i, j;

              fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;TIME %d&quot;</FONT></B> LF, (<B><FONT COLOR="#228B22">int</FONT></B>) (tl - HTS_STAT.stat_timestart));
              fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;TOTAL %d&quot;</FONT></B> LF, (<B><FONT COLOR="#228B22">int</FONT></B>) HTS_STAT.stat_bytes);
              fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;RATE %d&quot;</FONT></B> LF,
                      (<B><FONT COLOR="#228B22">int</FONT></B>) (HTS_STAT.HTS_TOTAL_RECV /
                             (tl - HTS_STAT.stat_timestart)));
              fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;SOCKET %d&quot;</FONT></B> LF, back_nsoc(sback));
              fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;LINK %d&quot;</FONT></B> LF, opt-&gt;lien_tot);
              {
                LLint mem = 0;

                <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; back_max; i++)
                  <B><FONT COLOR="#A020F0">if</FONT></B> (back[i].r.adr != NULL)
                    mem += back[i].r.size;
                fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;INMEM &quot;</FONT></B> LLintP <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B> LF, (LLint) mem);
              }
              <B><FONT COLOR="#A020F0">for</FONT></B>(j = 0; j &lt; 2; j++) {  <I><FONT COLOR="#B22222">// passes pour ready et wait
</FONT></I>                <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; back_max; i++) {
                  back_info(sback, i, j + 1, stdout);   <I><FONT COLOR="#B22222">// maketrack_fp a la place de stdout ?? // **
</FONT></I>                }
              }
              fprintf(fp, LF);
              <B><FONT COLOR="#A020F0">if</FONT></B> (a)
                fclose(fp);
              io_flush;
            }
          }
        }                       <I><FONT COLOR="#B22222">// si shell
</FONT></I>
      }                         <I><FONT COLOR="#B22222">// si shell ou keyboard (option)
</FONT></I>      <I><FONT COLOR="#B22222">//
</FONT></I>#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    } <B><FONT COLOR="#A020F0">while</FONT></B>((b &gt;= 0) &amp;&amp; (back[max(b, 0)].status &gt; 0));

    <I><FONT COLOR="#B22222">// If link not found on the stack, it's because it has already been downloaded
</FONT></I>    <I><FONT COLOR="#B22222">// in background
</FONT></I>    <I><FONT COLOR="#B22222">// Then, skip it and go to the next one
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (b &lt; 0) {
      hts_log_print(opt, LOG_DEBUG,
                    <B><FONT COLOR="#BC8F8F">&quot;link #%d is ready, no more on the stack, skipping: %s%s..&quot;</FONT></B>,
                    ptr, urladr(), urlfil());

      <I><FONT COLOR="#B22222">// prochain lien
</FONT></I>      <I><FONT COLOR="#B22222">// ptr++;
</FONT></I>
      <B><FONT COLOR="#A020F0">return</FONT></B> 2;                 <I><FONT COLOR="#B22222">// goto jump_if_done;
</FONT></I>
    }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
    <I><FONT COLOR="#B22222">/* FIXME - finalized HAS NO MORE THIS MEANING */</FONT></I>
    <I><FONT COLOR="#B22222">/* link put in cache by the backing system for memory spare - reclaim */</FONT></I>
    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].finalized) {
      assertf(back[b].r.adr == NULL);
      <I><FONT COLOR="#B22222">/* read file in cache */</FONT></I>
      back[b].r =
        cache_read_ro(opt, cache, back[b].url_adr, back[b].url_fil,
                      back[b].url_sav, back[b].location_buffer);
      <I><FONT COLOR="#B22222">/* ensure correct location buffer set */</FONT></I>
      back[b].r.location = back[b].location_buffer;
      <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].r.statuscode == STATUSCODE_INVALID) {
        hts_log_print(opt, LOG_ERROR,
                      <B><FONT COLOR="#BC8F8F">&quot;Unexpected error: %s%s not found anymore in cache&quot;</FONT></B>,
                      back[b].url_adr, back[b].url_fil);
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;reclaim file %s%s (%d)&quot;</FONT></B>, back[b].url_adr,
                      back[b].url_fil, back[b].r.statuscode);
      }
    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;verbosedisplay) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;quiet) {
        <B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> roll = 0;    <I><FONT COLOR="#B22222">/* static: ok */</FONT></I>

        roll = (roll + 1) % 4;
        printf(<B><FONT COLOR="#BC8F8F">&quot;%c\x0d&quot;</FONT></B>, (<B><FONT COLOR="#BC8F8F">&quot;/-\\|&quot;</FONT></B>)[roll]);
        fflush(stdout);
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;verbosedisplay == 1) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (b &gt;= 0) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].r.statuscode == HTTP_OK)
          printf(<B><FONT COLOR="#BC8F8F">&quot;%d/%d: %s%s (&quot;</FONT></B> LLintP <B><FONT COLOR="#BC8F8F">&quot; bytes) - OK\33[K\r&quot;</FONT></B>, ptr, opt-&gt;lien_tot,
                 back[b].url_adr, back[b].url_fil, (LLint) back[b].r.size);
        <B><FONT COLOR="#A020F0">else</FONT></B>
          printf(<B><FONT COLOR="#BC8F8F">&quot;%d/%d: %s%s (&quot;</FONT></B> LLintP <B><FONT COLOR="#BC8F8F">&quot; bytes) - %d\33[K\r&quot;</FONT></B>, ptr, opt-&gt;lien_tot,
                 back[b].url_adr, back[b].url_fil, (LLint) back[b].r.size,
                 back[b].r.statuscode);
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_log_print(opt, LOG_ERROR, <B><FONT COLOR="#BC8F8F">&quot;Link disappeared&quot;</FONT></B>);
      }
      fflush(stdout);
    }
    <I><FONT COLOR="#B22222">//}
</FONT></I>
    <I><FONT COLOR="#B22222">// ------------------------------------------------------------
</FONT></I>    <I><FONT COLOR="#B22222">// Vérificateur d'intégrité
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG_CHECKINT</FONT>
    _CHECKINT(&amp;back[b], <B><FONT COLOR="#BC8F8F">&quot;Retour de back_wait, après le while&quot;</FONT></B>) {
      <B><FONT COLOR="#228B22">int</FONT></B> i;

      <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; back_max; i++) {
        <B><FONT COLOR="#228B22">char</FONT></B> si[256];

        sprintf(si, <B><FONT COLOR="#BC8F8F">&quot;Test global après back_wait, index %d&quot;</FONT></B>, i);
        _CHECKINT(&amp;back[i], si)
      }
    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    <I><FONT COLOR="#B22222">// copier structure réponse htsblk
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (b &gt;= 0) {
      memcpy(r, &amp;(back[b].r), <B><FONT COLOR="#A020F0">sizeof</FONT></B>(htsblk));
      r-&gt;location = stre-&gt;loc_; <I><FONT COLOR="#B22222">// ne PAS copier location!! adresse, pas de buffer
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].r.location)
        strcpybuff(r-&gt;location, back[b].r.location);
      back[b].r.adr = NULL;     <I><FONT COLOR="#B22222">// ne pas faire de desalloc ensuite
</FONT></I>
      <I><FONT COLOR="#B22222">// libérer emplacement backing
</FONT></I>      back_maydelete(opt, cache, sback, b);
    }
    <I><FONT COLOR="#B22222">// débug graphique
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">BDEBUG</FONT>==2
    {
      <B><FONT COLOR="#228B22">char</FONT></B> s[12];
      <B><FONT COLOR="#228B22">int</FONT></B> i = 0;

      _GOTOXY(1, 1);
      printf(<B><FONT COLOR="#BC8F8F">&quot;Rate=%d B/sec\n&quot;</FONT></B>,
             (<B><FONT COLOR="#228B22">int</FONT></B>) (HTS_STAT.HTS_TOTAL_RECV /
                    (time_local() - HTS_STAT.stat_timestart)));
      <B><FONT COLOR="#A020F0">while</FONT></B>(i &lt; minimum(back_max, 160)) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (back[i].status &gt; 0) {
          sprintf(s, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, back[i].r.size);
        } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (back[i].status == STATUS_READY) {
          strcpybuff(s, <B><FONT COLOR="#BC8F8F">&quot;ENDED&quot;</FONT></B>);
        } <B><FONT COLOR="#A020F0">else</FONT></B>
          strcpybuff(s, <B><FONT COLOR="#BC8F8F">&quot;   -   &quot;</FONT></B>);
        <B><FONT COLOR="#A020F0">while</FONT></B>(strlen(s) &lt; 8)
          strcatbuff(s, <B><FONT COLOR="#BC8F8F">&quot; &quot;</FONT></B>);
        printf(<B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, s);
        io_flush;
        i++;
      }
    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">BDEBUG</FONT>==1
    printf(<B><FONT COLOR="#BC8F8F">&quot;statuscode=%d with %s / msg=%s\n&quot;</FONT></B>, r-&gt;statuscode, r-&gt;contenttype,
           r-&gt;msg);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  }

  ENGINE_SAVE_CONTEXT();
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* Wait for delayed types */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_wait_delayed</FONT></B>(htsmoduleStruct * str, lien_adrfilsave *afs,
                     <B><FONT COLOR="#228B22">char</FONT></B> *parent_adr, <B><FONT COLOR="#228B22">char</FONT></B> *parent_fil, lien_adrfil *former,
                     <B><FONT COLOR="#228B22">int</FONT></B> *forbidden_url) {
  ENGINE_LOAD_CONTEXT_BASE();
  hash_struct *<B><FONT COLOR="#228B22">const</FONT></B> hash = hashptr;

  <B><FONT COLOR="#228B22">int</FONT></B> in_error = 0;
  LLint in_error_size = 0;
  <B><FONT COLOR="#228B22">char</FONT></B> in_error_msg[32];

  <I><FONT COLOR="#B22222">// resolve unresolved type
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;savename_delayed != 0 &amp;&amp; *forbidden_url == 0 &amp;&amp; IS_DELAYED_EXT(afs-&gt;save)
      &amp;&amp; !opt-&gt;state.stop) {
    <B><FONT COLOR="#228B22">int</FONT></B> loops;
    <B><FONT COLOR="#228B22">int</FONT></B> continue_loop;

    hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Waiting for type to be known: %s%s&quot;</FONT></B>, afs-&gt;af.adr,
                  afs-&gt;af.fil);

    <I><FONT COLOR="#B22222">/* Follow while type is unknown and redirects occurs */</FONT></I>
    <B><FONT COLOR="#A020F0">for</FONT></B>(loops = 0, continue_loop = 1;
        IS_DELAYED_EXT(afs-&gt;save) &amp;&amp; continue_loop &amp;&amp; loops &lt; 7; loops++) {
      continue_loop = 0;

      <I><FONT COLOR="#B22222">/*
         Wait for an available slot 
       */</FONT></I>
      WAIT_FOR_AVAILABLE_SOCKET();

      <I><FONT COLOR="#B22222">/* We can lookup directly in the cache to speedup this mess */</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;delayed_cached) {
        lien_back back;

        memset(&amp;back, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(back));
        back.r = cache_read(opt, cache, afs-&gt;af.adr, afs-&gt;af.fil, NULL, NULL);  <I><FONT COLOR="#B22222">// test uniquement
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (back.r.statuscode == HTTP_OK &amp;&amp; strnotempty(back.r.contenttype)) {  <I><FONT COLOR="#B22222">// cache found, and aswer is 'OK'
</FONT></I>          hts_log_print(opt, LOG_DEBUG,
                        <B><FONT COLOR="#BC8F8F">&quot;Direct type lookup in cache (-%%D1): %s&quot;</FONT></B>,
                        back.r.contenttype);

          <I><FONT COLOR="#B22222">/* Recompute filename with MIME type */</FONT></I>
          afs-&gt;save[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
          url_savename(afs, former, heap(ptr)-&gt;adr,
                       heap(ptr)-&gt;fil, opt, sback, cache,
                       hash, ptr, numero_passe, &amp;back);

          <I><FONT COLOR="#B22222">/* Recompute authorization with MIME type */</FONT></I>
          {
            <B><FONT COLOR="#228B22">int</FONT></B> new_forbidden_url =
              hts_acceptmime(opt, ptr, afs-&gt;af.adr, afs-&gt;af.fil, back.r.contenttype);
            <B><FONT COLOR="#A020F0">if</FONT></B> (new_forbidden_url != -1) {
              hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;result for wizard mime test: %d&quot;</FONT></B>,
                            new_forbidden_url);
              <B><FONT COLOR="#A020F0">if</FONT></B> (new_forbidden_url == 1) {
                *forbidden_url = new_forbidden_url;
                hts_log_print(opt, LOG_DEBUG,
                              <B><FONT COLOR="#BC8F8F">&quot;link forbidden because of MIME types restrictions: %s%s&quot;</FONT></B>,
                              afs-&gt;af.adr, afs-&gt;af.fil);
                <B><FONT COLOR="#A020F0">break</FONT></B>;          <I><FONT COLOR="#B22222">// exit loop
</FONT></I>              }
            }
          }

          <I><FONT COLOR="#B22222">/* And exit loop */</FONT></I>
          <B><FONT COLOR="#A020F0">break</FONT></B>;
        }
      }

      <I><FONT COLOR="#B22222">/* Check if the file was recorded already (necessary for redirects) */</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> (hash_read(hash, afs-&gt;save, NULL, HASH_STRUCT_FILENAME) &gt;= 0) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (loops == 0) {       <I><FONT COLOR="#B22222">/* Should not happend */</FONT></I>
          hts_log_print(opt, LOG_ERROR,
                        <B><FONT COLOR="#BC8F8F">&quot;Duplicate entry in hts_wait_delayed() cancelled: %s%s -&gt; %s&quot;</FONT></B>,
                        afs-&gt;af.adr, afs-&gt;af.fil, afs-&gt;save);
        }
        <I><FONT COLOR="#B22222">/* Exit loop (we're done) */</FONT></I>
        continue_loop = 0;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      }

      <I><FONT COLOR="#B22222">/* Add in backing (back_index() will respond correctly) */</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> (back_add_if_not_exists
          (sback, opt, cache, afs-&gt;af.adr, afs-&gt;af.fil, afs-&gt;save, parent_adr, parent_fil,
           0) != -1) {
        <B><FONT COLOR="#228B22">int</FONT></B> b;

        b = back_index(opt, sback, afs-&gt;af.adr, afs-&gt;af.fil, afs-&gt;save);
        <B><FONT COLOR="#A020F0">if</FONT></B> (b &lt; 0) {
          printf(<B><FONT COLOR="#BC8F8F">&quot;PANIC! : Crash adding error, unexpected error found.. [%d]\n&quot;</FONT></B>,
                 __LINE__);
          XH_uninit;            <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>          <B><FONT COLOR="#A020F0">return</FONT></B> -1;
        }

        <I><FONT COLOR="#B22222">/* We added the link before the parser recorded it -- the background download MUST NOT clean silently this entry! (Petr Gajdusek) */</FONT></I>
        back[b].early_add = 1;

        <I><FONT COLOR="#B22222">/* Cache read failed because file does not exist (bad delayed name!)
           Just re-add with the correct name, as we know the MIME now!
         */</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].r.statuscode == STATUSCODE_INVALID &amp;&amp; back[b].r.adr == NULL) {
          lien_back delayed_back;

          <I><FONT COLOR="#B22222">//char BIGSTK delayed_ctype[128];
</FONT></I>          <I><FONT COLOR="#B22222">// delayed_ctype[0] = '\0';
</FONT></I>          <I><FONT COLOR="#B22222">// strncatbuff(delayed_ctype, back[b].r.contenttype, sizeof(delayed_ctype) - 1);    // copier content-type
</FONT></I>          back_copy_static(&amp;back[b], &amp;delayed_back);

          <I><FONT COLOR="#B22222">/* Delete entry */</FONT></I>
          back[b].r.statuscode = 0;  <I><FONT COLOR="#B22222">/* TEMPORARY INVESTIGATE WHY WE FETCHED A SOCKET HERE */</FONT></I>
          back_maydelete(opt, cache, sback, b);    <I><FONT COLOR="#B22222">// cancel
</FONT></I>          b = -1;

          <I><FONT COLOR="#B22222">/* Recompute filename with MIME type */</FONT></I>
          afs-&gt;save[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
          url_savename(afs, former, heap(ptr)-&gt;adr,
                       heap(ptr)-&gt;fil, opt, sback, cache,
                       hash, ptr, numero_passe, &amp;delayed_back);

          <I><FONT COLOR="#B22222">/* Recompute authorization with MIME type */</FONT></I>
          {
            <B><FONT COLOR="#228B22">int</FONT></B> new_forbidden_url =
              hts_acceptmime(opt, ptr, afs-&gt;af.adr, afs-&gt;af.fil, delayed_back.r.contenttype);
            <B><FONT COLOR="#A020F0">if</FONT></B> (new_forbidden_url != -1) {
              hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;result for wizard mime test: %d&quot;</FONT></B>,
                            *forbidden_url);
              <B><FONT COLOR="#A020F0">if</FONT></B> (new_forbidden_url == 1) {
                *forbidden_url = new_forbidden_url;
                hts_log_print(opt, LOG_DEBUG,
                              <B><FONT COLOR="#BC8F8F">&quot;link forbidden because of MIME types restrictions: %s%s&quot;</FONT></B>,
                              afs-&gt;af.adr, afs-&gt;af.fil);
                <B><FONT COLOR="#A020F0">break</FONT></B>;          <I><FONT COLOR="#B22222">// exit loop
</FONT></I>              }
            }
          }

          <I><FONT COLOR="#B22222">/* Re-Add wiht correct type */</FONT></I>
          <B><FONT COLOR="#A020F0">if</FONT></B> (back_add_if_not_exists
              (sback, opt, cache, afs-&gt;af.adr, afs-&gt;af.fil, afs-&gt;save, parent_adr, parent_fil,
               0) != -1) {
            b = back_index(opt, sback, afs-&gt;af.adr, afs-&gt;af.fil, afs-&gt;save);
          }
          <B><FONT COLOR="#A020F0">if</FONT></B> (b &lt; 0) {
            printf
              (<B><FONT COLOR="#BC8F8F">&quot;PANIC! : Crash adding error, unexpected error found.. [%d]\n&quot;</FONT></B>,
               __LINE__);
            XH_uninit;          <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>            <B><FONT COLOR="#A020F0">return</FONT></B> -1;
          }

          <I><FONT COLOR="#B22222">/* We added the link before the parser recorded it -- the background download MUST NOT clean silently this entry! (Petr Gajdusek) */</FONT></I>
          back[b].early_add = 1;

          hts_log_print(opt, LOG_DEBUG,
                        <B><FONT COLOR="#BC8F8F">&quot;Type immediately loaded from cache: %s&quot;</FONT></B>,
                        delayed_back.r.contenttype);
        }

        <I><FONT COLOR="#B22222">/* Wait for headers to be received */</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> (b &gt;= 0) {
          back_set_locked(sback, b);    <I><FONT COLOR="#B22222">// Locked entry
</FONT></I>        }
        <B><FONT COLOR="#A020F0">do</FONT></B> {
          <B><FONT COLOR="#A020F0">if</FONT></B> (b &lt; 0)
            <B><FONT COLOR="#A020F0">break</FONT></B>;

          <I><FONT COLOR="#B22222">// temps à attendre, et remplir autant que l'on peut le cache (backing)
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].status &gt; 0) {
            back_wait(sback, opt, cache, 0);
          }
          <B><FONT COLOR="#A020F0">if</FONT></B> (ptr &gt;= 0) {
            back_fillmax(sback, opt, cache, ptr, numero_passe);
          }
          <I><FONT COLOR="#B22222">// on est obligé d'appeler le shell pour le refresh..
</FONT></I>          {

            <I><FONT COLOR="#B22222">// Transfer rate
</FONT></I>            engine_stats();

            <I><FONT COLOR="#B22222">// Refresh various stats
</FONT></I>            HTS_STAT.stat_nsocket = back_nsoc(sback);
            HTS_STAT.stat_errors = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;error&quot;</FONT></B>);
            HTS_STAT.stat_warnings = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;warning&quot;</FONT></B>);
            HTS_STAT.stat_infos = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);
            HTS_STAT.nbk = backlinks_done(sback, opt-&gt;liens, opt-&gt;lien_tot, ptr);
            HTS_STAT.nb = back_transferred(HTS_STAT.stat_bytes, sback);

            <B><FONT COLOR="#A020F0">if</FONT></B> (!RUN_CALLBACK7
                (opt, loop, sback-&gt;lnk, sback-&gt;count, b, ptr, opt-&gt;lien_tot,
                 (<B><FONT COLOR="#228B22">int</FONT></B>) (time_local() - HTS_STAT.stat_timestart), &amp;HTS_STAT)) {
              <B><FONT COLOR="#A020F0">return</FONT></B> -1;
            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;state._hts_cancel || !back_checkmirror(opt)) {      <I><FONT COLOR="#B22222">// cancel 2 ou 1 (cancel parsing)
</FONT></I>              back_delete(opt, cache, sback, b);        <I><FONT COLOR="#B22222">// cancel test
</FONT></I>              <B><FONT COLOR="#A020F0">break</FONT></B>;
            }
          }
        } <B><FONT COLOR="#A020F0">while</FONT></B>(
                 <I><FONT COLOR="#B22222">/* dns/connect/request */</FONT></I>
                 (back[b].status &gt;= 99 &amp;&amp; back[b].status &lt;= 101)
                 ||
                 <I><FONT COLOR="#B22222">/* For redirects, wait for request to be terminated */</FONT></I>
                 (HTTP_IS_REDIRECT(back[b].r.statuscode) &amp;&amp; back[b].status &gt; 0)
                 ||
                 <I><FONT COLOR="#B22222">/* Same for errors */</FONT></I>
                 (HTTP_IS_ERROR(back[b].r.statuscode) &amp;&amp; back[b].status &gt; 0)
          );
        <B><FONT COLOR="#A020F0">if</FONT></B> (b &gt;= 0) {
          back_set_unlocked(sback, b);  <I><FONT COLOR="#B22222">// Unlocked entry
</FONT></I>        }
        <I><FONT COLOR="#B22222">/* ready (chunked) or ready (regular download) or ready (completed) */</FONT></I>

        <I><FONT COLOR="#B22222">// Note: filename NOT in hashtable yet - liens_record will do it, with the correct ext!
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (b &gt;= 0) {
          lien_back delayed_back;

          <I><FONT COLOR="#B22222">//char BIGSTK delayed_ctype[128];
</FONT></I>          <I><FONT COLOR="#B22222">//delayed_ctype[0] = '\0';
</FONT></I>          <I><FONT COLOR="#B22222">//strncatbuff(delayed_ctype, back[b].r.contenttype, sizeof(delayed_ctype) - 1);    // copier content-type
</FONT></I>          back_copy_static(&amp;back[b], &amp;delayed_back);

          <I><FONT COLOR="#B22222">/* Error */</FONT></I>
          <B><FONT COLOR="#A020F0">if</FONT></B> (HTTP_IS_ERROR(back[b].r.statuscode)) {
            <I><FONT COLOR="#B22222">/* seen as in error */</FONT></I>
            in_error = back[b].r.statuscode;
            in_error_msg[0] = 0;
            strncat(in_error_msg, back[b].r.msg, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(in_error_msg) - 1);
            in_error_size = back[b].r.totalsize;
            <I><FONT COLOR="#B22222">/* don't break, even with &quot;don't take error pages&quot; switch, because we need to process the slot anyway (and cache the error) */</FONT></I>
          }
          <I><FONT COLOR="#B22222">/* Moved! */</FONT></I>
          <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (HTTP_IS_REDIRECT(back[b].r.statuscode)) {
            <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK mov_url[HTS_URLMAXSIZE * 2];

            mov_url[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
            strcpybuff(mov_url, back[b].r.location);    <I><FONT COLOR="#B22222">// copier URL
</FONT></I>
            <I><FONT COLOR="#B22222">/* Remove (temporarily created) file if it was created */</FONT></I>
            UNLINK(fconv(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), back[b].url_sav));

            <I><FONT COLOR="#B22222">/* Remove slot! */</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].status == STATUS_READY) {
              back_maydelete(opt, cache, sback, b);
            } <B><FONT COLOR="#A020F0">else</FONT></B> {            <I><FONT COLOR="#B22222">/* should not happend */</FONT></I>
              back_delete(opt, cache, sback, b);
            }
            b = -1;

            <I><FONT COLOR="#B22222">/* Handle redirect */</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(mov_url)) {   <I><FONT COLOR="#B22222">// location existe!
</FONT></I>              lien_adrfil moved;
              moved.adr[0] = moved.fil[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
              <I><FONT COLOR="#B22222">//
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> (ident_url_relatif(mov_url, afs-&gt;af.adr, afs-&gt;af.fil, &amp;moved) &gt;= 0) {
                hts_log_print(opt, LOG_DEBUG,
                              <B><FONT COLOR="#BC8F8F">&quot;Redirect while resolving type: %s%s -&gt; %s%s&quot;</FONT></B>,
                              afs-&gt;af.adr, afs-&gt;af.fil, moved.adr, moved.fil);
                <I><FONT COLOR="#B22222">// si non bouclage sur soi même, ou si test avec GET non testé
</FONT></I>                <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(moved.adr, afs-&gt;af.adr) != 0 || strcmp(moved.fil, afs-&gt;af.fil) != 0) {

                  <I><FONT COLOR="#B22222">// recopier former-&gt;adr/fil?
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (former != NULL) {
                    <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(former-&gt;adr) == 0) { <I><FONT COLOR="#B22222">// Pas déja noté
</FONT></I>                      strcpybuff(former-&gt;adr, afs-&gt;af.adr);
                      strcpybuff(former-&gt;fil, afs-&gt;af.fil);
                    }
                  }
                  <I><FONT COLOR="#B22222">// check explicit forbidden - don't follow 3xx in this case
</FONT></I>                  {
                    <B><FONT COLOR="#228B22">int</FONT></B> set_prio_to = 0;

                    <B><FONT COLOR="#A020F0">if</FONT></B> (hts_acceptlink(opt, ptr, moved.adr, moved.fil, NULL, NULL, &amp;set_prio_to, NULL) == 1) {     <I><FONT COLOR="#B22222">/* forbidden */</FONT></I>
                      <I><FONT COLOR="#B22222">/* Note: the cache 'cached_tests' system will remember this error, and we'll only issue ONE request */</FONT></I>
                      *forbidden_url = 1;       <I><FONT COLOR="#B22222">/* Forbidden! */</FONT></I>
                      hts_log_print(opt, LOG_DEBUG,
                                    <B><FONT COLOR="#BC8F8F">&quot;link forbidden because of redirect beyond the mirror scope at %s%s -&gt; %s%s&quot;</FONT></B>,
                                    afs-&gt;af.adr, afs-&gt;af.fil, moved.adr, moved.fil);
                      strcpybuff(afs-&gt;af.adr, moved.adr);
                      strcpybuff(afs-&gt;af.fil, moved.fil);
                      mov_url[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                      <B><FONT COLOR="#A020F0">break</FONT></B>;
                    }
                  }

                  <I><FONT COLOR="#B22222">// ftp: stop!
</FONT></I>                  <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(mov_url, <B><FONT COLOR="#BC8F8F">&quot;ftp://&quot;</FONT></B>)) {
                    strcpybuff(afs-&gt;af.adr, moved.adr);
                    strcpybuff(afs-&gt;af.fil, moved.fil);
                    <B><FONT COLOR="#A020F0">break</FONT></B>;
                  }

                  <I><FONT COLOR="#B22222">/* ok, continue */</FONT></I>
                  strcpybuff(afs-&gt;af.adr, moved.adr);
                  strcpybuff(afs-&gt;af.fil, moved.fil);
                  continue_loop = 1;

                  <I><FONT COLOR="#B22222">/* Recompute filename for hash lookup */</FONT></I>
                  afs-&gt;save[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                  url_savename(afs, former, heap(ptr)-&gt;adr, heap(ptr)-&gt;fil, 
                               opt, sback, cache, hash, ptr, numero_passe,
                               &amp;delayed_back);
                } <B><FONT COLOR="#A020F0">else</FONT></B> {
                  hts_log_print(opt, LOG_WARNING,
                                <B><FONT COLOR="#BC8F8F">&quot;Unable to test %s%s (loop to same filename)&quot;</FONT></B>,
                                afs-&gt;af.adr, afs-&gt;af.fil);
                }               <I><FONT COLOR="#B22222">// loop to same location
</FONT></I>              }                 <I><FONT COLOR="#B22222">// ident_url_relatif()
</FONT></I>            }                   <I><FONT COLOR="#B22222">// location
</FONT></I>          }                     <I><FONT COLOR="#B22222">// redirect
</FONT></I>          hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;Final type for %s%s: '%s'&quot;</FONT></B>, afs-&gt;af.adr, afs-&gt;af.fil,
                        delayed_back.r.contenttype);

          <I><FONT COLOR="#B22222">/* If we are done, do additional checks with final type and authorizations */</FONT></I>
          <B><FONT COLOR="#A020F0">if</FONT></B> (!continue_loop) {
            <I><FONT COLOR="#B22222">/* Recompute filename with MIME type */</FONT></I>
            afs-&gt;save[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
            url_savename(afs, former,
                         heap(ptr)-&gt;adr, heap(ptr)-&gt;fil, opt,
                         sback, cache, hash, ptr, numero_passe, &amp;delayed_back);

            <I><FONT COLOR="#B22222">/* Recompute authorization with MIME type */</FONT></I>
            {
              <B><FONT COLOR="#228B22">int</FONT></B> new_forbidden_url =
                hts_acceptmime(opt, ptr, afs-&gt;af.adr, afs-&gt;af.fil, delayed_back.r.contenttype);
              <B><FONT COLOR="#A020F0">if</FONT></B> (new_forbidden_url != -1) {
                hts_log_print(opt, LOG_DEBUG, <B><FONT COLOR="#BC8F8F">&quot;result for wizard mime test: %d&quot;</FONT></B>,
                              *forbidden_url);
                <B><FONT COLOR="#A020F0">if</FONT></B> (new_forbidden_url == 1) {
                  *forbidden_url = new_forbidden_url;
                  hts_log_print(opt, LOG_DEBUG,
                                <B><FONT COLOR="#BC8F8F">&quot;link forbidden because of MIME types restrictions: %s%s&quot;</FONT></B>,
                                afs-&gt;af.adr, afs-&gt;af.fil);
                  <B><FONT COLOR="#A020F0">break</FONT></B>;        <I><FONT COLOR="#B22222">// exit loop
</FONT></I>                }
              }
            }
          }

          <I><FONT COLOR="#B22222">/* Still have a back reference */</FONT></I>
          <B><FONT COLOR="#A020F0">if</FONT></B> (b &gt;= 0) {
            <I><FONT COLOR="#B22222">/* Finalize now as we have the type */</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> (back[b].status == STATUS_READY) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (!back[b].finalized) {
                hts_log_print(opt, LOG_TRACE, <B><FONT COLOR="#BC8F8F">&quot;finalizing as we have the type&quot;</FONT></B>);
                back_finalize(opt, cache, sback, b);
              }
            }
            <I><FONT COLOR="#B22222">/* Patch destination filename for direct-to-disk mode */</FONT></I>
            strcpybuff(back[b].url_sav, afs-&gt;save);
          }

        }                       <I><FONT COLOR="#B22222">// b &gt;= 0
</FONT></I>      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        printf(<B><FONT COLOR="#BC8F8F">&quot;PANIC! : Crash adding error, unexpected error found.. [%d]\n&quot;</FONT></B>,
               __LINE__);
        XH_uninit;              <I><FONT COLOR="#B22222">// désallocation mémoire &amp; buffers
</FONT></I>        <B><FONT COLOR="#A020F0">return</FONT></B> -1;
      }

    }                           <I><FONT COLOR="#B22222">// while(IS_DELAYED_EXT(save))
</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (in_error != 0) {
      <I><FONT COLOR="#B22222">/* 'no error page' selected or file discarded by size rules! */</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> (!opt-&gt;errpage || (in_error == STATUSCODE_TOO_BIG)) {
        <I><FONT COLOR="#B22222">/* Note: the cache 'cached_tests' system will remember this error, and we'll only issue ONE request */</FONT></I>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
        <I><FONT COLOR="#B22222">/* No (3.43) - don't do that. We must not post-exclude an authorized link, because this will prevent the cache
           system from processing it, leading to refetch it endlessly. Just accept it, and handle the error as
           usual during parsing.
         */</FONT></I>
        *forbidden_url = 1;     <I><FONT COLOR="#B22222">/* Forbidden! */</FONT></I>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        <B><FONT COLOR="#A020F0">if</FONT></B> (in_error == STATUSCODE_TOO_BIG) {
          hts_log_print(opt, LOG_INFO,
                        <B><FONT COLOR="#BC8F8F">&quot;link not taken because of its size (%d bytes) at %s%s&quot;</FONT></B>,
                        (<B><FONT COLOR="#228B22">int</FONT></B>) in_error_size, afs-&gt;af.adr, afs-&gt;af.fil);
        } <B><FONT COLOR="#A020F0">else</FONT></B> {
          hts_log_print(opt, LOG_INFO,
                        <B><FONT COLOR="#BC8F8F">&quot;link not taken because of error (%d '%s') at %s%s&quot;</FONT></B>,
                        in_error, in_error_msg, afs-&gt;af.adr, afs-&gt;af.fil);
        }
      }
    }
    <I><FONT COLOR="#B22222">// error
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (*forbidden_url != 1 &amp;&amp; IS_DELAYED_EXT(afs-&gt;save)) {
      *forbidden_url = 1;
      <B><FONT COLOR="#A020F0">if</FONT></B> (in_error) {
        hts_log_print(opt, LOG_WARNING,
                      <B><FONT COLOR="#BC8F8F">&quot;link in error (%d '%s'), type unknown, aborting: %s%s&quot;</FONT></B>,
                      in_error, in_error_msg, afs-&gt;af.adr, afs-&gt;af.fil);
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_log_print(opt, LOG_WARNING,
                      <B><FONT COLOR="#BC8F8F">&quot;link is probably looping, type unknown, aborting: %s%s&quot;</FONT></B>,
                      afs-&gt;af.adr, afs-&gt;af.fil);
      }
    }

  }                             <I><FONT COLOR="#B22222">// delayed type check ?
</FONT></I>
  ENGINE_SAVE_CONTEXT_BASE();

  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}
</PRE>
<HR>
<ADDRESS>Generated by <A HREF="http://www.iki.fi/~mtr/genscript/">GNU Enscript 1.6.5.90</A>.</ADDRESS>
</BODY>

<!-- Mirrored from www.httrack.com/src/htsparse.c.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 02 Jan 2023 20:32:47 GMT -->
</HTML>
