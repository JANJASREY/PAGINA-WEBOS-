<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>

<!-- Mirrored from www.httrack.com/src/htslib.c.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 02 Jan 2023 20:32:26 GMT -->
<HEAD>
<TITLE>./htslib.c - HTTrack Website Copier</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#1F00FF" ALINK="#FF0000" VLINK="#9900DD">
<A NAME="top">
<A NAME="file1">
<H1>./htslib.c</H1>

<PRE>
<I><FONT COLOR="#B22222">/* ------------------------------------------------------------ */</FONT></I>
<I><FONT COLOR="#B22222">/*
HTTrack Website Copier, Offline Browser for Windows and Unix
Copyright (C) 1998-2015 Xavier Roche and other contributors

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.

Important notes:

- We hereby ask people using this source NOT to use it in purpose of grabbing
emails addresses, or collecting any other private information on persons.
This would disgrace our work, and spoil the many hours we spent on it.

Please visit our Website: http://www.httrack.com
*/</FONT></I>

<I><FONT COLOR="#B22222">/* ------------------------------------------------------------ */</FONT></I>
<I><FONT COLOR="#B22222">/* File: Subroutines                                            */</FONT></I>
<I><FONT COLOR="#B22222">/* Author: Xavier Roche                                         */</FONT></I>
<I><FONT COLOR="#B22222">/* ------------------------------------------------------------ */</FONT></I>

<I><FONT COLOR="#B22222">/* Internal engine bytecode */</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">HTS_INTERNAL_BYTECODE</FONT>

<I><FONT COLOR="#B22222">// Fichier librairie .c
</FONT></I>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htscore.h&quot;</FONT></B>

<I><FONT COLOR="#B22222">/* specific definitions */</FONT></I>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsbase.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsnet.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsbauth.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsthread.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsback.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htswrap.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsmd5.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsmodules.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htscharset.h&quot;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;htsencoding.h&quot;</FONT></B>

#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;direct.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">HAVE_SYS_TYPES_H</FONT>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;sys/types.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">HAVE_SYS_STAT_H</FONT>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;sys/stat.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">HAVE_UNISTD_H</FONT>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;unistd.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B> <I><FONT COLOR="#B22222">/* _WIN32 */</FONT></I>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;stdarg.h&gt;</FONT></B>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;string.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;time.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">__ANDROID__</FONT>
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">long</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B>  timezone = 0;
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;stdarg.h&gt;</FONT></B>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;sys/timeb.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;fcntl.h&gt;</FONT></B>

<I><FONT COLOR="#B22222">// pour utimbuf
</FONT></I>#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;sys/utime.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;utime.h&gt;</FONT></B>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B> <I><FONT COLOR="#B22222">/* _WIN32 */</FONT></I>

#<B><FONT COLOR="#5F9EA0">include</FONT></B> <B><FONT COLOR="#BC8F8F">&lt;sys/stat.h&gt;</FONT></B>
<I><FONT COLOR="#B22222">/* END specific definitions */</FONT></I>

<I><FONT COLOR="#B22222">/* Windows might be missing va_copy */</FONT></I>
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
#<B><FONT COLOR="#5F9EA0">ifndef</FONT></B> <FONT COLOR="#B8860B">va_copy</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">va_copy</FONT></B>(dst, src) ((dst) = (src))
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

<I><FONT COLOR="#B22222">// Debugging
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">_HTS_WIDE</FONT>
FILE *DEBUG_fp = NULL;
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

<I><FONT COLOR="#B22222">/* variables globales */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> _DEBUG_HEAD;
FILE *ioinfo;

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
SSL_CTX *openssl_ctx = NULL;
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
<B><FONT COLOR="#228B22">int</FONT></B> IPV6_resolver = 0;

<I><FONT COLOR="#B22222">/* détection complémentaire */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_detect[] = {
  <B><FONT COLOR="#BC8F8F">&quot;archive&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;background&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;data&quot;</FONT></B>,                       <I><FONT COLOR="#B22222">// OBJECT
</FONT></I>  <B><FONT COLOR="#BC8F8F">&quot;dynsrc&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;lowsrc&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;profile&quot;</FONT></B>,                    <I><FONT COLOR="#B22222">// element META
</FONT></I>  <B><FONT COLOR="#BC8F8F">&quot;src&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;swurl&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;url&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;usemap&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;longdesc&quot;</FONT></B>,                   <I><FONT COLOR="#B22222">// accessibility
</FONT></I>  <B><FONT COLOR="#BC8F8F">&quot;xlink:href&quot;</FONT></B>,                 <I><FONT COLOR="#B22222">// xml/svg tag
</FONT></I>  <B><FONT COLOR="#BC8F8F">&quot;poster&quot;</FONT></B>,                     <I><FONT COLOR="#B22222">// HTML5
</FONT></I>  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* détecter début */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_detectbeg[] = {
  <B><FONT COLOR="#BC8F8F">&quot;hotspot&quot;</FONT></B>,                    <I><FONT COLOR="#B22222">/* hotspot1=..,hotspot2=.. */</FONT></I>
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* ne pas détcter de liens dedans */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_nodetect[] = {
  <B><FONT COLOR="#BC8F8F">&quot;accept-charset&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;accesskey&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;action&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;align&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;alt&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;axes&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;axis&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;char&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;charset&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;cite&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;class&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;classid&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;code&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;color&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;datetime&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;dir&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;enctype&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;face&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;height&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;id&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;lang&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;language&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;media&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;method&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;name&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;prompt&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;scheme&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;size&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;style&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;target&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;title&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;type&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;valign&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;version&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;width&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* détection de mini-code javascript */</FONT></I>
<I><FONT COLOR="#B22222">/* ALSO USED: detection based on the name: onXXX=&quot;&lt;tag&gt;&quot; where XXX starts with upper case letter */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_detect_js[] = {
  <B><FONT COLOR="#BC8F8F">&quot;onAbort&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onBlur&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onChange&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onClick&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onDblClick&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onDragDrop&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onError&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onFocus&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onKeyDown&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onKeyPress&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onKeyUp&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onLoad&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onMouseDown&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onMouseMove&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onMouseOut&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onMouseOver&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onMouseUp&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onMove&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onReset&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onResize&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onSelect&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onSubmit&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;onUnload&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;style&quot;</FONT></B>,                      <I><FONT COLOR="#B22222">/* hack for CSS code data */</FONT></I>
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_main_mime[] = {
  <B><FONT COLOR="#BC8F8F">&quot;application&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;audio&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;image&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;message&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;multipart&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;text&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;video&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* détection &quot;...URL=&lt;url&gt;&quot; */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_detectURL[] = {
  <B><FONT COLOR="#BC8F8F">&quot;content&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* tags où l'URL doit être réécrite mais non capturée */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_detectandleave[] = {
  <B><FONT COLOR="#BC8F8F">&quot;action&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* ne pas renommer les types renvoyés (souvent types inconnus) */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_mime_keep[] = {
  <B><FONT COLOR="#BC8F8F">&quot;application/octet-stream&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;application/xml&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;text/xml&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* bogus servers returns these mime types when the extension is seen within the filename */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_mime_bogus_multiple[] = {
  <B><FONT COLOR="#BC8F8F">&quot;application/x-wais-source&quot;</FONT></B>,  <I><FONT COLOR="#B22222">/* src (src.rpm) */</FONT></I>
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* pas de type mime connu, mais extension connue */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_ext_dynamic[] = {
  <B><FONT COLOR="#BC8F8F">&quot;php3&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;php&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;php4&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;php2&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;cgi&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;asp&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;jsp&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;pl&quot;</FONT></B>,
  <I><FONT COLOR="#B22222">/*&quot;exe&quot;, */</FONT></I>
  <B><FONT COLOR="#BC8F8F">&quot;cfm&quot;</FONT></B>,
  <B><FONT COLOR="#BC8F8F">&quot;nsf&quot;</FONT></B>,                        <I><FONT COLOR="#B22222">/* lotus */</FONT></I>
  <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>
};

<I><FONT COLOR="#B22222">/* types MIME 
   note: application/octet-stream should not be used here
*/</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *hts_mime[][2] = {
  {<B><FONT COLOR="#BC8F8F">&quot;application/acad&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dwg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/arj&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;arj&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/clariscad&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ccad&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/drafting&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;drw&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/dxf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dxf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/excel&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xls&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/i-deas&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;unv&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/iges&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;isg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/iges&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;iges&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/mac-binhex40&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;hqx&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/mac-compactpro&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cpt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/msword&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;doc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/msword&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;w6w&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/msword&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;word&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/mswrite&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wri&quot;</FONT></B>},
  <I><FONT COLOR="#B22222">/*{&quot;application/octet-stream&quot;,&quot;dms&quot;}, */</FONT></I>
  <I><FONT COLOR="#B22222">/*{&quot;application/octet-stream&quot;,&quot;lzh&quot;}, */</FONT></I>
  <I><FONT COLOR="#B22222">/*{&quot;application/octet-stream&quot;,&quot;lha&quot;}, */</FONT></I>
  <I><FONT COLOR="#B22222">/*{&quot;application/octet-stream&quot;,&quot;bin&quot;}, */</FONT></I>
  {<B><FONT COLOR="#BC8F8F">&quot;application/oda&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;oda&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/pdf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pdf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/postscript&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ps&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/postscript&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ai&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/postscript&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;eps&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/powerpoint&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ppt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/pro_eng&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;prt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/pro_eng&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;part&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/rtf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;rtf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/set&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;set&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/sla&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;stl&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/smil&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;smi&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/smil&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;smil&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/smil&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sml&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/solids&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sol&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/STEP&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;stp&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/STEP&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;step&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vda&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;vda&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-authorware-map&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;aam&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-authorware-seg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;aas&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-authorware-bin&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;aab&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-bzip2&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;bz2&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-cocoa&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cco&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-csh&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;csh&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-director&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dir&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-director&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dcr&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-director&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dxr&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-mif&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mif&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-dvi&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dvi&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-gzip&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;gz&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-gzip&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;gzip&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-hdf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;hdf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-javascript&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;js&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-koan&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;skp&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-koan&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;skd&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-koan&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;skt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-koan&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;skm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-latex&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;latex&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-netcdf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;nc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-netcdf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cdf&quot;</FONT></B>},
  <I><FONT COLOR="#B22222">/* {&quot;application/x-sh&quot;,&quot;sh&quot;}, */</FONT></I>
  <I><FONT COLOR="#B22222">/* {&quot;application/x-csh&quot;,&quot;csh&quot;}, */</FONT></I>
  <I><FONT COLOR="#B22222">/* {&quot;application/x-ksh&quot;,&quot;ksh&quot;}, */</FONT></I>
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-shar&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;shar&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-stuffit&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sit&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-tcl&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tcl&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-tex&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tex&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-texinfo&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;texinfo&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-texinfo&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;texi&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-troff&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;t&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-troff&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tr&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-troff&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;roff&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-troff-man&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;man&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-troff-me&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ms&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-wais-source&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;src&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/zip&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;zip&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-zip-compressed&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;zip&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-bcpio&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;bcpio&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-cdlink&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;vcd&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-cpio&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cpio&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-gtar&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tgz&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-gtar&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;gtar&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-shar&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;shar&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-shockwave-flash&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;swf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-sv4cpio&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sv4cpio&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-sv4crc&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sv4crc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-tar&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tar&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-ustar&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ustar&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-winhelp&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;hlp&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/xml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xml&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/midi&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mid&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/midi&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;midi&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/midi&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;kar&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mp3&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mpga&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mp2&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/basic&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;au&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/basic&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;snd&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-aiff&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;aif&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-aiff&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;aiff&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-aiff&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;aifc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-pn-realaudio&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;rm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-pn-realaudio&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ram&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-pn-realaudio&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ra&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-pn-realaudio-plugin&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;rpm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-wav&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wav&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;chemical/x-pdb&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pdb&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;chemical/x-pdb&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xyz&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;drawing/x-dwf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dwf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/gif&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;gif&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/ief&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ief&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/jpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;jpg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/jpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;jpe&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/jpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;jpeg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/pict&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pict&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/png&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;png&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/tiff&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tiff&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/tiff&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tif&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/svg+xml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;svg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/svg-xml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;svg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-cmu-raster&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ras&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-freehand&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;fh4&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-freehand&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;fh7&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-freehand&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;fh5&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-freehand&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;fhc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-freehand&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;fh&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-portable-anymap&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pnm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-portable-bitmap&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pgm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-portable-pixmap&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ppm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-rgb&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;rgb&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-xbitmap&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xbm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-xpixmap&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xpm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-xwindowdump&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xwd&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;model/mesh&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;msh&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;model/mesh&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mesh&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;model/mesh&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;silo&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;multipart/x-zip&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;zip&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;multipart/x-gzip&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;gzip&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/css&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;css&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/html&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;html&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/html&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;htm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;txt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;g&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;h&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;c&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;hh&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;m&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;f90&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/richtext&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;rtx&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/tab-separated-values&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tsv&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/x-setext&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;etx&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/x-sgml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sgml&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/x-sgml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sgm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/xml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xml&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/xml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dtd&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mpeg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mpg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mpe&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/quicktime&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;qt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/quicktime&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mov&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/x-msvideo&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;avi&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/x-sgi-movie&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;movie&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;x-conference/x-cooltalk&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ice&quot;</FONT></B>},
  <I><FONT COLOR="#B22222">/*{&quot;application/x-httpd-cgi&quot;,&quot;cgi&quot;}, */</FONT></I>
  {<B><FONT COLOR="#BC8F8F">&quot;x-world/x-vrml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wrl&quot;</FONT></B>},

  <I><FONT COLOR="#B22222">/* More from w3schools.com */</FONT></I>
  {<B><FONT COLOR="#BC8F8F">&quot;application/envoy&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;evy&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/fractals&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;fif&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/futuresplash&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;spl&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/hta&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;hta&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/internet-property-stream&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;acx&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/msword&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;dot&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/olescript&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;axs&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/pics-rules&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;prf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/pkcs10&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;p10&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/pkix-crl&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;crl&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/set-payment-initiation&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;setpay&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/set-registration-initiation&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;setreg&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-excel&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xls&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-excel&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xla&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-excel&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xlc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-excel&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xlm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-excel&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xlt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-excel&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xlw&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-pkicertstore&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sst&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-pkiseccat&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cat&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-powerpoint&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ppt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-powerpoint&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pot&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-powerpoint&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pps&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-project&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mpp&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-works&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wcm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-works&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wdb&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-works&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wks&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/vnd.ms-works&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wps&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-compress&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;z&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-compressed&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;tgz&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-internet-signup&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ins&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-internet-signup&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;isp&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-iphone&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;iii&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-javascript&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;js&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msaccess&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mdb&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-mscardfile&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;crd&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msclip&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;clp&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msmediaview&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;m13&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msmediaview&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;m14&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msmediaview&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mvb&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msmetafile&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wmf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msmoney&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mny&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-mspublisher&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pub&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msschedule&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;scd&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-msterminal&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;trm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-perfmon&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pma&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-perfmon&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pmc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-perfmon&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pml&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-perfmon&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pmr&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-perfmon&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pmw&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-pkcs12&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;p12&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-pkcs12&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pfx&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-pkcs7-certificates&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;p7b&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-pkcs7-certificates&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;spc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-pkcs7-certreqresp&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;p7r&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-pkcs7-mime&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;p7c&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-pkcs7-mime&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;p7m&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-pkcs7-signature&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;p7s&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-troff-me&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;me&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-x509-ca-cert&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cer&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-x509-ca-cert&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;crt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-x509-ca-cert&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;der&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/ynd.ms-pkipko&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pko&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/mid&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mid&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/mid&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;rmi&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mp3&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;audio/x-mpegurl&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;m3u&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/bmp&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;bmp&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/cis-cod&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cod&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/pipeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;jfif&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-cmx&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;cmx&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-icon&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ico&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;image/x-portable-bitmap&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;pbm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;message/rfc822&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mht&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;message/rfc822&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mhtml&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;message/rfc822&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;nws&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/css&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;css&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/h323&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;323&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/html&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;stm&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/iuls&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;uls&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/plain&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;bas&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/scriptlet&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;sct&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/webviewhtml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;htt&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/x-component&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;htc&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;text/x-vcard&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;vcf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mp2&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mpa&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/mpeg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;mpv2&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/x-la-asf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;lsf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/x-la-asf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;lsx&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/x-ms-asf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;asf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/x-ms-asf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;asr&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/x-ms-asf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;asx&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;video/x-ms-wmv&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wmv&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;x-world/x-vrml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;flr&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;x-world/x-vrml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;vrml&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;x-world/x-vrml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wrz&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;x-world/x-vrml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xaf&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;x-world/x-vrml&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;xof&quot;</FONT></B>},

  <I><FONT COLOR="#B22222">/* Various */</FONT></I>
  {<B><FONT COLOR="#BC8F8F">&quot;application/ogg&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;ogg&quot;</FONT></B>},

  {<B><FONT COLOR="#BC8F8F">&quot;application/x-java-vm&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;class&quot;</FONT></B>},
  {<B><FONT COLOR="#BC8F8F">&quot;application/x-bittorrent&quot;</FONT></B>,<B><FONT COLOR="#BC8F8F">&quot;torrent&quot;</FONT></B>},

  {<B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>}
};

<I><FONT COLOR="#B22222">// Reserved (RFC2396)
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CIS</FONT></B>(c,ch) ( ((unsigned char)(c)) == (ch) )
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_RESERVED</FONT></B>(c)  ( CIS(c,<B><FONT COLOR="#BC8F8F">';'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'/'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'?'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">':'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'@'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'='</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'+'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'$'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">','</FONT></B>) )
<I><FONT COLOR="#B22222">//#define CHAR_RESERVED(c)  ( strchr(&quot;;/?:@&amp;=+$,&quot;,(unsigned char)(c)) != 0 )
</FONT></I><I><FONT COLOR="#B22222">// Delimiters (RFC2396)
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_DELIM</FONT></B>(c)     ( CIS(c,<B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'&gt;'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'#'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'%'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>) )
<I><FONT COLOR="#B22222">//#define CHAR_DELIM(c)     ( strchr(&quot;&lt;&gt;#%\&quot;&quot;,(unsigned char)(c)) != 0 )
</FONT></I><I><FONT COLOR="#B22222">// Unwise (RFC2396)
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_UNWISE</FONT></B>(c)    ( CIS(c,<B><FONT COLOR="#BC8F8F">'{'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'}'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'|'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'\\'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'^'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'['</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">']'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'`'</FONT></B>) )
<I><FONT COLOR="#B22222">//#define CHAR_UNWISE(c)    ( strchr(&quot;{}|\\^[]`&quot;,(unsigned char)(c)) != 0 )
</FONT></I><I><FONT COLOR="#B22222">// Special (escape chars) (RFC2396 + &gt;127 )
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_LOW</FONT></B>(c)       ( ((unsigned char)(c) &lt;= 31) )
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_HIG</FONT></B>(c)       ( ((unsigned char)(c) &gt;= 127) )
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_SPECIAL</FONT></B>(c)   ( CHAR_LOW(c) || CHAR_HIG(c) )
<I><FONT COLOR="#B22222">// We try to avoid them and encode them instead
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_XXAVOID</FONT></B>(c)   ( CIS(c,<B><FONT COLOR="#BC8F8F">' '</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'*'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'\''</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'!'</FONT></B>) )
<I><FONT COLOR="#B22222">//#define CHAR_XXAVOID(c)   ( strchr(&quot; *'\&quot;!&quot;,(unsigned char)(c)) != 0 )
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_MARK</FONT></B>(c)      ( CIS(c,<B><FONT COLOR="#BC8F8F">'-'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'_'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'.'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'!'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'~'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'*'</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'\''</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">'('</FONT></B>) \
                         || CIS(c,<B><FONT COLOR="#BC8F8F">')'</FONT></B>) )
<I><FONT COLOR="#B22222">//#define CHAR_MARK(c)      ( strchr(&quot;-_.!~*'()&quot;,(unsigned char)(c)) != 0 )
</FONT></I>
<I><FONT COLOR="#B22222">// conversion éventuelle / vers antislash
</FONT></I>#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
<B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">antislash</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *catbuff, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s) {
  <B><FONT COLOR="#228B22">char</FONT></B> *a;

  strcpybuff(catbuff, s);
  <B><FONT COLOR="#A020F0">while</FONT></B>(a = strchr(catbuff, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>))
    *a = <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> catbuff;
}
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

<I><FONT COLOR="#B22222">// Initialize a htsblk structure
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_init_htsblk</FONT></B>(htsblk * r) {
  memset(r, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(htsblk)); <I><FONT COLOR="#B22222">// effacer
</FONT></I>  r-&gt;soc = INVALID_SOCKET;
  r-&gt;msg[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  r-&gt;statuscode = STATUSCODE_INVALID;
  r-&gt;totalsize = -1;
}

<I><FONT COLOR="#B22222">// ouvre une liaison http, envoie une requète GET et réceptionne le header
</FONT></I><I><FONT COLOR="#B22222">// retour: socket
</FONT></I>T_SOC <B><FONT COLOR="#0000FF">http_fopen</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil, htsblk * retour) {
  <I><FONT COLOR="#B22222">//                / GET, traiter en-tête
</FONT></I>  <B><FONT COLOR="#A020F0">return</FONT></B> http_xfopen(opt, 0, 1, 1, NULL, adr, fil, retour);
}

<I><FONT COLOR="#B22222">// ouverture d'une liaison http, envoi d'une requète
</FONT></I><I><FONT COLOR="#B22222">// mode: 0 GET  1 HEAD  [2 POST]
</FONT></I><I><FONT COLOR="#B22222">// treat: traiter header?
</FONT></I><I><FONT COLOR="#B22222">// waitconnect: attendre le connect()
</FONT></I><I><FONT COLOR="#B22222">// note: dans retour, on met les params du proxy
</FONT></I>T_SOC <B><FONT COLOR="#0000FF">http_xfopen</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">int</FONT></B> mode, <B><FONT COLOR="#228B22">int</FONT></B> treat, <B><FONT COLOR="#228B22">int</FONT></B> waitconnect,
                  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *xsend, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil, htsblk * retour) {
  <I><FONT COLOR="#B22222">//htsblk retour;
</FONT></I>  <I><FONT COLOR="#B22222">//int bufl=TAILLE_BUFFER;    // 8Ko de buffer
</FONT></I>  T_SOC soc = INVALID_SOCKET;
  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo_fil[HTS_URLMAXSIZE * 2];

  <I><FONT COLOR="#B22222">//char *p,*q;
</FONT></I>
  <I><FONT COLOR="#B22222">// retour prédéfini: erreur
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (retour) {
    retour-&gt;adr = NULL;
    retour-&gt;size = 0;
    retour-&gt;msg[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    retour-&gt;statuscode = STATUSCODE_NON_FATAL;  <I><FONT COLOR="#B22222">// a priori erreur non fatale
</FONT></I>  }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
  printf(<B><FONT COLOR="#BC8F8F">&quot;adr=%s\nfichier=%s\n&quot;</FONT></B>, adr, fil);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  <I><FONT COLOR="#B22222">// ouvrir liaison
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
  printf(<B><FONT COLOR="#BC8F8F">&quot;Création d'une socket sur %s\n&quot;</FONT></B>, adr);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">CNXDEBUG</FONT>
  printf(<B><FONT COLOR="#BC8F8F">&quot;..newhttp\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  <I><FONT COLOR="#B22222">/* connexion */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (retour) {
    <B><FONT COLOR="#A020F0">if</FONT></B> ((!(retour-&gt;req.proxy.active))
        || ((strcmp(adr, <B><FONT COLOR="#BC8F8F">&quot;file://&quot;</FONT></B>) == 0)
            || (strncmp(adr, <B><FONT COLOR="#BC8F8F">&quot;https://&quot;</FONT></B>, 8) == 0)
        )
      ) {                       <I><FONT COLOR="#B22222">/* pas de proxy, ou non utilisable ici */</FONT></I>
      soc = newhttp(opt, adr, retour, -1, waitconnect);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      soc = newhttp(opt, retour-&gt;req.proxy.name, retour, retour-&gt;req.proxy.port, waitconnect);  <I><FONT COLOR="#B22222">// ouvrir sur le proxy à la place
</FONT></I>    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    soc = newhttp(opt, adr, NULL, -1, waitconnect);
  }

  <I><FONT COLOR="#B22222">// copier index socket retour
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (retour)
    retour-&gt;soc = soc;

  <I><FONT COLOR="#B22222">/* Check for errors */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (soc == INVALID_SOCKET) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (retour) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;msg) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(retour-&gt;msg)) {
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
          <B><FONT COLOR="#228B22">int</FONT></B> last_errno = WSAGetLastError();

          sprintf(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Connect error: %s&quot;</FONT></B>, strerror(last_errno));
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
          <B><FONT COLOR="#228B22">int</FONT></B> last_errno = errno;

          sprintf(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Connect error: %s&quot;</FONT></B>, strerror(last_errno));
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        }
      }
    }
  }
  <I><FONT COLOR="#B22222">// --------------------
</FONT></I>  <I><FONT COLOR="#B22222">// court-circuit (court circuite aussi le proxy..)
</FONT></I>  <I><FONT COLOR="#B22222">// LOCAL_SOCKET_ID est une pseudo-socket locale
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (soc == LOCAL_SOCKET_ID) {
    retour-&gt;is_file = 1;        <I><FONT COLOR="#B22222">// fichier local
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 0) {            <I><FONT COLOR="#B22222">// GET
</FONT></I>
      <I><FONT COLOR="#B22222">// Test en cas de file:///C|...
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (!fexist
          (fconv(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
          unescape_http(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), fil))))
        <B><FONT COLOR="#A020F0">if</FONT></B> (fexist
            (fconv
             (OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
             unescape_http(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), fil + 1)))) {
          strcpybuff(tempo_fil, fil + 1);
          fil = tempo_fil;
        }
      <I><FONT COLOR="#B22222">// Ouvrir
</FONT></I>      retour-&gt;totalsize = fsize(fconv(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), 
        unescape_http(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), fil)));       <I><FONT COLOR="#B22222">// taille du fichier
</FONT></I>      retour-&gt;msg[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      soc = INVALID_SOCKET;
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;totalsize &lt; 0)
        strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unable to open local file&quot;</FONT></B>);
      <B><FONT COLOR="#A020F0">else</FONT></B> {
        <I><FONT COLOR="#B22222">// Note: On passe par un FILE* (plus propre)
</FONT></I>        <I><FONT COLOR="#B22222">//soc=open(fil,O_RDONLY,0);    // en lecture seule!
</FONT></I>        retour-&gt;fp = FOPEN(fconv(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), 
          unescape_http(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), fil)), <B><FONT COLOR="#BC8F8F">&quot;rb&quot;</FONT></B>);      <I><FONT COLOR="#B22222">// ouvrir
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;fp == NULL)
          soc = INVALID_SOCKET;
        <B><FONT COLOR="#A020F0">else</FONT></B>
          soc = LOCAL_SOCKET_ID;
      }
      retour-&gt;soc = soc;
      <B><FONT COLOR="#A020F0">if</FONT></B> (soc != INVALID_SOCKET) {
        retour-&gt;statuscode = HTTP_OK;   <I><FONT COLOR="#B22222">// OK
</FONT></I>        strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;OK&quot;</FONT></B>);
        guess_httptype(opt, retour-&gt;contenttype, fil);
      } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(retour-&gt;msg) == 0)
        strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unable to open local file&quot;</FONT></B>);
      <B><FONT COLOR="#A020F0">return</FONT></B> soc;               <I><FONT COLOR="#B22222">// renvoyer
</FONT></I>    } <B><FONT COLOR="#A020F0">else</FONT></B> {                    <I><FONT COLOR="#B22222">// HEAD ou POST : interdit sur un local!!!! (c'est idiot!)
</FONT></I>      strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unexpected Head/Post local request&quot;</FONT></B>);
      soc = INVALID_SOCKET;     <I><FONT COLOR="#B22222">// erreur
</FONT></I>      retour-&gt;soc = soc;
      <B><FONT COLOR="#A020F0">return</FONT></B> soc;
    }
  }
  <I><FONT COLOR="#B22222">// --------------------
</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (soc != INVALID_SOCKET) {
    <B><FONT COLOR="#228B22">char</FONT></B> rcvd[1100];

    rcvd[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;Ok, connexion réussie, id=%d\n&quot;</FONT></B>, soc);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    <I><FONT COLOR="#B22222">// connecté?
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (waitconnect) {
      http_sendhead(opt, NULL, mode, xsend, adr, fil, NULL, NULL, retour);
    }

    <B><FONT COLOR="#A020F0">if</FONT></B> (soc != INVALID_SOCKET) {

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
      printf(<B><FONT COLOR="#BC8F8F">&quot;Attente de la réponse:\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

      <I><FONT COLOR="#B22222">// si GET (réception d'un fichier), réceptionner en-tête d'abord,
</FONT></I>      <I><FONT COLOR="#B22222">// et ensuite le corps
</FONT></I>      <I><FONT COLOR="#B22222">// si POST on ne réceptionne rien du tout, c'est après que l'on fera
</FONT></I>      <I><FONT COLOR="#B22222">// une réception standard pour récupérer l'en tête
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> ((treat) &amp;&amp; (waitconnect)) {   <I><FONT COLOR="#B22222">// traiter (attendre!) en-tête        
</FONT></I>        <I><FONT COLOR="#B22222">// Réception de la status line et de l'en-tête (norme RFC1945)
</FONT></I>
        <I><FONT COLOR="#B22222">// status-line à récupérer
</FONT></I>        finput(soc, rcvd, 1024);
        <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(rcvd) == 0)
          finput(soc, rcvd, 1024);      <I><FONT COLOR="#B22222">// &quot;certains serveurs buggés envoient un \n au début&quot; (RFC)
</FONT></I>
        <I><FONT COLOR="#B22222">// traiter status-line
</FONT></I>        treatfirstline(retour, rcvd);

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
        printf(<B><FONT COLOR="#BC8F8F">&quot;Status-Code=%d\n&quot;</FONT></B>, retour-&gt;statuscode);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

        <I><FONT COLOR="#B22222">// en-tête
</FONT></I>
        <I><FONT COLOR="#B22222">// header // ** !attention! HTTP/0.9 non supporté
</FONT></I>        <B><FONT COLOR="#A020F0">do</FONT></B> {
          finput(soc, rcvd, 1024);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
          printf(<B><FONT COLOR="#BC8F8F">&quot;&gt;%s\n&quot;</FONT></B>, rcvd);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
          <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(rcvd))
            treathead(NULL, NULL, NULL, retour, rcvd);  <I><FONT COLOR="#B22222">// traiter
</FONT></I>
        } <B><FONT COLOR="#A020F0">while</FONT></B>(strnotempty(rcvd));

        <I><FONT COLOR="#B22222">//rcvsize=-1;    // forCER CHARGEMENT INCONNU
</FONT></I>
        <I><FONT COLOR="#B22222">//if (retour)
</FONT></I>        <I><FONT COLOR="#B22222">//  retour-&gt;totalsize=rcvsize;
</FONT></I>
      } <B><FONT COLOR="#A020F0">else</FONT></B> {                  <I><FONT COLOR="#B22222">// si GET, on recevra l'en tête APRES
</FONT></I>        <I><FONT COLOR="#B22222">//rcvsize=-1;    // on ne connait pas la taille de l'en-tête
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (retour)
          retour-&gt;totalsize = -1;
      }

    }

  }

  <B><FONT COLOR="#A020F0">return</FONT></B> soc;
}

<I><FONT COLOR="#B22222">/* Buffer printing */</FONT></I>
<B><FONT COLOR="#228B22">typedef</FONT></B> <B><FONT COLOR="#228B22">struct</FONT></B> buff_struct {
  <I><FONT COLOR="#B22222">/** Buffer **/</FONT></I>
  <B><FONT COLOR="#228B22">char</FONT></B> *buffer;
  <I><FONT COLOR="#B22222">/** Buffer capacity in bytes **/</FONT></I>
  size_t capacity;
  <I><FONT COLOR="#B22222">/** Buffer write position ; MUST point to a valid \0. **/</FONT></I>
  size_t pos;
} buff_struct;

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">print_buffer</FONT></B>(buff_struct*<B><FONT COLOR="#228B22">const</FONT></B> str, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *format, ...)
  HTS_PRINTF_FUN(2, 3);

<I><FONT COLOR="#B22222">/* Prints on a static buffer. asserts in case of overflow. */</FONT></I>
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">print_buffer</FONT></B>(buff_struct*<B><FONT COLOR="#228B22">const</FONT></B> str, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *format, ...) {
  size_t result;
  va_list args;
  size_t remaining;
  <B><FONT COLOR="#228B22">char</FONT></B> *position;

  <I><FONT COLOR="#B22222">/* Security check. */</FONT></I>
  assertf(str != NULL);
  assertf(str-&gt;pos &lt; str-&gt;capacity);

  <I><FONT COLOR="#B22222">/* Print */</FONT></I>
  position = &amp;str-&gt;buffer[str-&gt;pos];
  remaining = str-&gt;capacity - str-&gt;pos;
  va_start(args, format);
  result = (size_t) vsnprintf(position, remaining, format, args);
  va_end(args);
  assertf(result &lt; remaining);

  <I><FONT COLOR="#B22222">/* Increment. */</FONT></I>
  str-&gt;pos += strlen(position);
  assertf(str-&gt;pos &lt; str-&gt;capacity);
}

<I><FONT COLOR="#B22222">// envoi d'une requète
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">http_sendhead</FONT></B>(httrackp * opt, t_cookie * cookie, <B><FONT COLOR="#228B22">int</FONT></B> mode,
                  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *xsend, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil,
                  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *referer_adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *referer_fil,
                  htsblk * retour) {
  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK buffer_head_request[8192];
  buff_struct bstr = { buffer_head_request, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(buffer_head_request), 0 };

  <I><FONT COLOR="#B22222">//int use_11=0;     // HTTP 1.1 utilisé
</FONT></I>  <B><FONT COLOR="#228B22">int</FONT></B> direct_url = 0;           <I><FONT COLOR="#B22222">// ne pas analyser l'url (exemple: ftp://)
</FONT></I>  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *search_tag = NULL;

  <I><FONT COLOR="#B22222">// Initialize buffer
</FONT></I>  buffer_head_request[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

  <I><FONT COLOR="#B22222">// header Date
</FONT></I>  <I><FONT COLOR="#B22222">//strcatbuff(buff,&quot;Date: &quot;);
</FONT></I>  <I><FONT COLOR="#B22222">//time_gmt_rfc822(buff);    // obtenir l'heure au format rfc822
</FONT></I>  <I><FONT COLOR="#B22222">//sendc(&quot;\n&quot;);
</FONT></I>  <I><FONT COLOR="#B22222">//strcatbuff(buff,buff);
</FONT></I>
  <I><FONT COLOR="#B22222">// possibilité non documentée: &gt;post: et &gt;postfile:
</FONT></I>  <I><FONT COLOR="#B22222">// si présence d'un tag &gt;post: alors executer un POST
</FONT></I>  <I><FONT COLOR="#B22222">// exemple: http://www.someweb.com/test.cgi?foo&gt;post:posteddata=10&amp;foo=5
</FONT></I>  <I><FONT COLOR="#B22222">// si présence d'un tag &gt;postfile: alors envoyer en tête brut contenu dans le fichier en question
</FONT></I>  <I><FONT COLOR="#B22222">// exemple: http://www.someweb.com/test.cgi?foo&gt;postfile:post0.txt
</FONT></I>  search_tag = strstr(fil, POSTTOK <B><FONT COLOR="#BC8F8F">&quot;:&quot;</FONT></B>);
  <B><FONT COLOR="#A020F0">if</FONT></B> (!search_tag) {
    search_tag = strstr(fil, POSTTOK <B><FONT COLOR="#BC8F8F">&quot;file:&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">if</FONT></B> (search_tag) {           <I><FONT COLOR="#B22222">// postfile
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 0) {          <I><FONT COLOR="#B22222">// GET!
</FONT></I>        FILE *fp =
          FOPEN(unescape_http(OPT_GET_BUFF(opt), 
                OPT_GET_BUFF_SIZE(opt), search_tag + strlen(POSTTOK) + 5), <B><FONT COLOR="#BC8F8F">&quot;rb&quot;</FONT></B>);
        <B><FONT COLOR="#A020F0">if</FONT></B> (fp) {
          <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK line[1100];
          <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK protocol[256], url[HTS_URLMAXSIZE * 2], method[256];

          linput(fp, line, 1000);
          <B><FONT COLOR="#A020F0">if</FONT></B> (sscanf(line, <B><FONT COLOR="#BC8F8F">&quot;%s %s %s&quot;</FONT></B>, method, url, protocol) == 3) {
            size_t ret;
            <I><FONT COLOR="#B22222">// selon que l'on a ou pas un proxy
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;req.proxy.active) {
              print_buffer(&amp;bstr,
                      <B><FONT COLOR="#BC8F8F">&quot;%s http://%s%s %s\r\n&quot;</FONT></B>, method, adr, url,
                      protocol);
            } <B><FONT COLOR="#A020F0">else</FONT></B> {
              print_buffer(&amp;bstr,
                       <B><FONT COLOR="#BC8F8F">&quot;%s %s %s\r\n&quot;</FONT></B>, method, url, protocol);
            }
            <I><FONT COLOR="#B22222">// lire le reste en brut
</FONT></I>            ret = fread(&amp;bstr.buffer[bstr.pos],
                        bstr.capacity - bstr.pos, 1, fp);
            <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) ret &lt; 0) {
              <B><FONT COLOR="#A020F0">return</FONT></B> -1;
            }
            bstr.pos += strlen(&amp;bstr.buffer[bstr.pos]);
          }
          fclose(fp);
        }
      }
    }
  }
  <I><FONT COLOR="#B22222">// Fin postfile
</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (bstr.pos == 0) { <I><FONT COLOR="#B22222">// PAS POSTFILE
</FONT></I>    <I><FONT COLOR="#B22222">// Type de requète?
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> ((search_tag) &amp;&amp; (mode == 0)) {
      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;POST &quot;</FONT></B>);
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 0) {     <I><FONT COLOR="#B22222">// GET
</FONT></I>      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;GET &quot;</FONT></B>);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {                    <I><FONT COLOR="#B22222">// if (mode==1) {
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (!retour-&gt;req.http11)  <I><FONT COLOR="#B22222">// forcer HTTP/1.0
</FONT></I>        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;GET &quot;</FONT></B>);       <I><FONT COLOR="#B22222">// certains serveurs (cgi) buggent avec HEAD
</FONT></I>      <B><FONT COLOR="#A020F0">else</FONT></B>
        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;HEAD &quot;</FONT></B>);
    }

    <I><FONT COLOR="#B22222">// si on gère un proxy, il faut une Absolute URI: on ajoute avant http://www.adr.dom
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;req.proxy.active &amp;&amp; (strncmp(adr, <B><FONT COLOR="#BC8F8F">&quot;https://&quot;</FONT></B>, 8) != 0)) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (!link_has_authority(adr)) {   <I><FONT COLOR="#B22222">// default http
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
        printf(<B><FONT COLOR="#BC8F8F">&quot;Proxy Use: for %s%s proxy %d port %d\n&quot;</FONT></B>, adr, fil,
               retour-&gt;req.proxy.name, retour-&gt;req.proxy.port);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;http://%s&quot;</FONT></B>, jump_identification_const(adr));
      } <B><FONT COLOR="#A020F0">else</FONT></B> {                  <I><FONT COLOR="#B22222">// ftp:// en proxy http
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
        printf(<B><FONT COLOR="#BC8F8F">&quot;Proxy Use for ftp: for %s%s proxy %d port %d\n&quot;</FONT></B>, adr, fil,
               retour-&gt;req.proxy.name, retour-&gt;req.proxy.port);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        direct_url = 1;         <I><FONT COLOR="#B22222">// ne pas analyser user/pass
</FONT></I>        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, adr);
      }
    }
    <I><FONT COLOR="#B22222">// NOM DU FICHIER
</FONT></I>    <I><FONT COLOR="#B22222">// on slash doit être présent en début, sinon attention aux bad request! (400)
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (*fil != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);

    {
      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK tempo[HTS_URLMAXSIZE * 2];

      tempo[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      <B><FONT COLOR="#A020F0">if</FONT></B> (search_tag)
        strncatbuff(tempo, fil, (<B><FONT COLOR="#228B22">int</FONT></B>) (search_tag - fil));
      <B><FONT COLOR="#A020F0">else</FONT></B>
        strcpybuff(tempo, fil);
      inplace_escape_check_url(tempo, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(tempo));
      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, tempo);  <I><FONT COLOR="#B22222">// avec échappement
</FONT></I>    }

    <I><FONT COLOR="#B22222">// protocole
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (!retour-&gt;req.http11) {  <I><FONT COLOR="#B22222">// forcer HTTP/1.0
</FONT></I>      <I><FONT COLOR="#B22222">//use_11=0;
</FONT></I>      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot; HTTP/1.0\x0d\x0a&quot;</FONT></B>);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {                    <I><FONT COLOR="#B22222">// Requète 1.1
</FONT></I>      <I><FONT COLOR="#B22222">//use_11=1;
</FONT></I>      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot; HTTP/1.1\x0d\x0a&quot;</FONT></B>);
    }

    <I><FONT COLOR="#B22222">/* supplemental data */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (xsend)
      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, xsend);  <I><FONT COLOR="#B22222">// éventuelles autres lignes
</FONT></I>
    <I><FONT COLOR="#B22222">// tester proxy authentication
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;req.proxy.active) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (link_has_authorization(retour-&gt;req.proxy.name)) {     <I><FONT COLOR="#B22222">// et hop, authentification proxy!
</FONT></I>        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = jump_identification_const(retour-&gt;req.proxy.name);
        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *astart = jump_protocol_const(retour-&gt;req.proxy.name);
        <B><FONT COLOR="#228B22">char</FONT></B> autorisation[1100];
        <B><FONT COLOR="#228B22">char</FONT></B> user_pass[256];

        autorisation[0] = user_pass[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        <I><FONT COLOR="#B22222">//
</FONT></I>        strncatbuff(user_pass, astart, (<B><FONT COLOR="#228B22">int</FONT></B>) (a - astart) - 1);
        strcpybuff(user_pass, unescape_http(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), user_pass));
        code64((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *) user_pass, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(user_pass),
               (<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *) autorisation, 0);
        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Proxy-Authorization: Basic %s&quot;</FONT></B>H_CRLF,
                     autorisation);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
        printf(<B><FONT COLOR="#BC8F8F">&quot;Proxy-Authenticate, %s (code: %s)\n&quot;</FONT></B>, user_pass, autorisation);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      }
    }
    <I><FONT COLOR="#B22222">// Referer?
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (referer_adr != NULL &amp;&amp; referer_fil != NULL &amp;&amp; strnotempty(referer_adr)
        &amp;&amp; strnotempty(referer_fil)
      ) {                       <I><FONT COLOR="#B22222">// non vide
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> ((strcmp(referer_adr, <B><FONT COLOR="#BC8F8F">&quot;file://&quot;</FONT></B>) != 0)
          &amp;&amp; (                  <I><FONT COLOR="#B22222">/* no https referer to http urls */</FONT></I>
               (strncmp(referer_adr, <B><FONT COLOR="#BC8F8F">&quot;https://&quot;</FONT></B>, 8) != 0)       <I><FONT COLOR="#B22222">/* referer is not https */</FONT></I>
               ||(strncmp(adr, <B><FONT COLOR="#BC8F8F">&quot;https://&quot;</FONT></B>, 8) == 0)     <I><FONT COLOR="#B22222">/* or referer AND addresses are https */</FONT></I>
          )
        ) {                     <I><FONT COLOR="#B22222">// PAS file://
</FONT></I>        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Referer: http://%s%s&quot;</FONT></B>H_CRLF,
                     jump_identification_const(referer_adr), referer_fil);
      }
    }
    <I><FONT COLOR="#B22222">// HTTP field: referer
</FONT></I>    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(retour-&gt;req.referer)) {
      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Referer: %s&quot;</FONT></B>H_CRLF, retour-&gt;req.referer);
    }
    <I><FONT COLOR="#B22222">// POST?
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 0) {            <I><FONT COLOR="#B22222">// GET!
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (search_tag) {
        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Content-length: %d&quot;</FONT></B> H_CRLF,
                (<B><FONT COLOR="#228B22">int</FONT></B>) (strlen
                       (unescape_http
                        (OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
                         search_tag + strlen(POSTTOK) + 1))));
      }
    }
    <I><FONT COLOR="#B22222">// gestion cookies?
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (cookie) {
      <B><FONT COLOR="#228B22">char</FONT></B> buffer[8192];
      <B><FONT COLOR="#228B22">char</FONT></B> *b = cookie-&gt;data;
      <B><FONT COLOR="#228B22">int</FONT></B> cook = 0;
      <B><FONT COLOR="#228B22">int</FONT></B> max_cookies = 8;

      <B><FONT COLOR="#A020F0">do</FONT></B> {
        b = cookie_find(b, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, jump_identification_const(adr), fil);  <I><FONT COLOR="#B22222">// prochain cookie satisfaisant aux conditions
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (b != NULL) {
          max_cookies--;
          <B><FONT COLOR="#A020F0">if</FONT></B> (!cook) {
            print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Cookie: $Version=1; &quot;</FONT></B>);
            cook = 1;
          } <B><FONT COLOR="#A020F0">else</FONT></B>
            print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;; &quot;</FONT></B>);
          print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, cookie_get(buffer, b, 5));
          print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;=%s&quot;</FONT></B>, cookie_get(buffer, b, 6));
          print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;; $Path=%s&quot;</FONT></B>, cookie_get(buffer, b, 2));
          b = cookie_nextfield(b);
        }
      } <B><FONT COLOR="#A020F0">while</FONT></B>(b != NULL &amp;&amp; max_cookies &gt; 0);
      <B><FONT COLOR="#A020F0">if</FONT></B> (cook) {               <I><FONT COLOR="#B22222">// on a envoyé un (ou plusieurs) cookie?
</FONT></I>        print_buffer(&amp;bstr, H_CRLF);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG_COOK</FONT>
        printf(<B><FONT COLOR="#BC8F8F">&quot;Header:\n%s\n&quot;</FONT></B>, bstr.buffer);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      }
    }
    <I><FONT COLOR="#B22222">// gérer le keep-alive (garder socket)
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;req.http11 &amp;&amp; !retour-&gt;req.nokeepalive) {
      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Connection: keep-alive&quot;</FONT></B> H_CRLF);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Connection: close&quot;</FONT></B> H_CRLF);
    }

    {
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *real_adr = jump_identification_const(adr);

      <I><FONT COLOR="#B22222">// Mandatory per RFC2616
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (!direct_url) {        <I><FONT COLOR="#B22222">// pas ftp:// par exemple
</FONT></I>        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Host: %s&quot;</FONT></B>H_CRLF, real_adr);
      }

      <I><FONT COLOR="#B22222">// HTTP field: from
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(retour-&gt;req.from)) {        <I><FONT COLOR="#B22222">// HTTP from
</FONT></I>        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;From: %s&quot;</FONT></B> H_CRLF, retour-&gt;req.from);
      }

      <I><FONT COLOR="#B22222">// Présence d'un user-agent?
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;req.user_agent_send
          &amp;&amp; strnotempty(retour-&gt;req.user_agent)) {
        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;User-Agent: %s&quot;</FONT></B> H_CRLF, retour-&gt;req.user_agent);
      }

      <I><FONT COLOR="#B22222">// Accept
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(retour-&gt;req.accept)) {
        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Accept: %s&quot;</FONT></B> H_CRLF, retour-&gt;req.accept);
      }

      <I><FONT COLOR="#B22222">// Accept-language
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(retour-&gt;req.lang_iso)) {
        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Accept-Language: %s&quot;</FONT></B>H_CRLF, retour-&gt;req.lang_iso);
      }

      <I><FONT COLOR="#B22222">// Compression accepted ?
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;req.http11) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEZLIB</FONT>
        <B><FONT COLOR="#A020F0">if</FONT></B> ((!retour-&gt;req.range_used)
            &amp;&amp; (!retour-&gt;req.nocompression))
          print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Accept-Encoding: &quot;</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;gzip&quot;</FONT></B> <I><FONT COLOR="#B22222">/* gzip if the preffered encoding */</FONT></I>
                     <B><FONT COLOR="#BC8F8F">&quot;, &quot;</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;identity;q=0.9&quot;</FONT></B> H_CRLF);
        <B><FONT COLOR="#A020F0">else</FONT></B>
          print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Accept-Encoding: identity&quot;</FONT></B> H_CRLF);       <I><FONT COLOR="#B22222">/* no compression */</FONT></I>
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Accept-Encoding: identity&quot;</FONT></B> H_CRLF); <I><FONT COLOR="#B22222">/* no compression */</FONT></I>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      }

      <I><FONT COLOR="#B22222">/* Authentification */</FONT></I>
      {
        <B><FONT COLOR="#228B22">char</FONT></B> autorisation[1100];
        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a;

        autorisation[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        <B><FONT COLOR="#A020F0">if</FONT></B> (link_has_authorization(adr)) {      <I><FONT COLOR="#B22222">// ohh une authentification!
</FONT></I>          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = jump_identification_const(adr);
          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *astart = jump_protocol_const(adr);

          <B><FONT COLOR="#A020F0">if</FONT></B> (!direct_url) {    <I><FONT COLOR="#B22222">// pas ftp:// par exemple
</FONT></I>            <B><FONT COLOR="#228B22">char</FONT></B> user_pass[256];

            user_pass[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
            strncatbuff(user_pass, astart, (<B><FONT COLOR="#228B22">int</FONT></B>) (a - astart) - 1);
            strcpybuff(user_pass, 
              unescape_http(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt), user_pass));
            code64((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *) user_pass, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(user_pass),
                   (<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *) autorisation, 0);
            <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(fil, <B><FONT COLOR="#BC8F8F">&quot;/robots.txt&quot;</FONT></B>))     <I><FONT COLOR="#B22222">/* pas robots.txt */</FONT></I>
              bauth_add(cookie, astart, fil, autorisation);
          }
        } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((a = bauth_check(cookie, real_adr, fil)))
          strcpybuff(autorisation, a);
        <I><FONT COLOR="#B22222">/* On a une autorisation a donner?  */</FONT></I>
        <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(autorisation)) {
          print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;Authorization: Basic %s&quot;</FONT></B>H_CRLF, autorisation);
        }
      }

    }
    <I><FONT COLOR="#B22222">//strcatbuff(buff,&quot;Accept-Charset: iso-8859-1,*,utf-8\n&quot;);
</FONT></I>
    <I><FONT COLOR="#B22222">// Custom header(s)
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(retour-&gt;req.headers)) {
      print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, retour-&gt;req.headers);
    }

    <I><FONT COLOR="#B22222">// CRLF de fin d'en tête
</FONT></I>    print_buffer(&amp;bstr, H_CRLF);

    <I><FONT COLOR="#B22222">// données complémentaires?
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (search_tag)
      <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 0)            <I><FONT COLOR="#B22222">// GET!
</FONT></I>        print_buffer(&amp;bstr, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>,
                   unescape_http(OPT_GET_BUFF(opt), OPT_GET_BUFF_SIZE(opt),
                                 search_tag + strlen(POSTTOK) + 1));
  }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  <B><FONT COLOR="#A020F0">if</FONT></B> (_DEBUG_HEAD) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (ioinfo) {
      fprintf(ioinfo, <B><FONT COLOR="#BC8F8F">&quot;[%d] request for %s%s:\r\n&quot;</FONT></B>, retour-&gt;debugid,
              jump_identification_const(adr), fil);
      fprintfio(ioinfo, bstr.buffer, <B><FONT COLOR="#BC8F8F">&quot;&lt;&lt;&lt; &quot;</FONT></B>);
      fprintf(ioinfo, <B><FONT COLOR="#BC8F8F">&quot;\r\n&quot;</FONT></B>);
      fflush(ioinfo);
    }
  }                             <I><FONT COLOR="#B22222">// Fin test pas postfile
</FONT></I>  <I><FONT COLOR="#B22222">//
</FONT></I>
  <I><FONT COLOR="#B22222">// Callback
</FONT></I>  {
    <B><FONT COLOR="#228B22">int</FONT></B> test_head =
      RUN_CALLBACK6(opt, sendhead, bstr.buffer, adr, fil, referer_adr, referer_fil,
                    retour);
    <B><FONT COLOR="#A020F0">if</FONT></B> (test_head != 1) {
      deletesoc_r(retour);
      strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Header refused by external wrapper&quot;</FONT></B>);
      retour-&gt;soc = INVALID_SOCKET;
    }
  }

  <I><FONT COLOR="#B22222">// Envoi
</FONT></I>  HTS_STAT.last_request = mtime_local();
  <B><FONT COLOR="#A020F0">if</FONT></B> (sendc(retour, bstr.buffer) &lt; 0) {        <I><FONT COLOR="#B22222">// ERREUR, socket rompue?...
</FONT></I>    deletesoc_r(retour);        <I><FONT COLOR="#B22222">// fermer tout de même
</FONT></I>    <I><FONT COLOR="#B22222">// et tenter de reconnecter
</FONT></I>
    strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Write error&quot;</FONT></B>);
    retour-&gt;soc = INVALID_SOCKET;
  }

  <I><FONT COLOR="#B22222">// RX'98
</FONT></I>  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">// traiter 1ere ligne d'en tête
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">treatfirstline</FONT></B>(htsblk * retour, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *rcvd) {
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = rcvd;

  <I><FONT COLOR="#B22222">// exemple:
</FONT></I>  <I><FONT COLOR="#B22222">// HTTP/1.0 200 OK
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (*a) {
    <I><FONT COLOR="#B22222">// note: certains serveurs buggés renvoient HTTP/1.0\n200 OK ou &quot; HTTP/1.0 200 OK&quot;
</FONT></I>    <B><FONT COLOR="#A020F0">while</FONT></B>((*a == <B><FONT COLOR="#BC8F8F">' '</FONT></B>) || (*a == 10) || (*a == 13) || (*a == 9))
      a++;                      <I><FONT COLOR="#B22222">// épurer espaces au début
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(a, <B><FONT COLOR="#BC8F8F">&quot;HTTP/&quot;</FONT></B>)) {
      <I><FONT COLOR="#B22222">// sauter HTTP/1.x
</FONT></I>      <B><FONT COLOR="#A020F0">while</FONT></B>((*a != <B><FONT COLOR="#BC8F8F">' '</FONT></B>) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) &amp;&amp; (*a != 10) &amp;&amp; (*a != 13)
            &amp;&amp; (*a != 9))
        a++;
      <B><FONT COLOR="#A020F0">if</FONT></B> (*a != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
        <B><FONT COLOR="#A020F0">while</FONT></B>((*a == <B><FONT COLOR="#BC8F8F">' '</FONT></B>) || (*a == 10) || (*a == 13) || (*a == 9))
          a++;                  <I><FONT COLOR="#B22222">// épurer espaces
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> ((*a &gt;= <B><FONT COLOR="#BC8F8F">'0'</FONT></B>) &amp;&amp; (*a &lt;= <B><FONT COLOR="#BC8F8F">'9'</FONT></B>)) {
          sscanf(a, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, &amp;(retour-&gt;statuscode));
          <I><FONT COLOR="#B22222">// sauter 200
</FONT></I>          <B><FONT COLOR="#A020F0">while</FONT></B>((*a != <B><FONT COLOR="#BC8F8F">' '</FONT></B>) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) &amp;&amp; (*a != 10) &amp;&amp; (*a != 13)
                &amp;&amp; (*a != 9))
            a++;
          <B><FONT COLOR="#A020F0">while</FONT></B>((*a == <B><FONT COLOR="#BC8F8F">' '</FONT></B>) || (*a == 10) || (*a == 13) || (*a == 9))
            a++;                <I><FONT COLOR="#B22222">// épurer espaces
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> ((strlen(a) &gt; 1) &amp;&amp; (strlen(a) &lt; 64))      <I><FONT COLOR="#B22222">// message retour
</FONT></I>            strcpybuff(retour-&gt;msg, a);
          <B><FONT COLOR="#A020F0">else</FONT></B>
            infostatuscode(retour-&gt;msg, retour-&gt;statuscode);
          <I><FONT COLOR="#B22222">// type MIME par défaut2
</FONT></I>          strcpybuff(retour-&gt;contenttype, HTS_HYPERTEXT_DEFAULT_MIME);
        } <B><FONT COLOR="#A020F0">else</FONT></B> {                <I><FONT COLOR="#B22222">// pas de code!
</FONT></I>          retour-&gt;statuscode = STATUSCODE_INVALID;
          strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unknown response structure&quot;</FONT></B>);
        }
      } <B><FONT COLOR="#A020F0">else</FONT></B> {                  <I><FONT COLOR="#B22222">// euhh??
</FONT></I>        retour-&gt;statuscode = STATUSCODE_INVALID;
        strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unknown response structure&quot;</FONT></B>);
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'&lt;'</FONT></B>) {
        <I><FONT COLOR="#B22222">/* This is dirty .. */</FONT></I>
        retour-&gt;statuscode = HTTP_OK;
        retour-&gt;keep_alive = 0;
        strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unknown, assuming junky server&quot;</FONT></B>);
        strcpybuff(retour-&gt;contenttype, HTS_HYPERTEXT_DEFAULT_MIME);
      } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(a)) {
        retour-&gt;statuscode = STATUSCODE_INVALID;
        strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unknown (not HTTP/xx) response structure&quot;</FONT></B>);
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        <I><FONT COLOR="#B22222">/* This is dirty .. */</FONT></I>
        retour-&gt;statuscode = HTTP_OK;
        retour-&gt;keep_alive = 0;
        strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unknown, assuming junky server&quot;</FONT></B>);
        strcpybuff(retour-&gt;contenttype, HTS_HYPERTEXT_DEFAULT_MIME);
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> {                      <I><FONT COLOR="#B22222">// vide!
</FONT></I>    <I><FONT COLOR="#B22222">/*
       retour-&gt;statuscode=STATUSCODE_INVALID;
       strcpybuff(retour-&gt;msg,&quot;Empty reponse or internal error&quot;);
     */</FONT></I>
    <I><FONT COLOR="#B22222">/* This is dirty .. */</FONT></I>
    retour-&gt;statuscode = HTTP_OK;
    strcpybuff(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unknown, assuming junky server&quot;</FONT></B>);
    strcpybuff(retour-&gt;contenttype, HTS_HYPERTEXT_DEFAULT_MIME);
  }
}

<I><FONT COLOR="#B22222">// traiter ligne par ligne l'en tête
</FONT></I><I><FONT COLOR="#B22222">// gestion des cookies
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">treathead</FONT></B>(t_cookie * cookie, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil, htsblk * retour,
               <B><FONT COLOR="#228B22">char</FONT></B> *rcvd) {
  <B><FONT COLOR="#228B22">int</FONT></B> p;

  <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Content-length:&quot;</FONT></B>)) != 0) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;ok, Content-length: détecté\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B> (sscanf(rcvd + p, LLintP, &amp;(retour-&gt;totalsize)) == 1) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;totalsize == 0) {
        retour-&gt;empty = 1;
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Content-Disposition:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*(rcvd + p)))
      p++;                      <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(rcvd + p) &lt; 250) { <I><FONT COLOR="#B22222">// pas trop long?
</FONT></I>      <B><FONT COLOR="#228B22">char</FONT></B> tmp[256];
      <B><FONT COLOR="#228B22">char</FONT></B> *a = NULL, *b = NULL;

      strcpybuff(tmp, rcvd + p);
      a = strstr(tmp, <B><FONT COLOR="#BC8F8F">&quot;filename=&quot;</FONT></B>);
      <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
        a += strlen(<B><FONT COLOR="#BC8F8F">&quot;filename=&quot;</FONT></B>);
        <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
          a++;
        <I><FONT COLOR="#B22222">//a=strchr(a,'&quot;');
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
          <B><FONT COLOR="#228B22">char</FONT></B> *c = NULL;

          <I><FONT COLOR="#B22222">//a++;      /* jump &quot; */
</FONT></I>          <B><FONT COLOR="#A020F0">while</FONT></B>((c = strchr(a, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)))   <I><FONT COLOR="#B22222">/* skip all / (see RFC2616) */</FONT></I>
            a = c + 1;
          <I><FONT COLOR="#B22222">//b=strchr(a+1,'&quot;');
</FONT></I>          b = a + strlen(a) - 1;
          <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*b))
            b--;
          b++;
          <B><FONT COLOR="#A020F0">if</FONT></B> (b) {
            *b = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
            <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(a) &lt; 200) {        <I><FONT COLOR="#B22222">// pas trop long?
</FONT></I>              strcpybuff(retour-&gt;cdispo, a);
            }
          }
        }
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Last-Modified:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*(rcvd + p)))
      p++;                      <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(rcvd + p) &lt; 64) {  <I><FONT COLOR="#B22222">// pas trop long?
</FONT></I>      <I><FONT COLOR="#B22222">//struct tm* tm_time=convert_time_rfc822(rcvd+p);
</FONT></I>      strcpybuff(retour-&gt;lastmodified, rcvd + p);
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Date:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(retour-&gt;lastmodified) == 0) {       <I><FONT COLOR="#B22222">/* pas encore de last-modified */</FONT></I>
      <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*(rcvd + p)))
        p++;                    <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(rcvd + p) &lt; 64) {        <I><FONT COLOR="#B22222">// pas trop long?
</FONT></I>        <I><FONT COLOR="#B22222">//struct tm* tm_time=convert_time_rfc822(rcvd+p);
</FONT></I>        strcpybuff(retour-&gt;lastmodified, rcvd + p);
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Etag:&quot;</FONT></B>)) != 0) {      <I><FONT COLOR="#B22222">/* Etag */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (retour) {
      <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*(rcvd + p)))
        p++;                    <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(rcvd + p) &lt; 64)  <I><FONT COLOR="#B22222">// pas trop long?
</FONT></I>        strcpybuff(retour-&gt;etag, rcvd + p);
      <B><FONT COLOR="#A020F0">else</FONT></B>                      <I><FONT COLOR="#B22222">// erreur.. ignorer
</FONT></I>        retour-&gt;etag[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    }
  }
  <I><FONT COLOR="#B22222">// else if ((p=strfield(rcvd,&quot;Transfer-Encoding: chunked&quot;))!=0) {  // chunk!
</FONT></I>  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Transfer-Encoding:&quot;</FONT></B>)) != 0) {   <I><FONT COLOR="#B22222">// chunk!
</FONT></I>    <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*(rcvd + p)))
      p++;                      <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(rcvd + p, <B><FONT COLOR="#BC8F8F">&quot;chunked&quot;</FONT></B>)) {
      retour-&gt;is_chunk = 1;     <I><FONT COLOR="#B22222">// chunked
</FONT></I>      <I><FONT COLOR="#B22222">//retour-&gt;http11=2;     // chunked
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
      printf(<B><FONT COLOR="#BC8F8F">&quot;ok, Transfer-Encoding: détecté\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Content-type:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (retour) {
      <B><FONT COLOR="#228B22">char</FONT></B> tempo[1100];

      <I><FONT COLOR="#B22222">// éviter les text/html; charset=foo
</FONT></I>      {
        <B><FONT COLOR="#228B22">char</FONT></B> *a = strchr(rcvd + p, <B><FONT COLOR="#BC8F8F">';'</FONT></B>);

        <B><FONT COLOR="#A020F0">if</FONT></B> (a) {                <I><FONT COLOR="#B22222">// extended information
</FONT></I>          *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
          a++;
          <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
            a++;
          <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(a, <B><FONT COLOR="#BC8F8F">&quot;charset&quot;</FONT></B>)) {
            a += 7;
            <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
              a++;
            <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'='</FONT></B>) {
              a++;
              <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
                a++;
              <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B>)
                a++;
              <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
                a++;
              <B><FONT COLOR="#A020F0">if</FONT></B> (*a) {
                <B><FONT COLOR="#228B22">char</FONT></B> *chs = a;

                <B><FONT COLOR="#A020F0">while</FONT></B>(*a &amp;&amp; !is_space(*a) &amp;&amp; *a != <B><FONT COLOR="#BC8F8F">'\&quot;'</FONT></B> &amp;&amp; *a != <B><FONT COLOR="#BC8F8F">';'</FONT></B>)
                  a++;
                *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                <B><FONT COLOR="#A020F0">if</FONT></B> (*chs) {
                  <B><FONT COLOR="#A020F0">if</FONT></B> (strlen(chs) &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(retour-&gt;charset) - 2) {
                    strcpybuff(retour-&gt;charset, chs);
                  }
                }
              }
            }
          }
        }
      }
      sscanf(rcvd + p, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, tempo);
      <B><FONT COLOR="#A020F0">if</FONT></B> (strlen(tempo) &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(retour-&gt;contenttype) - 2)      <I><FONT COLOR="#B22222">// pas trop long!!
</FONT></I>        strcpybuff(retour-&gt;contenttype, tempo);
      <B><FONT COLOR="#A020F0">else</FONT></B>
        strcpybuff(retour-&gt;contenttype, <B><FONT COLOR="#BC8F8F">&quot;application/octet-stream-unknown&quot;</FONT></B>);    <I><FONT COLOR="#B22222">// erreur
</FONT></I>    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Content-Range:&quot;</FONT></B>)) != 0) {
    <I><FONT COLOR="#B22222">// Content-Range: bytes 0-70870/70871
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a;

    <B><FONT COLOR="#A020F0">for</FONT></B>(a = rcvd + p; is_space(*a); a++) ;
    <B><FONT COLOR="#A020F0">if</FONT></B> (strncasecmp(a, <B><FONT COLOR="#BC8F8F">&quot;bytes &quot;</FONT></B>, 6) == 0) {
      <B><FONT COLOR="#A020F0">for</FONT></B>(a += 6; is_space(*a); a++) ;
      <B><FONT COLOR="#A020F0">if</FONT></B> (sscanf
          (a, LLintP <B><FONT COLOR="#BC8F8F">&quot;-&quot;</FONT></B> LLintP <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B> LLintP, &amp;retour-&gt;crange_start,
           &amp;retour-&gt;crange_end, &amp;retour-&gt;crange) != 3) {
        retour-&gt;crange_start = 0;
        retour-&gt;crange_end = 0;
        retour-&gt;crange = 0;
        a = strchr(rcvd + p, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);
        <B><FONT COLOR="#A020F0">if</FONT></B> (a != NULL) {
          a++;
          <B><FONT COLOR="#A020F0">if</FONT></B> (sscanf(a, LLintP, &amp;retour-&gt;crange) == 1) {
            retour-&gt;crange_start = 0;
            retour-&gt;crange_end = retour-&gt;crange - 1;
          } <B><FONT COLOR="#A020F0">else</FONT></B> {
            retour-&gt;crange = 0;
          }
        }
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Connection:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#228B22">char</FONT></B> *a = rcvd + p;

    <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
      a++;
    <B><FONT COLOR="#A020F0">if</FONT></B> (*a) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(a, <B><FONT COLOR="#BC8F8F">&quot;Keep-Alive&quot;</FONT></B>)) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (!retour-&gt;keep_alive) {
          retour-&gt;keep_alive_max = 10;
          retour-&gt;keep_alive_t = 15;
        }
        retour-&gt;keep_alive = 1;
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        retour-&gt;keep_alive = 0;
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Keep-Alive:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#228B22">char</FONT></B> *a = rcvd + p;

    <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
      a++;
    <B><FONT COLOR="#A020F0">if</FONT></B> (*a) {
      <B><FONT COLOR="#228B22">char</FONT></B> *p;

      retour-&gt;keep_alive = 1;
      retour-&gt;keep_alive_max = 10;
      retour-&gt;keep_alive_t = 15;
      <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strstr(a, <B><FONT COLOR="#BC8F8F">&quot;timeout=&quot;</FONT></B>))) {
        p += strlen(<B><FONT COLOR="#BC8F8F">&quot;timeout=&quot;</FONT></B>);
        sscanf(p, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, &amp;retour-&gt;keep_alive_t);
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strstr(a, <B><FONT COLOR="#BC8F8F">&quot;max=&quot;</FONT></B>))) {
        p += strlen(<B><FONT COLOR="#BC8F8F">&quot;max=&quot;</FONT></B>);
        sscanf(p, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, &amp;retour-&gt;keep_alive_max);
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;keep_alive_max &lt;= 1 || retour-&gt;keep_alive_t &lt; 1) {
        retour-&gt;keep_alive = 0;
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;TE:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#228B22">char</FONT></B> *a = rcvd + p;

    <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
      a++;
    <B><FONT COLOR="#A020F0">if</FONT></B> (*a) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(a, <B><FONT COLOR="#BC8F8F">&quot;trailers&quot;</FONT></B>)) {
        retour-&gt;keep_alive_trailers = 1;
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Content-Encoding:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (retour) {
      <B><FONT COLOR="#228B22">char</FONT></B> tempo[1100];
      <B><FONT COLOR="#228B22">char</FONT></B> *a = rcvd + p;

      <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
        a++;
      {
        <B><FONT COLOR="#228B22">char</FONT></B> *a = strchr(rcvd + p, <B><FONT COLOR="#BC8F8F">';'</FONT></B>);

        <B><FONT COLOR="#A020F0">if</FONT></B> (a)
          *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      }
      sscanf(a, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, tempo);
      <B><FONT COLOR="#A020F0">if</FONT></B> (strlen(tempo) &lt; 64)   <I><FONT COLOR="#B22222">// pas trop long!!
</FONT></I>        strcpybuff(retour-&gt;contentencoding, tempo);
      <B><FONT COLOR="#A020F0">else</FONT></B>
        retour-&gt;contentencoding[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;      <I><FONT COLOR="#B22222">// erreur
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEZLIB</FONT>
      <I><FONT COLOR="#B22222">/* Check known encodings */</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;contentencoding[0]) {
        <B><FONT COLOR="#A020F0">if</FONT></B> ((strfield2(retour-&gt;contentencoding, <B><FONT COLOR="#BC8F8F">&quot;gzip&quot;</FONT></B>))
            || (strfield2(retour-&gt;contentencoding, <B><FONT COLOR="#BC8F8F">&quot;x-gzip&quot;</FONT></B>))
            <I><FONT COLOR="#B22222">/*
               || (strfield2(retour-&gt;contentencoding, &quot;compress&quot;))
               || (strfield2(retour-&gt;contentencoding, &quot;x-compress&quot;))
             */</FONT></I>
            || (strfield2(retour-&gt;contentencoding, <B><FONT COLOR="#BC8F8F">&quot;deflate&quot;</FONT></B>))
            || (strfield2(retour-&gt;contentencoding, <B><FONT COLOR="#BC8F8F">&quot;x-deflate&quot;</FONT></B>))
          ) {
          retour-&gt;compressed = 1;
        }
      }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Location:&quot;</FONT></B>)) != 0) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (retour) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;location) {
        <B><FONT COLOR="#A020F0">while</FONT></B>(is_realspace(*(rcvd + p)))
          p++;                  <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(rcvd + p) &lt; HTS_URLMAXSIZE)    <I><FONT COLOR="#B22222">// pas trop long?
</FONT></I>          strcpybuff(retour-&gt;location, rcvd + p);
        <B><FONT COLOR="#A020F0">else</FONT></B>                    <I><FONT COLOR="#B22222">// erreur.. ignorer
</FONT></I>          retour-&gt;location[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      }
    }
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (((p = strfield(rcvd, <B><FONT COLOR="#BC8F8F">&quot;Set-Cookie:&quot;</FONT></B>)) != 0) &amp;&amp; (cookie)) {  <I><FONT COLOR="#B22222">// ohh un cookie
</FONT></I>    <B><FONT COLOR="#228B22">char</FONT></B> *a = rcvd + p;         <I><FONT COLOR="#B22222">// pointeur
</FONT></I>    <B><FONT COLOR="#228B22">char</FONT></B> domain[256];           <I><FONT COLOR="#B22222">// domaine cookie (.netscape.com)
</FONT></I>    <B><FONT COLOR="#228B22">char</FONT></B> path[256];             <I><FONT COLOR="#B22222">// chemin (/)
</FONT></I>    <B><FONT COLOR="#228B22">char</FONT></B> cook_name[256];        <I><FONT COLOR="#B22222">// nom cookie (MYCOOK)
</FONT></I>    <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK cook_value[8192];       <I><FONT COLOR="#B22222">// valeur (ID=toto,S=1234)
</FONT></I>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG_COOK</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;set-cookie detected\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <B><FONT COLOR="#A020F0">while</FONT></B>(*a) {
      <B><FONT COLOR="#228B22">char</FONT></B> *token_st, *token_end;
      <B><FONT COLOR="#228B22">char</FONT></B> *value_st, *value_end;
      <B><FONT COLOR="#228B22">char</FONT></B> name[256];
      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK value[8192];
      <B><FONT COLOR="#228B22">int</FONT></B> next = 0;

      name[0] = value[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      <I><FONT COLOR="#B22222">//
</FONT></I>
      <I><FONT COLOR="#B22222">// initialiser cookie lu actuellement
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (adr)
        strcpybuff(domain, jump_identification_const(adr));   <I><FONT COLOR="#B22222">// domaine
</FONT></I>      strcpybuff(path, <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);    <I><FONT COLOR="#B22222">// chemin (/)
</FONT></I>      strcpybuff(cook_name, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);        <I><FONT COLOR="#B22222">// nom cookie (MYCOOK)
</FONT></I>      strcpybuff(cook_value, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);       <I><FONT COLOR="#B22222">// valeur (ID=toto,S=1234)
</FONT></I>      <I><FONT COLOR="#B22222">// boucler jusqu'au prochain cookie ou la fin
</FONT></I>      <B><FONT COLOR="#A020F0">do</FONT></B> {
        <B><FONT COLOR="#228B22">char</FONT></B> *start_loop = a;

        <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
          a++;                  <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>        token_st = a;           <I><FONT COLOR="#B22222">// départ token
</FONT></I>        <B><FONT COLOR="#A020F0">while</FONT></B>((!is_space(*a)) &amp;&amp; (*a) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">';'</FONT></B>) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'='</FONT></B>))
          a++;                  <I><FONT COLOR="#B22222">// arrêter si espace, point virgule
</FONT></I>        token_end = a;
        <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
          a++;                  <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'='</FONT></B>) {        <I><FONT COLOR="#B22222">// name=value
</FONT></I>          a++;
          <B><FONT COLOR="#A020F0">while</FONT></B>(is_space(*a))
            a++;                <I><FONT COLOR="#B22222">// sauter espaces
</FONT></I>          value_st = a;
          <B><FONT COLOR="#A020F0">while</FONT></B>((*a != <B><FONT COLOR="#BC8F8F">';'</FONT></B>) &amp;&amp; (*a))
            a++;                <I><FONT COLOR="#B22222">// prochain ;
</FONT></I>          <I><FONT COLOR="#B22222">//while( ((*a!='&quot;') || (*(a-1)=='\\')) &amp;&amp; (*a)) a++;    // prochain &quot; (et pas \&quot;)
</FONT></I>          value_end = a;
          <I><FONT COLOR="#B22222">//if (*a==';') {  // finit par un ;
</FONT></I>          <I><FONT COLOR="#B22222">// vérifier débordements
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> ((((<B><FONT COLOR="#228B22">int</FONT></B>) (token_end - token_st)) &lt; 200)
              &amp;&amp; (((<B><FONT COLOR="#228B22">int</FONT></B>) (value_end - value_st)) &lt; 8000)
              &amp;&amp; (((<B><FONT COLOR="#228B22">int</FONT></B>) (token_end - token_st)) &gt; 0)
              &amp;&amp; (((<B><FONT COLOR="#228B22">int</FONT></B>) (value_end - value_st)) &gt; 0)) {
            <B><FONT COLOR="#228B22">int</FONT></B> name_len = (<B><FONT COLOR="#228B22">int</FONT></B>) (token_end - token_st);
            <B><FONT COLOR="#228B22">int</FONT></B> value_len = (<B><FONT COLOR="#228B22">int</FONT></B>) (value_end - value_st);

            name[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
            value[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
            strncatbuff(name, token_st, name_len);
            strncatbuff(value, value_st, value_len);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG_COOK</FONT>
            printf(<B><FONT COLOR="#BC8F8F">&quot;detected cookie-av: name=\&quot;%s\&quot; value=\&quot;%s\&quot;\n&quot;</FONT></B>, name,
                   value);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
            <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(name, <B><FONT COLOR="#BC8F8F">&quot;domain&quot;</FONT></B>)) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (value_len &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(domain) - 1) {
                strcpybuff(domain, value);
              } <B><FONT COLOR="#A020F0">else</FONT></B> {
                cook_name[0] = 0;
                <B><FONT COLOR="#A020F0">break</FONT></B>;
              }
            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(name, <B><FONT COLOR="#BC8F8F">&quot;path&quot;</FONT></B>)) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (value_len &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(path) - 1) {
                strcpybuff(path, value);
              } <B><FONT COLOR="#A020F0">else</FONT></B> {
                cook_name[0] = 0;
                <B><FONT COLOR="#A020F0">break</FONT></B>;
              }
            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(name, <B><FONT COLOR="#BC8F8F">&quot;max-age&quot;</FONT></B>)) {
              <I><FONT COLOR="#B22222">// ignoré..
</FONT></I>            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(name, <B><FONT COLOR="#BC8F8F">&quot;expires&quot;</FONT></B>)) {
              <I><FONT COLOR="#B22222">// ignoré..
</FONT></I>            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(name, <B><FONT COLOR="#BC8F8F">&quot;version&quot;</FONT></B>)) {
              <I><FONT COLOR="#B22222">// ignoré..
</FONT></I>            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(name, <B><FONT COLOR="#BC8F8F">&quot;comment&quot;</FONT></B>)) {
              <I><FONT COLOR="#B22222">// ignoré
</FONT></I>            } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(name, <B><FONT COLOR="#BC8F8F">&quot;secure&quot;</FONT></B>)) {     <I><FONT COLOR="#B22222">// ne devrait pas arriver ici
</FONT></I>              <I><FONT COLOR="#B22222">// ignoré
</FONT></I>            } <B><FONT COLOR="#A020F0">else</FONT></B> {
              <B><FONT COLOR="#A020F0">if</FONT></B> (value_len &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(cook_value) - 1
                  &amp;&amp; name_len &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(cook_name) - 1) {
                <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(cook_name) == 0) {      <I><FONT COLOR="#B22222">// noter premier: nom et valeur cookie
</FONT></I>                  strcpybuff(cook_name, name);
                  strcpybuff(cook_value, value);
                } <B><FONT COLOR="#A020F0">else</FONT></B> {        <I><FONT COLOR="#B22222">// prochain cookie
</FONT></I>                  a = start_loop;       <I><FONT COLOR="#B22222">// on devra recommencer à cette position
</FONT></I>                  next = 1;     <I><FONT COLOR="#B22222">// enregistrer
</FONT></I>                }
              } <B><FONT COLOR="#A020F0">else</FONT></B> {
                cook_name[0] = 0;
                <B><FONT COLOR="#A020F0">break</FONT></B>;
              }
            }
          }
        }
        <B><FONT COLOR="#A020F0">if</FONT></B> (!next) {
          <B><FONT COLOR="#A020F0">while</FONT></B>((*a != <B><FONT COLOR="#BC8F8F">';'</FONT></B>) &amp;&amp; (*a))
            a++;                <I><FONT COLOR="#B22222">// prochain
</FONT></I>          <B><FONT COLOR="#A020F0">while</FONT></B>(*a == <B><FONT COLOR="#BC8F8F">';'</FONT></B>)
            a++;                <I><FONT COLOR="#B22222">// sauter ;
</FONT></I>        }
      } <B><FONT COLOR="#A020F0">while</FONT></B>((*a) &amp;&amp; (!next));
      <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(cook_name)) {     <I><FONT COLOR="#B22222">// cookie?
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG_COOK</FONT>
        printf
          (<B><FONT COLOR="#BC8F8F">&quot;new cookie: name=\&quot;%s\&quot; value=\&quot;%s\&quot; domain=\&quot;%s\&quot; path=\&quot;%s\&quot;\n&quot;</FONT></B>,
           cook_name, cook_value, domain, path);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        cookie_add(cookie, cook_name, cook_value, domain, path);
      }
    }
  }
}

<I><FONT COLOR="#B22222">// transforme le message statuscode en chaîne
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">infostatuscode</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *msg, <B><FONT COLOR="#228B22">int</FONT></B> statuscode) {
  <B><FONT COLOR="#A020F0">switch</FONT></B> (statuscode) {
    <I><FONT COLOR="#B22222">// Erreurs HTTP, selon RFC
</FONT></I>  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">100</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Continue&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">101</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Switching Protocols&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">200</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;OK&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">201</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Created&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">202</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Accepted&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">203</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Non-Authoritative Information&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">204</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;No Content&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">205</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Reset Content&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">206</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Partial Content&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">300</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Multiple Choices&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">301</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Moved Permanently&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">302</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Moved Temporarily&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">303</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;See Other&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">304</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Not Modified&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">305</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Use Proxy&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">306</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Undefined 306 error&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">307</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Temporary Redirect&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">400</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Bad Request&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">401</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Unauthorized&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">402</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Payment Required&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">403</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Forbidden&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">404</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Not Found&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">405</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Method Not Allowed&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">406</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Not Acceptable&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">407</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Proxy Authentication Required&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">408</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Request Time-out&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">409</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Conflict&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">410</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Gone&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">411</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Length Required&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">412</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Precondition Failed&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">413</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Request Entity Too Large&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">414</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Request-URI Too Large&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">415</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Unsupported Media Type&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">416</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Requested Range Not Satisfiable&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">417</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Expectation Failed&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">500</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Internal Server Error&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">501</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Not Implemented&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">502</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Bad Gateway&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">503</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Service Unavailable&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">504</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Gateway Time-out&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">505</FONT></B>:
    strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;HTTP Version Not Supported&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
    <I><FONT COLOR="#B22222">//
</FONT></I>  <B><FONT COLOR="#5F9EA0">default</FONT></B>:
    <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(msg) == 0)
      strcpybuff(msg, <B><FONT COLOR="#BC8F8F">&quot;Unknown error&quot;</FONT></B>);
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  }
}

<I><FONT COLOR="#B22222">// check if data is available
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">check_readinput</FONT></B>(htsblk * r) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;soc != INVALID_SOCKET) {
    fd_set fds;                 <I><FONT COLOR="#B22222">// poll structures
</FONT></I>    <B><FONT COLOR="#228B22">struct</FONT></B> timeval tv;          <I><FONT COLOR="#B22222">// structure for select
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> soc = (<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;soc;

    assertf(soc == r-&gt;soc);
    FD_ZERO(&amp;fds);
    FD_SET(soc, &amp;fds);
    tv.tv_sec = 0;
    tv.tv_usec = 0;
    select(soc + 1, &amp;fds, NULL, NULL, &amp;tv);
    <B><FONT COLOR="#A020F0">if</FONT></B> (FD_ISSET(soc, &amp;fds))
      <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    <B><FONT COLOR="#A020F0">else</FONT></B>
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  } <B><FONT COLOR="#A020F0">else</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">// check if data is available
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">check_readinput_t</FONT></B>(T_SOC soc, <B><FONT COLOR="#228B22">int</FONT></B> timeout) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (soc != INVALID_SOCKET) {
    fd_set fds;                 <I><FONT COLOR="#B22222">// poll structures
</FONT></I>    <B><FONT COLOR="#228B22">struct</FONT></B> timeval tv;          <I><FONT COLOR="#B22222">// structure for select
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> isoc = (<B><FONT COLOR="#228B22">int</FONT></B>) soc;

    assertf(isoc == soc);
    FD_ZERO(&amp;fds);
    FD_SET(isoc, &amp;fds);
    tv.tv_sec = timeout;
    tv.tv_usec = 0;
    select(isoc + 1, &amp;fds, NULL, NULL, &amp;tv);
    <B><FONT COLOR="#A020F0">if</FONT></B> (FD_ISSET(isoc, &amp;fds))
      <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    <B><FONT COLOR="#A020F0">else</FONT></B>
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  } <B><FONT COLOR="#A020F0">else</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">// idem, sauf qu'ici on peut choisir la taille max de données à recevoir
</FONT></I><I><FONT COLOR="#B22222">// SI bufl==0 alors le buffer est censé être de 8kos, et on recoit par bloc de lignes
</FONT></I><I><FONT COLOR="#B22222">// en éliminant les cr (ex: header), arrêt si double-lf
</FONT></I><I><FONT COLOR="#B22222">// SI bufl==-1 alors le buffer est censé être de 8kos, et on recoit ligne par ligne
</FONT></I><I><FONT COLOR="#B22222">// en éliminant les cr (ex: header), arrêt si double-lf
</FONT></I><I><FONT COLOR="#B22222">// Note: les +1 dans les malloc sont dûs à l'octet nul rajouté en fin de fichier
</FONT></I>LLint <B><FONT COLOR="#0000FF">http_xfread1</FONT></B>(htsblk * r, <B><FONT COLOR="#228B22">int</FONT></B> bufl) {
  <B><FONT COLOR="#228B22">int</FONT></B> nl = -1;

  <I><FONT COLOR="#B22222">// EOF
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;totalsize &gt;= 0 &amp;&amp; r-&gt;size == r-&gt;totalsize) {
    <B><FONT COLOR="#A020F0">return</FONT></B> READ_EOF;
  }

  <B><FONT COLOR="#A020F0">if</FONT></B> (bufl &gt; 0) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (!r-&gt;is_write) {         <I><FONT COLOR="#B22222">// stocker en mémoire
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;totalsize &gt;= 0) {  <I><FONT COLOR="#B22222">// totalsize déterminé ET ALLOUE
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr == NULL) {
          r-&gt;adr = (<B><FONT COLOR="#228B22">char</FONT></B> *) malloct((size_t) r-&gt;totalsize + 1);
          r-&gt;size = 0;
        }
        <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr != NULL) {
          <I><FONT COLOR="#B22222">// lecture
</FONT></I>          <B><FONT COLOR="#228B22">const</FONT></B> size_t req_size = r-&gt;totalsize - r-&gt;size;

          nl = req_size &gt; 0 ? hts_read(r, r-&gt;adr + ((<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;size), (<B><FONT COLOR="#228B22">int</FONT></B>) req_size) : 0;        <I><FONT COLOR="#B22222">/* NO 32 bit overlow possible here (no 4GB html!) */</FONT></I>
          <I><FONT COLOR="#B22222">// nouvelle taille
</FONT></I>          <B><FONT COLOR="#A020F0">if</FONT></B> (nl &gt;= 0)
            r-&gt;size += nl;

          <I><FONT COLOR="#B22222">/*
             if (r-&gt;size &gt;= r-&gt;totalsize)
             nl = -1;  // break
           */</FONT></I>

          r-&gt;adr[r-&gt;size] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;       <I><FONT COLOR="#B22222">// caractère NULL en fin au cas où l'on traite des HTML
</FONT></I>        }

      } <B><FONT COLOR="#A020F0">else</FONT></B> {                  <I><FONT COLOR="#B22222">// inconnu..
</FONT></I>        <I><FONT COLOR="#B22222">// réserver de la mémoire?
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr == NULL) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
          printf(<B><FONT COLOR="#BC8F8F">&quot;..alloc xfread\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
          r-&gt;adr = (<B><FONT COLOR="#228B22">char</FONT></B> *) malloct(bufl + 1);
          r-&gt;size = 0;
        } <B><FONT COLOR="#A020F0">else</FONT></B> {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
          printf(<B><FONT COLOR="#BC8F8F">&quot;..realloc xfread1\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
          r-&gt;adr = (<B><FONT COLOR="#228B22">char</FONT></B> *) realloct(r-&gt;adr, (<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;size + bufl + 1);
        }

        <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr != NULL) {
          <I><FONT COLOR="#B22222">// lecture
</FONT></I>          nl = hts_read(r, r-&gt;adr + (<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;size, bufl);
          <B><FONT COLOR="#A020F0">if</FONT></B> (nl &gt; 0) {
            <I><FONT COLOR="#B22222">// resize
</FONT></I>            r-&gt;adr = (<B><FONT COLOR="#228B22">char</FONT></B> *) realloct(r-&gt;adr, (<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;size + nl + 1);
            <I><FONT COLOR="#B22222">// nouvelle taille
</FONT></I>            r-&gt;size += nl;
            <I><FONT COLOR="#B22222">// octet nul
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr)
              r-&gt;adr[r-&gt;size] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

          }                     <I><FONT COLOR="#B22222">// sinon on a fini
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
          <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (nl &lt; 0)
            printf(<B><FONT COLOR="#BC8F8F">&quot;..end read (%d)\n&quot;</FONT></B>, nl);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
        <B><FONT COLOR="#A020F0">else</FONT></B>
          printf(<B><FONT COLOR="#BC8F8F">&quot;..-&gt; error\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      }

      <I><FONT COLOR="#B22222">// pas de adr=erreur
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr == NULL)
        nl = READ_ERROR;

    } <B><FONT COLOR="#A020F0">else</FONT></B> {                    <I><FONT COLOR="#B22222">// stocker sur disque
</FONT></I>      <B><FONT COLOR="#228B22">char</FONT></B> *buff;

      buff = (<B><FONT COLOR="#228B22">char</FONT></B> *) malloct(bufl);
      <B><FONT COLOR="#A020F0">if</FONT></B> (buff != NULL) {
        <I><FONT COLOR="#B22222">// lecture
</FONT></I>        nl = hts_read(r, buff, bufl);
        <I><FONT COLOR="#B22222">// nouvelle taille
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (nl &gt; 0) {
          r-&gt;size += nl;
          <B><FONT COLOR="#A020F0">if</FONT></B> (fwrite(buff, 1, nl, r-&gt;out) != nl) {
            r-&gt;statuscode = STATUSCODE_INVALID;
            strcpybuff(r-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Write error on disk&quot;</FONT></B>);
            nl = READ_ERROR;
          }
        }
        <I><FONT COLOR="#B22222">//if ((nl &lt; 0) || ((r-&gt;totalsize&gt;0) &amp;&amp; (r-&gt;size &gt;= r-&gt;totalsize)))
</FONT></I>        <I><FONT COLOR="#B22222">//  nl=-1;  // break
</FONT></I>
        <I><FONT COLOR="#B22222">// libérer bloc tempo
</FONT></I>        freet(buff);
      } <B><FONT COLOR="#A020F0">else</FONT></B>
        nl = READ_ERROR;

      <B><FONT COLOR="#A020F0">if</FONT></B> ((nl &lt; 0) &amp;&amp; (r-&gt;out != NULL)) {
        fflush(r-&gt;out);
      }

    }                           <I><FONT COLOR="#B22222">// stockage disque ou mémoire
</FONT></I>
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (bufl == -2) {      <I><FONT COLOR="#B22222">// force reserve
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr == NULL) {
      r-&gt;adr = (<B><FONT COLOR="#228B22">char</FONT></B> *) malloct(8192);
      r-&gt;size = 0;
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
    }
    <B><FONT COLOR="#A020F0">return</FONT></B> -1;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {                      <I><FONT COLOR="#B22222">// réception d'un en-tête octet par octet
</FONT></I>    <B><FONT COLOR="#228B22">int</FONT></B> count = 256;
    <B><FONT COLOR="#228B22">int</FONT></B> tot_nl = 0;
    <B><FONT COLOR="#228B22">int</FONT></B> lf_detected = 0;
    <B><FONT COLOR="#228B22">int</FONT></B> at_beginning = 1;

    <B><FONT COLOR="#A020F0">do</FONT></B> {
      nl = READ_INTERNAL_ERROR;
      count--;
      <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr == NULL) {
        r-&gt;adr = (<B><FONT COLOR="#228B22">char</FONT></B> *) malloct(8192);
        r-&gt;size = 0;
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr != NULL) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;size &lt; 8190) {
          <I><FONT COLOR="#B22222">// lecture
</FONT></I>          nl = hts_read(r, r-&gt;adr + r-&gt;size, 1);
          <B><FONT COLOR="#A020F0">if</FONT></B> (nl &gt; 0) {
            <I><FONT COLOR="#B22222">// exit if:
</FONT></I>            <I><FONT COLOR="#B22222">// lf detected AND already detected before
</FONT></I>            <I><FONT COLOR="#B22222">// or
</FONT></I>            <I><FONT COLOR="#B22222">// lf detected AND first character read
</FONT></I>            <B><FONT COLOR="#A020F0">if</FONT></B> (*(r-&gt;adr + r-&gt;size) == 10) {
              <B><FONT COLOR="#A020F0">if</FONT></B> (lf_detected || (at_beginning) || (bufl &lt; 0))
                count = -1;
              lf_detected = 1;
            }
            <B><FONT COLOR="#A020F0">if</FONT></B> (*(r-&gt;adr + r-&gt;size) != 13) {    <I><FONT COLOR="#B22222">// sauter caractères 13
</FONT></I>              <B><FONT COLOR="#A020F0">if</FONT></B> ((*(r-&gt;adr + r-&gt;size) != 10)
                  &amp;&amp; (*(r-&gt;adr + r-&gt;size) != 13)
                ) {
                <I><FONT COLOR="#B22222">// restart for new line
</FONT></I>                lf_detected = 0;
              }
              (r-&gt;size)++;
              at_beginning = 0;
            }
            *(r-&gt;adr + r-&gt;size) = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; <I><FONT COLOR="#B22222">// terminer par octet nul
</FONT></I>          }
        }
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (nl &gt;= 0) {
        tot_nl += nl;
        <B><FONT COLOR="#A020F0">if</FONT></B> (!check_readinput(r))
          count = -1;
      }
    } <B><FONT COLOR="#A020F0">while</FONT></B>((nl &gt;= 0) &amp;&amp; (count &gt; 0));
    <B><FONT COLOR="#A020F0">if</FONT></B> (nl &gt;= 0) {
      nl = tot_nl;
    }
  }
  <I><FONT COLOR="#B22222">// EOF
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;totalsize &gt;= 0 &amp;&amp; r-&gt;size == r-&gt;totalsize) {
    <B><FONT COLOR="#A020F0">return</FONT></B> READ_EOF;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <B><FONT COLOR="#A020F0">return</FONT></B> nl;
  }
}

<I><FONT COLOR="#B22222">// teste si une URL (validité, header, taille)
</FONT></I><I><FONT COLOR="#B22222">// retourne 200 ou le code d'erreur (404=NOT FOUND, etc)
</FONT></I><I><FONT COLOR="#B22222">// en cas de moved xx, dans location
</FONT></I><I><FONT COLOR="#B22222">// abandonne désormais au bout de 30 secondes (aurevoir les sites
</FONT></I><I><FONT COLOR="#B22222">// qui nous font poireauter 5 heures..) -&gt; -2=timeout
</FONT></I>htsblk <B><FONT COLOR="#0000FF">http_test</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil, <B><FONT COLOR="#228B22">char</FONT></B> *loc) {
  T_SOC soc;
  htsblk retour;

  <I><FONT COLOR="#B22222">//int rcvsize=-1;
</FONT></I>  <I><FONT COLOR="#B22222">//char* rcv=NULL;    // adresse de retour
</FONT></I>  <I><FONT COLOR="#B22222">//int bufl=TAILLE_BUFFER;    // 8Ko de buffer
</FONT></I>  TStamp tl;
  <B><FONT COLOR="#228B22">int</FONT></B> timeout = 30;             <I><FONT COLOR="#B22222">// timeout pour un check (arbitraire) // **
</FONT></I>
  <I><FONT COLOR="#B22222">// pour abandonner un site trop lent
</FONT></I>  tl = time_local();

  loc[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  hts_init_htsblk(&amp;retour);
  <I><FONT COLOR="#B22222">//memset(&amp;retour, 0, sizeof(htsblk));    // effacer
</FONT></I>  retour.location = loc;        <I><FONT COLOR="#B22222">// si non nul, contiendra l'adresse véritable en cas de moved xx
</FONT></I>
  <I><FONT COLOR="#B22222">//soc=http_fopen(adr,fil,&amp;retour,NULL);  // ouvrir, + header
</FONT></I>
  <I><FONT COLOR="#B22222">// on ouvre en head, et on traite l'en tête
</FONT></I>  soc = http_xfopen(opt, 1, 0, 1, NULL, adr, fil, &amp;retour);     <I><FONT COLOR="#B22222">// ouvrir HEAD, + envoi header
</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (soc != INVALID_SOCKET) {
    <B><FONT COLOR="#228B22">int</FONT></B> e = 0;

    <I><FONT COLOR="#B22222">// tant qu'on a des données, et qu'on ne recoit pas deux LF, et que le timeout n'arrie pas
</FONT></I>    <B><FONT COLOR="#A020F0">do</FONT></B> {
      <B><FONT COLOR="#A020F0">if</FONT></B> (http_xfread1(&amp;retour, 0) &lt; 0)
        e = 1;
      <B><FONT COLOR="#A020F0">else</FONT></B> {
        <B><FONT COLOR="#A020F0">if</FONT></B> (retour.adr != NULL) {
          <B><FONT COLOR="#A020F0">if</FONT></B> ((retour.adr[retour.size - 1] != 10)
              || (retour.adr[retour.size - 2] != 10))
            e = 1;
        }
      }

      <B><FONT COLOR="#A020F0">if</FONT></B> (!e) {
        <B><FONT COLOR="#A020F0">if</FONT></B> ((time_local() - tl) &gt;= timeout) {
          e = -1;
        }
      }

    } <B><FONT COLOR="#A020F0">while</FONT></B>(!e);

    <B><FONT COLOR="#A020F0">if</FONT></B> (e == 1) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (adr != NULL) {
        <B><FONT COLOR="#228B22">int</FONT></B> ptr = 0;
        <B><FONT COLOR="#228B22">char</FONT></B> rcvd[1100];

        <I><FONT COLOR="#B22222">// note: en gros recopie du traitement de back_wait()
</FONT></I>        <I><FONT COLOR="#B22222">//
</FONT></I>
        <I><FONT COLOR="#B22222">// ----------------------------------------
</FONT></I>        <I><FONT COLOR="#B22222">// traiter en-tête!
</FONT></I>        <I><FONT COLOR="#B22222">// status-line à récupérer
</FONT></I>        ptr += binput(retour.adr + ptr, rcvd, 1024);
        <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(rcvd) == 0)
          ptr += binput(retour.adr + ptr, rcvd, 1024);  <I><FONT COLOR="#B22222">// &quot;certains serveurs buggés envoient un \n au début&quot; (RFC)
</FONT></I>
        <I><FONT COLOR="#B22222">// traiter status-line
</FONT></I>        treatfirstline(&amp;retour, rcvd);

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
        printf(<B><FONT COLOR="#BC8F8F">&quot;(Buffer) Status-Code=%d\n&quot;</FONT></B>, retour.statuscode);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

        <I><FONT COLOR="#B22222">// en-tête
</FONT></I>
        <I><FONT COLOR="#B22222">// header // ** !attention! HTTP/0.9 non supporté
</FONT></I>        <B><FONT COLOR="#A020F0">do</FONT></B> {
          ptr += binput(retour.adr + ptr, rcvd, 1024);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
          printf(<B><FONT COLOR="#BC8F8F">&quot;(buffer)&gt;%s\n&quot;</FONT></B>, rcvd);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
          <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(rcvd))
            treathead(NULL, NULL, NULL, &amp;retour, rcvd); <I><FONT COLOR="#B22222">// traiter
</FONT></I>
        } <B><FONT COLOR="#A020F0">while</FONT></B>(strnotempty(rcvd));
        <I><FONT COLOR="#B22222">// ----------------------------------------                    
</FONT></I>
        <I><FONT COLOR="#B22222">// libérer mémoire
</FONT></I>        <B><FONT COLOR="#A020F0">if</FONT></B> (retour.adr != NULL) {
          freet(retour.adr);
          retour.adr = NULL;
        }
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      retour.statuscode = STATUSCODE_TIMEOUT;
      strcpybuff(retour.msg, <B><FONT COLOR="#BC8F8F">&quot;Timeout While Testing&quot;</FONT></B>);
    }

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_DEBUG_CLOSESOCK</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;http_test: deletehttp\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    deletehttp(&amp;retour);
    retour.soc = INVALID_SOCKET;
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> retour;
}

<I><FONT COLOR="#B22222">// Crée un lien (http) vers une adresse internet iadr
</FONT></I><I><FONT COLOR="#B22222">// retour: structure (adresse, taille, message si erreur (si !adr))
</FONT></I><I><FONT COLOR="#B22222">// peut ouvrir avec des connect() non bloquants: waitconnect=0/1
</FONT></I>T_SOC <B><FONT COLOR="#0000FF">newhttp</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *_iadr, htsblk * retour, <B><FONT COLOR="#228B22">int</FONT></B> port,
              <B><FONT COLOR="#228B22">int</FONT></B> waitconnect) {
  T_SOC soc;                    <I><FONT COLOR="#B22222">// descipteur de la socket
</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(_iadr, <B><FONT COLOR="#BC8F8F">&quot;file://&quot;</FONT></B>) != 0) {  <I><FONT COLOR="#B22222">/* non fichier */</FONT></I>
    SOCaddr server;
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *error = <B><FONT COLOR="#BC8F8F">&quot;unknown error&quot;</FONT></B>;

    <I><FONT COLOR="#B22222">// tester un éventuel id:pass et virer id:pass@ si détecté
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> iadr = jump_identification_const(_iadr);

    SOCaddr_clear(server);

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;gethostbyname\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    <I><FONT COLOR="#B22222">// tester un éventuel port
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (port == -1) {
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = jump_toport_const(iadr);

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour-&gt;ssl)
        port = 443;
      <B><FONT COLOR="#A020F0">else</FONT></B>
        port = 80;              <I><FONT COLOR="#B22222">// port par défaut
</FONT></I>#<B><FONT COLOR="#5F9EA0">else</FONT></B>
      port = 80;                <I><FONT COLOR="#B22222">// port par défaut
</FONT></I>#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

      <B><FONT COLOR="#A020F0">if</FONT></B> (a != NULL) {
        <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK iadr2[HTS_URLMAXSIZE * 2];
        <B><FONT COLOR="#228B22">int</FONT></B> i = -1;

        iadr2[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        sscanf(a + 1, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, &amp;i);
        <B><FONT COLOR="#A020F0">if</FONT></B> (i != -1) {
          port = (<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">short</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B>) i;
        }

        <I><FONT COLOR="#B22222">// adresse véritable (sans :xx)
</FONT></I>        strncatbuff(iadr2, iadr, (<B><FONT COLOR="#228B22">int</FONT></B>) (a - iadr));

        <I><FONT COLOR="#B22222">// adresse sans le :xx
</FONT></I>        hts_dns_resolve2(opt, iadr2, &amp;server, &amp;error);

      } <B><FONT COLOR="#A020F0">else</FONT></B> {

        <I><FONT COLOR="#B22222">// adresse normale (port par défaut par la suite)
</FONT></I>        hts_dns_resolve2(opt, iadr, &amp;server, &amp;error);
      }

    } <B><FONT COLOR="#A020F0">else</FONT></B> {                    <I><FONT COLOR="#B22222">// port défini
</FONT></I>      hts_dns_resolve2(opt, iadr, &amp;server, &amp;error);
    }

    <B><FONT COLOR="#A020F0">if</FONT></B> (!SOCaddr_is_valid(server)) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUG</FONT>
      printf(<B><FONT COLOR="#BC8F8F">&quot;erreur gethostbyname\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour &amp;&amp; retour-&gt;msg) {
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
        snprintf(retour-&gt;msg, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(retour-&gt;msg),
                 <B><FONT COLOR="#BC8F8F">&quot;Unable to get server's address: %s&quot;</FONT></B>, error);
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
        snprintf(retour-&gt;msg, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(retour-&gt;msg),
                 <B><FONT COLOR="#BC8F8F">&quot;Unable to get server's address: %s&quot;</FONT></B>, error);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      }
      <B><FONT COLOR="#A020F0">return</FONT></B> INVALID_SOCKET;
    }

    <I><FONT COLOR="#B22222">// make a copy for external clients
</FONT></I>    SOCaddr_copy_SOCaddr(retour-&gt;address, server);
    retour-&gt;address_size = SOCaddr_size(retour-&gt;address);

    <I><FONT COLOR="#B22222">// créer (&quot;attachement&quot;) une socket (point d'accès) internet,en flot
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;socket\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;socket\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    soc = (T_SOC) socket(SOCaddr_sinfamily(server), SOCK_STREAM, 0);
    <B><FONT COLOR="#A020F0">if</FONT></B> (retour != NULL) {
      retour-&gt;debugid = HTS_STAT.stat_sockid++;
    }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;socket()=%d\n&quot;</FONT></B> _(<B><FONT COLOR="#228B22">int</FONT></B>) soc);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B> (soc == INVALID_SOCKET) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour &amp;&amp; retour-&gt;msg) {
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
        <B><FONT COLOR="#228B22">int</FONT></B> last_errno = WSAGetLastError();

        sprintf(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unable to create a socket: %s&quot;</FONT></B>,
                strerror(last_errno));
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
        <B><FONT COLOR="#228B22">int</FONT></B> last_errno = errno;

        sprintf(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unable to create a socket: %s&quot;</FONT></B>,
                strerror(last_errno));
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      }
      <B><FONT COLOR="#A020F0">return</FONT></B> INVALID_SOCKET;    <I><FONT COLOR="#B22222">// erreur création socket impossible
</FONT></I>    }
    <I><FONT COLOR="#B22222">// bind this address
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (retour != NULL &amp;&amp; strnotempty(retour-&gt;req.proxy.bindhost)) {
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *error = <B><FONT COLOR="#BC8F8F">&quot;unknown error&quot;</FONT></B>;
      SOCaddr bind_addr;

      <B><FONT COLOR="#A020F0">if</FONT></B> (hts_dns_resolve2(opt, retour-&gt;req.proxy.bindhost,
                             &amp;bind_addr, &amp;error) == NULL
          || bind(soc, &amp;SOCaddr_sockaddr(bind_addr), 
                  SOCaddr_size(bind_addr)) != 0) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (retour &amp;&amp; retour-&gt;msg) {
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
          snprintf(retour-&gt;msg, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(retour-&gt;msg),
                   <B><FONT COLOR="#BC8F8F">&quot;Unable to bind the specificied server address: %s&quot;</FONT></B>,
                   error);
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
          snprintf(retour-&gt;msg, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(retour-&gt;msg),
                   <B><FONT COLOR="#BC8F8F">&quot;Unable to bind the specificied server address: %s&quot;</FONT></B>,
                   error);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        }
        deletesoc(soc);
        <B><FONT COLOR="#A020F0">return</FONT></B> INVALID_SOCKET;
      }
    }
    <I><FONT COLOR="#B22222">// structure: connexion au domaine internet, port 80 (ou autre)
</FONT></I>    SOCaddr_initport(server, port);
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;==%d\n&quot;</FONT></B>, soc);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    <I><FONT COLOR="#B22222">// connexion non bloquante?
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (!waitconnect) {
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
      <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">long</FONT></B> p = 1;      <I><FONT COLOR="#B22222">// non bloquant
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (ioctlsocket(soc, FIONBIO, &amp;p)) {
        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> last_errno = WSAGetLastError();
        snprintf(retour-&gt;msg, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(retour-&gt;msg),
                 <B><FONT COLOR="#BC8F8F">&quot;Non-blocking socket failed: %s&quot;</FONT></B>, strerror(last_errno));
        deletesoc(soc);
        <B><FONT COLOR="#A020F0">return</FONT></B> INVALID_SOCKET;
      }
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> flags = fcntl(soc, F_GETFL, 0);
      <B><FONT COLOR="#A020F0">if</FONT></B> (flags == -1 || fcntl(soc, F_SETFL, flags | O_NONBLOCK) == -1) {
        snprintf(retour-&gt;msg, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(retour-&gt;msg),
                 <B><FONT COLOR="#BC8F8F">&quot;Non-blocking socket failed: %s&quot;</FONT></B>, strerror(errno));
        deletesoc(soc);
        <B><FONT COLOR="#A020F0">return</FONT></B> INVALID_SOCKET;
      }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    }
    <I><FONT COLOR="#B22222">// Connexion au serveur lui même
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;connect\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    HTS_STAT.last_connect = mtime_local();

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;connect\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B> (connect(soc, &amp;SOCaddr_sockaddr(server), SOCaddr_size(server)) != 0) {
      <I><FONT COLOR="#B22222">// bloquant
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (waitconnect) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
        printf(<B><FONT COLOR="#BC8F8F">&quot;unable to connect!\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        <B><FONT COLOR="#A020F0">if</FONT></B> (retour != NULL &amp;&amp; retour-&gt;msg) {
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> last_errno = WSAGetLastError();

          sprintf(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unable to connect to the server: %s&quot;</FONT></B>,
                  strerror(last_errno));
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> last_errno = errno;

          sprintf(retour-&gt;msg, <B><FONT COLOR="#BC8F8F">&quot;Unable to connect to the server: %s&quot;</FONT></B>,
                  strerror(last_errno));
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
        }
        <I><FONT COLOR="#B22222">/* Close the socket and notify the error!!! */</FONT></I>
        deletesoc(soc);
        <B><FONT COLOR="#A020F0">return</FONT></B> INVALID_SOCKET;
      }
    }
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;connect done\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;connexion établie\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    <I><FONT COLOR="#B22222">// A partir de maintenant, on peut envoyer et recevoir des données
</FONT></I>    <I><FONT COLOR="#B22222">// via le flot identifié par soc (socket): write(soc,adr,taille) et 
</FONT></I>    <I><FONT COLOR="#B22222">// read(soc,adr,taille)
</FONT></I>
  } <B><FONT COLOR="#A020F0">else</FONT></B> {                      <I><FONT COLOR="#B22222">// on doit ouvrir un fichier local!
</FONT></I>    <I><FONT COLOR="#B22222">// il sera géré de la même manière qu'une socket (c'est idem!)
</FONT></I>
    soc = LOCAL_SOCKET_ID;      <I><FONT COLOR="#B22222">// pseudo-socket locale..
</FONT></I>    <I><FONT COLOR="#B22222">// soc sera remplacé lors d'un http_fopen() par un handle véritable!
</FONT></I>
  }                             <I><FONT COLOR="#B22222">// teste fichier local ou http
</FONT></I>
  <B><FONT COLOR="#A020F0">return</FONT></B> soc;
}

<I><FONT COLOR="#B22222">// couper http://www.truc.fr/pub/index.html -&gt; www.truc.fr /pub/index.html
</FONT></I><I><FONT COLOR="#B22222">// retour=-1 si erreur.
</FONT></I><I><FONT COLOR="#B22222">// si file://... alors adresse=file:// (et coupe le ?query dans ce cas)
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ident_url_absolute</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *url, lien_adrfil *adrfil) {
  <B><FONT COLOR="#228B22">int</FONT></B> pos = 0;
  <B><FONT COLOR="#228B22">int</FONT></B> scheme = 0;

  <I><FONT COLOR="#B22222">// effacer adrfil-&gt;adr et adrfil-&gt;fil
</FONT></I>  adrfil-&gt;adr[0] = adrfil-&gt;fil[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
  printf(<B><FONT COLOR="#BC8F8F">&quot;protocol: %s\n&quot;</FONT></B>, url);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  <I><FONT COLOR="#B22222">// Scheme?
</FONT></I>  {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = url;

    <B><FONT COLOR="#A020F0">while</FONT></B>(isalpha((<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) *a))
      a++;
    <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">':'</FONT></B>)
      scheme = 1;
  }

  <I><FONT COLOR="#B22222">// 1. optional scheme &quot;:&quot;
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> ((pos = strfield(url, <B><FONT COLOR="#BC8F8F">&quot;file:&quot;</FONT></B>))) { <I><FONT COLOR="#B22222">// fichier local!! (pour les tests)
</FONT></I>    <I><FONT COLOR="#B22222">//!!p+=3;
</FONT></I>    strcpybuff(adrfil-&gt;adr, <B><FONT COLOR="#BC8F8F">&quot;file://&quot;</FONT></B>);
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((pos = strfield(url, <B><FONT COLOR="#BC8F8F">&quot;http:&quot;</FONT></B>))) {  <I><FONT COLOR="#B22222">// HTTP
</FONT></I>    <I><FONT COLOR="#B22222">//!!p+=3;
</FONT></I>  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((pos = strfield(url, <B><FONT COLOR="#BC8F8F">&quot;ftp:&quot;</FONT></B>))) {   <I><FONT COLOR="#B22222">// FTP
</FONT></I>    strcpybuff(adrfil-&gt;adr, <B><FONT COLOR="#BC8F8F">&quot;ftp://&quot;</FONT></B>);  <I><FONT COLOR="#B22222">// FTP!!
</FONT></I>    <I><FONT COLOR="#B22222">//!!p+=3;
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((pos = strfield(url, <B><FONT COLOR="#BC8F8F">&quot;https:&quot;</FONT></B>))) {     <I><FONT COLOR="#B22222">// HTTPS
</FONT></I>    strcpybuff(adrfil-&gt;adr, <B><FONT COLOR="#BC8F8F">&quot;https://&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (scheme) {
    <B><FONT COLOR="#A020F0">return</FONT></B> -1;                  <I><FONT COLOR="#B22222">// erreur non reconnu
</FONT></I>  } <B><FONT COLOR="#A020F0">else</FONT></B>
    pos = 0;

  <I><FONT COLOR="#B22222">// 2. optional &quot;//&quot; authority
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (strncmp(url + pos, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>, 2) == 0)
    pos += 2;

  <I><FONT COLOR="#B22222">// (url+pos) now points to the path (not net path)
</FONT></I>
  <I><FONT COLOR="#B22222">//## if (adrfil-&gt;adr[0]!=lOCAL_CHAR) {    // adrfil-&gt;adresse normale http
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (!strfield(adrfil-&gt;adr, <B><FONT COLOR="#BC8F8F">&quot;file:&quot;</FONT></B>)) {        <I><FONT COLOR="#B22222">// PAS adrfil-&gt;file://
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *p, *q;

    p = url + pos;

    <I><FONT COLOR="#B22222">// p pointe sur le début de l'adrfil-&gt;adresse, ex: www.truc.fr/sommaire/index.html
</FONT></I>    q = strchr(jump_identification_const(p), <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);
    <B><FONT COLOR="#A020F0">if</FONT></B> (q == 0)
      q = strchr(jump_identification_const(p), <B><FONT COLOR="#BC8F8F">'?'</FONT></B>);  <I><FONT COLOR="#B22222">// http://www.foo.com?bar=1
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (q == 0)
      q = p + strlen(p);        <I><FONT COLOR="#B22222">// pointe sur \0
</FONT></I>    <I><FONT COLOR="#B22222">// q pointe sur le chemin, ex: index.html?query=recherche
</FONT></I>
    <I><FONT COLOR="#B22222">// chemin www... trop long!!
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> ((((<B><FONT COLOR="#228B22">int</FONT></B>) (q - p))) &gt; HTS_URLMAXSIZE) {
      <I><FONT COLOR="#B22222">//strcpybuff(retour.msg,&quot;Path too long&quot;);
</FONT></I>      <B><FONT COLOR="#A020F0">return</FONT></B> -1;                <I><FONT COLOR="#B22222">// erreur
</FONT></I>    }
    <I><FONT COLOR="#B22222">// recopier adrfil-&gt;adresse www..
</FONT></I>    strncatbuff(adrfil-&gt;adr, p, ((<B><FONT COLOR="#228B22">int</FONT></B>) (q - p)));
    <I><FONT COLOR="#B22222">// *( adrfil-&gt;adr+( ((int) q) - ((int) p) ) )=0;  // faut arrêter la fumette!
</FONT></I>    <I><FONT COLOR="#B22222">// recopier chemin /pub/..
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (q[0] != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)            <I><FONT COLOR="#B22222">// page par défaut (/)
</FONT></I>      strcatbuff(adrfil-&gt;fil, <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
    strcatbuff(adrfil-&gt;fil, q);
    <I><FONT COLOR="#B22222">// SECURITE:
</FONT></I>    <I><FONT COLOR="#B22222">// simplifier url pour les ../
</FONT></I>    fil_simplifie(adrfil-&gt;fil);
  } <B><FONT COLOR="#A020F0">else</FONT></B> {                      <I><FONT COLOR="#B22222">// localhost adrfil-&gt;file://
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *p;
    size_t i;
    <B><FONT COLOR="#228B22">char</FONT></B> *a;

    p = url + pos;
    <B><FONT COLOR="#A020F0">if</FONT></B> (*p == <B><FONT COLOR="#BC8F8F">'/'</FONT></B> || *p == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>) {      <I><FONT COLOR="#B22222">/* adrfil-&gt;file:///.. */</FONT></I>
      strcatbuff(adrfil-&gt;fil, p);       <I><FONT COLOR="#B22222">// fichier local ; adrfil-&gt;adr=&quot;#&quot;
</FONT></I>    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">if</FONT></B> (p[1] != <B><FONT COLOR="#BC8F8F">':'</FONT></B>) {
        strcatbuff(adrfil-&gt;fil, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>);  <I><FONT COLOR="#B22222">/* adrfil-&gt;file://server/foo */</FONT></I>
        strcatbuff(adrfil-&gt;fil, p);
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        strcatbuff(adrfil-&gt;fil, p);     <I><FONT COLOR="#B22222">// adrfil-&gt;file://C:\..
</FONT></I>      }
    }

    a = strchr(adrfil-&gt;fil, <B><FONT COLOR="#BC8F8F">'?'</FONT></B>);
    <B><FONT COLOR="#A020F0">if</FONT></B> (a)
      *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;                <I><FONT COLOR="#B22222">/* couper query (inutile pour adrfil-&gt;file:// lors de la requête) */</FONT></I>
    <I><FONT COLOR="#B22222">// adrfil-&gt;filtrer les \\ -&gt; / pour les fichiers DOS
</FONT></I>    <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; adrfil-&gt;fil[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; i++)
      <B><FONT COLOR="#A020F0">if</FONT></B> (adrfil-&gt;fil[i] == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>)
        adrfil-&gt;fil[i] = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;
  }

  <I><FONT COLOR="#B22222">// no hostname
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(adrfil-&gt;adr))
    <B><FONT COLOR="#A020F0">return</FONT></B> -1;                  <I><FONT COLOR="#B22222">// erreur non reconnu
</FONT></I>
  <I><FONT COLOR="#B22222">// nommer au besoin.. (non utilisé normalement)
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(adrfil-&gt;fil))
    strcpybuff(adrfil-&gt;fil, <B><FONT COLOR="#BC8F8F">&quot;default-index.html&quot;</FONT></B>);

  <I><FONT COLOR="#B22222">// case insensitive pour adrfil-&gt;adresse
</FONT></I>  {
    <B><FONT COLOR="#228B22">char</FONT></B> *a = jump_identification(adrfil-&gt;adr);

    <B><FONT COLOR="#A020F0">while</FONT></B>(*a) {
      <B><FONT COLOR="#A020F0">if</FONT></B> ((*a &gt;= <B><FONT COLOR="#BC8F8F">'A'</FONT></B>) &amp;&amp; (*a &lt;= <B><FONT COLOR="#BC8F8F">'Z'</FONT></B>))
        *a += <B><FONT COLOR="#BC8F8F">'a'</FONT></B> - <B><FONT COLOR="#BC8F8F">'A'</FONT></B>;
      a++;
    }
  }

  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* simplify ../ and ./ */</FONT></I>
<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">fil_simplifie</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *f) {
  <B><FONT COLOR="#228B22">char</FONT></B> *a, *b;
  <B><FONT COLOR="#228B22">char</FONT></B> *rollback[128];
  <B><FONT COLOR="#228B22">int</FONT></B> rollid = 0;
  <B><FONT COLOR="#228B22">char</FONT></B> lc = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;
  <B><FONT COLOR="#228B22">int</FONT></B> query = 0;
  <B><FONT COLOR="#228B22">int</FONT></B> wasAbsolute = (*f == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);

  <B><FONT COLOR="#A020F0">for</FONT></B>(a = b = f; *a != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'?'</FONT></B>)
      query = 1;
    <B><FONT COLOR="#A020F0">if</FONT></B> (query == 0 &amp;&amp; lc == <B><FONT COLOR="#BC8F8F">'/'</FONT></B> &amp;&amp; a[0] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B> &amp;&amp; a[1] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {        <I><FONT COLOR="#B22222">/* foo/./bar or ./foo  */</FONT></I>
      a += 2;
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (query == 0 &amp;&amp; lc == <B><FONT COLOR="#BC8F8F">'/'</FONT></B> &amp;&amp; a[0] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B> &amp;&amp; a[1] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B> &amp;&amp; (a[2] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B> || a[2] == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>)) {        <I><FONT COLOR="#B22222">/* foo/../bar or ../foo or .. */</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> (a[2] == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>)
        a += 2;
      <B><FONT COLOR="#A020F0">else</FONT></B>
        a += 3;
      <B><FONT COLOR="#A020F0">if</FONT></B> (rollid &gt; 1) {
        rollid--;
        b = rollback[rollid - 1];
      } <B><FONT COLOR="#A020F0">else</FONT></B> {                  <I><FONT COLOR="#B22222">/* too many ../ */</FONT></I>
        rollid = 0;
        b = f;
        <B><FONT COLOR="#A020F0">if</FONT></B> (wasAbsolute)
          b++;                  <I><FONT COLOR="#B22222">/* after the / */</FONT></I>
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      *b++ = lc = *a;
      <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {
        rollback[rollid++] = b;
        <B><FONT COLOR="#A020F0">if</FONT></B> (rollid &gt;= 127) {
          *f = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;            <I><FONT COLOR="#B22222">/* ERROR */</FONT></I>
          <B><FONT COLOR="#A020F0">break</FONT></B>;
        }
      }
      a++;
    }
  }
  *b = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">if</FONT></B> (*f == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (wasAbsolute) {
      f[0] = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;
      f[1] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      f[0] = <B><FONT COLOR="#BC8F8F">'.'</FONT></B>;
      f[1] = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;
      f[2] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    }
  }
}

<I><FONT COLOR="#B22222">// fermer liaison fichier ou socket
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">deletehttp</FONT></B>(htsblk * r) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_DEBUG_CLOSESOCK</FONT>
  DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;deletehttp: (htsblk*) 0x%p\n&quot;</FONT></B> _(<B><FONT COLOR="#228B22">void</FONT></B> *)r);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
  <I><FONT COLOR="#B22222">/* Free OpenSSL structures */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;ssl_con) {
    SSL_shutdown(r-&gt;ssl_con);
    SSL_free(r-&gt;ssl_con);
    r-&gt;ssl_con = NULL;
  }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;soc != INVALID_SOCKET) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;is_file) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;fp)
        fclose(r-&gt;fp);
      r-&gt;fp = NULL;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;soc != LOCAL_SOCKET_ID)
        deletesoc_r(r);
    }
    r-&gt;soc = INVALID_SOCKET;
  }
}

<I><FONT COLOR="#B22222">// free the addr buffer
</FONT></I><I><FONT COLOR="#B22222">// always returns 1
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">deleteaddr</FONT></B>(htsblk * r) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;adr != NULL) {
    freet(r-&gt;adr);
    r-&gt;adr = NULL;
  }
  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;headers != NULL) {
    freet(r-&gt;headers);
    r-&gt;headers = NULL;
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}

<I><FONT COLOR="#B22222">// fermer une socket
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">deletesoc</FONT></B>(T_SOC soc) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (soc != INVALID_SOCKET &amp;&amp; soc != LOCAL_SOCKET_ID) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;close %d\n&quot;</FONT></B> _(<B><FONT COLOR="#228B22">int</FONT></B>) soc);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
    <B><FONT COLOR="#A020F0">if</FONT></B> (closesocket(soc) != 0) {
      <B><FONT COLOR="#228B22">int</FONT></B> err = WSAGetLastError();

      fprintf(stderr, <B><FONT COLOR="#BC8F8F">&quot;* error closing socket %d: %s\n&quot;</FONT></B>, soc, strerror(err));
    }
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B> (close(soc) != 0) {
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> err = errno;

      fprintf(stderr, <B><FONT COLOR="#BC8F8F">&quot;* error closing socket %d: %s\n&quot;</FONT></B>, soc, strerror(err));
    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;.. done\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  }
}

<I><FONT COLOR="#B22222">/* Will also clean other things */</FONT></I>
<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">deletesoc_r</FONT></B>(htsblk * r) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;ssl_con) {
    SSL_shutdown(r-&gt;ssl_con);
    <I><FONT COLOR="#B22222">// SSL_CTX_set_quiet_shutdown(r-&gt;ssl_con-&gt;ctx, 1);
</FONT></I>    SSL_free(r-&gt;ssl_con);
    r-&gt;ssl_con = NULL;
  }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;soc != INVALID_SOCKET) {
    deletesoc(r-&gt;soc);
    r-&gt;soc = INVALID_SOCKET;
  }
}

<I><FONT COLOR="#B22222">// renvoi le nombre de secondes depuis 1970
</FONT></I>TStamp <B><FONT COLOR="#0000FF">time_local</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">return</FONT></B> ((TStamp) time(NULL));
}

<I><FONT COLOR="#B22222">// number of millisec since 1970
</FONT></I>HTSEXT_API TStamp <B><FONT COLOR="#0000FF">mtime_local</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
#<B><FONT COLOR="#5F9EA0">ifndef</FONT></B> <FONT COLOR="#B8860B">HTS_DO_NOT_USE_FTIME</FONT>
  <B><FONT COLOR="#228B22">struct</FONT></B> timeb B;

  ftime(&amp;B);
  <B><FONT COLOR="#A020F0">return</FONT></B> (TStamp) (((TStamp) B.time * (TStamp) 1000)
                   + ((TStamp) B.millitm));
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
  <I><FONT COLOR="#B22222">// not precise..
</FONT></I>  <B><FONT COLOR="#A020F0">return</FONT></B> (TStamp) (((TStamp) time_local() * (TStamp) 1000)
                   + ((TStamp) 0));
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
}

<I><FONT COLOR="#B22222">// convertit un nombre de secondes en temps (chaine)
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">sec2str</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *st, TStamp t) {
  <B><FONT COLOR="#228B22">int</FONT></B> j, h, m, s;

  j = (<B><FONT COLOR="#228B22">int</FONT></B>) (t / (3600 * 24));
  t -= ((TStamp) j) * (3600 * 24);
  h = (<B><FONT COLOR="#228B22">int</FONT></B>) (t / (3600));
  t -= ((TStamp) h) * 3600;
  m = (<B><FONT COLOR="#228B22">int</FONT></B>) (t / 60);
  t -= ((TStamp) m) * 60;
  s = (<B><FONT COLOR="#228B22">int</FONT></B>) t;

  <B><FONT COLOR="#A020F0">if</FONT></B> (j &gt; 0)
    sprintf(st, <B><FONT COLOR="#BC8F8F">&quot;%d days, %d hours %d minutes %d seconds&quot;</FONT></B>, j, h, m, s);
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (h &gt; 0)
    sprintf(st, <B><FONT COLOR="#BC8F8F">&quot;%d hours %d minutes %d seconds&quot;</FONT></B>, h, m, s);
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (m &gt; 0)
    sprintf(st, <B><FONT COLOR="#BC8F8F">&quot;%d minutes %d seconds&quot;</FONT></B>, m, s);
  <B><FONT COLOR="#A020F0">else</FONT></B>
    sprintf(st, <B><FONT COLOR="#BC8F8F">&quot;%d seconds&quot;</FONT></B>, s);
}

<I><FONT COLOR="#B22222">// idem, plus court (chaine)
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">qsec2str</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *st, TStamp t) {
  <B><FONT COLOR="#228B22">int</FONT></B> j, h, m, s;

  j = (<B><FONT COLOR="#228B22">int</FONT></B>) (t / (3600 * 24));
  t -= ((TStamp) j) * (3600 * 24);
  h = (<B><FONT COLOR="#228B22">int</FONT></B>) (t / (3600));
  t -= ((TStamp) h) * 3600;
  m = (<B><FONT COLOR="#228B22">int</FONT></B>) (t / 60);
  t -= ((TStamp) m) * 60;
  s = (<B><FONT COLOR="#228B22">int</FONT></B>) t;

  <B><FONT COLOR="#A020F0">if</FONT></B> (j &gt; 0)
    sprintf(st, <B><FONT COLOR="#BC8F8F">&quot;%dd,%02dh,%02dmin%02ds&quot;</FONT></B>, j, h, m, s);
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (h &gt; 0)
    sprintf(st, <B><FONT COLOR="#BC8F8F">&quot;%dh,%02dmin%02ds&quot;</FONT></B>, h, m, s);
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (m &gt; 0)
    sprintf(st, <B><FONT COLOR="#BC8F8F">&quot;%dmin%02ds&quot;</FONT></B>, m, s);
  <B><FONT COLOR="#A020F0">else</FONT></B>
    sprintf(st, <B><FONT COLOR="#BC8F8F">&quot;%ds&quot;</FONT></B>, s);
}

<I><FONT COLOR="#B22222">// heure actuelle, GMT, format rfc (taille buffer 256o)
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">time_gmt_rfc822</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *s) {
  time_t tt;
  <B><FONT COLOR="#228B22">struct</FONT></B> tm *A;

  tt = time(NULL);
  A = gmtime(&amp;tt);
  <B><FONT COLOR="#A020F0">if</FONT></B> (A == NULL)
    A = localtime(&amp;tt);
  time_rfc822(s, A);
}

<I><FONT COLOR="#B22222">// heure actuelle, format rfc (taille buffer 256o)
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">time_local_rfc822</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *s) {
  time_t tt;
  <B><FONT COLOR="#228B22">struct</FONT></B> tm *A;

  tt = time(NULL);
  A = localtime(&amp;tt);
  time_rfc822_local(s, A);
}

<I><FONT COLOR="#B22222">/* convertir une chaine en temps */</FONT></I>
<B><FONT COLOR="#228B22">struct</FONT></B> tm *<B><FONT COLOR="#0000FF">convert_time_rfc822</FONT></B>(<B><FONT COLOR="#228B22">struct</FONT></B> tm *result, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s) {
  <B><FONT COLOR="#228B22">char</FONT></B> months[] = <B><FONT COLOR="#BC8F8F">&quot;jan feb mar apr may jun jul aug sep oct nov dec&quot;</FONT></B>;
  <B><FONT COLOR="#228B22">char</FONT></B> str[256];
  <B><FONT COLOR="#228B22">char</FONT></B> *a;

  <I><FONT COLOR="#B22222">/* */</FONT></I>
  <B><FONT COLOR="#228B22">int</FONT></B> result_mm = -1;
  <B><FONT COLOR="#228B22">int</FONT></B> result_dd = -1;
  <B><FONT COLOR="#228B22">int</FONT></B> result_n1 = -1;
  <B><FONT COLOR="#228B22">int</FONT></B> result_n2 = -1;
  <B><FONT COLOR="#228B22">int</FONT></B> result_n3 = -1;
  <B><FONT COLOR="#228B22">int</FONT></B> result_n4 = -1;

  <I><FONT COLOR="#B22222">/* */</FONT></I>

  <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(s) &gt; 200)
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  strcpybuff(str, s);
  hts_lowcase(str);
  <I><FONT COLOR="#B22222">/* éliminer :,- */</FONT></I>
  <B><FONT COLOR="#A020F0">while</FONT></B>((a = strchr(str, <B><FONT COLOR="#BC8F8F">'-'</FONT></B>)))
    *a = <B><FONT COLOR="#BC8F8F">' '</FONT></B>;
  <B><FONT COLOR="#A020F0">while</FONT></B>((a = strchr(str, <B><FONT COLOR="#BC8F8F">':'</FONT></B>)))
    *a = <B><FONT COLOR="#BC8F8F">' '</FONT></B>;
  <B><FONT COLOR="#A020F0">while</FONT></B>((a = strchr(str, <B><FONT COLOR="#BC8F8F">','</FONT></B>)))
    *a = <B><FONT COLOR="#BC8F8F">' '</FONT></B>;
  <I><FONT COLOR="#B22222">/* tokeniser */</FONT></I>
  a = str;
  <B><FONT COLOR="#A020F0">while</FONT></B>(*a) {
    <B><FONT COLOR="#228B22">char</FONT></B> *first, *last;
    <B><FONT COLOR="#228B22">char</FONT></B> tok[256];

    <I><FONT COLOR="#B22222">/* découper mot */</FONT></I>
    <B><FONT COLOR="#A020F0">while</FONT></B>(*a == <B><FONT COLOR="#BC8F8F">' '</FONT></B>)
      a++;                      <I><FONT COLOR="#B22222">/* sauter espaces */</FONT></I>
    first = a;
    <B><FONT COLOR="#A020F0">while</FONT></B>((*a) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">' '</FONT></B>))
      a++;
    last = a;
    tok[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    <B><FONT COLOR="#A020F0">if</FONT></B> (first != last) {
      <B><FONT COLOR="#228B22">char</FONT></B> *pos;

      strncatbuff(tok, first, (<B><FONT COLOR="#228B22">int</FONT></B>) (last - first));
      <I><FONT COLOR="#B22222">/* analyser */</FONT></I>
      <B><FONT COLOR="#A020F0">if</FONT></B> ((pos = strstr(months, tok))) {        <I><FONT COLOR="#B22222">/* month always in letters */</FONT></I>
        result_mm = ((<B><FONT COLOR="#228B22">int</FONT></B>) (pos - months)) / 4;
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        <B><FONT COLOR="#228B22">int</FONT></B> number;

        <B><FONT COLOR="#A020F0">if</FONT></B> (sscanf(tok, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, &amp;number) == 1) {  <I><FONT COLOR="#B22222">/* number token */</FONT></I>
          <B><FONT COLOR="#A020F0">if</FONT></B> (result_dd &lt; 0)    <I><FONT COLOR="#B22222">/* day always first number */</FONT></I>
            result_dd = number;
          <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (result_n1 &lt; 0)
            result_n1 = number;
          <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (result_n2 &lt; 0)
            result_n2 = number;
          <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (result_n3 &lt; 0)
            result_n3 = number;
          <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (result_n4 &lt; 0)
            result_n4 = number;
        }                       <I><FONT COLOR="#B22222">/* sinon, bruit de fond(+1GMT for exampel) */</FONT></I>
      }
    }
  }
  <B><FONT COLOR="#A020F0">if</FONT></B> ((result_n1 &gt;= 0) &amp;&amp; (result_mm &gt;= 0) &amp;&amp; (result_dd &gt;= 0)
      &amp;&amp; (result_n2 &gt;= 0) &amp;&amp; (result_n3 &gt;= 0) &amp;&amp; (result_n4 &gt;= 0)) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (result_n4 &gt;= 1000) {    <I><FONT COLOR="#B22222">/* Sun Nov  6 08:49:37 1994 */</FONT></I>
      result-&gt;tm_year = result_n4 - 1900;
      result-&gt;tm_hour = result_n1;
      result-&gt;tm_min = result_n2;
      result-&gt;tm_sec = max(result_n3, 0);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {                    <I><FONT COLOR="#B22222">/* Sun, 06 Nov 1994 08:49:37 GMT or Sunday, 06-Nov-94 08:49:37 GMT */</FONT></I>
      result-&gt;tm_hour = result_n2;
      result-&gt;tm_min = result_n3;
      result-&gt;tm_sec = max(result_n4, 0);
      <B><FONT COLOR="#A020F0">if</FONT></B> (result_n1 &lt;= 50)      <I><FONT COLOR="#B22222">/* 00 means 2000 */</FONT></I>
        result-&gt;tm_year = result_n1 + 100;
      <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (result_n1 &lt; 1000)        <I><FONT COLOR="#B22222">/* 99 means 1999 */</FONT></I>
        result-&gt;tm_year = result_n1;
      <B><FONT COLOR="#A020F0">else</FONT></B>                      <I><FONT COLOR="#B22222">/* 2000 */</FONT></I>
        result-&gt;tm_year = result_n1 - 1900;
    }
    result-&gt;tm_isdst = 0;       <I><FONT COLOR="#B22222">/* assume GMT */</FONT></I>
    result-&gt;tm_yday = -1;       <I><FONT COLOR="#B22222">/* don't know */</FONT></I>
    result-&gt;tm_wday = -1;       <I><FONT COLOR="#B22222">/* don't know */</FONT></I>
    result-&gt;tm_mon = result_mm;
    result-&gt;tm_mday = result_dd;
    <B><FONT COLOR="#A020F0">return</FONT></B> result;
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
}

<B><FONT COLOR="#228B22">static</FONT></B> time_t <B><FONT COLOR="#0000FF">getGMT</FONT></B>(<B><FONT COLOR="#228B22">struct</FONT></B> tm *tm) {   <I><FONT COLOR="#B22222">/* hey, time_t is local! */</FONT></I>
  time_t t = mktime(tm);

  <B><FONT COLOR="#A020F0">if</FONT></B> (t != (time_t) - 1 &amp;&amp; t != (time_t) 0) {
    <I><FONT COLOR="#B22222">/* BSD does not have static &quot;timezone&quot; declared */</FONT></I>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> (<B><FONT COLOR="#5F9EA0">defined</FONT></B>(<FONT COLOR="#B8860B">BSD</FONT>) || <B><FONT COLOR="#5F9EA0">defined</FONT></B>(<FONT COLOR="#B8860B">__FreeBSD__</FONT>) || <B><FONT COLOR="#5F9EA0">defined</FONT></B>(<FONT COLOR="#B8860B">__OpenBSD__</FONT>) || <B><FONT COLOR="#5F9EA0">defined</FONT></B>(<FONT COLOR="#B8860B">__NetBSD__</FONT>) || <B><FONT COLOR="#5F9EA0">defined</FONT></B>(<FONT COLOR="#B8860B">__FreeBSD_kernel__</FONT>))
    time_t now = time(NULL);
    time_t timezone = -localtime(&amp;now)-&gt;tm_gmtoff;
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> (time_t) (t - timezone);
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> (time_t) - 1;
}

<I><FONT COLOR="#B22222">/* sets file time. -1 if error */</FONT></I>
<I><FONT COLOR="#B22222">/* Note: utf-8 */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">set_filetime</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *file, <B><FONT COLOR="#228B22">struct</FONT></B> tm *tm_time) {
  time_t t = getGMT(tm_time);

  <B><FONT COLOR="#A020F0">if</FONT></B> (t != (time_t) - 1) {
    STRUCT_UTIMBUF tim;

    memset(&amp;tim, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(tim));
    tim.actime = tim.modtime = t;
    <B><FONT COLOR="#A020F0">return</FONT></B> UTIME(file, &amp;tim);
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}

<I><FONT COLOR="#B22222">/* sets file time from RFC822 date+time, -1 if error*/</FONT></I>
<I><FONT COLOR="#B22222">/* Note: utf-8 */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">set_filetime_rfc822</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *file, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *date) {
  <B><FONT COLOR="#228B22">struct</FONT></B> tm buffer;
  <B><FONT COLOR="#228B22">struct</FONT></B> tm *tm_s = convert_time_rfc822(&amp;buffer, date);

  <B><FONT COLOR="#A020F0">if</FONT></B> (tm_s) {
    <B><FONT COLOR="#A020F0">return</FONT></B> set_filetime(file, tm_s);
  } <B><FONT COLOR="#A020F0">else</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}

<I><FONT COLOR="#B22222">/* Note: utf-8 */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">get_filetime_rfc822</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *file, <B><FONT COLOR="#228B22">char</FONT></B> *date) {
  STRUCT_STAT buf;

  date[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">if</FONT></B> (STAT(file, &amp;buf) == 0) {
    <B><FONT COLOR="#228B22">struct</FONT></B> tm *A;
    time_t tt = buf.st_mtime;

    A = gmtime(&amp;tt);
    <B><FONT COLOR="#A020F0">if</FONT></B> (A == NULL)
      A = localtime(&amp;tt);
    <B><FONT COLOR="#A020F0">if</FONT></B> (A != NULL) {
      time_rfc822(date, A);
      <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    }
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">// heure au format rfc (taille buffer 256o)
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">time_rfc822</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">struct</FONT></B> tm *A) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (A == NULL) {
    <B><FONT COLOR="#228B22">int</FONT></B> localtime_returned_null = 0;

    assertf(localtime_returned_null);
  }
  strftime(s, 256, <B><FONT COLOR="#BC8F8F">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</FONT></B>, A);
}

<I><FONT COLOR="#B22222">// heure locale au format rfc (taille buffer 256o)
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">time_rfc822_local</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">struct</FONT></B> tm *A) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (A == NULL) {
    <B><FONT COLOR="#228B22">int</FONT></B> localtime_returned_null = 0;

    assertf(localtime_returned_null);
  }
  strftime(s, 256, <B><FONT COLOR="#BC8F8F">&quot;%a, %d %b %Y %H:%M:%S&quot;</FONT></B>, A);
}

<I><FONT COLOR="#B22222">// conversion en b,Kb,Mb
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">int2bytes</FONT></B>(strc_int2bytes2 * strc, LLint n) {
  <B><FONT COLOR="#228B22">char</FONT></B> **a = int2bytes2(strc, n);

  strcpybuff(strc-&gt;catbuff, a[0]);
  strcatbuff(strc-&gt;catbuff, a[1]);
  <B><FONT COLOR="#A020F0">return</FONT></B> strc-&gt;catbuff;
}

<I><FONT COLOR="#B22222">// conversion en b/s,Kb/s,Mb/s
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">int2bytessec</FONT></B>(strc_int2bytes2 * strc, <B><FONT COLOR="#228B22">long</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> n) {
  <B><FONT COLOR="#228B22">char</FONT></B> buff[256];
  <B><FONT COLOR="#228B22">char</FONT></B> **a = int2bytes2(strc, n);

  strcpybuff(buff, a[0]);
  strcatbuff(buff, a[1]);
  <B><FONT COLOR="#A020F0">return</FONT></B> concat(strc-&gt;catbuff, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(strc-&gt;catbuff), buff, <B><FONT COLOR="#BC8F8F">&quot;/s&quot;</FONT></B>);
}
HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">int2char</FONT></B>(strc_int2bytes2 * strc, <B><FONT COLOR="#228B22">int</FONT></B> n) {
  sprintf(strc-&gt;buff2, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, n);
  <B><FONT COLOR="#A020F0">return</FONT></B> strc-&gt;buff2;
}

<I><FONT COLOR="#B22222">// conversion en b,Kb,Mb, nombre et type séparés
</FONT></I><I><FONT COLOR="#B22222">// limite: 2.10^9.10^6B
</FONT></I>
<I><FONT COLOR="#B22222">/* See http://physics.nist.gov/cuu/Units/binary.html */</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">ToLLint</FONT></B>(a) ((LLint)(a))
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">ToLLintKiB</FONT> (ToLLint(1024))
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">ToLLintMiB</FONT> (ToLLintKiB*ToLLintKiB)
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">HTS_LONGLONG</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">ToLLintGiB</FONT> (ToLLintKiB*ToLLintKiB*ToLLintKiB)
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">ToLLintTiB</FONT> (ToLLintKiB*ToLLintKiB*ToLLintKiB*ToLLintKiB)
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">ToLLintPiB</FONT> (ToLLintKiB*ToLLintKiB*ToLLintKiB*ToLLintKiB*ToLLintKiB)
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> **<B><FONT COLOR="#0000FF">int2bytes2</FONT></B>(strc_int2bytes2 * strc, LLint n) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (n &lt; ToLLintKiB) {
    sprintf(strc-&gt;buff1, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, (<B><FONT COLOR="#228B22">int</FONT></B>) (LLint) n);
    strcpybuff(strc-&gt;buff2, <B><FONT COLOR="#BC8F8F">&quot;B&quot;</FONT></B>);
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (n &lt; ToLLintMiB) {
    sprintf(strc-&gt;buff1, <B><FONT COLOR="#BC8F8F">&quot;%d,%02d&quot;</FONT></B>, (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (n / ToLLintKiB)),
            (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) ((n % ToLLintKiB) * 100) / ToLLintKiB));
    strcpybuff(strc-&gt;buff2, <B><FONT COLOR="#BC8F8F">&quot;KiB&quot;</FONT></B>);
  }
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">HTS_LONGLONG</FONT>
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (n &lt; ToLLintGiB) {
    sprintf(strc-&gt;buff1, <B><FONT COLOR="#BC8F8F">&quot;%d,%02d&quot;</FONT></B>, (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (n / (ToLLintMiB))),
            (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (((n % (ToLLintMiB)) * 100) / (ToLLintMiB))));
    strcpybuff(strc-&gt;buff2, <B><FONT COLOR="#BC8F8F">&quot;MiB&quot;</FONT></B>);
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (n &lt; ToLLintTiB) {
    sprintf(strc-&gt;buff1, <B><FONT COLOR="#BC8F8F">&quot;%d,%02d&quot;</FONT></B>, (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (n / (ToLLintGiB))),
            (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (((n % (ToLLintGiB)) * 100) / (ToLLintGiB))));
    strcpybuff(strc-&gt;buff2, <B><FONT COLOR="#BC8F8F">&quot;GiB&quot;</FONT></B>);
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (n &lt; ToLLintPiB) {
    sprintf(strc-&gt;buff1, <B><FONT COLOR="#BC8F8F">&quot;%d,%02d&quot;</FONT></B>, (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (n / (ToLLintTiB))),
            (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (((n % (ToLLintTiB)) * 100) / (ToLLintTiB))));
    strcpybuff(strc-&gt;buff2, <B><FONT COLOR="#BC8F8F">&quot;TiB&quot;</FONT></B>);
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    sprintf(strc-&gt;buff1, <B><FONT COLOR="#BC8F8F">&quot;%d,%02d&quot;</FONT></B>, (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (n / (ToLLintPiB))),
            (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (((n % (ToLLintPiB)) * 100) / (ToLLintPiB))));
    strcpybuff(strc-&gt;buff2, <B><FONT COLOR="#BC8F8F">&quot;PiB&quot;</FONT></B>);
  }
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
  <B><FONT COLOR="#A020F0">else</FONT></B> {
    sprintf(strc-&gt;buff1, <B><FONT COLOR="#BC8F8F">&quot;%d,%02d&quot;</FONT></B>, (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (n / (ToLLintMiB))),
            (<B><FONT COLOR="#228B22">int</FONT></B>) ((LLint) (((n % (ToLLintMiB)) * 100) / (ToLLintMiB))));
    strcpybuff(strc-&gt;buff2, <B><FONT COLOR="#BC8F8F">&quot;MiB&quot;</FONT></B>);
  }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  strc-&gt;buffadr[0] = strc-&gt;buff1;
  strc-&gt;buffadr[1] = strc-&gt;buff2;
  <B><FONT COLOR="#A020F0">return</FONT></B> strc-&gt;buffadr;
}

#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
<I><FONT COLOR="#B22222">// ignore sigpipe?
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">sig_ignore_flag</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> setflag) {      <I><FONT COLOR="#B22222">// flag ignore
</FONT></I>  <B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> flag = 0;          <I><FONT COLOR="#B22222">/* YES, this one is true static */</FONT></I>

  <B><FONT COLOR="#A020F0">if</FONT></B> (setflag &gt;= 0)
    flag = setflag;
  <B><FONT COLOR="#A020F0">return</FONT></B> flag;
}
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

<I><FONT COLOR="#B22222">// envoi de texte (en têtes généralement) sur la socket soc
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">sendc</FONT></B>(htsblk * r, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s) {
  <B><FONT COLOR="#228B22">int</FONT></B> n, ssz = (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(s);

#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
  sig_ignore_flag(1);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HDEBUG</FONT>
  write(0, s, ssz);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;ssl) {
    n = SSL_write(r-&gt;ssl_con, s, ssz);
  } <B><FONT COLOR="#A020F0">else</FONT></B>
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    n = send(r-&gt;soc, s, ssz, 0);

#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
  sig_ignore_flag(0);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  <B><FONT COLOR="#A020F0">return</FONT></B> (n == ssz) ? n : -1;
}

<I><FONT COLOR="#B22222">// Remplace read
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">finput</FONT></B>(T_SOC fd, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">int</FONT></B> max) {
  <B><FONT COLOR="#228B22">char</FONT></B> c;
  <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

  <B><FONT COLOR="#A020F0">do</FONT></B> {
    <I><FONT COLOR="#B22222">//c=fgetc(fp);
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (read((<B><FONT COLOR="#228B22">int</FONT></B>) fd, &amp;c, 1) &lt;= 0) {
      c = 0;
    }
    <B><FONT COLOR="#A020F0">if</FONT></B> (c != 0) {
      <B><FONT COLOR="#A020F0">switch</FONT></B> (c) {
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">10</FONT></B>:
        c = 0;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">13</FONT></B>:
        <B><FONT COLOR="#A020F0">break</FONT></B>;                  <I><FONT COLOR="#B22222">// sauter ces caractères
</FONT></I>      <B><FONT COLOR="#5F9EA0">default</FONT></B>:
        s[j++] = c;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      }
    }
  } <B><FONT COLOR="#A020F0">while</FONT></B>((c != 0) &amp;&amp; (j &lt; max - 1));
  s[j] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> j;
}

<I><FONT COLOR="#B22222">// Like linput, but in memory (optimized)
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">binput</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *buff, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">int</FONT></B> max) {
  <B><FONT COLOR="#228B22">int</FONT></B> count = 0;
  <B><FONT COLOR="#228B22">int</FONT></B> destCount = 0;

  <I><FONT COLOR="#B22222">// Note: \0 will return 1
</FONT></I>  <B><FONT COLOR="#A020F0">while</FONT></B>(destCount &lt; max &amp;&amp; buff != NULL &amp;&amp; buff[count] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>
        &amp;&amp; buff[count] != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (buff[count] != <B><FONT COLOR="#BC8F8F">'\r'</FONT></B>) {
      s[destCount++] = buff[count];
    }
    count++;
  }
  s[destCount] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

  <I><FONT COLOR="#B22222">// then return the supplemental jump offset
</FONT></I>  <B><FONT COLOR="#A020F0">return</FONT></B> count + 1;
}

<I><FONT COLOR="#B22222">// Lecture d'une ligne (peut être unicode à priori)
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">linput</FONT></B>(FILE * fp, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">int</FONT></B> max) {
  <B><FONT COLOR="#228B22">int</FONT></B> c;
  <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

  <B><FONT COLOR="#A020F0">do</FONT></B> {
    c = fgetc(fp);
    <B><FONT COLOR="#A020F0">if</FONT></B> (c != EOF) {
      <B><FONT COLOR="#A020F0">switch</FONT></B> (c) {
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">13</FONT></B>:
        <B><FONT COLOR="#A020F0">break</FONT></B>;                  <I><FONT COLOR="#B22222">// sauter CR
</FONT></I>      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">10</FONT></B>:
        c = -1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">9</FONT></B>:
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">12</FONT></B>:
        <B><FONT COLOR="#A020F0">break</FONT></B>;                  <I><FONT COLOR="#B22222">// sauter ces caractères
</FONT></I>      <B><FONT COLOR="#5F9EA0">default</FONT></B>:
        s[j++] = (<B><FONT COLOR="#228B22">char</FONT></B>) c;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      }
    }
  } <B><FONT COLOR="#A020F0">while</FONT></B>((c != -1) &amp;&amp; (c != EOF) &amp;&amp; (j &lt; (max - 1)));
  s[j] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> j;
}
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">linputsoc</FONT></B>(T_SOC soc, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">int</FONT></B> max) {
  <B><FONT COLOR="#228B22">int</FONT></B> c;
  <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

  <B><FONT COLOR="#A020F0">do</FONT></B> {
    <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> ch;

    <B><FONT COLOR="#A020F0">if</FONT></B> (recv(soc, &amp;ch, 1, 0) == 1) {
      c = ch;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      c = EOF;
    }
    <B><FONT COLOR="#A020F0">if</FONT></B> (c != EOF) {
      <B><FONT COLOR="#A020F0">switch</FONT></B> (c) {
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">13</FONT></B>:
        <B><FONT COLOR="#A020F0">break</FONT></B>;                  <I><FONT COLOR="#B22222">// sauter CR
</FONT></I>      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">10</FONT></B>:
        c = -1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">9</FONT></B>:
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">12</FONT></B>:
        <B><FONT COLOR="#A020F0">break</FONT></B>;                  <I><FONT COLOR="#B22222">// sauter ces caractères
</FONT></I>      <B><FONT COLOR="#5F9EA0">default</FONT></B>:
        s[j++] = (<B><FONT COLOR="#228B22">char</FONT></B>) c;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      }
    }
  } <B><FONT COLOR="#A020F0">while</FONT></B>((c != -1) &amp;&amp; (c != EOF) &amp;&amp; (j &lt; (max - 1)));
  s[j] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> j;
}
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">linputsoc_t</FONT></B>(T_SOC soc, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">int</FONT></B> max, <B><FONT COLOR="#228B22">int</FONT></B> timeout) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (check_readinput_t(soc, timeout)) {
    <B><FONT COLOR="#A020F0">return</FONT></B> linputsoc(soc, s, max);
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">linput_trim</FONT></B>(FILE * fp, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">int</FONT></B> max) {
  <B><FONT COLOR="#228B22">int</FONT></B> rlen = 0;
  <B><FONT COLOR="#228B22">char</FONT></B> *ls = (<B><FONT COLOR="#228B22">char</FONT></B> *) malloct(max + 1);

  s[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">if</FONT></B> (ls) {
    <B><FONT COLOR="#228B22">char</FONT></B> *a;

    <I><FONT COLOR="#B22222">// lire ligne
</FONT></I>    rlen = linput(fp, ls, max);
    <B><FONT COLOR="#A020F0">if</FONT></B> (rlen) {
      <I><FONT COLOR="#B22222">// sauter espaces et tabs en fin
</FONT></I>      <B><FONT COLOR="#A020F0">while</FONT></B>((rlen &gt; 0)
            &amp;&amp; ((ls[max(rlen - 1, 0)] == <B><FONT COLOR="#BC8F8F">' '</FONT></B>)
                || (ls[max(rlen - 1, 0)] == <B><FONT COLOR="#BC8F8F">'\t'</FONT></B>)))
        ls[--rlen] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      <I><FONT COLOR="#B22222">// sauter espaces en début
</FONT></I>      a = ls;
      <B><FONT COLOR="#A020F0">while</FONT></B>((rlen &gt; 0) &amp;&amp; ((*a == <B><FONT COLOR="#BC8F8F">' '</FONT></B>) || (*a == <B><FONT COLOR="#BC8F8F">'\t'</FONT></B>))) {
        a++;
        rlen--;
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (rlen &gt; 0) {
        memcpy(s, a, rlen);     <I><FONT COLOR="#B22222">// can copy \0 chars
</FONT></I>        s[rlen] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      }
    }
    <I><FONT COLOR="#B22222">//
</FONT></I>    freet(ls);
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> rlen;
}
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">linput_cpp</FONT></B>(FILE * fp, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">int</FONT></B> max) {
  <B><FONT COLOR="#228B22">int</FONT></B> rlen = 0;

  s[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">do</FONT></B> {
    <B><FONT COLOR="#228B22">int</FONT></B> ret;

    <B><FONT COLOR="#A020F0">if</FONT></B> (rlen &gt; 0)
      <B><FONT COLOR="#A020F0">if</FONT></B> (s[rlen - 1] == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>)
        s[--rlen] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;       <I><FONT COLOR="#B22222">// couper \ final
</FONT></I>    <I><FONT COLOR="#B22222">// lire ligne
</FONT></I>    ret = linput_trim(fp, s + rlen, max - rlen);
    <B><FONT COLOR="#A020F0">if</FONT></B> (ret &gt; 0)
      rlen += ret;
  } <B><FONT COLOR="#A020F0">while</FONT></B>((s[max(rlen - 1, 0)] == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>) &amp;&amp; (rlen &lt; max));
  <B><FONT COLOR="#A020F0">return</FONT></B> rlen;
}

<I><FONT COLOR="#B22222">// idem avec les car spéciaux
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">rawlinput</FONT></B>(FILE * fp, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">int</FONT></B> max) {
  <B><FONT COLOR="#228B22">int</FONT></B> c;
  <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

  <B><FONT COLOR="#A020F0">do</FONT></B> {
    c = fgetc(fp);
    <B><FONT COLOR="#A020F0">if</FONT></B> (c != EOF) {
      <B><FONT COLOR="#A020F0">switch</FONT></B> (c) {
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">13</FONT></B>:
        <B><FONT COLOR="#A020F0">break</FONT></B>;                  <I><FONT COLOR="#B22222">// sauter CR
</FONT></I>      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">10</FONT></B>:
        c = -1;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#5F9EA0">default</FONT></B>:
        s[j++] = (<B><FONT COLOR="#228B22">char</FONT></B>) c;
        <B><FONT COLOR="#A020F0">break</FONT></B>;
      }
    }
  } <B><FONT COLOR="#A020F0">while</FONT></B>((c != -1) &amp;&amp; (c != EOF) &amp;&amp; (j &lt; (max - 1)));
  s[j++] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
}

<I><FONT COLOR="#B22222">//cherche chaine, case insensitive
</FONT></I><B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">strstrcase</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *o) {
  <B><FONT COLOR="#A020F0">while</FONT></B>(*s &amp;&amp; strfield(s, o) == 0)
    s++;
  <B><FONT COLOR="#A020F0">if</FONT></B> (*s == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>)
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  <B><FONT COLOR="#A020F0">return</FONT></B> s;
}

<I><FONT COLOR="#B22222">// Unicode detector
</FONT></I><I><FONT COLOR="#B22222">// See http://www.unicode.org/unicode/reports/tr28/
</FONT></I><I><FONT COLOR="#B22222">// (sect Table 3.1B. Legal UTF-8 Byte Sequences)
</FONT></I><B><FONT COLOR="#228B22">typedef</FONT></B> <B><FONT COLOR="#228B22">struct</FONT></B> {
  <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> pos;
  <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> data[4];
} t_auto_seq;

<I><FONT COLOR="#B22222">// char between a and b
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CHAR_BETWEEN</FONT></B>(c, a, b)       ( (c) &gt;= 0x##a ) &amp;&amp; ( (c) &lt;= 0x##b )
<I><FONT COLOR="#B22222">// sequence start
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">SEQBEG</FONT>                      ( inseq == 0 )
<I><FONT COLOR="#B22222">// in this block
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">BLK</FONT></B>(n,a, b)                 ( (seq.pos &gt;= n) &amp;&amp; ((err = CHAR_BETWEEN(seq.data[n], a, b))) )
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">ELT</FONT></B>(n,a)                    BLK(n,a,a)
<I><FONT COLOR="#B22222">// end
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">SEQEND</FONT>                      ((ok = 1))
<I><FONT COLOR="#B22222">// sequence started, character will fail if error
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">IN_SEQ</FONT>                      ( (inseq = 1) )
<I><FONT COLOR="#B22222">// decoding error
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">BAD_SEQ</FONT>                     ( (ok == 0) &amp;&amp; (inseq != 0) &amp;&amp; (!err) )
<I><FONT COLOR="#B22222">// no sequence started
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <FONT COLOR="#B8860B">NO_SEQ</FONT>                      ( inseq == 0 )

<I><FONT COLOR="#B22222">// is this block an UTF unicode textfile?
</FONT></I><I><FONT COLOR="#B22222">// 0 : no
</FONT></I><I><FONT COLOR="#B22222">// 1 : yes
</FONT></I><I><FONT COLOR="#B22222">// -1: don't know
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">is_unicode_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *buffer_, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *buffer = (<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *) buffer_;
  t_auto_seq seq;
  size_t i;
  <B><FONT COLOR="#228B22">int</FONT></B> is_utf = -1;

  RUNTIME_TIME_CHECK_SIZE(size);

  seq.pos = 0;
  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; size; i++) {
    <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> ok = 0;
    <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> inseq = 0;
    <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> err = 0;

    seq.data[seq.pos] = buffer[i];
     <I><FONT COLOR="#B22222">/**/</FONT></I> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; BLK(0, 00, 7F) &amp;&amp; IN_SEQ &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; BLK(0, C2, DF) &amp;&amp; IN_SEQ &amp;&amp; BLK(1, 80, BF) &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; ELT(0, E0) &amp;&amp; IN_SEQ &amp;&amp; BLK(1, A0, BF)
               &amp;&amp; BLK(2, 80, BF) &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; BLK(0, E1, EC) &amp;&amp; IN_SEQ &amp;&amp; BLK(1, 80, BF)
               &amp;&amp; BLK(2, 80, BF) &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; ELT(0, ED) &amp;&amp; IN_SEQ &amp;&amp; BLK(1, 80, 9F)
               &amp;&amp; BLK(2, 80, BF) &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; BLK(0, EE, EF) &amp;&amp; IN_SEQ &amp;&amp; BLK(1, 80, BF)
               &amp;&amp; BLK(2, 80, BF) &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; ELT(0, F0) &amp;&amp; IN_SEQ &amp;&amp; BLK(1, 90, BF)
               &amp;&amp; BLK(2, 80, BF) &amp;&amp; BLK(3, 80, BF) &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; BLK(0, F1, F3) &amp;&amp; IN_SEQ &amp;&amp; BLK(1, 80, BF)
               &amp;&amp; BLK(2, 80, BF) &amp;&amp; BLK(3, 80, BF) &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (SEQBEG &amp;&amp; ELT(0, F4) &amp;&amp; IN_SEQ &amp;&amp; BLK(1, 80, 8F)
               &amp;&amp; BLK(2, 80, BF) &amp;&amp; BLK(3, 80, BF) &amp;&amp; SEQEND) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (NO_SEQ) {        <I><FONT COLOR="#B22222">// bad, unknown
</FONT></I>      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
    }
    <I><FONT COLOR="#B22222">/* */</FONT></I>

    <I><FONT COLOR="#B22222">/* Error */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (BAD_SEQ) {
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
    }

    <I><FONT COLOR="#B22222">/* unicode character */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (seq.pos &gt; 0)
      is_utf = 1;

    <I><FONT COLOR="#B22222">/* Next */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (ok)
      seq.pos = 0;
    <B><FONT COLOR="#A020F0">else</FONT></B>
      seq.pos++;

    <I><FONT COLOR="#B22222">/* Internal error */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (seq.pos &gt;= 4)
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;

  }

  <B><FONT COLOR="#A020F0">return</FONT></B> is_utf;
}

<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">map_characters</FONT></B>(<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *buffer, <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> size, <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> *map) {
  <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> i;

  memset(map, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B>) * 256);
  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; size; i++) {
    map[buffer[i]]++;
  }
}

<I><FONT COLOR="#B22222">// le fichier est-il un fichier html?
</FONT></I><I><FONT COLOR="#B22222">//  0 : non
</FONT></I><I><FONT COLOR="#B22222">//  1 : oui
</FONT></I><I><FONT COLOR="#B22222">// -1 : on sait pas
</FONT></I><I><FONT COLOR="#B22222">// -2 : on sait pas, pas d'extension
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ishtml</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil) {
  <I><FONT COLOR="#B22222">/* User-defined MIME types (overrides ishtml()) */</FONT></I>
  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK fil_noquery[HTS_URLMAXSIZE * 2];
  <B><FONT COLOR="#228B22">char</FONT></B> mime[256];
  <B><FONT COLOR="#228B22">char</FONT></B> *a;

  strcpybuff(fil_noquery, fil);
  <B><FONT COLOR="#A020F0">if</FONT></B> ((a = strchr(fil_noquery, <B><FONT COLOR="#BC8F8F">'?'</FONT></B>)) != NULL) {
    *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  }
  <B><FONT COLOR="#A020F0">if</FONT></B> (get_userhttptype(opt, mime, fil_noquery)) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (is_html_mime_type(mime)) {
      <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
    }
  }

  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(fil_noquery)) {
    <B><FONT COLOR="#A020F0">return</FONT></B> -2;
  }

  <I><FONT COLOR="#B22222">/* Search for known ext */</FONT></I>
  <B><FONT COLOR="#A020F0">for</FONT></B>(a = fil_noquery + strlen(fil_noquery) - 1;
      *a != <B><FONT COLOR="#BC8F8F">'.'</FONT></B> &amp;&amp; *a != <B><FONT COLOR="#BC8F8F">'/'</FONT></B> &amp;&amp; a &gt; fil_noquery; a--) ;
  <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'.'</FONT></B>) {              <I><FONT COLOR="#B22222">// a une extension
</FONT></I>    <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK fil_noquery[HTS_URLMAXSIZE * 2];
    <B><FONT COLOR="#228B22">char</FONT></B> *b;
    <B><FONT COLOR="#228B22">int</FONT></B> ret;
    <B><FONT COLOR="#228B22">char</FONT></B> *dotted = a;

    fil_noquery[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    a++;                        <I><FONT COLOR="#B22222">// pointer sur extension
</FONT></I>    strncatbuff(fil_noquery, a, HTS_URLMAXSIZE);
    b = strchr(fil_noquery, <B><FONT COLOR="#BC8F8F">'?'</FONT></B>);
    <B><FONT COLOR="#A020F0">if</FONT></B> (b)
      *b = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    ret = ishtml_ext(fil_noquery);      <I><FONT COLOR="#B22222">// retour
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (ret == -1) {
      <B><FONT COLOR="#A020F0">switch</FONT></B> (is_knowntype(opt, dotted)) {
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">1</FONT></B>:
        ret = 0;                <I><FONT COLOR="#B22222">// connu, non html
</FONT></I>        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">2</FONT></B>:
        ret = 1;                <I><FONT COLOR="#B22222">// connu, html
</FONT></I>        <B><FONT COLOR="#A020F0">break</FONT></B>;
      <B><FONT COLOR="#5F9EA0">default</FONT></B>:
        ret = -1;               <I><FONT COLOR="#B22222">// inconnu..
</FONT></I>        <B><FONT COLOR="#A020F0">break</FONT></B>;
      }
    }
    <B><FONT COLOR="#A020F0">return</FONT></B> ret;
  } <B><FONT COLOR="#A020F0">else</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> -2;                  <I><FONT COLOR="#B22222">// indéterminé, par exemple /truc
</FONT></I>}

<I><FONT COLOR="#B22222">// idem, mais pour uniquement l'extension
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ishtml_ext</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a) {
  <B><FONT COLOR="#228B22">int</FONT></B> html = 0;

  <I><FONT COLOR="#B22222">//
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;html&quot;</FONT></B>))
    html = 1;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;htm&quot;</FONT></B>))
    html = 1;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;shtml&quot;</FONT></B>))
    html = 1;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;phtml&quot;</FONT></B>))
    html = 1;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;htmlx&quot;</FONT></B>))
    html = 1;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;shtm&quot;</FONT></B>))
    html = 1;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;phtm&quot;</FONT></B>))
    html = 1;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(a, <B><FONT COLOR="#BC8F8F">&quot;htmx&quot;</FONT></B>))
    html = 1;
  <I><FONT COLOR="#B22222">//
</FONT></I>  <I><FONT COLOR="#B22222">// insuccès..
</FONT></I>  <B><FONT COLOR="#A020F0">else</FONT></B> {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> 1
    html = -1;                  <I><FONT COLOR="#B22222">// inconnu..
</FONT></I>#<B><FONT COLOR="#5F9EA0">else</FONT></B>
    <I><FONT COLOR="#B22222">// XXXXXX not suitable (ext)
</FONT></I>    <B><FONT COLOR="#A020F0">switch</FONT></B> (is_knownext(a)) {
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">1</FONT></B>:
      html = 0;                 <I><FONT COLOR="#B22222">// connu, non html
</FONT></I>      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">2</FONT></B>:
      html = 1;                 <I><FONT COLOR="#B22222">// connu, html
</FONT></I>      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#5F9EA0">default</FONT></B>:
      html = -1;                <I><FONT COLOR="#B22222">// inconnu..
</FONT></I>      <B><FONT COLOR="#A020F0">break</FONT></B>;
    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> html;
}

<I><FONT COLOR="#B22222">// error (404,500..)
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ishttperror</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> err) {
  <B><FONT COLOR="#A020F0">switch</FONT></B> (err / 100) {
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">4</FONT></B>:
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">5</FONT></B>:
    <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* Declare a non-const version of FUN */</FONT></I>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">DECLARE_NON_CONST_VERSION</FONT></B>(FUN) \
char *FUN(char *source) { \
  const char *const ret = FUN ##_const(source); \
  return ret != NULL ? source + ( ret - source ) : NULL; \
}

<I><FONT COLOR="#B22222">// retourne le pointeur ou le pointeur + offset si il existe dans la chaine un @ signifiant 
</FONT></I><I><FONT COLOR="#B22222">// une identification
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">jump_identification_const</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *source) {
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a, *trytofind;

  <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(source, <B><FONT COLOR="#BC8F8F">&quot;file://&quot;</FONT></B>) == 0)
    <B><FONT COLOR="#A020F0">return</FONT></B> source;
  <I><FONT COLOR="#B22222">// rechercher dernier @ (car parfois email transmise dans adresse!)
</FONT></I>  <I><FONT COLOR="#B22222">// mais sauter ftp:// éventuel
</FONT></I>  a = jump_protocol_const(source);
  trytofind = strrchr_limit(a, <B><FONT COLOR="#BC8F8F">'@'</FONT></B>, strchr(a, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>));
  <B><FONT COLOR="#A020F0">return</FONT></B> trytofind != NULL ? trytofind : a;
}

HTSEXT_API <B><FONT COLOR="#0000FF">DECLARE_NON_CONST_VERSION</FONT></B>(jump_identification)

HTSEXT_API <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">jump_normalized_const</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *source) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(source, <B><FONT COLOR="#BC8F8F">&quot;file://&quot;</FONT></B>) == 0)
    <B><FONT COLOR="#A020F0">return</FONT></B> source;
  source = jump_identification_const(source);
  <B><FONT COLOR="#A020F0">if</FONT></B> (strfield(source, <B><FONT COLOR="#BC8F8F">&quot;www&quot;</FONT></B>) &amp;&amp; source[3] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (source[3] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B>) {     <I><FONT COLOR="#B22222">// www.foo.com -&gt; foo.com
</FONT></I>      source += 4;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {                    <I><FONT COLOR="#B22222">// www-4.foo.com -&gt; foo.com
</FONT></I>      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = source + 3;

      <B><FONT COLOR="#A020F0">while</FONT></B>(*a &amp;&amp; (isdigit(*a) || *a == <B><FONT COLOR="#BC8F8F">'-'</FONT></B>))
        a++;
      <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'.'</FONT></B>) {
        source = a + 1;
      }
    }
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> source;
}

HTSEXT_API <B><FONT COLOR="#0000FF">DECLARE_NON_CONST_VERSION</FONT></B>(jump_normalized)

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">sortNormFnc</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> *a_, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> *b_) {
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B>*<B><FONT COLOR="#228B22">const</FONT></B> a = (<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B>*) a_;
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B>*<B><FONT COLOR="#228B22">const</FONT></B> b = (<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B>*) b_;

  <B><FONT COLOR="#A020F0">return</FONT></B> strcmp(*a + 1, *b + 1);
}

HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">fil_normalized</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *source, <B><FONT COLOR="#228B22">char</FONT></B> *dest) {
  <B><FONT COLOR="#228B22">char</FONT></B> lastc = 0;
  <B><FONT COLOR="#228B22">int</FONT></B> gotquery = 0;
  <B><FONT COLOR="#228B22">int</FONT></B> ampargs = 0;
  size_t i, j;
  <B><FONT COLOR="#228B22">char</FONT></B> *query = NULL;

  <B><FONT COLOR="#A020F0">for</FONT></B>(i = j = 0; source[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; i++) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (!gotquery &amp;&amp; source[i] == <B><FONT COLOR="#BC8F8F">'?'</FONT></B>)
      gotquery = ampargs = 1;
    <B><FONT COLOR="#A020F0">if</FONT></B> ((!gotquery &amp;&amp; lastc == <B><FONT COLOR="#BC8F8F">'/'</FONT></B> &amp;&amp; source[i] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) <I><FONT COLOR="#B22222">// foo//bar -&gt; foo/bar
</FONT></I>      ) {
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">if</FONT></B> (gotquery &amp;&amp; source[i] == <B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>) {
        ampargs++;
      }
      dest[j++] = source[i];
    }
    lastc = source[i];
  }
  dest[j++] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;

  <I><FONT COLOR="#B22222">/* Sort arguments (&amp;foo=1&amp;bar=2 == &amp;bar=2&amp;foo=1) */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (ampargs &gt; 1) {
    <B><FONT COLOR="#228B22">char</FONT></B> **amps = malloct(ampargs * <B><FONT COLOR="#A020F0">sizeof</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *));
    <B><FONT COLOR="#228B22">char</FONT></B> *copyBuff = NULL;
    size_t qLen = 0;

    assertf(amps != NULL);
    gotquery = 0;
    <B><FONT COLOR="#A020F0">for</FONT></B>(i = j = 0; dest[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; i++) {
      <B><FONT COLOR="#A020F0">if</FONT></B> ((gotquery &amp;&amp; dest[i] == <B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>) || (!gotquery &amp;&amp; dest[i] == <B><FONT COLOR="#BC8F8F">'?'</FONT></B>)) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (!gotquery) {
          gotquery = 1;
          query = &amp;dest[i];
          qLen = strlen(query);
        }
        assertf(j &lt; ampargs);
        amps[j++] = &amp;dest[i];
        dest[i] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      }
    }
    assertf(gotquery);
    assertf(j == ampargs);

    <I><FONT COLOR="#B22222">/* Sort 'em all */</FONT></I>
    qsort(amps, ampargs, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *), sortNormFnc);

    <I><FONT COLOR="#B22222">/* Replace query by sorted query */</FONT></I>
    copyBuff = malloct(qLen + 1);
    assertf(copyBuff != NULL);
    copyBuff[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; ampargs; i++) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (i == 0)
        strcatbuff(copyBuff, <B><FONT COLOR="#BC8F8F">&quot;?&quot;</FONT></B>);
      <B><FONT COLOR="#A020F0">else</FONT></B>
        strcatbuff(copyBuff, <B><FONT COLOR="#BC8F8F">&quot;&amp;&quot;</FONT></B>);
      strcatbuff(copyBuff, amps[i] + 1);
    }
    assertf(strlen(copyBuff) == qLen);
    strcpybuff(query, copyBuff);

    <I><FONT COLOR="#B22222">/* Cleanup */</FONT></I>
    freet(amps);
    freet(copyBuff);
  }

  <B><FONT COLOR="#A020F0">return</FONT></B> dest;
}

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">endwith</FONT></B>(a) ( (len &gt;= (sizeof(a)-1)) ? ( strncmp(dest, a+len-(sizeof(a)-1), sizeof(a)-1) == 0 ) : 0 );
HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">adr_normalized</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *source, <B><FONT COLOR="#228B22">char</FONT></B> *dest) {
  <I><FONT COLOR="#B22222">/* not yet too aggressive (no com&lt;-&gt;net&lt;-&gt;org checkings) */</FONT></I>
  strcpybuff(dest, jump_normalized_const(source));
  <B><FONT COLOR="#A020F0">return</FONT></B> dest;
}

#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">endwith</FONT>

<I><FONT COLOR="#B22222">// find port (:80) or NULL if not found
</FONT></I><I><FONT COLOR="#B22222">// can handle IPV6 addresses
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">jump_toport_const</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *source) {
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a, *trytofind;

  a = jump_identification_const(source);
  trytofind = strrchr_limit(a, <B><FONT COLOR="#BC8F8F">']'</FONT></B>, strchr(source, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>));       <I><FONT COLOR="#B22222">// find last ] (http://[3ffe:b80:1234::1]:80/foo.html)
</FONT></I>  a = strchr((trytofind) ? trytofind : a, <B><FONT COLOR="#BC8F8F">':'</FONT></B>);
  <B><FONT COLOR="#A020F0">return</FONT></B> a;
}

HTSEXT_API <B><FONT COLOR="#0000FF">DECLARE_NON_CONST_VERSION</FONT></B>(jump_toport)

<I><FONT COLOR="#B22222">// strrchr, but not too far
</FONT></I><B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">strrchr_limit</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">char</FONT></B> c, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *limit) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (limit == NULL) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *p = strrchr(s, c);

    <B><FONT COLOR="#A020F0">return</FONT></B> p ? (p + 1) : NULL;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = NULL, *p;

    <B><FONT COLOR="#A020F0">for</FONT></B>(;;) {
      p = strchr((a) ? a : s, c);
      <B><FONT COLOR="#A020F0">if</FONT></B> ((p &gt;= limit) || (p == NULL))
        <B><FONT COLOR="#A020F0">return</FONT></B> a;
      a = p + 1;
    }
  }
}

<I><FONT COLOR="#B22222">// retourner adr sans ftp://
</FONT></I><B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">jump_protocol_const</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *source) {
  <B><FONT COLOR="#228B22">int</FONT></B> p;

  <I><FONT COLOR="#B22222">// scheme
</FONT></I>  <I><FONT COLOR="#B22222">// &quot;Comparisons of scheme names MUST be case-insensitive&quot; (RFC2616)
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(source, <B><FONT COLOR="#BC8F8F">&quot;http:&quot;</FONT></B>)))
    source += p;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(source, <B><FONT COLOR="#BC8F8F">&quot;ftp:&quot;</FONT></B>)))
    source += p;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(source, <B><FONT COLOR="#BC8F8F">&quot;https:&quot;</FONT></B>)))
    source += p;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(source, <B><FONT COLOR="#BC8F8F">&quot;file:&quot;</FONT></B>)))
    source += p;
  <I><FONT COLOR="#B22222">// net_path
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (strncmp(source, <B><FONT COLOR="#BC8F8F">&quot;//&quot;</FONT></B>, 2) == 0)
    source += 2;
  <B><FONT COLOR="#A020F0">return</FONT></B> source;
}

<B><FONT COLOR="#0000FF">DECLARE_NON_CONST_VERSION</FONT></B>(jump_protocol)

<I><FONT COLOR="#B22222">// codage base 64 a vers b
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">code64</FONT></B>(<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a, <B><FONT COLOR="#228B22">int</FONT></B> size_a, <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *b, <B><FONT COLOR="#228B22">int</FONT></B> crlf) {
  <B><FONT COLOR="#228B22">int</FONT></B> i1 = 0, i2 = 0, i3 = 0, i4 = 0;
  <B><FONT COLOR="#228B22">int</FONT></B> loop = 0;
  <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">long</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> store;
  <B><FONT COLOR="#228B22">int</FONT></B> n;
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> _hts_base64[] =
    <B><FONT COLOR="#BC8F8F">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</FONT></B>;
  <B><FONT COLOR="#A020F0">while</FONT></B>(size_a-- &gt; 0) {
    <I><FONT COLOR="#B22222">// 24 bits
</FONT></I>    n = 1;
    store = *a++;
    <B><FONT COLOR="#A020F0">if</FONT></B> (size_a-- &gt; 0) {
      n = 2;
      store &lt;&lt;= 8;
      store |= *a++;
    }
    <B><FONT COLOR="#A020F0">if</FONT></B> (size_a-- &gt; 0) {
      n = 3;
      store &lt;&lt;= 8;
      store |= *a++;
    }
    <B><FONT COLOR="#A020F0">if</FONT></B> (n == 3) {
      i4 = store &amp; 63;
      i3 = (store &gt;&gt; 6) &amp; 63;
      i2 = (store &gt;&gt; 12) &amp; 63;
      i1 = (store &gt;&gt; 18) &amp; 63;
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (n == 2) {
      store &lt;&lt;= 2;
      i3 = store &amp; 63;
      i2 = (store &gt;&gt; 6) &amp; 63;
      i1 = (store &gt;&gt; 12) &amp; 63;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      store &lt;&lt;= 4;
      i2 = store &amp; 63;
      i1 = (store &gt;&gt; 6) &amp; 63;
    }

    *b++ = _hts_base64[i1];
    *b++ = _hts_base64[i2];
    <B><FONT COLOR="#A020F0">if</FONT></B> (n &gt;= 2)
      *b++ = _hts_base64[i3];
    <B><FONT COLOR="#A020F0">else</FONT></B>
      *b++ = <B><FONT COLOR="#BC8F8F">'='</FONT></B>;
    <B><FONT COLOR="#A020F0">if</FONT></B> (n &gt;= 3)
      *b++ = _hts_base64[i4];
    <B><FONT COLOR="#A020F0">else</FONT></B>
      *b++ = <B><FONT COLOR="#BC8F8F">'='</FONT></B>;

    <B><FONT COLOR="#A020F0">if</FONT></B> (crlf &amp;&amp; ((loop += 3) % 60) == 0) {
      *b++ = <B><FONT COLOR="#BC8F8F">'\r'</FONT></B>;
      *b++ = <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>;
    }
  }
  *b++ = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
}

<I><FONT COLOR="#B22222">// return the hex character value, or -1 on error.
</FONT></I><B><FONT COLOR="#228B22">static</FONT></B> HTS_INLINE <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ehexh</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> c) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (c &gt;= <B><FONT COLOR="#BC8F8F">'0'</FONT></B> &amp;&amp; c &lt;= <B><FONT COLOR="#BC8F8F">'9'</FONT></B>)
    <B><FONT COLOR="#A020F0">return</FONT></B> c - <B><FONT COLOR="#BC8F8F">'0'</FONT></B>;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (c &gt;= <B><FONT COLOR="#BC8F8F">'a'</FONT></B> &amp;&amp; c &lt;= <B><FONT COLOR="#BC8F8F">'f'</FONT></B>)
    <B><FONT COLOR="#A020F0">return</FONT></B> (c - <B><FONT COLOR="#BC8F8F">'a'</FONT></B> + 10);
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (c &gt;= <B><FONT COLOR="#BC8F8F">'A'</FONT></B> &amp;&amp; c &lt;= <B><FONT COLOR="#BC8F8F">'F'</FONT></B>)
    <B><FONT COLOR="#A020F0">return</FONT></B> (c - <B><FONT COLOR="#BC8F8F">'A'</FONT></B> + 10);
  <B><FONT COLOR="#A020F0">else</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}

<I><FONT COLOR="#B22222">// return the two-hex character value, or -1 on error.
</FONT></I><B><FONT COLOR="#228B22">static</FONT></B> HTS_INLINE <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ehex</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s) {
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> c1 = ehexh(s[0]);
  <B><FONT COLOR="#A020F0">if</FONT></B> (c1 &gt;= 0) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> c2 = ehexh(s[1]);
    <B><FONT COLOR="#A020F0">if</FONT></B> (c2 &gt;= 0) {
      <B><FONT COLOR="#A020F0">return</FONT></B> 16*c1 + c2;
    }
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}

<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">unescape_amp</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *s) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_unescapeEntities(s, s, strlen(s) + 1) != 0) {
    assertf(! <B><FONT COLOR="#BC8F8F">&quot;error escaping html entities&quot;</FONT></B>);
  }
}

<I><FONT COLOR="#B22222">// remplacer %20 par ' ', etc..
</FONT></I><I><FONT COLOR="#B22222">// buffer MAX 1Ko
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">unescape_http</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> catbuff, <B><FONT COLOR="#228B22">const</FONT></B> size_t size, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> s) {
  size_t i, j;

  RUNTIME_TIME_CHECK_SIZE(size);

  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0, j = 0; s[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> &amp;&amp; j + 1 &lt; size ; i++) {
    <B><FONT COLOR="#228B22">int</FONT></B> h;
    <B><FONT COLOR="#A020F0">if</FONT></B> (s[i] == <B><FONT COLOR="#BC8F8F">'%'</FONT></B> &amp;&amp; (h = ehex(&amp;s[i + 1])) &gt;= 0) {
      catbuff[j++] = (<B><FONT COLOR="#228B22">char</FONT></B>) h;
      i += 2;
    }
    <B><FONT COLOR="#A020F0">else</FONT></B>
      catbuff[j++] = s[i];
  }
  catbuff[j++] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> catbuff;
}

<I><FONT COLOR="#B22222">// unescape in URL/URI ONLY what has to be escaped, to form a standard URL/URI
</FONT></I><I><FONT COLOR="#B22222">// DOES NOT DECODE %25 (part of CHAR_DELIM)
</FONT></I><I><FONT COLOR="#B22222">// no_high &amp; 1: decode high chars
</FONT></I><I><FONT COLOR="#B22222">// no_high &amp; 2: decode space
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">unescape_http_unharm</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> catbuff, <B><FONT COLOR="#228B22">const</FONT></B> size_t size, 
                                      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> no_high) {
  size_t i, j;

  RUNTIME_TIME_CHECK_SIZE(size);

  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0, j = 0; s[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> &amp;&amp; j + 1 &lt; size ; i++) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (s[i] == <B><FONT COLOR="#BC8F8F">'%'</FONT></B>) {
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> nchar = ehex(&amp;s[i + 1]);

      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> test = 
        ( CHAR_RESERVED(nchar) &amp;&amp; nchar != <B><FONT COLOR="#BC8F8F">'+'</FONT></B> )        <I><FONT COLOR="#B22222">/* %2B =&gt; + (not in query!) */</FONT></I>
        || CHAR_DELIM(nchar)
        || CHAR_UNWISE(nchar)
        || CHAR_LOW(nchar)    <I><FONT COLOR="#B22222">/* CHAR_SPECIAL */</FONT></I>
        || ( CHAR_XXAVOID(nchar) &amp;&amp; ( nchar != <B><FONT COLOR="#BC8F8F">' '</FONT></B> || ( no_high &amp; 2) == 0 ) )
        || ( ( no_high &amp; 1 ) &amp;&amp; CHAR_HIG(nchar) )
        ;

      <B><FONT COLOR="#A020F0">if</FONT></B> (!test &amp;&amp; nchar &gt;= 0) {  <I><FONT COLOR="#B22222">/* can safely unescape */</FONT></I>
        catbuff[j++] = (<B><FONT COLOR="#228B22">char</FONT></B>) nchar;
        i += 2;
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        catbuff[j++] = <B><FONT COLOR="#BC8F8F">'%'</FONT></B>;
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      catbuff[j++] = s[i];
    }
  }
  catbuff[j++] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> catbuff;
}

<I><FONT COLOR="#B22222">// remplacer &quot; par %xx etc..
</FONT></I><I><FONT COLOR="#B22222">// buffer MAX 1Ko
</FONT></I>HTSEXT_API size_t <B><FONT COLOR="#0000FF">escape_spc_url</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> src, 
                                 <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#A020F0">return</FONT></B> x_escape_http(src, dest, size, 2);
}

<I><FONT COLOR="#B22222">// smith / john -&gt; smith%20%2f%20john
</FONT></I>HTSEXT_API size_t <B><FONT COLOR="#0000FF">escape_in_url</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> src, 
                                <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#A020F0">return</FONT></B> x_escape_http(src, dest, size, 1);
}

<I><FONT COLOR="#B22222">// smith / john -&gt; smith%20/%20john
</FONT></I>HTSEXT_API size_t <B><FONT COLOR="#0000FF">escape_uri</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> src, 
                             <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#A020F0">return</FONT></B> x_escape_http(src, dest, size, 3);
}

HTSEXT_API size_t <B><FONT COLOR="#0000FF">escape_uri_utf</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> src, 
                                 <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#A020F0">return</FONT></B> x_escape_http(src, dest, size, 30);
}

HTSEXT_API size_t <B><FONT COLOR="#0000FF">escape_check_url</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> src, 
                                   <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#A020F0">return</FONT></B> x_escape_http(src, dest, size, 0);
}

<I><FONT COLOR="#B22222">// same as escape_check_url, but returns char*
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">escape_check_url_addr</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> src, 
                                       <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  escape_check_url(src, dest, size);
  <B><FONT COLOR="#A020F0">return</FONT></B> dest;
}

<I><FONT COLOR="#B22222">// Same as above, but appending to &quot;dest&quot;
</FONT></I>#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">DECLARE_APPEND_ESCAPE_VERSION</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">DECLARE_APPEND_ESCAPE_VERSION</FONT></B>(NAME) \
HTSEXT_API size_t append_ ##NAME(const char *const src, char *const dest, const size_t size) { \
  const size_t len = strnlen(dest, size); \
  assertf(len &lt; size); \
  return NAME(src, dest + len, size - len); \
}

<B><FONT COLOR="#0000FF">DECLARE_APPEND_ESCAPE_VERSION</FONT></B>(escape_in_url)
<B><FONT COLOR="#0000FF">DECLARE_APPEND_ESCAPE_VERSION</FONT></B>(escape_spc_url)
<B><FONT COLOR="#0000FF">DECLARE_APPEND_ESCAPE_VERSION</FONT></B>(escape_uri_utf)
<B><FONT COLOR="#0000FF">DECLARE_APPEND_ESCAPE_VERSION</FONT></B>(escape_check_url)
<B><FONT COLOR="#0000FF">DECLARE_APPEND_ESCAPE_VERSION</FONT></B>(escape_uri)

#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">DECLARE_APPEND_ESCAPE_VERSION</FONT>

<I><FONT COLOR="#B22222">// Same as above, but in-place
</FONT></I>#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">DECLARE_INPLACE_ESCAPE_VERSION</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">DECLARE_INPLACE_ESCAPE_VERSION</FONT></B>(NAME) \
HTSEXT_API size_t inplace_ ##NAME(char *const dest, const size_t size) { \
  char buffer[256]; \
  const size_t len = strnlen(dest, size); \
  const int in_buffer = len + 1 &lt; sizeof(buffer); \
  char *src = in_buffer ? buffer : malloct(len + 1); \
  size_t ret; \
  assertf(src != NULL); \
  assertf(len &lt; size); \
  memcpy(src, dest, len + 1); \
  ret = NAME(src, dest, size); \
  if (!in_buffer) { \
    freet(src); \
  } \
  return ret; \
}

<B><FONT COLOR="#0000FF">DECLARE_INPLACE_ESCAPE_VERSION</FONT></B>(escape_in_url)
<B><FONT COLOR="#0000FF">DECLARE_INPLACE_ESCAPE_VERSION</FONT></B>(escape_spc_url)
<B><FONT COLOR="#0000FF">DECLARE_INPLACE_ESCAPE_VERSION</FONT></B>(escape_uri_utf)
<B><FONT COLOR="#0000FF">DECLARE_INPLACE_ESCAPE_VERSION</FONT></B>(escape_check_url)
<B><FONT COLOR="#0000FF">DECLARE_INPLACE_ESCAPE_VERSION</FONT></B>(escape_uri)

#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">DECLARE_INPLACE_ESCAPE_VERSION</FONT>


HTSEXT_API size_t <B><FONT COLOR="#0000FF">make_content_id</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> fil, 
                                  <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#228B22">char</FONT></B> *a;
  size_t esc_size = escape_in_url(adr, dest, size);
  esc_size += escape_in_url(fil, dest + esc_size, size - esc_size);
  RUNTIME_TIME_CHECK_SIZE(size);
  <B><FONT COLOR="#A020F0">for</FONT></B>(a = dest ; (a = strchr(a, <B><FONT COLOR="#BC8F8F">'%'</FONT></B>)) != NULL ; a++) {
    *a = <B><FONT COLOR="#BC8F8F">'X'</FONT></B>;
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> esc_size;
}

<I><FONT COLOR="#B22222">// strip all control characters
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">escape_remove_control</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> s) {
  size_t i, j;
  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0, j = 0 ; s[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> ; i++) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> c = (<B><FONT COLOR="#228B22">unsigned</FONT></B>  <B><FONT COLOR="#228B22">char</FONT></B>) s[i];
    <B><FONT COLOR="#A020F0">if</FONT></B> (c &gt;= 32) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (i != j) {
        assertf(j &lt; i);
        s[j] = s[i];
      }
      j++;
    }
  }
}

#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">ADD_CHAR</FONT>
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">ADD_CHAR</FONT></B>(C) do {   \
      assertf(j &lt; size);    \
      if (j + 1 == size) { \
        dest[j] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;    \
        return size;       \
      }                    \
      dest[j++] = (C);     \
  } while(0)

<I><FONT COLOR="#B22222">/* Returns the number of characters written (not taking in account the terminating \0), or 'size' upon overflow. */</FONT></I>
HTSEXT_API size_t <B><FONT COLOR="#0000FF">x_escape_http</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> s, <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, 
                                <B><FONT COLOR="#228B22">const</FONT></B> size_t size, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> mode) {
  <B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> hex[] = <B><FONT COLOR="#BC8F8F">&quot;0123456789abcdef&quot;</FONT></B>;
  size_t i, j;

  RUNTIME_TIME_CHECK_SIZE(size);

  <I><FONT COLOR="#B22222">// Out-of-bound.
</FONT></I>  <I><FONT COLOR="#B22222">// Previous character is supposed to be the terminating \0.
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (size == 0) {
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  }

  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0, j = 0 ; s[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> ; i++) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> c = (<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) s[i];
    <B><FONT COLOR="#228B22">int</FONT></B> test = 0;

    <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 0)
      test = c == <B><FONT COLOR="#BC8F8F">'&quot;'</FONT></B> || c == <B><FONT COLOR="#BC8F8F">' '</FONT></B> || CHAR_SPECIAL(c);
    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 1)
      test = CHAR_RESERVED(c)
             || CHAR_DELIM(c)
             || CHAR_UNWISE(c)
             || CHAR_SPECIAL(c)
             || CHAR_XXAVOID(c)
             || CHAR_MARK(c);
    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 2)
      test = c == <B><FONT COLOR="#BC8F8F">' '</FONT></B>;       <I><FONT COLOR="#B22222">// n'escaper que espace
</FONT></I>    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 3)         <I><FONT COLOR="#B22222">// échapper que ce qui est nécessaire
</FONT></I>      test = CHAR_SPECIAL(c)
             || CHAR_XXAVOID(c);
    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (mode == 30)      <I><FONT COLOR="#B22222">// échapper que ce qui est nécessaire
</FONT></I>      test = (c != <B><FONT COLOR="#BC8F8F">'/'</FONT></B> &amp;&amp; CHAR_RESERVED(c))
        || CHAR_DELIM(c)
        || CHAR_UNWISE(c)
        || CHAR_SPECIAL(c)
        || CHAR_XXAVOID(c);

    <B><FONT COLOR="#A020F0">if</FONT></B> (!test) {
      ADD_CHAR(c);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'%'</FONT></B>);
      ADD_CHAR(hex[c / 16]);
      ADD_CHAR(hex[c % 16]);
    }
  }

  assertf(j &lt; size);
  dest[j] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> j;
}

HTSEXT_API size_t <B><FONT COLOR="#0000FF">escape_for_html_print</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> s, <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  size_t i, j;

  RUNTIME_TIME_CHECK_SIZE(size);

  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0, j = 0 ; s[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> ; i++) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> c = (<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) s[i];
    <B><FONT COLOR="#A020F0">if</FONT></B> (c == <B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>) {
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'a'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'m'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'p'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">';'</FONT></B>);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      ADD_CHAR(c);
    }
  }
  assertf(j &lt; size);
  dest[j] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> j;
}

HTSEXT_API size_t <B><FONT COLOR="#0000FF">escape_for_html_print_full</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> s, <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> dest, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> hex[] = <B><FONT COLOR="#BC8F8F">&quot;0123456789abcdef&quot;</FONT></B>;
  size_t i, j;

  RUNTIME_TIME_CHECK_SIZE(size);

  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0, j = 0 ; s[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> ; i++) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> c = (<B><FONT COLOR="#228B22">unsigned</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>) s[i];
    <B><FONT COLOR="#A020F0">if</FONT></B> (c == <B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>) {
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'a'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'m'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'p'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">';'</FONT></B>);
    } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (CHAR_HIG(c)) {
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'&amp;'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'#'</FONT></B>);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">'x'</FONT></B>);
      ADD_CHAR(hex[c / 16]);
      ADD_CHAR(hex[c % 16]);
      ADD_CHAR(<B><FONT COLOR="#BC8F8F">';'</FONT></B>);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      ADD_CHAR(c);
    }
  }
  assertf(j &lt; size);
  dest[j] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">return</FONT></B> j;
}

#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">ADD_CHAR</FONT>

<I><FONT COLOR="#B22222">// conversion minuscules, avec buffer
</FONT></I><B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">convtolower</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *catbuff, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a) {
  strcpybuff(catbuff, a);
  hts_lowcase(catbuff);         <I><FONT COLOR="#B22222">// lower case
</FONT></I>  <B><FONT COLOR="#A020F0">return</FONT></B> catbuff;
}

<I><FONT COLOR="#B22222">// conversion en minuscules
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_lowcase</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *s) {
  size_t i;

  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; s[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; i++)
    <B><FONT COLOR="#A020F0">if</FONT></B> ((s[i] &gt;= <B><FONT COLOR="#BC8F8F">'A'</FONT></B>) &amp;&amp; (s[i] &lt;= <B><FONT COLOR="#BC8F8F">'Z'</FONT></B>))
      s[i] += (<B><FONT COLOR="#BC8F8F">'a'</FONT></B> - <B><FONT COLOR="#BC8F8F">'A'</FONT></B>);
}

<I><FONT COLOR="#B22222">// remplacer un caractère d'une chaîne dans une autre
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_replace</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">char</FONT></B> from, <B><FONT COLOR="#228B22">char</FONT></B> to) {
  <B><FONT COLOR="#228B22">char</FONT></B> *a;

  <B><FONT COLOR="#A020F0">while</FONT></B>((a = strchr(s, from)) != NULL) {
    *a = to;
  }
}

<I><FONT COLOR="#B22222">// deviner type d'un fichier local..
</FONT></I><I><FONT COLOR="#B22222">// ex: fil=&quot;toto.gif&quot; -&gt; s=&quot;image/gif&quot;
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">guess_httptype</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil) {
  get_httptype(opt, s, fil, 1);
}

<I><FONT COLOR="#B22222">// idem
</FONT></I><I><FONT COLOR="#B22222">// flag: 1 si toujours renvoyer un type
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">get_httptype</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil, <B><FONT COLOR="#228B22">int</FONT></B> flag) {
  <I><FONT COLOR="#B22222">// userdef overrides get_httptype
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (get_userhttptype(opt, s, fil)) {
    <B><FONT COLOR="#A020F0">return</FONT></B>;
  }
  <I><FONT COLOR="#B22222">// regular tests
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (ishtml(opt, fil) == 1) {
    strcpybuff(s, <B><FONT COLOR="#BC8F8F">&quot;text/html&quot;</FONT></B>);
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <I><FONT COLOR="#B22222">/* Check html -&gt; text/html */</FONT></I>
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = fil + strlen(fil) - 1;

    <B><FONT COLOR="#A020F0">while</FONT></B>((*a != <B><FONT COLOR="#BC8F8F">'.'</FONT></B>) &amp;&amp; (*a != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) &amp;&amp; (a &gt; fil))
      a--;
    <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'.'</FONT></B> &amp;&amp; strlen(a) &lt; 32) {
      <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

      a++;
      <B><FONT COLOR="#A020F0">while</FONT></B>(strnotempty(hts_mime[j][1])) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(hts_mime[j][1], a)) {
          <B><FONT COLOR="#A020F0">if</FONT></B> (hts_mime[j][0][0] != <B><FONT COLOR="#BC8F8F">'*'</FONT></B>) {       <I><FONT COLOR="#B22222">// Une correspondance existe
</FONT></I>            strcpybuff(s, hts_mime[j][0]);
            <B><FONT COLOR="#A020F0">return</FONT></B>;
          }
        }
        j++;
      }

      <B><FONT COLOR="#A020F0">if</FONT></B> (flag)
        sprintf(s, <B><FONT COLOR="#BC8F8F">&quot;application/%s&quot;</FONT></B>, a);
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">if</FONT></B> (flag)
        strcpybuff(s, <B><FONT COLOR="#BC8F8F">&quot;application/octet-stream&quot;</FONT></B>);
    }
  }
}

<I><FONT COLOR="#B22222">// get type of fil (php)
</FONT></I><I><FONT COLOR="#B22222">// s: buffer (text/html) or NULL
</FONT></I><I><FONT COLOR="#B22222">// return: 1 if known by user
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">get_userhttptype</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (s != NULL) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (s)
      s[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    <B><FONT COLOR="#A020F0">if</FONT></B> (fil == NULL || *fil == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>)
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
#<B><FONT COLOR="#5F9EA0">if</FONT></B> 1
    <B><FONT COLOR="#A020F0">if</FONT></B> (StringLength(opt-&gt;mimedefs) &gt; 0) {

      <I><FONT COLOR="#B22222">/* Check --assume foooo/foo/bar.cgi=text/html, then foo/bar.cgi=text/html, then bar.cgi=text/html */</FONT></I>
      <I><FONT COLOR="#B22222">/* also: --assume baz,bar,foooo/foo/bar.cgi=text/html */</FONT></I>
      <I><FONT COLOR="#B22222">/* start from path beginning */</FONT></I>
      <B><FONT COLOR="#A020F0">do</FONT></B> {
        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *next;
        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *mimedefs = StringBuff(opt-&gt;mimedefs);       <I><FONT COLOR="#B22222">/* loop through mime definitions : \nfoo=bar\nzoo=baz\n.. */</FONT></I>

        <B><FONT COLOR="#A020F0">while</FONT></B>(*mimedefs != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *segment = fil + 1;

          <B><FONT COLOR="#A020F0">if</FONT></B> (*mimedefs == <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>) {
            mimedefs++;
          }
          <I><FONT COLOR="#B22222">/* compare current segment with user's definition */</FONT></I>
          <B><FONT COLOR="#A020F0">do</FONT></B> {
            <B><FONT COLOR="#228B22">int</FONT></B> i;

            <I><FONT COLOR="#B22222">/* check current item */</FONT></I>
            <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; mimedefs[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>      <I><FONT COLOR="#B22222">/* end of all defs */</FONT></I>
                &amp;&amp; mimedefs[i] != <B><FONT COLOR="#BC8F8F">' '</FONT></B>   <I><FONT COLOR="#B22222">/* next item in left list */</FONT></I>
                &amp;&amp; mimedefs[i] != <B><FONT COLOR="#BC8F8F">'='</FONT></B>   <I><FONT COLOR="#B22222">/* end of left list */</FONT></I>
                &amp;&amp; mimedefs[i] != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>  <I><FONT COLOR="#B22222">/* end of this def (?) */</FONT></I>
                &amp;&amp; mimedefs[i] == segment[i]    <I><FONT COLOR="#B22222">/* same item */</FONT></I>
                ; i++) ;
            <I><FONT COLOR="#B22222">/* success */</FONT></I>
            <B><FONT COLOR="#A020F0">if</FONT></B> ((mimedefs[i] == <B><FONT COLOR="#BC8F8F">'='</FONT></B> || mimedefs[i] == <B><FONT COLOR="#BC8F8F">' '</FONT></B>)
                &amp;&amp; segment[i] == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
              <B><FONT COLOR="#228B22">int</FONT></B> i2;

              <B><FONT COLOR="#A020F0">while</FONT></B>(mimedefs[i] != 0 &amp;&amp; mimedefs[i] != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>
                    &amp;&amp; mimedefs[i] != <B><FONT COLOR="#BC8F8F">'='</FONT></B>)
                i++;
              <B><FONT COLOR="#A020F0">if</FONT></B> (mimedefs[i] == <B><FONT COLOR="#BC8F8F">'='</FONT></B>) {
                i++;
                <B><FONT COLOR="#A020F0">for</FONT></B>(i2 = 0;
                    mimedefs[i + i2] != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B> &amp;&amp; mimedefs[i + i2] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                    i2++) {
                  s[i2] = mimedefs[i + i2];
                }
                s[i2] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
                <B><FONT COLOR="#A020F0">return</FONT></B> 1;       <I><FONT COLOR="#B22222">/* SUCCESS! */</FONT></I>
              }
            }
            <I><FONT COLOR="#B22222">/* next item in list */</FONT></I>
            <B><FONT COLOR="#A020F0">for</FONT></B>(mimedefs += i;
                *mimedefs != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> &amp;&amp; *mimedefs != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B> &amp;&amp; *mimedefs != <B><FONT COLOR="#BC8F8F">'='</FONT></B>
                &amp;&amp; *mimedefs != <B><FONT COLOR="#BC8F8F">' '</FONT></B>; mimedefs++) ;
            <B><FONT COLOR="#A020F0">if</FONT></B> (*mimedefs == <B><FONT COLOR="#BC8F8F">' '</FONT></B>) {
              mimedefs++;
            }
          } <B><FONT COLOR="#A020F0">while</FONT></B>(*mimedefs != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> &amp;&amp; *mimedefs != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B> &amp;&amp; *mimedefs != <B><FONT COLOR="#BC8F8F">'='</FONT></B>);
          <I><FONT COLOR="#B22222">/* next user-def */</FONT></I>
          <B><FONT COLOR="#A020F0">for</FONT></B>(; *mimedefs != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B> &amp;&amp; *mimedefs != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>; mimedefs++) ;
        }
        <I><FONT COLOR="#B22222">/* shorten segment */</FONT></I>
        next = strchr(fil + 1, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);
        <B><FONT COLOR="#A020F0">if</FONT></B> (next == NULL) {
          <I><FONT COLOR="#B22222">/* ext tests */</FONT></I>
          next = strchr(fil + 1, <B><FONT COLOR="#BC8F8F">'.'</FONT></B>);
        }
        fil = next;
      } <B><FONT COLOR="#A020F0">while</FONT></B>(fil != NULL);
    }
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B> (*buffer) {
      <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK search[1024];
      <B><FONT COLOR="#228B22">char</FONT></B> *detect;

      sprintf(search, <B><FONT COLOR="#BC8F8F">&quot;\n%s=&quot;</FONT></B>, ext);    <I><FONT COLOR="#B22222">// php=text/html
</FONT></I>      detect = strstr(*buffer, search);
      <B><FONT COLOR="#A020F0">if</FONT></B> (!detect) {
        sprintf(search, <B><FONT COLOR="#BC8F8F">&quot;\n%s\n&quot;</FONT></B>, ext); <I><FONT COLOR="#B22222">// php\ncgi=text/html
</FONT></I>        detect = strstr(*buffer, search);
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (detect) {
        detect = strchr(detect, <B><FONT COLOR="#BC8F8F">'='</FONT></B>);
        <B><FONT COLOR="#A020F0">if</FONT></B> (detect) {
          detect++;
          <B><FONT COLOR="#A020F0">if</FONT></B> (s) {
            <B><FONT COLOR="#228B22">char</FONT></B> *a;

            a = strchr(detect, <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>);
            <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
              strncatbuff(s, detect, (<B><FONT COLOR="#228B22">int</FONT></B>) (a - detect));
            }
          }
          <B><FONT COLOR="#A020F0">return</FONT></B> 1;
        }
      }
    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">// renvoyer extesion d'un type mime..
</FONT></I><I><FONT COLOR="#B22222">// ex: &quot;image/gif&quot; -&gt; gif
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">give_mimext</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *st) {
  <B><FONT COLOR="#228B22">int</FONT></B> ok = 0;
  <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

  s[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">while</FONT></B>((!ok) &amp;&amp; (strnotempty(hts_mime[j][1]))) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(hts_mime[j][0], st)) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (hts_mime[j][1][0] != <B><FONT COLOR="#BC8F8F">'*'</FONT></B>) {   <I><FONT COLOR="#B22222">// Une correspondance existe
</FONT></I>        strcpybuff(s, hts_mime[j][1]);
        ok = 1;
      }
    }
    j++;
  }
  <I><FONT COLOR="#B22222">// wrap &quot;x&quot; mimetypes, such as:
</FONT></I>  <I><FONT COLOR="#B22222">// application/x-mp3
</FONT></I>  <I><FONT COLOR="#B22222">// or
</FONT></I>  <I><FONT COLOR="#B22222">// application/mp3
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (!ok) {
    <B><FONT COLOR="#228B22">int</FONT></B> p;
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *a = NULL;

    <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(st, <B><FONT COLOR="#BC8F8F">&quot;application/x-&quot;</FONT></B>)))
      a = st + p;
    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> ((p = strfield(st, <B><FONT COLOR="#BC8F8F">&quot;application/&quot;</FONT></B>)))
      a = st + p;
    <B><FONT COLOR="#A020F0">if</FONT></B> (a) {
      <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(a) &gt;= 1) {
        <B><FONT COLOR="#A020F0">if</FONT></B> ((<B><FONT COLOR="#228B22">int</FONT></B>) strlen(a) &lt;= 4) {
          strcpybuff(s, a);
          ok = 1;
        }
      }
    }
  }
}

<I><FONT COLOR="#B22222">// extension connue?..
</FONT></I><I><FONT COLOR="#B22222">//  0 : non
</FONT></I><I><FONT COLOR="#B22222">//  1 : oui
</FONT></I><I><FONT COLOR="#B22222">//  2 : html
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">is_knowntype</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil) {
  <B><FONT COLOR="#228B22">char</FONT></B> catbuff[CATBUFF_SIZE];
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *ext;
  <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

  <B><FONT COLOR="#A020F0">if</FONT></B> (!fil)
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  ext = get_ext(catbuff, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(catbuff), fil);
  <B><FONT COLOR="#A020F0">while</FONT></B>(strnotempty(hts_mime[j][1])) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(hts_mime[j][1], ext)) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (is_html_mime_type(hts_mime[j][0]))
        <B><FONT COLOR="#A020F0">return</FONT></B> 2;
      <B><FONT COLOR="#A020F0">else</FONT></B>
        <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    }
    j++;
  }

  <I><FONT COLOR="#B22222">// Known by user?
</FONT></I>  <B><FONT COLOR="#A020F0">return</FONT></B> (is_userknowntype(opt, fil));
}

<I><FONT COLOR="#B22222">// known type?..
</FONT></I><I><FONT COLOR="#B22222">//  0 : no
</FONT></I><I><FONT COLOR="#B22222">//  1 : yes
</FONT></I><I><FONT COLOR="#B22222">//  2 : html
</FONT></I><I><FONT COLOR="#B22222">// setdefs : set mime buffer:
</FONT></I><I><FONT COLOR="#B22222">//   file=(char*) &quot;asp=text/html\nphp=text/html\n&quot;
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">is_userknowntype</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil) {
  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK mime[1024];

  <B><FONT COLOR="#A020F0">if</FONT></B> (!fil)
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(fil))
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  mime[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  get_userhttptype(opt, mime, fil);
  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(mime))
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (is_html_mime_type(mime))
    <B><FONT COLOR="#A020F0">return</FONT></B> 2;
  <B><FONT COLOR="#A020F0">else</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}

<I><FONT COLOR="#B22222">// page dynamique?
</FONT></I><I><FONT COLOR="#B22222">// is_dyntype(get_ext(&quot;foo.asp&quot;))
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">is_dyntype</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil) {
  <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

  <B><FONT COLOR="#A020F0">if</FONT></B> (!fil)
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(fil))
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  <B><FONT COLOR="#A020F0">while</FONT></B>(strnotempty(hts_ext_dynamic[j])) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(hts_ext_dynamic[j], fil)) {
      <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    }
    j++;
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">// types critiques qui ne doivent pas être changés car renvoyés par des serveurs qui ne
</FONT></I><I><FONT COLOR="#B22222">// connaissent pas le type
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">may_unknown</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *st) {
  <B><FONT COLOR="#228B22">int</FONT></B> j = 0;

  <I><FONT COLOR="#B22222">// types média
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (may_be_hypertext_mime(opt, st, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>)) {
    <B><FONT COLOR="#A020F0">return</FONT></B> 1;
  }
  <B><FONT COLOR="#A020F0">while</FONT></B>(strnotempty(hts_mime_keep[j])) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(hts_mime_keep[j], st)) {      <I><FONT COLOR="#B22222">// trouvé
</FONT></I>      <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    }
    j++;
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* returns 1 if the mime/filename seems to be bogus because of badly recognized multiple extension
  ; such as &quot;application/x-wais-source&quot; for &quot;httrack-3.42-1.el5.src.rpm&quot;
  reported by Hippy Dave 08/2008 (3.43) */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">may_bogus_multiple</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *mime, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *filename) {
  <B><FONT COLOR="#228B22">int</FONT></B> j;

  <B><FONT COLOR="#A020F0">for</FONT></B>(j = 0; strnotempty(hts_mime_bogus_multiple[j]); j++) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (strfield2(hts_mime_bogus_multiple[j], mime)) {  <I><FONT COLOR="#B22222">/* found mime type in suspicious list */</FONT></I>
      <B><FONT COLOR="#228B22">char</FONT></B> ext[64];

      ext[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      give_mimext(ext, mime);
      <B><FONT COLOR="#A020F0">if</FONT></B> (ext[0] != 0) {        <I><FONT COLOR="#B22222">/* we have an extension for that */</FONT></I>
        <B><FONT COLOR="#228B22">const</FONT></B> size_t ext_size = strlen(ext);
        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *file = strrchr(filename, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>);      <I><FONT COLOR="#B22222">/* fetch terminal filename */</FONT></I>

        <B><FONT COLOR="#A020F0">if</FONT></B> (file != NULL) {
          <B><FONT COLOR="#228B22">int</FONT></B> i;

          <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; file[i] != 0; i++) {
            <B><FONT COLOR="#A020F0">if</FONT></B> (i &gt; 0 &amp;&amp; file[i - 1] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B>
                &amp;&amp; strncasecmp(&amp;file[i], ext, ext_size) == 0
                &amp;&amp; (file[i + ext_size] == 0 || file[i + ext_size] == <B><FONT COLOR="#BC8F8F">'.'</FONT></B>
                    || file[i + ext_size] == <B><FONT COLOR="#BC8F8F">'?'</FONT></B>)) {
              <B><FONT COLOR="#A020F0">return</FONT></B> 1;         <I><FONT COLOR="#B22222">/* is ambiguous */</FONT></I>
            }
          }
        }
      }
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
    }
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* filename extension should not be changed because potentially bogus ; replaces may_unknown() (3.43) */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">may_unknown2</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *mime, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *filename) {
  <B><FONT COLOR="#228B22">int</FONT></B> ret = may_unknown(opt, mime);

  <B><FONT COLOR="#A020F0">if</FONT></B> (ret == 0) {
    ret = may_bogus_multiple(opt, mime, filename);
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> ret;
}

<I><FONT COLOR="#B22222">// -- Utils fichiers
</FONT></I>
<I><FONT COLOR="#B22222">// pretty print for i/o
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">fprintfio</FONT></B>(FILE * fp, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *buff, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *prefix) {
  <B><FONT COLOR="#228B22">char</FONT></B> nl = 1;

  <B><FONT COLOR="#A020F0">while</FONT></B>(*buff) {
    <B><FONT COLOR="#A020F0">switch</FONT></B> (*buff) {
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">13</FONT></B>:
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">10</FONT></B>:
      fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;\r\n&quot;</FONT></B>);
      nl = 1;
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#5F9EA0">default</FONT></B>:
      <B><FONT COLOR="#A020F0">if</FONT></B> (nl)
        fprintf(fp, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B>, prefix);
      nl = 0;
      fputc(*buff, fp);
    }
    buff++;
  }
}

<I><FONT COLOR="#B22222">/* Le fichier existe-t-il? (ou est-il accessible?) */</FONT></I>
<I><FONT COLOR="#B22222">/* Note: NOT utf-8 */</FONT></I>
<I><FONT COLOR="#B22222">/* Note: preserve errno */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">fexist</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s) {
  <B><FONT COLOR="#228B22">char</FONT></B> catbuff[CATBUFF_SIZE];
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> err = errno;
  <B><FONT COLOR="#228B22">struct</FONT></B> stat st;

  memset(&amp;st, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(st));
  <B><FONT COLOR="#A020F0">if</FONT></B> (stat(fconv(catbuff, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(catbuff), s), &amp;st) == 0) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (S_ISREG(st.st_mode)) {
      <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
    }
  }
  errno = err;
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* Le fichier existe-t-il? (ou est-il accessible?) */</FONT></I>
<I><FONT COLOR="#B22222">/* Note: utf-8 */</FONT></I>
<I><FONT COLOR="#B22222">/* Note: preserve errno */</FONT></I>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">fexist_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s) {
  <B><FONT COLOR="#228B22">char</FONT></B> catbuff[CATBUFF_SIZE];
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> err = errno;
  STRUCT_STAT st;

  memset(&amp;st, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(st));
  <B><FONT COLOR="#A020F0">if</FONT></B> (STAT(fconv(catbuff, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(catbuff), s), &amp;st) == 0) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (S_ISREG(st.st_mode)) {
      <B><FONT COLOR="#A020F0">return</FONT></B> 1;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">return</FONT></B> 0;
    }
  }
  errno = err;
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* Taille d'un fichier, -1 si n'existe pas */</FONT></I>
<I><FONT COLOR="#B22222">/* Note: NOT utf-8 */</FONT></I>
off_t <B><FONT COLOR="#0000FF">fsize</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s) {
  <B><FONT COLOR="#228B22">struct</FONT></B> stat st;

  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(s))          <I><FONT COLOR="#B22222">// nom vide: erreur
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> -1;
  <B><FONT COLOR="#A020F0">if</FONT></B> (stat(s, &amp;st) == 0 &amp;&amp; S_ISREG(st.st_mode)) {
    <B><FONT COLOR="#A020F0">return</FONT></B> st.st_size;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <B><FONT COLOR="#A020F0">return</FONT></B> -1;
  }
}

<I><FONT COLOR="#B22222">/* Taille d'un fichier, -1 si n'existe pas */</FONT></I>
<I><FONT COLOR="#B22222">/* Note: utf-8 */</FONT></I>
off_t <B><FONT COLOR="#0000FF">fsize_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s) {
  STRUCT_STAT st;

  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(s))          <I><FONT COLOR="#B22222">// nom vide: erreur
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> -1;
  <B><FONT COLOR="#A020F0">if</FONT></B> (STAT(s, &amp;st) == 0 &amp;&amp; S_ISREG(st.st_mode)) {
    <B><FONT COLOR="#A020F0">return</FONT></B> st.st_size;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <B><FONT COLOR="#A020F0">return</FONT></B> -1;
  }
}

off_t <B><FONT COLOR="#0000FF">fpsize</FONT></B>(FILE * fp) {
  off_t oldpos, size;

  <B><FONT COLOR="#A020F0">if</FONT></B> (!fp)
    <B><FONT COLOR="#A020F0">return</FONT></B> -1;
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">HTS_FSEEKO</FONT>
  oldpos = ftello(fp);
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
  oldpos = ftell(fp);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  fseek(fp, 0, SEEK_END);
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">HTS_FSEEKO</FONT>
  size = ftello(fp);
  fseeko(fp, oldpos, SEEK_SET);
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
  size = ftell(fp);
  fseek(fp, oldpos, SEEK_SET);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  <B><FONT COLOR="#A020F0">return</FONT></B> size;
}

<I><FONT COLOR="#B22222">/* root dir, with ending / */</FONT></I>
<B><FONT COLOR="#228B22">typedef</FONT></B> <B><FONT COLOR="#228B22">struct</FONT></B> {
  <B><FONT COLOR="#228B22">char</FONT></B> path[1024 + 4];
  <B><FONT COLOR="#228B22">int</FONT></B> init;
} hts_rootdir_strc;
HTSEXT_API <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">hts_rootdir</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *file) {
  <B><FONT COLOR="#228B22">static</FONT></B> hts_rootdir_strc strc = { <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>, 0 };
  <B><FONT COLOR="#A020F0">if</FONT></B> (file) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (!strc.init) {
      strc.path[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      strc.init = 1;
      <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(file)) {
        <B><FONT COLOR="#228B22">const</FONT></B> size_t file_len = strlen(file);
        <B><FONT COLOR="#228B22">char</FONT></B> *a;

        assertf(file_len &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(strc.path));
        strcpybuff(strc.path, file);
        <B><FONT COLOR="#A020F0">while</FONT></B>((a = strrchr(strc.path, <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>)))
          *a = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;
        <B><FONT COLOR="#A020F0">if</FONT></B> ((a = strrchr(strc.path, <B><FONT COLOR="#BC8F8F">'/'</FONT></B>))) {
          *(a + 1) = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        } <B><FONT COLOR="#A020F0">else</FONT></B>
          strc.path[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(strc.path)) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (getcwd(strc.path, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(strc.path)) == NULL)
          strc.path[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
        <B><FONT COLOR="#A020F0">else</FONT></B>
          strcatbuff(strc.path, <B><FONT COLOR="#BC8F8F">&quot;/&quot;</FONT></B>);
      }
    }
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (strc.init)
    <B><FONT COLOR="#A020F0">return</FONT></B> strc.path;
  <B><FONT COLOR="#A020F0">else</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>;
}

HTSEXT_API hts_stat_struct HTS_STAT;

<I><FONT COLOR="#B22222">//
</FONT></I><I><FONT COLOR="#B22222">// return  number of downloadable bytes, depending on rate limiter
</FONT></I><I><FONT COLOR="#B22222">// see engine_stats() routine, too
</FONT></I><I><FONT COLOR="#B22222">// this routine works quite well for big files and regular ones, but apparently the rate limiter has
</FONT></I><I><FONT COLOR="#B22222">// some problems with very small files (rate too high)
</FONT></I>LLint <B><FONT COLOR="#0000FF">check_downloadable_bytes</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> rate) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (rate &gt; 0) {
    TStamp time_now;
    TStamp elapsed_useconds;
    LLint bytes_transferred_during_period;
    LLint left;

    <I><FONT COLOR="#B22222">// get the older timer
</FONT></I>    <B><FONT COLOR="#228B22">int</FONT></B> id_timer = (HTS_STAT.istat_idlasttimer + 1) % 2;

    time_now = mtime_local();
    elapsed_useconds = time_now - HTS_STAT.istat_timestart[id_timer];
    <I><FONT COLOR="#B22222">// NO totally stupid - elapsed_useconds+=1000;      // for the next second, too
</FONT></I>    bytes_transferred_during_period =
      (HTS_STAT.HTS_TOTAL_RECV - HTS_STAT.istat_bytes[id_timer]);

    left = ((rate * elapsed_useconds) / 1000) - bytes_transferred_during_period;
    <B><FONT COLOR="#A020F0">if</FONT></B> (left &lt;= 0)
      left = 0;

    <B><FONT COLOR="#A020F0">return</FONT></B> left;
  } <B><FONT COLOR="#A020F0">else</FONT></B>
    <B><FONT COLOR="#A020F0">return</FONT></B> TAILLE_BUFFER;
}

<I><FONT COLOR="#B22222">//
</FONT></I><I><FONT COLOR="#B22222">// 0 : OK
</FONT></I><I><FONT COLOR="#B22222">// 1 : slow down
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> 0
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">HTS_TOTAL_RECV_CHECK</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> var) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (HTS_STAT.HTS_TOTAL_RECV_STATE)
    <B><FONT COLOR="#A020F0">return</FONT></B> 1;
  <I><FONT COLOR="#B22222">/*
     {
     if (HTS_STAT.HTS_TOTAL_RECV_STATE==3) { 
     var = min(var,32); 
     Sleep(250); 
     } else if (HTS_STAT.HTS_TOTAL_RECV_STATE==2) { 
     var = min(var,256); 
     Sleep(100); 
     } else { 
     var/=2; 
     if (var&lt;=0) var=1; 
     Sleep(50); 
     } 
     }
   */</FONT></I>
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

<I><FONT COLOR="#B22222">// Lecture dans buff de size octets au maximum en utilisant la socket r (structure htsblk)
</FONT></I><I><FONT COLOR="#B22222">// returns: 
</FONT></I><I><FONT COLOR="#B22222">// &gt;0 : data received
</FONT></I><I><FONT COLOR="#B22222">// == 0 : not yet data
</FONT></I><I><FONT COLOR="#B22222">// &lt;0: error or no data: READ_ERROR, READ_EOF or READ_TIMEOUT
</FONT></I><B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_read</FONT></B>(htsblk * r, <B><FONT COLOR="#228B22">char</FONT></B> *buff, <B><FONT COLOR="#228B22">int</FONT></B> size) {
  <B><FONT COLOR="#228B22">int</FONT></B> retour;

  <I><FONT COLOR="#B22222">//  return read(soc,buff,size);
</FONT></I>  <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;is_file) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;read(%p, %d, %d)\n&quot;</FONT></B> _(<B><FONT COLOR="#228B22">void</FONT></B> *)buff _(<B><FONT COLOR="#228B22">int</FONT></B>) size _(<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;fp);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;fp) {
      retour = (<B><FONT COLOR="#228B22">int</FONT></B>) fread(buff, 1, size, r-&gt;fp);
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour == 0)  <I><FONT COLOR="#B22222">// can happen with directories (!)
</FONT></I>        retour = READ_ERROR;
    } <B><FONT COLOR="#A020F0">else</FONT></B>
      retour = READ_ERROR;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;recv(%d, %p, %d)\n&quot;</FONT></B> _(<B><FONT COLOR="#228B22">int</FONT></B>) r-&gt;soc _(<B><FONT COLOR="#228B22">void</FONT></B> *)buff _(<B><FONT COLOR="#228B22">int</FONT></B>) size);

    <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;soc == INVALID_SOCKET)
      printf(<B><FONT COLOR="#BC8F8F">&quot;!!WIDE_DEBUG ERROR, soc==INVALID hts_read\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <I><FONT COLOR="#B22222">//HTS_TOTAL_RECV_CHECK(size);         // Diminuer au besoin si trop de données reçues
</FONT></I>#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
    <B><FONT COLOR="#A020F0">if</FONT></B> (r-&gt;ssl) {
      retour = SSL_read(r-&gt;ssl_con, buff, size);
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour &lt;= 0) {
        <B><FONT COLOR="#228B22">int</FONT></B> err_code = SSL_get_error(r-&gt;ssl_con, retour);

        <B><FONT COLOR="#A020F0">if</FONT></B> ((err_code == SSL_ERROR_WANT_READ)
            || (err_code == SSL_ERROR_WANT_WRITE)
          ) {
          retour = 0;           <I><FONT COLOR="#B22222">/* no data yet (ssl cache) */</FONT></I>
        } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (err_code == SSL_ERROR_ZERO_RETURN) {
          retour = READ_EOF;    <I><FONT COLOR="#B22222">/* completed */</FONT></I>
        } <B><FONT COLOR="#A020F0">else</FONT></B> {
          retour = READ_ERROR;  <I><FONT COLOR="#B22222">/* eof or error */</FONT></I>
        }
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
      retour = recv(r-&gt;soc, buff, size, 0);
      <B><FONT COLOR="#A020F0">if</FONT></B> (retour == 0) {
        retour = READ_EOF;
      } <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (retour &lt; 0) {
        retour = READ_ERROR;
      }
    }
    <B><FONT COLOR="#A020F0">if</FONT></B> (retour &gt; 0)             <I><FONT COLOR="#B22222">// compter flux entrant
</FONT></I>      HTS_STAT.HTS_TOTAL_RECV += retour;
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
  }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
  DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;recv/read done (%d bytes)\n&quot;</FONT></B> _(<B><FONT COLOR="#228B22">int</FONT></B>) retour);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  <B><FONT COLOR="#A020F0">return</FONT></B> retour;
}

<I><FONT COLOR="#B22222">// -- Gestion cache DNS --
</FONT></I><I><FONT COLOR="#B22222">// 'RX98
</FONT></I>
<I><FONT COLOR="#B22222">// 'capsule' contenant uniquement le cache
</FONT></I>t_dnscache *<B><FONT COLOR="#0000FF">hts_cache</FONT></B>(httrackp * opt) {
  assertf(opt != NULL);
  <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;state.dns_cache == NULL) {
    opt-&gt;state.dns_cache = (t_dnscache *) malloct(<B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_dnscache));
    memset(opt-&gt;state.dns_cache, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_dnscache));
  }
  assertf(opt-&gt;state.dns_cache != NULL);
  <I><FONT COLOR="#B22222">/* first entry is NULL */</FONT></I>
  assertf(opt-&gt;state.dns_cache-&gt;iadr == NULL);
  <B><FONT COLOR="#A020F0">return</FONT></B> opt-&gt;state.dns_cache;
}

<I><FONT COLOR="#B22222">// Free DNS cache.
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_cache_free</FONT></B>(t_dnscache *<B><FONT COLOR="#228B22">const</FONT></B> root) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (root != NULL) {
    t_dnscache *cache;
    <B><FONT COLOR="#A020F0">for</FONT></B>(cache = root; cache != NULL; ) {
      t_dnscache *<B><FONT COLOR="#228B22">const</FONT></B> next = cache-&gt;next;
      cache-&gt;next = NULL;
      freet(cache);
      cache = next;
    }
  }
}

<I><FONT COLOR="#B22222">// lock le cache dns pour tout opération d'ajout
</FONT></I><I><FONT COLOR="#B22222">// plus prudent quand plusieurs threads peuvent écrire dedans..
</FONT></I><I><FONT COLOR="#B22222">// -1: status? 0: libérer 1:locker
</FONT></I>
<I><FONT COLOR="#B22222">// MUST BE LOCKED
</FONT></I><I><FONT COLOR="#B22222">// routine pour le cache - retour optionnel à donner à chaque fois
</FONT></I><I><FONT COLOR="#B22222">// NULL: nom non encore testé dans le cache
</FONT></I><I><FONT COLOR="#B22222">// si h_length==0 alors le nom n'existe pas dans le dns
</FONT></I><B><FONT COLOR="#228B22">static</FONT></B> SOCaddr* <B><FONT COLOR="#0000FF">hts_ghbn</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> t_dnscache *cache, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> iadr, SOCaddr *<B><FONT COLOR="#228B22">const</FONT></B> addr) {
  assertf(addr != NULL);
  assertf(iadr != NULL);
  <B><FONT COLOR="#A020F0">if</FONT></B> (*iadr == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  }
  <I><FONT COLOR="#B22222">/* first entry is empty */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (cache-&gt;iadr == NULL) {
    cache = cache-&gt;next;
  }
  <B><FONT COLOR="#A020F0">for</FONT></B>(; cache != NULL; cache = cache-&gt;next) {
    assertf(cache != NULL);
    assertf(cache-&gt;iadr != NULL);
    assertf(cache-&gt;iadr == (<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>*) cache + <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_dnscache));
    <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(cache-&gt;iadr, iadr) == 0) {       <I><FONT COLOR="#B22222">// ok trouvé
</FONT></I>      <B><FONT COLOR="#A020F0">if</FONT></B> (cache-&gt;host_length != 0) {     <I><FONT COLOR="#B22222">// entrée valide
</FONT></I>        assertf(cache-&gt;host_length &lt;= <B><FONT COLOR="#A020F0">sizeof</FONT></B>(cache-&gt;host_addr));
        SOCaddr_copyaddr2(*addr, cache-&gt;host_addr, cache-&gt;host_length);
        <B><FONT COLOR="#A020F0">return</FONT></B> addr;
      } <B><FONT COLOR="#A020F0">else</FONT></B> {                  <I><FONT COLOR="#B22222">// erreur dans le dns, déja vérifié
</FONT></I>        SOCaddr_clear(*addr);
        <B><FONT COLOR="#A020F0">return</FONT></B> addr;
      }
    }
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
}

<B><FONT COLOR="#228B22">static</FONT></B> SOCaddr* <B><FONT COLOR="#0000FF">hts_dns_resolve_nocache2_</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> hostname,
                                          SOCaddr *<B><FONT COLOR="#228B22">const</FONT></B> addr, 
                                          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> **error) {
  {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_INET6</FONT>==0
    <I><FONT COLOR="#B22222">/* IPv4 resolver */</FONT></I>
    <B><FONT COLOR="#228B22">struct</FONT></B> hostent *<B><FONT COLOR="#228B22">const</FONT></B> hp = gethostbyname(hostname);

    <B><FONT COLOR="#A020F0">if</FONT></B> (hp != NULL) {
      SOCaddr_copyaddr2(addr, hp-&gt;h_addr_list[0], hp-&gt;h_length);
      <B><FONT COLOR="#A020F0">return</FONT></B> SOCaddr_is_valid(addr) ? &amp;addr : NULL;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      SOCaddr_clear(*addr);
    }
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
    <I><FONT COLOR="#B22222">/* IPv6 resolver */</FONT></I>
    <B><FONT COLOR="#228B22">struct</FONT></B> addrinfo *res = NULL;
    <B><FONT COLOR="#228B22">struct</FONT></B> addrinfo hints;
    <B><FONT COLOR="#228B22">int</FONT></B> gerr;

    SOCaddr_clear(*addr);
    memset(&amp;hints, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(hints));
    <B><FONT COLOR="#A020F0">if</FONT></B> (IPV6_resolver == 1)     <I><FONT COLOR="#B22222">// V4 only (for bogus V6 entries)
</FONT></I>      hints.ai_family = PF_INET;
    <B><FONT COLOR="#A020F0">else</FONT></B> <B><FONT COLOR="#A020F0">if</FONT></B> (IPV6_resolver == 2)        <I><FONT COLOR="#B22222">// V6 only (for testing V6 only)
</FONT></I>      hints.ai_family = PF_INET6;
    <B><FONT COLOR="#A020F0">else</FONT></B>                        <I><FONT COLOR="#B22222">// V4 + V6
</FONT></I>      hints.ai_family = PF_UNSPEC;
    hints.ai_socktype = SOCK_STREAM;
    hints.ai_protocol = IPPROTO_TCP;
    <B><FONT COLOR="#A020F0">if</FONT></B> ( ( gerr = getaddrinfo(hostname, NULL, &amp;hints, &amp;res) ) == 0) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (res != NULL) {
        <B><FONT COLOR="#A020F0">if</FONT></B> (res-&gt;ai_addr != NULL &amp;&amp; res-&gt;ai_addrlen != 0) {
          SOCaddr_copyaddr2(*addr, res-&gt;ai_addr, res-&gt;ai_addrlen);
        }
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#A020F0">if</FONT></B> (error != NULL) {
        *error = gai_strerror(gerr);
      }
    }
    <B><FONT COLOR="#A020F0">if</FONT></B> (res) {
      freeaddrinfo(res);
    }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  }

  <B><FONT COLOR="#A020F0">return</FONT></B> SOCaddr_is_valid(*addr) ? addr : NULL;
}

HTSEXT_API SOCaddr* <B><FONT COLOR="#0000FF">hts_dns_resolve_nocache2</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> hostname, 
                                     SOCaddr *<B><FONT COLOR="#228B22">const</FONT></B> addr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> **error) {
  <I><FONT COLOR="#B22222">/* Protection */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (!strnotempty(hostname)) {
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  }

  <I><FONT COLOR="#B22222">/*
     Strip [] if any : [3ffe:b80:1234:1::1] 
     The resolver doesn't seem to handle IP6 addresses in brackets
   */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> ((hostname[0] == <B><FONT COLOR="#BC8F8F">'['</FONT></B>) &amp;&amp; (hostname[strlen(hostname) - 1] == <B><FONT COLOR="#BC8F8F">']'</FONT></B>)) {
    SOCaddr *ret;
    size_t size = strlen(hostname);
    <B><FONT COLOR="#228B22">char</FONT></B> *copy = malloct(size + 1);
    assertf(copy != NULL);
    copy[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    strncat(copy, hostname + 1, size - 2);
    ret =  hts_dns_resolve_nocache2_(copy, addr, error);
    freet(copy);
    <B><FONT COLOR="#A020F0">return</FONT></B> ret;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <B><FONT COLOR="#A020F0">return</FONT></B> hts_dns_resolve_nocache2_(hostname, addr, error);
  }
}

HTSEXT_API SOCaddr* <B><FONT COLOR="#0000FF">hts_dns_resolve_nocache</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> hostname, SOCaddr *<B><FONT COLOR="#228B22">const</FONT></B> addr) {
  <B><FONT COLOR="#A020F0">return</FONT></B> hts_dns_resolve_nocache2(hostname, addr, NULL);
}

HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">check_hostname_dns</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> hostname) {
  SOCaddr buffer;
  <B><FONT COLOR="#A020F0">return</FONT></B> hts_dns_resolve_nocache(hostname, &amp;buffer) != NULL;
}

<I><FONT COLOR="#B22222">// Needs locking
</FONT></I><I><FONT COLOR="#B22222">// cache dns interne à HTS // ** FREE A FAIRE sur la chaine
</FONT></I><B><FONT COLOR="#228B22">static</FONT></B> SOCaddr* <B><FONT COLOR="#0000FF">hts_dns_resolve_</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *_iadr,
                                 SOCaddr *<B><FONT COLOR="#228B22">const</FONT></B> addr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> **error) {
  <B><FONT COLOR="#228B22">char</FONT></B> BIGSTK iadr[HTS_URLMAXSIZE * 2];
  t_dnscache *cache = hts_cache(opt);  <I><FONT COLOR="#B22222">// adresse du cache
</FONT></I>  SOCaddr *sa;

  assertf(opt != NULL);
  assertf(_iadr != NULL);
  assertf(addr != NULL);

  strcpybuff(iadr, jump_identification_const(_iadr));
  <I><FONT COLOR="#B22222">// couper éventuel :
</FONT></I>  {
    <B><FONT COLOR="#228B22">char</FONT></B> *a;

    <B><FONT COLOR="#A020F0">if</FONT></B> ((a = jump_toport(iadr)))
      *a = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  }

  <I><FONT COLOR="#B22222">/* get IP from the dns cache */</FONT></I>
  sa = hts_ghbn(cache, iadr, addr);
  <B><FONT COLOR="#A020F0">if</FONT></B> (sa != NULL) {
    <B><FONT COLOR="#A020F0">return</FONT></B> SOCaddr_is_valid(*sa) ? sa : NULL;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {                      <I><FONT COLOR="#B22222">// non présent dans le cache dns, tester
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> size_t iadr_len = strlen(iadr) + 1;

    <I><FONT COLOR="#B22222">// find queue
</FONT></I>    <B><FONT COLOR="#A020F0">for</FONT></B>(; cache-&gt;next != NULL; cache = cache-&gt;next) ;

#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">DEBUGDNS</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;resolving (not cached) %s\n&quot;</FONT></B>, iadr);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    sa = hts_dns_resolve_nocache2(iadr, addr, error);     <I><FONT COLOR="#B22222">// calculer IP host
</FONT></I>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_WIDE_DEBUG</FONT>
    DEBUG_W(<B><FONT COLOR="#BC8F8F">&quot;gethostbyname done\n&quot;</FONT></B>);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

    <I><FONT COLOR="#B22222">/* attempt to store new entry */</FONT></I>
    cache-&gt;next = malloct(<B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_dnscache) + iadr_len);
    <B><FONT COLOR="#A020F0">if</FONT></B> (cache-&gt;next != NULL) {
      t_dnscache *<B><FONT COLOR="#228B22">const</FONT></B> next = cache-&gt;next;
      <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> block = (<B><FONT COLOR="#228B22">char</FONT></B>*) cache-&gt;next;
      <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> str = block + <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_dnscache);
      memcpy(str, iadr, iadr_len);
      next-&gt;iadr = str;
      <B><FONT COLOR="#A020F0">if</FONT></B> (sa != NULL) {
        next-&gt;host_length = SOCaddr_size(*sa);
        assertf(next-&gt;host_length &lt;= <B><FONT COLOR="#A020F0">sizeof</FONT></B>(next-&gt;host_addr));
        memcpy(next-&gt;host_addr, &amp;SOCaddr_sockaddr(*sa), next-&gt;host_length);
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        next-&gt;host_length = 0;      <I><FONT COLOR="#B22222">// non existant dans le dns
</FONT></I>      }
      next-&gt;next = NULL;
      <B><FONT COLOR="#A020F0">return</FONT></B> sa;
    }

    <I><FONT COLOR="#B22222">/* return result if any */</FONT></I>
    <B><FONT COLOR="#A020F0">return</FONT></B> sa;
  }                             <I><FONT COLOR="#B22222">// retour hp du cache
</FONT></I>}

SOCaddr* <B><FONT COLOR="#0000FF">hts_dns_resolve2</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *_iadr, SOCaddr *<B><FONT COLOR="#228B22">const</FONT></B> addr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> **error) {
  SOCaddr *ret;
  hts_mutexlock(&amp;opt-&gt;state.lock);
  ret = hts_dns_resolve_(opt, _iadr, addr, error);
  hts_mutexrelease(&amp;opt-&gt;state.lock);
  <B><FONT COLOR="#A020F0">return</FONT></B> ret;
}

SOCaddr* <B><FONT COLOR="#0000FF">hts_dns_resolve</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *_iadr, SOCaddr *<B><FONT COLOR="#228B22">const</FONT></B> addr) {
  <B><FONT COLOR="#A020F0">return</FONT></B> hts_dns_resolve2(opt, _iadr, addr, NULL);
}

<I><FONT COLOR="#B22222">// --- Tracage des mallocs() ---
</FONT></I>#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">HTS_TRACE_MALLOC</FONT>
<I><FONT COLOR="#B22222">//#define htsLocker(A, N) htsLocker(A, N)
</FONT></I>#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">htsLocker</FONT></B>(A, N) do {} while(0)
<B><FONT COLOR="#228B22">static</FONT></B> mlink trmalloc = { NULL, 0, 0, NULL };

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> trmalloc_id = 0;
<B><FONT COLOR="#228B22">static</FONT></B> htsmutex *mallocMutex = NULL;
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_meminit</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <I><FONT COLOR="#B22222">//if (mallocMutex == NULL) {
</FONT></I>  <I><FONT COLOR="#B22222">//  mallocMutex = calloc(sizeof(*mallocMutex), 1);
</FONT></I>  <I><FONT COLOR="#B22222">//  htsLocker(mallocMutex, -999);
</FONT></I>  <I><FONT COLOR="#B22222">//}
</FONT></I>}
<B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#0000FF">hts_malloc</FONT></B>(size_t len) {
  <B><FONT COLOR="#228B22">void</FONT></B> *adr;

  hts_meminit();
  htsLocker(mallocMutex, 1);
  assertf(len &gt; 0);
  adr = hts_xmalloc(len, 0);
  htsLocker(mallocMutex, 0);
  <B><FONT COLOR="#A020F0">return</FONT></B> adr;
}
<B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#0000FF">hts_calloc</FONT></B>(size_t len, size_t len2) {
  <B><FONT COLOR="#228B22">void</FONT></B> *adr;

  hts_meminit();
  assertf(len &gt; 0);
  assertf(len2 &gt; 0);
  htsLocker(mallocMutex, 1);
  adr = hts_xmalloc(len, len2);
  htsLocker(mallocMutex, 0);
  memset(adr, 0, len * len2);
  <B><FONT COLOR="#A020F0">return</FONT></B> adr;
}
<B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#0000FF">hts_strdup</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *str) {
  size_t size = str ? strlen(str) : 0;
  <B><FONT COLOR="#228B22">char</FONT></B> *adr = (<B><FONT COLOR="#228B22">char</FONT></B> *) hts_malloc(size + 1);

  assertf(adr != NULL);
  strcpy(adr, str ? str : <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  <B><FONT COLOR="#A020F0">return</FONT></B> adr;
}
<B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#0000FF">hts_xmalloc</FONT></B>(size_t len, size_t len2) {
  mlink *lnk = (mlink *) calloc(1, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(mlink));

  assertf(lnk != NULL);
  assertf(len &gt; 0);
  assertf(len2 &gt;= 0);
  <B><FONT COLOR="#A020F0">if</FONT></B> (lnk) {
    <B><FONT COLOR="#228B22">void</FONT></B> *r = NULL;
    <B><FONT COLOR="#228B22">int</FONT></B> size, bsize = <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_htsboundary);

    <B><FONT COLOR="#A020F0">if</FONT></B> (len2)
      size = len * len2;
    <B><FONT COLOR="#A020F0">else</FONT></B>
      size = len;
    size += ((bsize - (size % bsize)) % bsize); <I><FONT COLOR="#B22222">/* check alignement */</FONT></I>
    r = malloc(size + bsize * 2);
    assertf(r != NULL);
    <B><FONT COLOR="#A020F0">if</FONT></B> (r) {
      *((t_htsboundary *) ((<B><FONT COLOR="#228B22">char</FONT></B> *) r))
        = *((t_htsboundary *) ((<B><FONT COLOR="#228B22">char</FONT></B> *) r + size + bsize))
        = htsboundary;
      ((<B><FONT COLOR="#228B22">char</FONT></B> *) r) += bsize;    <I><FONT COLOR="#B22222">/* boundary */</FONT></I>
      lnk-&gt;adr = r;
      lnk-&gt;len = size;
      lnk-&gt;id = trmalloc_id++;
      lnk-&gt;next = trmalloc.next;
      trmalloc.next = lnk;
      <B><FONT COLOR="#A020F0">return</FONT></B> r;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      free(lnk);
    }
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
}
<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_free</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B> *adr) {
  mlink *lnk = &amp;trmalloc;
  <B><FONT COLOR="#228B22">int</FONT></B> bsize = <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_htsboundary);

  assertf(adr != NULL);
  <B><FONT COLOR="#A020F0">if</FONT></B> (!adr) {
    <B><FONT COLOR="#A020F0">return</FONT></B>;
  }
  htsLocker(mallocMutex, 1);
  <B><FONT COLOR="#A020F0">while</FONT></B>(lnk-&gt;next != NULL) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (lnk-&gt;next-&gt;adr == adr) {
      mlink *blk_free = lnk-&gt;next;

      assertf(blk_free-&gt;id != -1);
      assertf(*((t_htsboundary *) ((<B><FONT COLOR="#228B22">char</FONT></B> *) adr - bsize)) == htsboundary);
      assertf(*((t_htsboundary *) ((<B><FONT COLOR="#228B22">char</FONT></B> *) adr + blk_free-&gt;len)) ==
              htsboundary);
      lnk-&gt;next = lnk-&gt;next-&gt;next;
      free((<B><FONT COLOR="#228B22">void</FONT></B> *) blk_free);
      <I><FONT COLOR="#B22222">//blk_free-&gt;id=-1;
</FONT></I>      free((<B><FONT COLOR="#228B22">char</FONT></B> *) adr - bsize);
      htsLocker(mallocMutex, 0);
      <B><FONT COLOR="#A020F0">return</FONT></B>;
    }
    lnk = lnk-&gt;next;
    assertf(lnk-&gt;next != NULL);
  }
  free(adr);
  htsLocker(mallocMutex, 0);
}
<B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#0000FF">hts_realloc</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B> *adr, size_t len) {
  <B><FONT COLOR="#228B22">int</FONT></B> bsize = <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_htsboundary);

  len += ((bsize - (len % bsize)) % bsize);     <I><FONT COLOR="#B22222">/* check alignement */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (adr != NULL) {
    mlink *lnk = &amp;trmalloc;

    htsLocker(mallocMutex, 1);
    <B><FONT COLOR="#A020F0">while</FONT></B>(lnk-&gt;next != NULL) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (lnk-&gt;next-&gt;adr == adr) {
        {
          mlink *blk_free = lnk-&gt;next;

          assertf(blk_free-&gt;id != -1);
          assertf(*((t_htsboundary *) ((<B><FONT COLOR="#228B22">char</FONT></B> *) adr - bsize)) == htsboundary);
          assertf(*((t_htsboundary *) ((<B><FONT COLOR="#228B22">char</FONT></B> *) adr + blk_free-&gt;len)) ==
                  htsboundary);
        }
        adr = realloc((<B><FONT COLOR="#228B22">char</FONT></B> *) adr - bsize, len + bsize * 2);
        assertf(adr != NULL);
        lnk-&gt;next-&gt;adr = (<B><FONT COLOR="#228B22">char</FONT></B> *) adr + bsize;
        lnk-&gt;next-&gt;len = len;
        *((t_htsboundary *) ((<B><FONT COLOR="#228B22">char</FONT></B> *) adr))
          = *((t_htsboundary *) ((<B><FONT COLOR="#228B22">char</FONT></B> *) adr + len + bsize))
          = htsboundary;
        htsLocker(mallocMutex, 0);
        <B><FONT COLOR="#A020F0">return</FONT></B> (<B><FONT COLOR="#228B22">char</FONT></B> *) adr + bsize;
      }
      lnk = lnk-&gt;next;
      assertf(lnk-&gt;next != NULL);
    }
    htsLocker(mallocMutex, 0);
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> hts_malloc(len);
}
mlink *<B><FONT COLOR="#0000FF">hts_find</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *adr) {
  <B><FONT COLOR="#228B22">char</FONT></B> *stkframe = (<B><FONT COLOR="#228B22">char</FONT></B> *) &amp;stkframe;
  mlink *lnk = &amp;trmalloc;
  <B><FONT COLOR="#228B22">int</FONT></B> bsize = <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_htsboundary);

  assertf(adr != NULL);
  <B><FONT COLOR="#A020F0">if</FONT></B> (!adr) {
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  }
  htsLocker(mallocMutex, 1);
  <B><FONT COLOR="#A020F0">while</FONT></B>(lnk-&gt;next != NULL) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (adr &gt;= lnk-&gt;next-&gt;adr &amp;&amp; adr &lt;= lnk-&gt;next-&gt;adr + lnk-&gt;next-&gt;len) {      <I><FONT COLOR="#B22222">/* found */</FONT></I>
      htsLocker(mallocMutex, 0);
      <B><FONT COLOR="#A020F0">return</FONT></B> lnk-&gt;next;
    }
    lnk = lnk-&gt;next;
  }
  htsLocker(mallocMutex, 0);
  {
    <B><FONT COLOR="#228B22">int</FONT></B> depl = (<B><FONT COLOR="#228B22">int</FONT></B>) (adr - stkframe);

    <B><FONT COLOR="#A020F0">if</FONT></B> (depl &lt; 0)
      depl = -depl;
    <I><FONT COLOR="#B22222">//assertf(depl &lt; 512000);   /* near the stack frame.. doesn't look like malloc but stack variable */
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  }
}

<I><FONT COLOR="#B22222">// check the malloct() and calloct() trace stack
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_freeall</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#228B22">int</FONT></B> bsize = <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_htsboundary);

  <B><FONT COLOR="#A020F0">while</FONT></B>(trmalloc.next) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">MEMDEBUG</FONT>
    printf(<B><FONT COLOR="#BC8F8F">&quot;* block %d\t not released: at %d\t (%d\t bytes)\n&quot;</FONT></B>,
           trmalloc.next-&gt;id, trmalloc.next-&gt;adr, trmalloc.next-&gt;len);
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B> (trmalloc.next-&gt;id != -1) {
      free((<B><FONT COLOR="#228B22">char</FONT></B> *) trmalloc.next-&gt;adr - bsize);
    }
  }
}
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

<I><FONT COLOR="#B22222">// -- divers //
</FONT></I>
<I><FONT COLOR="#B22222">// cut path and project name
</FONT></I><I><FONT COLOR="#B22222">// patch also initial path
</FONT></I><B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">cut_path</FONT></B>(<B><FONT COLOR="#228B22">char</FONT></B> *fullpath, <B><FONT COLOR="#228B22">char</FONT></B> *path, <B><FONT COLOR="#228B22">char</FONT></B> *pname) {
  path[0] = pname[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
  <B><FONT COLOR="#A020F0">if</FONT></B> (strnotempty(fullpath)) {
    <B><FONT COLOR="#A020F0">if</FONT></B> ((fullpath[strlen(fullpath) - 1] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
        || (fullpath[strlen(fullpath) - 1] == <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>))
      fullpath[strlen(fullpath) - 1] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    <B><FONT COLOR="#A020F0">if</FONT></B> (strlen(fullpath) &gt; 1) {
      <B><FONT COLOR="#228B22">char</FONT></B> *a;

      <B><FONT COLOR="#A020F0">while</FONT></B>((a = strchr(fullpath, <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>)))
        *a = <B><FONT COLOR="#BC8F8F">'/'</FONT></B>;               <I><FONT COLOR="#B22222">// remplacer par /
</FONT></I>      a = fullpath + strlen(fullpath) - 2;
      <B><FONT COLOR="#A020F0">while</FONT></B>((*a != <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) &amp;&amp; (a &gt; fullpath))
        a--;
      <B><FONT COLOR="#A020F0">if</FONT></B> (*a == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>)
        a++;
      strcpybuff(pname, a);
      strncatbuff(path, fullpath, (<B><FONT COLOR="#228B22">int</FONT></B>) (a - fullpath));
    }
  }
}

<I><FONT COLOR="#B22222">// -- Gestion protocole ftp --
</FONT></I>
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ftp_available</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ftp_available</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;                     <I><FONT COLOR="#B22222">// ok!
</FONT></I>  <I><FONT COLOR="#B22222">//return 0;   // SOUS UNIX, PROBLEMESs
</FONT></I>}
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_debug_log_print</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *format, ...);

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> hts_dgb_init = 0;
<B><FONT COLOR="#228B22">static</FONT></B> FILE *hts_dgb_init_fp = NULL;
HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_debug</FONT></B>(<B><FONT COLOR="#228B22">int</FONT></B> level) {
  hts_dgb_init = level;
  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_dgb_init &gt; 0) {
    hts_debug_log_print(<B><FONT COLOR="#BC8F8F">&quot;hts_debug() called&quot;</FONT></B>);
  }
}

<B><FONT COLOR="#228B22">static</FONT></B> FILE *<B><FONT COLOR="#0000FF">hts_dgb_</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_dgb_init_fp == NULL) {
    <B><FONT COLOR="#A020F0">if</FONT></B> ((hts_dgb_init &amp; 0x80) == 0) {
      hts_dgb_init_fp = stderr;
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      hts_dgb_init_fp = FOPEN(<B><FONT COLOR="#BC8F8F">&quot;hts-debug.txt&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;wb&quot;</FONT></B>);
      <B><FONT COLOR="#A020F0">if</FONT></B> (hts_dgb_init_fp != NULL) {
        fprintf(hts_dgb_init_fp, <B><FONT COLOR="#BC8F8F">&quot;* Creating file\r\n&quot;</FONT></B>);
      }
    }
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> hts_dgb_init_fp;
}

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_debug_log_print</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *format, ...) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_dgb_init &gt; 0) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> error = errno;
    FILE *<B><FONT COLOR="#228B22">const</FONT></B> fp = hts_dgb_();
    va_list args;

    assertf(format != NULL);
    va_start(args, format);
    (<B><FONT COLOR="#228B22">void</FONT></B>) vfprintf(fp, format, args);
    va_end(args);
    fputs(<B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>, fp);
    fflush(fp);
    errno = error;
  }
}

HTSEXT_API <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>* <B><FONT COLOR="#0000FF">hts_version</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">return</FONT></B> HTTRACK_VERSIONID;
}

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">ssl_vulnerable</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *version) {
#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>
  <B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> match = <B><FONT COLOR="#BC8F8F">&quot;OpenSSL 1.0.1&quot;</FONT></B>;
  <B><FONT COLOR="#228B22">const</FONT></B> size_t match_len = strlen(match);
  <B><FONT COLOR="#A020F0">if</FONT></B> (version != NULL &amp;&amp; strncmp(version, match, match_len) == 0) {
    <I><FONT COLOR="#B22222">// CVE-2014-0160
</FONT></I>    <I><FONT COLOR="#B22222">// &quot;OpenSSL 1.0.1g 7 Apr 2014&quot;
</FONT></I>    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> minor = version[match_len];
    <B><FONT COLOR="#A020F0">return</FONT></B> minor == <B><FONT COLOR="#BC8F8F">' '</FONT></B> || ( minor &gt;= <B><FONT COLOR="#BC8F8F">'a'</FONT></B> &amp;&amp; minor &lt;= <B><FONT COLOR="#BC8F8F">'f'</FONT></B> );
  }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* user abort callback */</FONT></I>
htsErrorCallback htsCallbackErr = NULL;

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_set_error_callback</FONT></B>(htsErrorCallback handler) {
  htsCallbackErr = handler;
}

HTSEXT_API htsErrorCallback <B><FONT COLOR="#0000FF">hts_get_error_callback</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">return</FONT></B> htsCallbackErr;
}

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">default_coucal_asserthandler</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B> *arg, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>* exp, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>* file, <B><FONT COLOR="#228B22">int</FONT></B> line) {
  abortf_(exp, file, line);
}

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">get_loglevel_from_coucal</FONT></B>(coucal_loglevel level) {
  <B><FONT COLOR="#A020F0">switch</FONT></B>(level) {
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">coucal_log_critical</FONT></B>:
    <B><FONT COLOR="#A020F0">return</FONT></B> LOG_PANIC;
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">coucal_log_warning</FONT></B>:
    <B><FONT COLOR="#A020F0">return</FONT></B> LOG_WARNING;
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">coucal_log_info</FONT></B>:
    <B><FONT COLOR="#A020F0">return</FONT></B> LOG_INFO;
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">coucal_log_debug</FONT></B>:
    <B><FONT COLOR="#A020F0">return</FONT></B> LOG_DEBUG;
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">coucal_log_trace</FONT></B>:
    <B><FONT COLOR="#A020F0">return</FONT></B> LOG_TRACE;
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  <B><FONT COLOR="#5F9EA0">default</FONT></B>:
    <B><FONT COLOR="#A020F0">return</FONT></B> LOG_ERROR;
    <B><FONT COLOR="#A020F0">break</FONT></B>;
  }
}

<I><FONT COLOR="#B22222">/* log to default console */</FONT></I>
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">default_coucal_loghandler</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B> *arg, coucal_loglevel level, 
                                       <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>* format, va_list args) {

  <B><FONT COLOR="#A020F0">if</FONT></B> (level &lt;= coucal_log_warning) {
    fprintf(stderr, <B><FONT COLOR="#BC8F8F">&quot;** warning: &quot;</FONT></B>);
  }
  vfprintf(stderr, format, args);
  fprintf(stderr, <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>);
}

<I><FONT COLOR="#B22222">/* log to project log */</FONT></I>
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">htsopt_coucal_loghandler</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B> *arg, coucal_loglevel level, 
                                      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B>* format, va_list args) {
  httrackp *<B><FONT COLOR="#228B22">const</FONT></B> opt = (httrackp*) arg;
  <B><FONT COLOR="#A020F0">if</FONT></B> (opt != NULL &amp;&amp; opt-&gt;log != NULL) {
    hts_log_vprint(opt, get_loglevel_from_coucal(level), 
      format, args);
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    default_coucal_loghandler(NULL, level, format, args);
  }
}

<I><FONT COLOR="#B22222">/* attach hashtable logger to project log */</FONT></I>
<B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_set_hash_handler</FONT></B>(coucal hashtable, httrackp *opt) {
  <I><FONT COLOR="#B22222">/* Init hashtable default assertion handler. */</FONT></I>
  coucal_set_assert_handler(hashtable,
    htsopt_coucal_loghandler, 
    default_coucal_asserthandler,
    opt);
}

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> hts_init_ok = 0;
HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_init</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *dbg_env;

  <I><FONT COLOR="#B22222">/* */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_init_ok)
    <B><FONT COLOR="#A020F0">return</FONT></B> 1;
  hts_init_ok = 1;

  <I><FONT COLOR="#B22222">/* enable debugging ? */</FONT></I>
  dbg_env = getenv(<B><FONT COLOR="#BC8F8F">&quot;HTS_LOG&quot;</FONT></B>);
  <B><FONT COLOR="#A020F0">if</FONT></B> (dbg_env != NULL &amp;&amp; *dbg_env != 0) {
    <B><FONT COLOR="#228B22">int</FONT></B> level = 0;

    <B><FONT COLOR="#A020F0">if</FONT></B> (sscanf(dbg_env, <B><FONT COLOR="#BC8F8F">&quot;%d&quot;</FONT></B>, &amp;level) == 1) {
      hts_debug(level);
    }
  }

  hts_debug_log_print(<B><FONT COLOR="#BC8F8F">&quot;entering hts_init()&quot;</FONT></B>);   <I><FONT COLOR="#B22222">/* debug */</FONT></I>

  <I><FONT COLOR="#B22222">/* Init hashtable default assertion handler. */</FONT></I>
  coucal_set_global_assert_handler(default_coucal_loghandler, 
    default_coucal_asserthandler);

  <I><FONT COLOR="#B22222">/* Init threads (lazy init) */</FONT></I>
  htsthread_init();

  <I><FONT COLOR="#B22222">/* Ensure external modules are loaded */</FONT></I>
  hts_debug_log_print(<B><FONT COLOR="#BC8F8F">&quot;calling htspe_init()&quot;</FONT></B>);  <I><FONT COLOR="#B22222">/* debug */</FONT></I>
  htspe_init();                 <I><FONT COLOR="#B22222">/* module load (lazy) */</FONT></I>

  <I><FONT COLOR="#B22222">/* MD5 Auto-test */</FONT></I>
  {
    <B><FONT COLOR="#228B22">char</FONT></B> digest[32 + 2];
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *atest = <B><FONT COLOR="#BC8F8F">&quot;MD5 Checksum Autotest&quot;</FONT></B>;

    digest[0] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
    domd5mem(atest, strlen(atest), digest, 1);  <I><FONT COLOR="#B22222">/* a42ec44369da07ace5ec1d660ba4a69a */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (strcmp(digest, <B><FONT COLOR="#BC8F8F">&quot;a42ec44369da07ace5ec1d660ba4a69a&quot;</FONT></B>) != 0) {
      <B><FONT COLOR="#228B22">int</FONT></B> fatal_broken_md5 = 0;

      assertf(fatal_broken_md5);
    }
  }

  hts_debug_log_print(<B><FONT COLOR="#BC8F8F">&quot;initializing SSL&quot;</FONT></B>);      <I><FONT COLOR="#B22222">/* debug */</FONT></I>
#<B><FONT COLOR="#5F9EA0">if</FONT></B> <FONT COLOR="#B8860B">HTS_USEOPENSSL</FONT>
  <I><FONT COLOR="#B22222">/*
     Initialize the OpensSSL library
   */</FONT></I>
  <B><FONT COLOR="#A020F0">if</FONT></B> (!openssl_ctx) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *version;

    SSL_load_error_strings();
    SSL_library_init();

    <I><FONT COLOR="#B22222">// Check CVE-2014-0160.
</FONT></I>    version = SSLeay_version(SSLEAY_VERSION);
    <B><FONT COLOR="#A020F0">if</FONT></B> (ssl_vulnerable(version)) {
      fprintf(stderr,
              <B><FONT COLOR="#BC8F8F">&quot;SSLeay_version(SSLEAY_VERSION) == '%s'\n&quot;</FONT></B>, version);
      abortLog(<B><FONT COLOR="#BC8F8F">&quot;unable to initialize TLS: OpenSSL version seems vulnerable to heartbleed bug (CVE-2014-0160)&quot;</FONT></B>);
      assertf(<B><FONT COLOR="#BC8F8F">&quot;OpenSSL version seems vulnerable to heartbleed bug (CVE-2014-0160)&quot;</FONT></B> == NULL);
    }

    <I><FONT COLOR="#B22222">// OpenSSL_add_all_algorithms();
</FONT></I>    openssl_ctx = SSL_CTX_new(SSLv23_client_method());
    <B><FONT COLOR="#A020F0">if</FONT></B> (!openssl_ctx) {
      fprintf(stderr,
              <B><FONT COLOR="#BC8F8F">&quot;fatal: unable to initialize TLS: SSL_CTX_new(SSLv23_client_method)\n&quot;</FONT></B>);
      abortLog(<B><FONT COLOR="#BC8F8F">&quot;unable to initialize TLS: SSL_CTX_new(SSLv23_client_method)&quot;</FONT></B>);
      assertf(<B><FONT COLOR="#BC8F8F">&quot;unable to initialize TLS&quot;</FONT></B> == NULL);
    }
  }
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

  hts_debug_log_print(<B><FONT COLOR="#BC8F8F">&quot;ending hts_init()&quot;</FONT></B>);     <I><FONT COLOR="#B22222">/* debug */</FONT></I>
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}

<I><FONT COLOR="#B22222">/* will not free thread env. */</FONT></I>
HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_uninit</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <I><FONT COLOR="#B22222">/* hts_init() is a lazy initializer, with limited a allocation (one or two mutexes) ;
     we won't free anything here as the .h semantic was never being very clear */</FONT></I>
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}

HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_uninit_module</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (!hts_init_ok)
    <B><FONT COLOR="#A020F0">return</FONT></B> 1;
  htsthread_uninit();
  htspe_uninit();
  hts_init_ok = 0;
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}

<I><FONT COLOR="#B22222">// legacy. do not use
</FONT></I>HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_log</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *prefix, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *msg) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;log != NULL) {
    fspc(opt, opt-&gt;log, prefix);
    fprintf(opt-&gt;log, <B><FONT COLOR="#BC8F8F">&quot;%s&quot;</FONT></B> LF, msg);
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;                     <I><FONT COLOR="#B22222">/* Error */</FONT></I>
}

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#0000FF">void</FONT></B> (*hts_log_print_callback)(httrackp * opt, <B><FONT COLOR="#228B22">int</FONT></B> type, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *format, va_list args) = NULL;

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_set_log_vprint_callback</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B> (*callback)(httrackp * opt,
                                            <B><FONT COLOR="#228B22">int</FONT></B> type, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *format, va_list args)) {
  hts_log_print_callback = callback;
}

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_log_vprint</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">int</FONT></B> type, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *format, va_list args) {
  assertf(format != NULL);
  <B><FONT COLOR="#A020F0">if</FONT></B> (hts_log_print_callback != NULL) {
    va_list args_copy;
    va_copy(args_copy, args);
    hts_log_print_callback(opt, type, format, args);
    va_end(args_copy);
  }
  <B><FONT COLOR="#A020F0">if</FONT></B> (opt != NULL &amp;&amp; opt-&gt;log != NULL) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> save_errno = errno;
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s_type = <B><FONT COLOR="#BC8F8F">&quot;unknown&quot;</FONT></B>;
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> level = type &amp; 0xff;

    <I><FONT COLOR="#B22222">// Check log level
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;debug &lt; level) {
      <B><FONT COLOR="#A020F0">return</FONT></B>;
    }

    <B><FONT COLOR="#A020F0">switch</FONT></B> (level) {
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">LOG_TRACE</FONT></B>:
      s_type = <B><FONT COLOR="#BC8F8F">&quot;trace&quot;</FONT></B>;
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">LOG_DEBUG</FONT></B>:
      s_type = <B><FONT COLOR="#BC8F8F">&quot;debug&quot;</FONT></B>;
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">LOG_INFO</FONT></B>:
      s_type = <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>;
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">LOG_NOTICE</FONT></B>:
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">LOG_WARNING</FONT></B>:
      s_type = <B><FONT COLOR="#BC8F8F">&quot;warning&quot;</FONT></B>;
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">LOG_ERROR</FONT></B>:
      s_type = <B><FONT COLOR="#BC8F8F">&quot;error&quot;</FONT></B>;
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    <B><FONT COLOR="#A020F0">case</FONT></B> <B><FONT COLOR="#5F9EA0">LOG_PANIC</FONT></B>:
      s_type = <B><FONT COLOR="#BC8F8F">&quot;panic&quot;</FONT></B>;
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    }
    fspc(opt, opt-&gt;log, s_type);
    (<B><FONT COLOR="#228B22">void</FONT></B>) vfprintf(opt-&gt;log, format, args);
    <B><FONT COLOR="#A020F0">if</FONT></B> ((type &amp; LOG_ERRNO) != 0) {
      fprintf(opt-&gt;log, <B><FONT COLOR="#BC8F8F">&quot;: %s&quot;</FONT></B>, strerror(save_errno));
    }
    fputs(LF, opt-&gt;log);
    <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;flush) {
      fflush(opt-&gt;log);
    }
    errno = save_errno;
  }
}

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_log_print</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">int</FONT></B> type, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *format, ...) {
  va_list args;
  assertf(format != NULL);
  va_start(args, format);
  hts_log_vprint(opt, type, format, args);
  va_end(args);
}

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">set_wrappers</FONT></B>(httrackp * opt) {  <I><FONT COLOR="#B22222">// LEGACY
</FONT></I>}

HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">plug_wrapper</FONT></B>(httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *moduleName,
                            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *argv) {
  <B><FONT COLOR="#228B22">void</FONT></B> *handle = openFunctionLib(moduleName);

  <B><FONT COLOR="#A020F0">if</FONT></B> (handle != NULL) {
    t_hts_plug plug = (t_hts_plug) getFunctionPtr(handle, <B><FONT COLOR="#BC8F8F">&quot;hts_plug&quot;</FONT></B>);
    t_hts_unplug unplug = (t_hts_unplug) getFunctionPtr(handle, <B><FONT COLOR="#BC8F8F">&quot;hts_unplug&quot;</FONT></B>);

    <B><FONT COLOR="#A020F0">if</FONT></B> (plug != NULL) {
      <B><FONT COLOR="#228B22">int</FONT></B> ret = plug(opt, argv);

      <B><FONT COLOR="#A020F0">if</FONT></B> (hts_dgb_init &gt; 0 &amp;&amp; opt-&gt;log != NULL) {
        hts_debug_log_print(<B><FONT COLOR="#BC8F8F">&quot;plugged module '%s' (return code=%d)&quot;</FONT></B>, moduleName,
                            ret);
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (ret == 1) {           <I><FONT COLOR="#B22222">/* Success! */</FONT></I>
        opt-&gt;libHandles.handles =
          (htslibhandle *) realloct(opt-&gt;libHandles.handles,
                                    (opt-&gt;libHandles.count +
                                     1) * <B><FONT COLOR="#A020F0">sizeof</FONT></B>(htslibhandle));
        opt-&gt;libHandles.handles[opt-&gt;libHandles.count].handle = handle;
        opt-&gt;libHandles.handles[opt-&gt;libHandles.count].moduleName =
          strdupt(moduleName);
        opt-&gt;libHandles.count++;
        <B><FONT COLOR="#A020F0">return</FONT></B> 1;
      } <B><FONT COLOR="#A020F0">else</FONT></B> {
        hts_debug_log_print
          (<B><FONT COLOR="#BC8F8F">&quot;* note: error while running entry point 'hts_plug' in %s&quot;</FONT></B>,
           moduleName);
        <B><FONT COLOR="#A020F0">if</FONT></B> (unplug)
          unplug(opt);
      }
    } <B><FONT COLOR="#A020F0">else</FONT></B> {
      <B><FONT COLOR="#228B22">int</FONT></B> last_errno = errno;

      hts_debug_log_print(<B><FONT COLOR="#BC8F8F">&quot;* note: can't find entry point 'hts_plug' in %s: %s&quot;</FONT></B>,
                          moduleName, strerror(last_errno));
    }
    closeFunctionLib(handle);
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <B><FONT COLOR="#228B22">int</FONT></B> last_errno = errno;

    hts_debug_log_print(<B><FONT COLOR="#BC8F8F">&quot;* note: can't load %s: %s&quot;</FONT></B>, moduleName,
                        strerror(last_errno));
  }
  <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}

<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">unplug_wrappers</FONT></B>(httrackp * opt) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;libHandles.handles != NULL) {
    <B><FONT COLOR="#228B22">int</FONT></B> i;

    <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; opt-&gt;libHandles.count; i++) {
      <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;libHandles.handles[i].handle != NULL) {
        <I><FONT COLOR="#B22222">/* hts_unplug(), the dll exit point (finalizer) */</FONT></I>
        t_hts_unplug unplug =
          (t_hts_unplug) getFunctionPtr(opt-&gt;libHandles.handles[i].handle,
                                        <B><FONT COLOR="#BC8F8F">&quot;hts_unplug&quot;</FONT></B>);
        <B><FONT COLOR="#A020F0">if</FONT></B> (unplug != NULL)
          unplug(opt);
        closeFunctionLib(opt-&gt;libHandles.handles[i].handle);
        opt-&gt;libHandles.handles[i].handle = NULL;
      }
      <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;libHandles.handles[i].moduleName != NULL) {
        freet(opt-&gt;libHandles.handles[i].moduleName);
        opt-&gt;libHandles.handles[i].moduleName = NULL;
      }
    }
    freet(opt-&gt;libHandles.handles);
    opt-&gt;libHandles.handles = NULL;
    opt-&gt;libHandles.count = 0;
  }
}

<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">multipleStringMatch</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *s, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *match) {
  <B><FONT COLOR="#228B22">int</FONT></B> ret = 0;
  String name = STRING_EMPTY;

  <B><FONT COLOR="#A020F0">if</FONT></B> (match == NULL || s == NULL || *s == 0)
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  <B><FONT COLOR="#A020F0">for</FONT></B>(; *match != 0; match++) {
    StringClear(name);
    <B><FONT COLOR="#A020F0">for</FONT></B>(; *match != 0 &amp;&amp; *match != <B><FONT COLOR="#BC8F8F">'\n'</FONT></B>; match++) {
      StringAddchar(name, *match);
    }
    <B><FONT COLOR="#A020F0">if</FONT></B> (StringLength(name) &gt; 0 &amp;&amp; strstr(s, StringBuff(name)) != NULL) {
      ret = 1;
      <B><FONT COLOR="#A020F0">break</FONT></B>;
    }
  }
  StringFree(name);
  <B><FONT COLOR="#A020F0">return</FONT></B> ret;
}

HTSEXT_API httrackp *<B><FONT COLOR="#0000FF">hts_create_opt</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
#<B><FONT COLOR="#5F9EA0">if</FONT></B> ( <B><FONT COLOR="#5F9EA0">defined</FONT></B>(<FONT COLOR="#B8860B">_WIN32</FONT>) || <B><FONT COLOR="#5F9EA0">defined</FONT></B>(<FONT COLOR="#B8860B">__ANDROID__</FONT>) )
  <B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *defaultModules[] = {
    <B><FONT COLOR="#BC8F8F">&quot;htsswf&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;htsjava&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;httrack-plugin&quot;</FONT></B>, NULL
  };
#<B><FONT COLOR="#5F9EA0">else</FONT></B>
  <B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *defaultModules[] = {
    <B><FONT COLOR="#BC8F8F">&quot;libhtsswf.so.1&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;libhtsjava.so.2&quot;</FONT></B>, <B><FONT COLOR="#BC8F8F">&quot;httrack-plugin&quot;</FONT></B>, NULL
  };
#<B><FONT COLOR="#5F9EA0">endif</FONT></B>
  httrackp *opt = malloc(<B><FONT COLOR="#A020F0">sizeof</FONT></B>(httrackp));

  <I><FONT COLOR="#B22222">/* default options */</FONT></I>
  memset(opt, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(httrackp));
  opt-&gt;size_httrackp = <B><FONT COLOR="#A020F0">sizeof</FONT></B>(httrackp);

  <I><FONT COLOR="#B22222">/* mutexes */</FONT></I>
  hts_mutexinit(&amp;opt-&gt;state.lock);

  <I><FONT COLOR="#B22222">/* custom wrappers */</FONT></I>
  opt-&gt;libHandles.count = 0;

  <I><FONT COLOR="#B22222">/* default settings */</FONT></I>

  opt-&gt;wizard = 2;              <I><FONT COLOR="#B22222">// wizard automatique
</FONT></I>  opt-&gt;quiet = 0;               <I><FONT COLOR="#B22222">// questions
</FONT></I>  <I><FONT COLOR="#B22222">//  
</FONT></I>  opt-&gt;travel = 0;              <I><FONT COLOR="#B22222">// même adresse
</FONT></I>  opt-&gt;depth = 9999;            <I><FONT COLOR="#B22222">// mirror total par défaut
</FONT></I>  opt-&gt;extdepth = 0;            <I><FONT COLOR="#B22222">// mais pas à l'extérieur
</FONT></I>  opt-&gt;seeker = 1;              <I><FONT COLOR="#B22222">// down 
</FONT></I>  opt-&gt;urlmode = 2;             <I><FONT COLOR="#B22222">// relatif par défaut
</FONT></I>  opt-&gt;no_type_change = 0;      <I><FONT COLOR="#B22222">// change file types
</FONT></I>  opt-&gt;debug = LOG_NOTICE;      <I><FONT COLOR="#B22222">// small log
</FONT></I>  opt-&gt;getmode = 3;             <I><FONT COLOR="#B22222">// linear scan
</FONT></I>  opt-&gt;maxsite = -1;            <I><FONT COLOR="#B22222">// taille max site (aucune)
</FONT></I>  opt-&gt;maxfile_nonhtml = -1;    <I><FONT COLOR="#B22222">// taille max fichier non html
</FONT></I>  opt-&gt;maxfile_html = -1;       <I><FONT COLOR="#B22222">// idem pour html
</FONT></I>  opt-&gt;maxsoc = 4;              <I><FONT COLOR="#B22222">// nbre socket max
</FONT></I>  opt-&gt;fragment = -1;           <I><FONT COLOR="#B22222">// pas de fragmentation
</FONT></I>  opt-&gt;nearlink = 0;            <I><FONT COLOR="#B22222">// ne pas prendre les liens non-html &quot;adjacents&quot;
</FONT></I>  opt-&gt;makeindex = 1;           <I><FONT COLOR="#B22222">// faire un index
</FONT></I>  opt-&gt;kindex = 0;              <I><FONT COLOR="#B22222">// index 'keyword'
</FONT></I>  opt-&gt;delete_old = 1;          <I><FONT COLOR="#B22222">// effacer anciens fichiers
</FONT></I>  opt-&gt;background_on_suspend = 1;       <I><FONT COLOR="#B22222">// Background the process if Control Z calls signal suspend.
</FONT></I>  opt-&gt;makestat = 0;            <I><FONT COLOR="#B22222">// pas de fichier de stats
</FONT></I>  opt-&gt;maketrack = 0;           <I><FONT COLOR="#B22222">// ni de tracking
</FONT></I>  opt-&gt;timeout = 120;           <I><FONT COLOR="#B22222">// timeout par défaut (2 minutes)
</FONT></I>  opt-&gt;cache = 1;               <I><FONT COLOR="#B22222">// cache prioritaire
</FONT></I>  opt-&gt;shell = 0;               <I><FONT COLOR="#B22222">// pas de shell par defaut
</FONT></I>  opt-&gt;proxy.active = 0;        <I><FONT COLOR="#B22222">// pas de proxy
</FONT></I>  opt-&gt;user_agent_send = 1;     <I><FONT COLOR="#B22222">// envoyer un user-agent
</FONT></I>  StringCopy(opt-&gt;user_agent,
             <B><FONT COLOR="#BC8F8F">&quot;Mozilla/4.5 (compatible; HTTrack 3.0x; Windows 98)&quot;</FONT></B>);
  StringCopy(opt-&gt;referer, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  StringCopy(opt-&gt;from, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  opt-&gt;savename_83 = 0;         <I><FONT COLOR="#B22222">// noms longs par défaut
</FONT></I>  opt-&gt;savename_type = 0;       <I><FONT COLOR="#B22222">// avec structure originale
</FONT></I>  opt-&gt;savename_delayed = 2;    <I><FONT COLOR="#B22222">// hard delayed type (default)
</FONT></I>  opt-&gt;delayed_cached = 1;      <I><FONT COLOR="#B22222">// cached delayed type (default)
</FONT></I>  opt-&gt;mimehtml = 0;            <I><FONT COLOR="#B22222">// pas MIME-html
</FONT></I>  opt-&gt;parsejava = HTSPARSE_DEFAULT;    <I><FONT COLOR="#B22222">// parser classes
</FONT></I>  opt-&gt;hostcontrol = 0;         <I><FONT COLOR="#B22222">// PAS de control host pour timeout et traffic jammer
</FONT></I>  opt-&gt;retry = 2;               <I><FONT COLOR="#B22222">// 2 retry par défaut
</FONT></I>  opt-&gt;errpage = 1;             <I><FONT COLOR="#B22222">// copier ou générer une page d'erreur en cas d'erreur (404 etc.)
</FONT></I>  opt-&gt;check_type = 1;          <I><FONT COLOR="#B22222">// vérifier type si inconnu (cgi,asp..) SAUF / considéré comme html
</FONT></I>  opt-&gt;all_in_cache = 0;        <I><FONT COLOR="#B22222">// ne pas tout stocker en cache
</FONT></I>  opt-&gt;robots = 2;              <I><FONT COLOR="#B22222">// traiter les robots.txt
</FONT></I>  opt-&gt;external = 0;            <I><FONT COLOR="#B22222">// liens externes normaux
</FONT></I>  opt-&gt;passprivacy = 0;         <I><FONT COLOR="#B22222">// mots de passe dans les fichiers
</FONT></I>  opt-&gt;includequery = 1;        <I><FONT COLOR="#B22222">// include query-string par défaut
</FONT></I>  opt-&gt;mirror_first_page = 0;   <I><FONT COLOR="#B22222">// pas mode mirror links
</FONT></I>  opt-&gt;accept_cookie = 1;       <I><FONT COLOR="#B22222">// gérer les cookies
</FONT></I>  opt-&gt;cookie = NULL;
  opt-&gt;http10 = 0;              <I><FONT COLOR="#B22222">// laisser http/1.1
</FONT></I>  opt-&gt;nokeepalive = 0;         <I><FONT COLOR="#B22222">// pas keep-alive
</FONT></I>  opt-&gt;nocompression = 0;       <I><FONT COLOR="#B22222">// pas de compression
</FONT></I>  opt-&gt;tolerant = 0;            <I><FONT COLOR="#B22222">// ne pas accepter content-length incorrect
</FONT></I>  opt-&gt;parseall = 1;            <I><FONT COLOR="#B22222">// tout parser (tags inconnus, par exemple)
</FONT></I>  opt-&gt;parsedebug = 0;          <I><FONT COLOR="#B22222">// pas de mode débuggage
</FONT></I>  opt-&gt;norecatch = 0;           <I><FONT COLOR="#B22222">// ne pas reprendre les fichiers effacés par l'utilisateur
</FONT></I>  opt-&gt;verbosedisplay = 0;      <I><FONT COLOR="#B22222">// pas d'animation texte
</FONT></I>  opt-&gt;sizehack = 0;            <I><FONT COLOR="#B22222">// size hack
</FONT></I>  opt-&gt;urlhack = 1;             <I><FONT COLOR="#B22222">// url hack (normalizer)
</FONT></I>  StringCopy(opt-&gt;footer, HTS_DEFAULT_FOOTER);
  opt-&gt;ftp_proxy = 1;           <I><FONT COLOR="#B22222">// proxy http pour ftp
</FONT></I>  opt-&gt;convert_utf8 = 1;        <I><FONT COLOR="#B22222">// convert html to UTF-8
</FONT></I>  StringCopy(opt-&gt;filelist, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  StringCopy(opt-&gt;lang_iso, <B><FONT COLOR="#BC8F8F">&quot;en, *&quot;</FONT></B>);
  StringCopy(opt-&gt;accept,
    <B><FONT COLOR="#BC8F8F">&quot;text/html,image/png,image/jpeg,image/pjpeg,image/x-xbitmap,image/svg+xml,image/gif;q=0.9,*/*;q=0.1&quot;</FONT></B>);
  StringCopy(opt-&gt;headers, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  StringCopy(opt-&gt;mimedefs, <B><FONT COLOR="#BC8F8F">&quot;\n&quot;</FONT></B>);      <I><FONT COLOR="#B22222">// aucun filtre mime (\n IMPORTANT)
</FONT></I>  StringClear(opt-&gt;mod_blacklist);
  <I><FONT COLOR="#B22222">//
</FONT></I>  opt-&gt;log = stdout;
  opt-&gt;errlog = stderr;
  opt-&gt;flush = 1;               <I><FONT COLOR="#B22222">// flush sur les fichiers log
</FONT></I>  <I><FONT COLOR="#B22222">//opt-&gt;aff_progress=0;
</FONT></I>  opt-&gt;keyboard = 0;
  <I><FONT COLOR="#B22222">//
</FONT></I>  StringCopy(opt-&gt;path_html, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  StringCopy(opt-&gt;path_html_utf8, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  StringCopy(opt-&gt;path_log, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  StringCopy(opt-&gt;path_bin, <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>);
  <I><FONT COLOR="#B22222">//
</FONT></I>  opt-&gt;maxlink = 100000;        <I><FONT COLOR="#B22222">// 100,000 liens max par défaut
</FONT></I>  opt-&gt;maxfilter = 200;         <I><FONT COLOR="#B22222">// 200 filtres max par défaut
</FONT></I>  opt-&gt;maxcache = 1048576 * 32; <I><FONT COLOR="#B22222">// a peu près 32Mo en cache max -- OPTION NON PARAMETRABLE POUR L'INSTANT --
</FONT></I>  <I><FONT COLOR="#B22222">//opt-&gt;maxcache_anticipate=256;  // maximum de liens à anticiper
</FONT></I>  opt-&gt;maxtime = -1;            <I><FONT COLOR="#B22222">// temps max en secondes
</FONT></I>  opt-&gt;maxrate = 25000;         <I><FONT COLOR="#B22222">// taux maxi
</FONT></I>  opt-&gt;maxconn = 5.0;           <I><FONT COLOR="#B22222">// nombre connexions/s
</FONT></I>  opt-&gt;waittime = -1;           <I><FONT COLOR="#B22222">// wait until.. hh*3600+mm*60+ss
</FONT></I>  <I><FONT COLOR="#B22222">//
</FONT></I>  opt-&gt;exec = <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>;
  opt-&gt;is_update = 0;           <I><FONT COLOR="#B22222">// not an update (yet)
</FONT></I>  opt-&gt;dir_topindex = 0;        <I><FONT COLOR="#B22222">// do not built top index (yet)
</FONT></I>  <I><FONT COLOR="#B22222">//
</FONT></I>  opt-&gt;bypass_limits = 0;       <I><FONT COLOR="#B22222">// enforce limits by default
</FONT></I>  opt-&gt;state.stop = 0;          <I><FONT COLOR="#B22222">// stopper
</FONT></I>  opt-&gt;state.exit_xh = 0;       <I><FONT COLOR="#B22222">// abort
</FONT></I>  <I><FONT COLOR="#B22222">//
</FONT></I>  opt-&gt;state.is_ended = 0;

  <I><FONT COLOR="#B22222">/* Alocated buffers */</FONT></I>

  opt-&gt;callbacks_fun =
    (t_hts_htmlcheck_callbacks *) malloct(<B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_hts_htmlcheck_callbacks));
  memset(opt-&gt;callbacks_fun, 0, <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_hts_htmlcheck_callbacks));

  <I><FONT COLOR="#B22222">/* Preload callbacks : java and flash parser, and the automatic user-defined callback */</FONT></I>

  {
    <B><FONT COLOR="#228B22">int</FONT></B> i;

    <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; defaultModules[i] != NULL; i++) {
      <B><FONT COLOR="#228B22">int</FONT></B> ret = plug_wrapper(opt, defaultModules[i], defaultModules[i]);

      <B><FONT COLOR="#A020F0">if</FONT></B> (ret == 0) {           <I><FONT COLOR="#B22222">/* Module aborted initialization */</FONT></I>
        <I><FONT COLOR="#B22222">/* Ignored. */</FONT></I>
      }
    }
  }

  <B><FONT COLOR="#A020F0">return</FONT></B> opt;
}

HTSEXT_API size_t <B><FONT COLOR="#0000FF">hts_sizeof_opt</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">return</FONT></B> <B><FONT COLOR="#A020F0">sizeof</FONT></B>(httrackp);
}

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_free_opt</FONT></B>(httrackp * opt) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (opt != NULL) {

    <I><FONT COLOR="#B22222">/* Alocated callbacks */</FONT></I>

    <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;callbacks_fun != NULL) {
      <B><FONT COLOR="#228B22">int</FONT></B> i;
      t_hts_htmlcheck_callbacks_item *items =
        (t_hts_htmlcheck_callbacks_item *) opt-&gt;callbacks_fun;
      <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> size =
        (<B><FONT COLOR="#228B22">int</FONT></B>) <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_hts_htmlcheck_callbacks) /
        <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_hts_htmlcheck_callbacks_item);
      assertf(<B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_hts_htmlcheck_callbacks_item) * size ==
              <B><FONT COLOR="#A020F0">sizeof</FONT></B>(t_hts_htmlcheck_callbacks));

      <I><FONT COLOR="#B22222">/* Free all linked lists */</FONT></I>
      <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; i &lt; size; i++) {
        t_hts_callbackarg *carg, *next_carg;

        <B><FONT COLOR="#A020F0">for</FONT></B>(carg = items[i].carg;
            carg != NULL &amp;&amp; (next_carg = carg-&gt;prev.carg, carg != NULL);
            carg = next_carg) {
          hts_free(carg);
        }
      }

      freet(opt-&gt;callbacks_fun);
      opt-&gt;callbacks_fun = NULL;
    }

    <I><FONT COLOR="#B22222">/* Close library handles */</FONT></I>
    unplug_wrappers(opt);

    <I><FONT COLOR="#B22222">/* Cache */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;state.dns_cache != NULL) {
      t_dnscache *root;

      hts_mutexlock(&amp;opt-&gt;state.lock);
      root = opt-&gt;state.dns_cache;
      opt-&gt;state.dns_cache = NULL;
      hts_mutexrelease(&amp;opt-&gt;state.lock);

      hts_cache_free(root);
    }

    <I><FONT COLOR="#B22222">/* Cancel chain */</FONT></I>
    <B><FONT COLOR="#A020F0">if</FONT></B> (opt-&gt;state.cancel != NULL) {
      htsoptstatecancel *cancel;

      <B><FONT COLOR="#A020F0">for</FONT></B>(cancel = opt-&gt;state.cancel; cancel != NULL;) {
        htsoptstatecancel *next = cancel-&gt;next;

        <B><FONT COLOR="#A020F0">if</FONT></B> (cancel-&gt;url != NULL) {
          freet(cancel-&gt;url);
        }
        freet(cancel);
        cancel = next;
      }
      opt-&gt;state.cancel = NULL;
    }

    <I><FONT COLOR="#B22222">/* Free strings */</FONT></I>

    StringFree(opt-&gt;proxy.name);
    StringFree(opt-&gt;proxy.bindhost);

    StringFree(opt-&gt;savename_userdef);
    StringFree(opt-&gt;user_agent);
    StringFree(opt-&gt;referer);
    StringFree(opt-&gt;from);
    StringFree(opt-&gt;lang_iso);
    StringFree(opt-&gt;sys_com);
    StringFree(opt-&gt;mimedefs);
    StringFree(opt-&gt;filelist);
    StringFree(opt-&gt;urllist);
    StringFree(opt-&gt;footer);
    StringFree(opt-&gt;mod_blacklist);

    StringFree(opt-&gt;path_html);
    StringFree(opt-&gt;path_html_utf8);
    StringFree(opt-&gt;path_log);
    StringFree(opt-&gt;path_bin);

    <I><FONT COLOR="#B22222">/* mutexes */</FONT></I>
    hts_mutexfree(&amp;opt-&gt;state.lock);

    <I><FONT COLOR="#B22222">/* Free structure */</FONT></I>
    free(opt);
  }
}

<I><FONT COLOR="#B22222">// TEMPORARY - PUT THIS STRUCTURE INSIDE httrackp !
</FONT></I><B><FONT COLOR="#228B22">const</FONT></B> hts_stat_struct* <B><FONT COLOR="#0000FF">hts_get_stats</FONT></B>(httrackp * opt) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (opt == NULL) {
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  }

  HTS_STAT.stat_nsocket = 0;
  HTS_STAT.stat_errors = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;error&quot;</FONT></B>);
  HTS_STAT.stat_warnings = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;warning&quot;</FONT></B>);
  HTS_STAT.stat_infos = fspc(opt, NULL, <B><FONT COLOR="#BC8F8F">&quot;info&quot;</FONT></B>);
  HTS_STAT.nbk = 0;
  HTS_STAT.nb = 0;

  <B><FONT COLOR="#A020F0">return</FONT></B> &amp;HTS_STAT;
}

<I><FONT COLOR="#B22222">// defaut wrappers
</FONT></I><B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_init</FONT></B>(t_hts_callbackarg * carg) {
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_uninit</FONT></B>(t_hts_callbackarg * carg) {
  <I><FONT COLOR="#B22222">// hts_freevar();
</FONT></I>}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_start</FONT></B>(t_hts_callbackarg * carg, httrackp * opt) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_chopt</FONT></B>(t_hts_callbackarg * carg, httrackp * opt) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_end</FONT></B>(t_hts_callbackarg * carg, httrackp * opt) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_preprocesshtml</FONT></B>(t_hts_callbackarg * carg,
                                             httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> **html,
                                             <B><FONT COLOR="#228B22">int</FONT></B> *len, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *url_adresse,
                                             <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *url_fichier) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_postprocesshtml</FONT></B>(t_hts_callbackarg * carg,
                                              httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> **html,
                                              <B><FONT COLOR="#228B22">int</FONT></B> *len, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *url_adresse,
                                              <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *url_fichier) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_checkhtml</FONT></B>(t_hts_callbackarg * carg,
                                        httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> *html, <B><FONT COLOR="#228B22">int</FONT></B> len,
                                        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *url_adresse,
                                        <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *url_fichier) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_loop</FONT></B>(t_hts_callbackarg * carg, httrackp * opt, lien_back * back, <B><FONT COLOR="#228B22">int</FONT></B> back_max, <B><FONT COLOR="#228B22">int</FONT></B> back_index, <B><FONT COLOR="#228B22">int</FONT></B> lien_n, <B><FONT COLOR="#228B22">int</FONT></B> lien_tot, <B><FONT COLOR="#228B22">int</FONT></B> stat_time, hts_stat_struct * stats) {        <I><FONT COLOR="#B22222">// appelé à chaque boucle de HTTrack
</FONT></I>  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *__cdecl <B><FONT COLOR="#0000FF">htsdefault_query</FONT></B>(t_hts_callbackarg * carg,
                                            httrackp * opt,
                                            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *question) {
  <B><FONT COLOR="#A020F0">return</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *__cdecl <B><FONT COLOR="#0000FF">htsdefault_query2</FONT></B>(t_hts_callbackarg * carg,
                                             httrackp * opt,
                                             <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *question) {
  <B><FONT COLOR="#A020F0">return</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *__cdecl <B><FONT COLOR="#0000FF">htsdefault_query3</FONT></B>(t_hts_callbackarg * carg,
                                             httrackp * opt,
                                             <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *question) {
  <B><FONT COLOR="#A020F0">return</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;&quot;</FONT></B>;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_check</FONT></B>(t_hts_callbackarg * carg, httrackp * opt,
                                    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil,
                                    <B><FONT COLOR="#228B22">int</FONT></B> status) {
  <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_check_mime</FONT></B>(t_hts_callbackarg * carg,
                                         httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr,
                                         <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *mime,
                                         <B><FONT COLOR="#228B22">int</FONT></B> status) {
  <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_pause</FONT></B>(t_hts_callbackarg * carg, httrackp * opt,
                                     <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *lockfile) {
  <B><FONT COLOR="#A020F0">while</FONT></B>(fexist(lockfile)) {
    Sleep(1000);
  }
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_filesave</FONT></B>(t_hts_callbackarg * carg,
                                        httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *file) {
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_filesave2</FONT></B>(t_hts_callbackarg * carg,
                                         httrackp * opt, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr,
                                         <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *file, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *sav,
                                         <B><FONT COLOR="#228B22">int</FONT></B> is_new, <B><FONT COLOR="#228B22">int</FONT></B> is_modified,
                                         <B><FONT COLOR="#228B22">int</FONT></B> not_updated) {
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_linkdetected</FONT></B>(t_hts_callbackarg * carg,
                                           httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> *link) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_linkdetected2</FONT></B>(t_hts_callbackarg * carg,
                                            httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> *link,
                                            <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *start_tag) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_xfrstatus</FONT></B>(t_hts_callbackarg * carg,
                                        httrackp * opt, lien_back * back) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_savename</FONT></B>(t_hts_callbackarg * carg, httrackp * opt,
                                       <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr_complete,
                                       <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil_complete,
                                       <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *referer_adr,
                                       <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *referer_fil, <B><FONT COLOR="#228B22">char</FONT></B> *save) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_sendhead</FONT></B>(t_hts_callbackarg * carg, httrackp * opt,
                                       <B><FONT COLOR="#228B22">char</FONT></B> *buff, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr,
                                       <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *referer_adr,
                                       <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *referer_fil,
                                       htsblk * outgoing) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_receivehead</FONT></B>(t_hts_callbackarg * carg,
                                          httrackp * opt, <B><FONT COLOR="#228B22">char</FONT></B> *buff,
                                          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *adr, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *fil,
                                          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *referer_adr,
                                          <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *referer_fil,
                                          htsblk * incoming) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 1;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_detect</FONT></B>(t_hts_callbackarg * carg, httrackp * opt,
                                     htsmoduleStruct * str) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> __cdecl <B><FONT COLOR="#0000FF">htsdefault_parse</FONT></B>(t_hts_callbackarg * carg, httrackp * opt,
                                    htsmoduleStruct * str) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

<I><FONT COLOR="#B22222">/* Default internal dummy callbacks */</FONT></I>
<B><FONT COLOR="#228B22">const</FONT></B> t_hts_htmlcheck_callbacks default_callbacks = {
  {htsdefault_init, NULL},
  {htsdefault_uninit, NULL},
  {htsdefault_start, NULL},
  {htsdefault_end, NULL},
  {htsdefault_chopt, NULL},
  {htsdefault_preprocesshtml, NULL},
  {htsdefault_postprocesshtml, NULL},
  {htsdefault_checkhtml, NULL},
  {htsdefault_query, NULL},
  {htsdefault_query2, NULL},
  {htsdefault_query3, NULL},
  {htsdefault_loop, NULL},
  {htsdefault_check, NULL},
  {htsdefault_check_mime, NULL},
  {htsdefault_pause, NULL},
  {htsdefault_filesave, NULL},
  {htsdefault_filesave2, NULL},
  {htsdefault_linkdetected, NULL},
  {htsdefault_linkdetected2, NULL},
  {htsdefault_xfrstatus, NULL},
  {htsdefault_savename, NULL},
  {htsdefault_sendhead, NULL},
  {htsdefault_receivehead, NULL},
  {htsdefault_detect, NULL},
  {htsdefault_parse, NULL}
};

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CALLBACK_OP</FONT></B>(CB, NAME, OPERATION, S, FUN) do {   \
  if (strcmp(NAME, S) == 0) {                           \
    OPERATION(t_hts_htmlcheck_ ##FUN, (CB)-&gt;FUN.fun);   \
  }                                                     \
} while(0)

#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">DISPATCH_CALLBACK</FONT></B>(CB, NAME, OPERATION) do { \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;init&quot;</FONT></B>, init); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;free&quot;</FONT></B>, uninit); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;start&quot;</FONT></B>, start); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;end&quot;</FONT></B>, end); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;change-options&quot;</FONT></B>, chopt); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;preprocess-html&quot;</FONT></B>, preprocess); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;postprocess-html&quot;</FONT></B>, postprocess); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;check-html&quot;</FONT></B>, check_html); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;query&quot;</FONT></B>, query); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;query2&quot;</FONT></B>, query2); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;query3&quot;</FONT></B>, query3); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;loop&quot;</FONT></B>, loop); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;check-link&quot;</FONT></B>, check_link); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;check-mime&quot;</FONT></B>, check_mime); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;pause&quot;</FONT></B>, pause); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;save-file&quot;</FONT></B>, filesave); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;save-file2&quot;</FONT></B>, filesave2); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;link-detected&quot;</FONT></B>, linkdetected); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;link-detected2&quot;</FONT></B>, linkdetected2); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;transfer-status&quot;</FONT></B>, xfrstatus); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;save-name&quot;</FONT></B>, savename); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;send-header&quot;</FONT></B>, sendhead); \
  CALLBACK_OP(CB, NAME, OPERATION, <B><FONT COLOR="#BC8F8F">&quot;receive-header&quot;</FONT></B>, receivehead); \
} while(0)

<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_set_callback</FONT></B>(t_hts_htmlcheck_callbacks * callbacks, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *name,
                     <B><FONT COLOR="#228B22">void</FONT></B> *function) {
  <B><FONT COLOR="#228B22">int</FONT></B> error = 1;
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CALLBACK_OPERATION</FONT></B>(TYPE, FUNCTION) do { \
    FUNCTION = (TYPE) function;                 \
    error = 0;                                  \
  } while(0)
  DISPATCH_CALLBACK(callbacks, name, CALLBACK_OPERATION);
#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">CALLBACK_OPERATION</FONT>
  <B><FONT COLOR="#A020F0">return</FONT></B> error;
}

<B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#0000FF">hts_get_callback</FONT></B>(t_hts_htmlcheck_callbacks * callbacks, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *name) {
#<B><FONT COLOR="#5F9EA0">define</FONT></B> <B><FONT COLOR="#0000FF">CALLBACK_OPERATION</FONT></B>(TYPE, FUNCTION) do { \
    return (void*) FUNCTION;                    \
  } while(0)
  DISPATCH_CALLBACK(callbacks, name, CALLBACK_OPERATION);
#<B><FONT COLOR="#5F9EA0">undef</FONT></B> <FONT COLOR="#B8860B">CALLBACK_OPERATION</FONT>
  <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
}

<I><FONT COLOR="#B22222">// end defaut wrappers
</FONT></I>
<I><FONT COLOR="#B22222">/* libc stubs */</FONT></I>

HTSEXT_API <B><FONT COLOR="#228B22">char</FONT></B> *<B><FONT COLOR="#0000FF">hts_strdup</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *str) {
  <B><FONT COLOR="#A020F0">return</FONT></B> strdup(str);
}

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#0000FF">hts_malloc</FONT></B>(size_t size) {
  <B><FONT COLOR="#A020F0">return</FONT></B> malloc(size);
}

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#0000FF">hts_realloc</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B> *<B><FONT COLOR="#228B22">const</FONT></B> data, <B><FONT COLOR="#228B22">const</FONT></B> size_t size) {
  <B><FONT COLOR="#A020F0">return</FONT></B> realloc(data, size);
}

HTSEXT_API <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">hts_free</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B> *data) {
  free(data);
}

<I><FONT COLOR="#B22222">/* Dummy functions */</FONT></I>
HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_resetvar</FONT></B>(<B><FONT COLOR="#228B22">void</FONT></B>) {
  <B><FONT COLOR="#A020F0">return</FONT></B> 0;
}

#<B><FONT COLOR="#5F9EA0">ifdef</FONT></B> <FONT COLOR="#B8860B">_WIN32</FONT>

<B><FONT COLOR="#228B22">typedef</FONT></B> <B><FONT COLOR="#228B22">struct</FONT></B> dirent dirent;
DIR *<B><FONT COLOR="#0000FF">opendir</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *name) {
  WIN32_FILE_ATTRIBUTE_DATA st;
  DIR *dir;
  size_t len;
  <B><FONT COLOR="#228B22">int</FONT></B> i;

  <B><FONT COLOR="#A020F0">if</FONT></B> (name == NULL || *name == <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>) {
    errno = ENOENT;
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  }
  <B><FONT COLOR="#A020F0">if</FONT></B> (!GetFileAttributesEx(name, GetFileExInfoStandard, &amp;st)
      || (st.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY) == 0) {
    errno = ENOENT;
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  }
  dir = calloc(<B><FONT COLOR="#A020F0">sizeof</FONT></B>(DIR), 1);
  <B><FONT COLOR="#A020F0">if</FONT></B> (dir == NULL) {
    errno = ENOMEM;
    <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
  }
  len = strlen(name);
  dir-&gt;h = INVALID_HANDLE_VALUE;
  dir-&gt;name = malloc(len + 2 + 1);
  strcpy(dir-&gt;name, name);
  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; dir-&gt;name[i] != <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>; i++) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (dir-&gt;name[i] == <B><FONT COLOR="#BC8F8F">'/'</FONT></B>) {
      dir-&gt;name[i] = <B><FONT COLOR="#BC8F8F">'\\'</FONT></B>;
    }
  }
  strcat(dir-&gt;name, <B><FONT COLOR="#BC8F8F">&quot;\\*&quot;</FONT></B>);
  <B><FONT COLOR="#A020F0">return</FONT></B> dir;
}

<B><FONT COLOR="#228B22">struct</FONT></B> dirent *<B><FONT COLOR="#0000FF">readdir</FONT></B>(DIR * dir) {
  WIN32_FIND_DATAA find;

  <B><FONT COLOR="#A020F0">if</FONT></B> (dir-&gt;h == INVALID_HANDLE_VALUE) {
    dir-&gt;h = FindFirstFileA(dir-&gt;name, &amp;find);
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <B><FONT COLOR="#A020F0">if</FONT></B> (!FindNextFile(dir-&gt;h, &amp;find)) {
      FindClose(dir-&gt;h);
      dir-&gt;h = INVALID_HANDLE_VALUE;
    }
  }
  <B><FONT COLOR="#A020F0">if</FONT></B> (dir-&gt;h != INVALID_HANDLE_VALUE) {
    dir-&gt;entry.d_name[0] = 0;
    strncat(dir-&gt;entry.d_name, find.cFileName, HTS_DIRENT_SIZE - 1);
    <B><FONT COLOR="#A020F0">return</FONT></B> &amp;dir-&gt;entry;
  }
  errno = ENOENT;
  <B><FONT COLOR="#A020F0">return</FONT></B> NULL;
}

<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">closedir</FONT></B>(DIR * dir) {
  <B><FONT COLOR="#A020F0">if</FONT></B> (dir != NULL) {
    <B><FONT COLOR="#A020F0">if</FONT></B> (dir-&gt;h != INVALID_HANDLE_VALUE) {
      CloseHandle(dir-&gt;h);
    }
    <B><FONT COLOR="#A020F0">if</FONT></B> (dir-&gt;name != NULL) {
      free(dir-&gt;name);
    }
    free(dir);
    <B><FONT COLOR="#A020F0">return</FONT></B> 0;
  }
  errno = EBADF;
  <B><FONT COLOR="#A020F0">return</FONT></B> -1;
}

<I><FONT COLOR="#B22222">// UTF-8 aware FILE API
</FONT></I>
<B><FONT COLOR="#228B22">static</FONT></B> <B><FONT COLOR="#228B22">void</FONT></B> <B><FONT COLOR="#0000FF">copyWchar</FONT></B>(LPWSTR dest, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *src) {
  <B><FONT COLOR="#228B22">int</FONT></B> i;

  <B><FONT COLOR="#A020F0">for</FONT></B>(i = 0; src[i]; i++) {
    dest[i] = src[i];
  }
  dest[i] = <B><FONT COLOR="#BC8F8F">'\0'</FONT></B>;
}

FILE *<B><FONT COLOR="#0000FF">hts_fopen_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *path, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *mode) {
  WCHAR wmode[32];
  LPWSTR wpath = hts_convertUTF8StringToUCS2(path, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(path), NULL);

  assertf(strlen(mode) &lt; <B><FONT COLOR="#A020F0">sizeof</FONT></B>(wmode) / <B><FONT COLOR="#A020F0">sizeof</FONT></B>(WCHAR));
  copyWchar(wmode, mode);
  <B><FONT COLOR="#A020F0">if</FONT></B> (wpath != NULL) {
    FILE *<B><FONT COLOR="#228B22">const</FONT></B> fp = _wfopen(wpath, wmode);

    free(wpath);
    <B><FONT COLOR="#A020F0">return</FONT></B> fp;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <I><FONT COLOR="#B22222">// Fallback on conversion error.
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> fopen(path, mode);
  }
}

<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_stat_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *path, STRUCT_STAT * buf) {
  LPWSTR wpath = hts_convertUTF8StringToUCS2(path, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(path), NULL);

  <B><FONT COLOR="#A020F0">if</FONT></B> (wpath != NULL) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> result = _wstat(wpath, buf);

    free(wpath);
    <B><FONT COLOR="#A020F0">return</FONT></B> result;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <I><FONT COLOR="#B22222">// Fallback on conversion error.
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> _stat(path, buf);
  }
}

<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_unlink_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *path) {
  LPWSTR wpath = hts_convertUTF8StringToUCS2(path, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(path), NULL);

  <B><FONT COLOR="#A020F0">if</FONT></B> (wpath != NULL) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> result = _wunlink(wpath);

    free(wpath);
    <B><FONT COLOR="#A020F0">return</FONT></B> result;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <I><FONT COLOR="#B22222">// Fallback on conversion error.
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> _unlink(path);
  }
}

<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_rename_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *oldpath, <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *newpath) {
  LPWSTR woldpath =
    hts_convertUTF8StringToUCS2(oldpath, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(oldpath), NULL);
  LPWSTR wnewpath =
    hts_convertUTF8StringToUCS2(newpath, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(newpath), NULL);
  <B><FONT COLOR="#A020F0">if</FONT></B> (woldpath != NULL &amp;&amp; wnewpath != NULL) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> result = _wrename(woldpath, wnewpath);

    free(woldpath);
    free(wnewpath);
    <B><FONT COLOR="#A020F0">return</FONT></B> result;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <B><FONT COLOR="#A020F0">if</FONT></B> (woldpath != NULL)
      free(woldpath);
    <B><FONT COLOR="#A020F0">if</FONT></B> (wnewpath != NULL)
      free(wnewpath);
    <I><FONT COLOR="#B22222">// Fallback on conversion error.
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> rename(oldpath, newpath);
  }
}

<B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_mkdir_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *path) {
  LPWSTR wpath = hts_convertUTF8StringToUCS2(path, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(path), NULL);

  <B><FONT COLOR="#A020F0">if</FONT></B> (wpath != NULL) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> result = _wmkdir(wpath);

    free(wpath);
    <B><FONT COLOR="#A020F0">return</FONT></B> result;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <I><FONT COLOR="#B22222">// Fallback on conversion error.
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> _mkdir(path);
  }
}

HTSEXT_API <B><FONT COLOR="#228B22">int</FONT></B> <B><FONT COLOR="#0000FF">hts_utime_utf8</FONT></B>(<B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">char</FONT></B> *path, <B><FONT COLOR="#228B22">const</FONT></B> STRUCT_UTIMBUF * times) {
  STRUCT_UTIMBUF mtimes = *times;
  LPWSTR wpath = hts_convertUTF8StringToUCS2(path, (<B><FONT COLOR="#228B22">int</FONT></B>) strlen(path), NULL);

  <B><FONT COLOR="#A020F0">if</FONT></B> (wpath != NULL) {
    <B><FONT COLOR="#228B22">const</FONT></B> <B><FONT COLOR="#228B22">int</FONT></B> result = _wutime(wpath, &amp;mtimes);

    free(wpath);
    <B><FONT COLOR="#A020F0">return</FONT></B> result;
  } <B><FONT COLOR="#A020F0">else</FONT></B> {
    <I><FONT COLOR="#B22222">// Fallback on conversion error.
</FONT></I>    <B><FONT COLOR="#A020F0">return</FONT></B> _utime(path, &amp;mtimes);
  }
}

#<B><FONT COLOR="#5F9EA0">endif</FONT></B>

<I><FONT COLOR="#B22222">// Fin
</FONT></I></PRE>
<HR>
<ADDRESS>Generated by <A HREF="http://www.iki.fi/~mtr/genscript/">GNU Enscript 1.6.5.90</A>.</ADDRESS>
</BODY>

<!-- Mirrored from www.httrack.com/src/htslib.c.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 02 Jan 2023 20:32:27 GMT -->
</HTML>
